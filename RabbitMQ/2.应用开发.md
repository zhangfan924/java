<h1 align="center">RabbitMQå®¢æˆ·ç«¯åº”ç”¨å¼€å‘å®æˆ˜</h1>

<p align="center">
  <img src="https://img.shields.io/badge/Markdown-æ¨¡æ¿-blue.svg" />
  <img src="https://img.shields.io/badge/Version-1.0-green.svg" />
</p>

# ä¸€ã€å›é¡¾RabbitMQåŸºç¡€æ¦‚å¿µ

![QQ_1722144719705](img\QQ_1722144719705.png)

è¿™ä¸ªRabbitMQçš„æ ¸å¿ƒç»„ä»¶ï¼Œæ˜¯è¿›è¡Œåº”ç”¨å¼€å‘çš„åŸºç¡€ã€‚

# äºŒã€RabbitMQåŸºç¡€ç¼–ç¨‹æ¨¡å‹

RabbitMQæä¾›äº†å¾ˆå¤šç§ä¸»æµç¼–ç¨‹è¯­è¨€çš„å®¢æˆ·ç«¯æ”¯æŒã€‚è¿™é‡Œæˆ‘ä»¬åªåˆ†æJavaè¯­è¨€çš„å®¢æˆ·ç«¯ã€‚

ä¸Šä¸€ç« èŠ‚æä¾›äº†ä¸€ä¸ªç®€å•çš„RabbitMQå®¢æˆ·ç«¯å®ç°ï¼Œè¿™é‡Œï¼Œå°±ä»¥ä¸Šä¸€ç« èŠ‚çš„å®¢æˆ·ç«¯ç¤ºä¾‹ä¸ºåŸºç¡€ï¼Œäº†è§£ä¸‹RabbitMQå®¢æˆ·ç«¯å¼€å‘çš„åŸºç¡€æµç¨‹ï¼Œä¸ºåç»­ç†è§£å„ç§ä¸šåŠ¡åœºæ™¯æ‰“ä¸‹åŸºç¡€ã€‚

## 1ã€mavenä¾èµ–

```xml
<dependency>
    <groupId>com.rabbitmq</groupId>
    <artifactId>amqp-client</artifactId>
    <version>5.21.0</version>
</dependency>
```

amqpæ˜¯ä¸€ç§æ ‡å‡†çš„æ¶ˆæ¯é©±åŠ¨å®ç°åè®®ï¼ŒRabbitMQæ˜¯å¯¹è¿™ä¸€åè®®çš„å…·ä½“å®ç°ã€‚ç”±äºåè®®å…·æœ‰ç¨³å®šæ€§ï¼Œæ‰€ä»¥ï¼Œé€šå¸¸RabbitMQçš„å®¢æˆ·ç«¯ä¸ä¸€å®šè¦æ±‚ä¸æœåŠ¡ç«¯ç‰ˆæœ¬ä¸€è‡´ã€‚

## 2ã€åŸºç¡€ç¼–ç¨‹æ¨¡å‹

ç»“åˆä¸Šä¸€ç« èŠ‚çš„ç¬¬ä¸€ä¸ªæ¡ˆä¾‹ï¼Œè¯¦ç»†æ‹†è§£æ¯ä¸ªæ ¸å¿ƒæ¦‚å¿µçš„å…·ä½“å®ç°æ–¹å¼ä»¥åŠåŠŸèƒ½æ‰©å±•ã€‚

### step1ã€é¦–å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å–Channel

```java
ConnectionFactory factory = new ConnectionFactory();
factory.setHost(HOST_NAME);
factory.setPort(HOST_PORT);
factory.setUsername(USER_NAME);
factory.setPassword(PASSWORD);
factory.setVirtualHost(VIRTUAL_HOST);
Connection connection = factory.newConnection();
Channel channel = connection.createChannel();
```

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªå®¢æˆ·ç«¯é‡Œéƒ½åªæ˜¯åˆ›å»ºä¸€ä¸ªChannelå°±å¯ä»¥äº†ï¼Œå› ä¸ºä¸€ä¸ªChannelåªè¦ä¸å…³é—­ï¼Œæ˜¯å¯ä»¥ä¸€ç›´å¤ç”¨çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ æƒ³è¦åˆ›å»ºå¤šä¸ªChannelï¼Œè¦æ³¨æ„ä¸€ä¸‹Channelå†²çªçš„é—®é¢˜ã€‚

åœ¨åˆ›å»ºchannelæ—¶ï¼Œå¯ä»¥åœ¨createChannelæ–¹æ³•ä¸­ä¼ å…¥ä¸€ä¸ªåˆ†é…çš„intå‚æ•°channelNumberã€‚è¿™ä¸ªChannelNumberå°±ä¼šä½œä¸ºChannelçš„å”¯ä¸€æ ‡è¯†ã€‚è€ŒRabbitMQé˜²æ­¢ChannelNumberé‡å¤çš„æ–¹å¼æ˜¯ï¼šå¦‚æœå¯¹åº”çš„Channelæ²¡æœ‰åˆ›å»ºè¿‡ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Channelã€‚ä½†æ˜¯å¦‚æœChannelNumberå·²ç»åˆ›å»ºè¿‡ä¸€ä¸ªChanneläº†ï¼Œè¿™æ—¶å°±ä¼šè¿”å›ä¸€ä¸ªnullã€‚

### â“ ä»€ä¹ˆæƒ…å†µä¸‹ä¼šåˆ›å»ºå¤šä¸ª Channelï¼Ÿ

é€šå¸¸åœ¨å®¢æˆ·ç«¯é‡Œï¼Œ**ä¸€ä¸ª Channel å°±å¤Ÿç”¨**ï¼Œå› ä¸ºï¼š

- Channel æ˜¯è½»é‡çº§çš„ï¼Œ
- ä¸€ä¸ª Channel å¯ä»¥å¤ç”¨è¿›è¡Œå¤šä¸ªæ“ä½œï¼ˆå£°æ˜é˜Ÿåˆ—ã€å‘é€ã€æ¶ˆè´¹ï¼‰ã€‚

ä½†æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œ**éœ€è¦åˆ›å»ºå¤šä¸ª Channel**ï¼š

------

#### 1ï¸âƒ£ å¤šçº¿ç¨‹å¹¶å‘åœºæ™¯

- **åŸå› **ï¼šRabbitMQ çš„ **Channel ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„**ã€‚
- å¦‚æœåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å…±äº«ä¸€ä¸ª Channelï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ•°æ®é”™ä¹±æˆ–æ­»é”ã€‚
- âœ… æ­£ç¡®åšæ³•ï¼šæ¯ä¸ªçº¿ç¨‹å•ç‹¬åˆ›å»ºä¸€ä¸ª Channelï¼Œè¿™æ ·äº’ä¸å¹²æ‰°ã€‚

------

#### 2ï¸âƒ£ åŒºåˆ†ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…çš„é€»è¾‘

- æœ‰äº›åº”ç”¨åŒæ—¶æ‰¿æ‹… **ç”Ÿäº§è€…** å’Œ **æ¶ˆè´¹è€…** çš„è§’è‰²ã€‚
- ä¸ºäº†é¿å…é€»è¾‘è€¦åˆå’Œèµ„æºäº‰ç”¨ï¼Œå¯ä»¥ï¼š
  - ä¸€ä¸ª Channel ä¸“é—¨ç”¨äºç”Ÿäº§æ¶ˆæ¯
  - ä¸€ä¸ª Channel ä¸“é—¨ç”¨äºæ¶ˆè´¹æ¶ˆæ¯

------

#### 3ï¸âƒ£ ä¸šåŠ¡éš”ç¦» / ä¼˜å…ˆçº§æ§åˆ¶

- åœ¨ä¸€äº›å¤æ‚ä¸šåŠ¡é‡Œï¼Œä¸åŒç±»å‹çš„æ¶ˆæ¯è¦åˆ†å¼€å¤„ç†ï¼š
  - ä¾‹å¦‚ï¼šè®¢å•æ¶ˆæ¯ã€æ—¥å¿—æ¶ˆæ¯ã€å»¶æ—¶ä»»åŠ¡
- å¯ä»¥ç”¨ä¸åŒçš„ Channel æ¥æ“ä½œä¸åŒçš„ Queueï¼Œæ–¹ä¾¿åšæµé‡éš”ç¦»æˆ–ç›‘æ§ã€‚

------

#### 4ï¸âƒ£ çŸ­è¿æ¥/ä¸´æ—¶ä»»åŠ¡

- æŸäº›ä¸´æ—¶ä»»åŠ¡åªéœ€å’Œ RabbitMQ æ‰“ä¸€æ¬¡äº¤é“ï¼Œä¸æƒ³å¤ç”¨å·²æœ‰ Channelã€‚
- è¿™æ—¶å¯ä»¥æ–°å»ºä¸€ä¸ª Channelï¼Œç”¨å®Œå°±å…³é—­ï¼Œé¿å…å½±å“é•¿æœŸè¿è¡Œçš„ Channelã€‚

### step2ã€å£°æ˜Exchange

å…³é”®ä»£ç ï¼š

```java
channel.exchangeDeclare(String exchange, String type, boolean durable, boolean autoDelete,Map<String, Object> arguments) throws IOException;
```

> ### å„å‚æ•°å«ä¹‰
>
> | å‚æ•°         | è¯´æ˜                                                     |
> | ------------ | -------------------------------------------------------- |
> | `exchange`   | äº¤æ¢æœºåå­—ï¼Œå¯ä»¥è‡ªå·±å®šä¹‰ï¼Œæœ€å¥½å”¯ä¸€                       |
> | `type`       | äº¤æ¢æœºç±»å‹ï¼ˆå››ç§ç±»å‹ï¼šdirectã€fanoutã€topicã€headersï¼‰   |
> | `durable`    | æ˜¯å¦æŒä¹…åŒ–ï¼Œå¦‚æœä¸º `true`ï¼ŒRabbitMQ é‡å¯åäº¤æ¢æœºä¸ä¼šæ¶ˆå¤± |
> | `autoDelete` | æ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œå½“æ²¡æœ‰é˜Ÿåˆ—ç»‘å®šæ—¶ï¼Œäº¤æ¢æœºä¼šè¢«åˆ é™¤           |
> | `arguments`  | æ‰©å±•å±æ€§ï¼Œé€šå¸¸ç”¨äºè‡ªå®šä¹‰ç‰¹æ€§ï¼ˆæ¯”å¦‚æ¶ˆæ¯ TTLã€æ­»ä¿¡é˜Ÿåˆ—ç­‰ï¼‰ |

1. å¦‚æœ Broker ä¸Šä¸å­˜åœ¨è¯¥ Exchangeï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ã€‚
2. å¦‚æœ Broker ä¸Šå·²ç»æœ‰è¯¥ Exchangeï¼Œå£°æ˜æ—¶çš„å‚æ•°å¿…é¡»**å®Œå…¨ä¸€è‡´**ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
3. ç®¡ç†æ§åˆ¶å°ä¸Šå¯ä»¥çœ‹åˆ°è¿™äº›å‚æ•°ï¼Œå°¤å…¶æ˜¯ typeã€durable ç­‰ï¼Œæœ€å¥½å¯¹ç…§æ§åˆ¶å°ã€‚

![QQ_1722151145975](img\QQ_1722151145975.png)



### step3ã€å£°æ˜queue

å…³é”®ä»£ç ï¼š

```java
 channel.queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments);
```

> ### å„å‚æ•°å«ä¹‰
>
> | å‚æ•°         | è¯´æ˜                                             |
> | ------------ | ------------------------------------------------ |
> | `queue`      | é˜Ÿåˆ—åç§°                                         |
> | `durable`    | æ˜¯å¦æŒä¹…åŒ–é˜Ÿåˆ—ï¼ˆé‡å¯ RabbitMQ ä¸ä¸¢å¤±é˜Ÿåˆ—å’Œæ¶ˆæ¯ï¼‰ |
> | `exclusive`  | æ˜¯å¦ä¸ºç‹¬å é˜Ÿåˆ—ï¼Œåªèƒ½è¢«åˆ›å»ºå®ƒçš„ Connection ä½¿ç”¨   |
> | `autoDelete` | æ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œå½“æ²¡æœ‰æ¶ˆè´¹è€…æ—¶é˜Ÿåˆ—è‡ªåŠ¨åˆ é™¤         |
> | `arguments`  | æ‰©å±•å±æ€§ï¼ˆå¯å®šä¹‰é˜Ÿåˆ—ç±»å‹ã€æ¶ˆæ¯ TTL ç­‰ï¼‰          |

1. é˜Ÿåˆ—ä¸å­˜åœ¨æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºã€‚
2. é˜Ÿåˆ—å·²å­˜åœ¨æ—¶ï¼Œå£°æ˜å±æ€§å¿…é¡»ä¸å·²æœ‰é˜Ÿåˆ—ä¸€è‡´ï¼Œå¦åˆ™æŠ¥é”™ã€‚
3. Durability å†³å®šæ¶ˆæ¯æ˜¯å¦å†™å…¥ç£ç›˜ï¼š
   - **æŒä¹…åŒ–** (`durable = true`)ï¼šé‡å¯ä¸ä¸¢å¤±ï¼Œä½†æ€§èƒ½ç¨ä½
   - **ä¸´æ—¶** (`durable = false`)ï¼šé‡å¯ä¼šä¸¢å¤±ï¼Œä½†æ€§èƒ½é«˜
4. é˜Ÿåˆ—ç±»å‹ï¼š
   - API é»˜è®¤åˆ›å»º **Classic ç±»å‹**
   - å¦‚æœè¦å£°æ˜ **Quorum ç±»å‹**ï¼Œéœ€è¦é€šè¿‡ `arguments.put("x-queue-type", "quorum")` æ¥æŒ‡å®š
   - ä¸åŒç±»å‹é˜Ÿåˆ—å‚æ•°å¯èƒ½ä¸åŒï¼Œä¾‹å¦‚ Quorum é˜Ÿåˆ—é»˜è®¤æŒä¹…åŒ–ï¼Œä¸æ”¯æŒ Durability å‚æ•°

![QQ_1722151378827](img\QQ_1722151378827.png)





#### â“ Quorum é˜Ÿåˆ—æ˜¯ä»€ä¹ˆ

##### 1ï¸âƒ£ ä»€ä¹ˆæ˜¯ Quorum é˜Ÿåˆ—

Quorum é˜Ÿåˆ—æ˜¯ RabbitMQ 3.8 ä¹‹åå¼•å…¥çš„ä¸€ç§ **é«˜å¯ç”¨ã€å¼ºä¸€è‡´æ€§çš„é˜Ÿåˆ—ç±»å‹**ã€‚å®ƒæ˜¯åŸºäº **Raft åè®®** å®ç°çš„åˆ†å¸ƒå¼é˜Ÿåˆ—ï¼Œè®¾è®¡ç›®æ ‡æ˜¯ï¼š

- æ¶ˆæ¯ **ä¸ä¼šä¸¢å¤±**
- é›†ç¾¤èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œèƒ½å¤Ÿ **è‡ªåŠ¨æ¢å¤**
- æ”¯æŒ **æ•°æ®å¤åˆ¶å’Œä¸€è‡´æ€§**

æ¢å¥è¯è¯´ï¼ŒQuorum é˜Ÿåˆ—å°±æ˜¯ä¸ºäº†ä¿è¯åœ¨å¤šèŠ‚ç‚¹é›†ç¾¤ä¸­ **æ¶ˆæ¯å®‰å…¨å¯é ** çš„é˜Ÿåˆ—ç±»å‹ã€‚

------

##### 2ï¸âƒ£ Quorum é˜Ÿåˆ—çš„å†…éƒ¨åŸç†

- æ¯ä¸ª Quorum é˜Ÿåˆ—éƒ½æœ‰ **å¤šä¸ªå‰¯æœ¬ï¼ˆreplicaï¼‰**ï¼Œé€šå¸¸åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šåˆ†å¸ƒã€‚
- **ä¸€ä¸ªå‰¯æœ¬ä¸º Leader**ï¼Œå…¶ä»–ä¸º Followerã€‚
- æ‰€æœ‰å†™æ“ä½œï¼ˆå‘é€æ¶ˆæ¯ï¼‰å¿…é¡»åœ¨ **å¤§å¤šæ•°èŠ‚ç‚¹ï¼ˆmajorityï¼‰** ä¸ŠæˆåŠŸç¡®è®¤ï¼Œæ‰ç®—æˆåŠŸã€‚
- å½“ Leader èŠ‚ç‚¹å®•æœºæ—¶ï¼ŒFollower ä¼šé€‰ä¸¾æ–°çš„ Leaderï¼Œé˜Ÿåˆ—ç»§ç»­å¯ç”¨ã€‚

> âš¡ æ ¸å¿ƒæ€æƒ³ï¼šåŸºäº Raft åè®®ï¼Œä¿è¯å†™å…¥æ•°æ®ä¸€è‡´æ€§å’Œé«˜å¯ç”¨ã€‚

#### â“ Stream é˜Ÿåˆ—æ˜¯ä»€ä¹ˆ

##### 1ï¸âƒ£ ä»€ä¹ˆæ˜¯ Stream é˜Ÿåˆ—

- **Stream é˜Ÿåˆ—** æ˜¯ä¸€ç§ **æŒä¹…åŒ–ã€é«˜ååé‡ã€é¢å‘é¡ºåºæ¶ˆæ¯**çš„é˜Ÿåˆ—ç±»å‹ã€‚
- å®ƒçš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š**åœ¨ä¿è¯é¡ºåºçš„æƒ…å†µä¸‹ï¼Œå¤„ç†æµ·é‡æ¶ˆæ¯ï¼Œå¹¶æ”¯æŒæ¶ˆæ¯æŒ‰åç§»é‡ï¼ˆoffsetï¼‰è¯»å–**ã€‚
- å¯ä»¥ç†è§£æˆ RabbitMQ å¯¹ **Kafka é£æ ¼æ—¥å¿—é˜Ÿåˆ—** çš„æ”¯æŒã€‚

> ğŸ”¹ Quorum é˜Ÿåˆ—å¼ºè°ƒä¸€è‡´æ€§å’Œé«˜å¯é æ€§
>  ğŸ”¹ Stream é˜Ÿåˆ—å¼ºè°ƒé¡ºåºæ€§å’Œé«˜ååé‡

------

##### 2ï¸âƒ£ Stream é˜Ÿåˆ—çš„å†…éƒ¨åŸç†

- Stream é˜Ÿåˆ—å°†æ¶ˆæ¯ **è¿½åŠ å†™å…¥ç£ç›˜æ–‡ä»¶**ï¼ˆåƒæ—¥å¿—ä¸€æ ·ï¼‰ï¼Œè€Œä¸æ˜¯åƒ Classic æˆ– Quorum é˜Ÿåˆ—é‚£æ ·ç›´æ¥å­˜å‚¨åœ¨å†…å­˜é‡Œã€‚
- æ¶ˆæ¯ **æŒ‰é¡ºåºå­˜å‚¨**ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½æœ‰å”¯ä¸€çš„ **offset**ã€‚
- æ¶ˆè´¹è€…å¯ä»¥ **ä»ä»»æ„ offset** è¯»å–æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥é‡å¤æ¶ˆè´¹ã€‚
- æ”¯æŒ **æ‰¹é‡æ‹‰å–ï¼ˆbatch fetchï¼‰**ï¼Œæé«˜ååé‡ã€‚
- é»˜è®¤ **æŒä¹…åŒ–**ï¼Œå³ä½¿æœåŠ¡é‡å¯ä¹Ÿä¸ä¼šä¸¢æ¶ˆæ¯ã€‚

#### ä¸‰ç§é˜Ÿåˆ—å¯¹æ¯”

| ç‰¹æ€§     | Classic é˜Ÿåˆ—               | Quorum é˜Ÿåˆ—        | Stream é˜Ÿåˆ—                    |
| -------- | -------------------------- | ------------------ | ------------------------------ |
| æŒä¹…åŒ–   | å¯é€‰                       | é»˜è®¤æŒä¹…åŒ–         | é»˜è®¤æŒä¹…åŒ–                     |
| æ¶ˆæ¯é¡ºåº | FIFOï¼Œä½†å¯èƒ½å› å‰¯æœ¬åŒæ­¥ä¹±åº | FIFOï¼ŒRaftä¿è¯é¡ºåº | FIFOï¼Œä¸¥æ ¼é¡ºåº                 |
| é«˜å¯ç”¨æ€§ | å¯é…ç½®é•œåƒ                 | Raftå¤šå‰¯æœ¬         | é€šè¿‡é›†ç¾¤å¤åˆ¶å®ç°               |
| æ¶ˆæ¯æ¶ˆè´¹ | æ¨æ¨¡å¼                     | æ¨æ¨¡å¼             | æ‹‰æ¨¡å¼ï¼ˆPullï¼‰ä¸ºä¸»ï¼Œå¯é‡å¤æ¶ˆè´¹ |
| ååé‡   | é«˜                         | ä¸­                 | å¾ˆé«˜ï¼ˆç™¾ä¸‡çº§/ç§’ï¼‰              |
| æ¶ˆæ¯å­˜å‚¨ | å†…å­˜+ç£ç›˜                  | å†…å­˜+ç£ç›˜          | ç£ç›˜æ—¥å¿—å¼ï¼Œé€‚åˆå¤§æ¶ˆæ¯é‡       |

### step4ã€å£°æ˜Exchangeä¸Queueçš„ç»‘å®šå…³ç³»

```java
channel.basicPublish(String exchange, String routingKey, BasicProperties props,message.getBytes("UTF-8")) ;
```

> ### å‚æ•°è¯´æ˜
>
> | å‚æ•°         | ä½œç”¨                                         |
> | ------------ | -------------------------------------------- |
> | `queue`      | è¦ç»‘å®šçš„é˜Ÿåˆ—åç§°                             |
> | `exchange`   | è¦ç»‘å®šçš„äº¤æ¢æœºåç§°                           |
> | `routingKey` | è·¯ç”±å…³é”®å­—ï¼Œç”¨äº Exchange å†³å®šæ¶ˆæ¯çš„åˆ†å‘é€»è¾‘ |
> | `è¿”å›å€¼`     | Binding-confirmï¼Œç¡®è®¤ç»‘å®šæˆåŠŸ                |
> | `å¼‚å¸¸`       | IOExceptionï¼Œå¦‚æœç»‘å®šå¤±è´¥                    |

**Broker è‡ªåŠ¨åˆ›å»º**

- å¦‚æœ Queueã€Exchange å·²ç»å­˜åœ¨ï¼Œä½† Binding ä¸å­˜åœ¨ï¼ŒRabbitMQ ä¼šè‡ªåŠ¨åˆ›å»ºã€‚
- å¦‚æœ Binding å·²ç»å­˜åœ¨ï¼Œå£°æ˜æ—¶å¿…é¡»ä¸ç°æœ‰ Binding å±æ€§ä¸€è‡´ï¼Œå¦åˆ™æŠ¥é”™ã€‚

**routingKey çš„ä½œç”¨**

- ä¸åŒç±»å‹çš„ Exchangeï¼ˆDirect / Topic / Fanout / Headersï¼‰å¯¹ routingKey çš„ä½¿ç”¨è§„åˆ™ä¸åŒï¼š
  - **Direct Exchange**ï¼šroutingKey å¿…é¡»å®Œå…¨åŒ¹é… Queueã€‚
  - **Topic Exchange**ï¼šæ”¯æŒé€šé…ç¬¦ï¼Œå¦‚ `user.*` æˆ– `#.log`ã€‚
  - **Fanout Exchange**ï¼šå¿½ç•¥ routingKeyï¼Œå¹¿æ’­ç»™æ‰€æœ‰ç»‘å®šçš„ Queueã€‚
  - **Headers Exchange**ï¼šé€šå¸¸ç”¨å±æ€§ï¼ˆpropsï¼‰åŒ¹é…ï¼Œä¸ä½¿ç”¨ routingKeyã€‚

**å¤š Binding**

- ä¸€ä¸ª Exchange å¯ä»¥ç»‘å®šå¤šä¸ª Queueã€‚
- ä¸€ä¸ª Queue ä¹Ÿå¯ä»¥ç»‘å®šå¤šä¸ª Exchangeï¼ˆåŒä¸€ä¸ª routingKey æˆ–ä¸åŒ routingKeyï¼‰ã€‚

### step5ã€Produceræ ¹æ®åº”ç”¨åœºæ™¯å‘é€æ¶ˆæ¯åˆ°queue

```
channel.basicPublish(String exchange, String routingKey, BasicProperties props,message.getBytes("UTF-8")) ;
```

> ### å‚æ•°è¯´æ˜
>
> | å‚æ•°         | ä½œç”¨                                                         |
> | ------------ | ------------------------------------------------------------ |
> | `exchange`   | æ¶ˆæ¯è¦å‘é€åˆ°çš„äº¤æ¢æœºåç§°ã€‚å¦‚æœä¸ä½¿ç”¨ Exchangeï¼Œå¯ä¼ ç©ºå­—ç¬¦ä¸² `""`ï¼Œè¡¨ç¤ºé»˜è®¤äº¤æ¢æœºï¼ˆDefault Exchangeï¼‰ã€‚ |
> | `routingKey` | è·¯ç”±å…³é”®å­—ï¼Œç”¨äº Exchange å†³å®šæ¶ˆæ¯è¯¥å‘åˆ°å“ªä¸ª Queueã€‚ä¸åŒ Exchange ç±»å‹åŒ¹é…è§„åˆ™ä¸åŒã€‚ |
> | `props`      | æ¶ˆæ¯å±æ€§ï¼ˆAMQP.BasicPropertiesï¼‰ï¼Œå¯è®¾ç½®æŒä¹…åŒ–ã€æ¶ˆæ¯ç±»å‹ã€ä¼˜å…ˆçº§ã€headers ç­‰ã€‚ |
> | `body`       | æ¶ˆæ¯ä½“ï¼Œå­—èŠ‚æ•°ç»„ï¼Œä¸€èˆ¬ç”¨ `message.getBytes("UTF-8")` è½¬æ¢ã€‚  |

**Exchange å¿…é¡»å­˜åœ¨**

- å¦‚æœå‘é€åˆ°ä¸€ä¸ªä¸å­˜åœ¨çš„ Exchangeï¼Œä¼šè§¦å‘ **channel-level protocol exception**ï¼Œå¯¼è‡´ Channel è¢«å…³é—­ã€‚

**routingKey çš„ä½œç”¨**

- å’Œ Exchange ç±»å‹ç´§å¯†ç›¸å…³ï¼š
  - **Direct Exchange**ï¼šå®Œå…¨åŒ¹é… Queue çš„ bindingKeyã€‚
  - **Topic Exchange**ï¼šæ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼Œå¦‚ `user.*`ã€‚
  - **Fanout Exchange**ï¼šå¿½ç•¥ routingKeyï¼Œå¹¿æ’­æ¶ˆæ¯ã€‚
  - **Headers Exchange**ï¼šé€šå¸¸ä½¿ç”¨ props ä¸­çš„ header å±æ€§åŒ¹é…ï¼Œä¸ä½¿ç”¨ routingKeyã€‚

**props çš„ä½œç”¨**

- å¯ä»¥æ§åˆ¶æ¶ˆæ¯çš„æŒä¹…åŒ–ï¼ˆdeliveryModeï¼‰ã€ä¼˜å…ˆçº§ï¼ˆpriorityï¼‰ã€è¿‡æœŸæ—¶é—´ï¼ˆexpirationï¼‰ã€æ¶ˆæ¯ç±»å‹ï¼ˆtypeï¼‰ã€headers ç­‰ã€‚
- ä¸ç”¨æ­»è®°ï¼Œç®¡ç†æ§åˆ¶å°æˆ– API æ–‡æ¡£é‡Œæœ‰è¯¦ç»†è¯´æ˜ã€‚

**é»˜è®¤äº¤æ¢æœºï¼ˆDefault Exchangeï¼‰**

- RabbitMQ å†…ç½®ä¸€ä¸ªç©ºå­—ç¬¦ä¸² Exchangeã€‚
- å¦‚æœ `exchange=""`ï¼Œåˆ™ routingKey å¿…é¡»æ˜¯å­˜åœ¨çš„ Queue åç§°ï¼Œæ¶ˆæ¯ä¼šç›´æ¥å‘é€åˆ°æŒ‡å®š Queueã€‚![QQ_1722152570982](img\QQ_1722152570982.png)

propsçš„è¿™äº›é…ç½®é¡¹ï¼Œå¯ä»¥ç”¨RabbitMQä¸­æä¾›çš„ä¸€ä¸ªBuilderå¯¹è±¡æ¥æ„å»ºã€‚

```java
    AMQP.BasicProperties.Builder builder = new AMQP.BasicProperties.Builder(); 
    //å¯¹åº”é¡µé¢ä¸Šçš„Propertieséƒ¨åˆ†ï¼Œä¼ å…¥ä¸€äº›é¢„å®šçš„å‚æ•°å€¼ã€‚
    builder.deliveryMode(MessageProperties.PERSISTENT_TEXT_PLAIN.getDeliveryMode());
    builder.priority(MessageProperties.PERSISTENT_TEXT_PLAIN.getPriority());
    //builder.headers(headers);å¯¹åº”é¡µé¢ä¸Šçš„Headerséƒ¨åˆ†ã€‚ä¼ å…¥è‡ªå®šä¹‰çš„å‚æ•°å€¼
    builder.build()
    AMQP.BasicProperties prop = builder.build();
```

åœ¨å‘é€æ¶ˆæ¯æ—¶è¦æ³¨æ„ä¸€ä¸‹æ¶ˆæ¯çš„æŒä¹…åŒ–é—®é¢˜ã€‚MessageProperties.PERSISTENT_TEXT_PLAINæ˜¯RabbitMQæä¾›çš„æŒä¹…åŒ–æ¶ˆæ¯çš„é»˜è®¤é…ç½®ã€‚è€ŒRabbitMQä¸­æ¶ˆæ¯æ˜¯å¦æŒä¹…åŒ–ä¸å…‰å–å†³äºæ¶ˆæ¯ï¼Œè¿˜å–å†³äºQueueã€‚é€šå¸¸ä¸ºäº†ä¿è¯æ¶ˆæ¯å®‰å…¨ï¼Œä¼šå°†Queueå’Œæ¶ˆæ¯åŒæ—¶å£°æ˜ä¸ºæŒä¹…åŒ–ã€‚

### step6ã€Consumeræ¶ˆè´¹æ¶ˆæ¯

å®šä¹‰æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œå¹¶å‘RabbitMQè¿›è¡Œæ¶ˆæ¯ç¡®è®¤ã€‚ç¡®è®¤äº†ä¹‹åå°±è¡¨æ˜è¿™ä¸ªæ¶ˆæ¯å·²ç»æ¶ˆè´¹å®Œäº†ï¼Œå¦åˆ™RabbitMQè¿˜ä¼šç»§ç»­å‘èµ·é‡è¯•ã€‚

#### 1ï¸âƒ£ æ¶ˆè´¹è€…çš„æ ¸å¿ƒä½œç”¨

Consumer çš„èŒè´£å°±æ˜¯ï¼š

1. ä» **Queue** è·å–æ¶ˆæ¯
2. å¯¹æ¶ˆæ¯è¿›è¡Œå¤„ç†
3. å‘ RabbitMQ **ç¡®è®¤æ¶ˆæ¯å·²æ¶ˆè´¹**ï¼ˆAckï¼‰

> å¦‚æœæ¶ˆæ¯æœªè¢«ç¡®è®¤ï¼ŒRabbitMQ ä¼šè®¤ä¸ºæ¶ˆè´¹å¤±è´¥ï¼Œä¼šé‡æ–°æŠ•é€’æ¶ˆæ¯ç»™å…¶ä»–æ¶ˆè´¹è€…æˆ–è‡ªå·±é‡è¯•ã€‚

------

#### 2ï¸âƒ£ æ¶ˆè´¹æ¨¡å¼

##### (1) **Push æ¨¡å¼ï¼ˆæ¨èï¼‰**

- RabbitMQ **ä¸»åŠ¨æ¨é€**æ¶ˆæ¯ç»™ Consumer
- é€šå¸¸ä¼šåœ¨å®¢æˆ·ç«¯å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æˆ–çº¿ç¨‹æ± ï¼Œé•¿æ—¶é—´æŒ‚èµ·ç­‰å¾…æ¶ˆæ¯
- **ä¼˜ç‚¹**ï¼šæ¶ˆæ¯å¤„ç†åŠæ—¶ï¼Œä¸éœ€è¦é¢‘ç¹è½®è¯¢ï¼ŒæœåŠ¡ç«¯è´Ÿè½½å°

**å…³é”®ä»£ç **ï¼š

```
channel.basicConsume(String queue, boolean autoAck, Consumer callback);
```

| å‚æ•°       | è¯´æ˜                                                         |
| ---------- | ------------------------------------------------------------ |
| `queue`    | é˜Ÿåˆ—åç§°                                                     |
| `autoAck`  | æ˜¯å¦è‡ªåŠ¨åº”ç­”ï¼š`true`è¡¨ç¤ºæ¶ˆæ¯ä¸€åˆ°å°±è‡ªåŠ¨ç¡®è®¤ï¼Œ`false`è¡¨ç¤ºæ‰‹åŠ¨ç¡®è®¤ |
| `callback` | æ¶ˆè´¹è€…å›è°ƒæ¥å£ï¼Œå¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯                               |

> æ¶ˆæ¯å¤„ç†å®Œåï¼Œå¦‚æœ `autoAck=false`ï¼Œéœ€è¦è°ƒç”¨ `channel.basicAck(deliveryTag, false)` æ¥æ˜¾å¼ç¡®è®¤æ¶ˆæ¯ã€‚

------

##### (2) **Pull æ¨¡å¼**

- Consumer **ä¸»åŠ¨æ‹‰å–**æ¶ˆæ¯
- éœ€è¦ä¸æ–­è°ƒç”¨ `basicGet` æ¥æŸ¥è¯¢æ¶ˆæ¯
- **ä¼˜ç‚¹**ï¼šå¯ä»¥æŒ‰éœ€æ‹‰å–ï¼Œé€‚åˆå¤„ç†ä½é¢‘æˆ–æ‰¹é‡å¤„ç†
- **ç¼ºç‚¹**ï¼šä¸å¤Ÿå®æ—¶ï¼Œä¼šå¢åŠ æœåŠ¡ç«¯å‹åŠ›

**å…³é”®ä»£ç **ï¼š

```
GetResponse response = channel.basicGet(QUEUE_NAME, boolean autoAck);
```

| å‚æ•°         | è¯´æ˜                                                       |
| ------------ | ---------------------------------------------------------- |
| `QUEUE_NAME` | é˜Ÿåˆ—åç§°                                                   |
| `autoAck`    | æ˜¯å¦è‡ªåŠ¨åº”ç­”                                               |
| è¿”å›å€¼       | `GetResponse`ï¼ŒåŒ…å«æ¶ˆæ¯æ•°æ®ã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å› `GetEmpty` |

> åŒæ ·ï¼Œå¦‚æœ `autoAck=false`ï¼Œå¤„ç†å®Œæ¶ˆæ¯åéœ€è¦æ‰‹åŠ¨è°ƒç”¨ `basicAck` ç¡®è®¤ã€‚

------

#### 3ï¸âƒ£ æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆAckï¼‰

- **autoAck=true**
  - æ¶ˆæ¯ä¸€é€åˆ° Consumer å°±è‡ªåŠ¨ç¡®è®¤
  - å¦‚æœ Consumer å¼‚å¸¸é€€å‡ºï¼Œæ¶ˆæ¯å¯èƒ½ä¸¢å¤±
- **autoAck=false**ï¼ˆæ¨èï¼‰
  - æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯åæ‰‹åŠ¨ç¡®è®¤
  - `channel.basicAck(deliveryTag, false)`
  - Broker æ”¶åˆ° Ack åï¼Œæ‰ä¼šè®¤ä¸ºæ¶ˆæ¯æ¶ˆè´¹æˆåŠŸ

> å®é™…ç”Ÿäº§ä¸­ï¼Œæ¨æ¨¡å¼ + æ‰‹åŠ¨ Ack æ˜¯æœ€å¸¸ç”¨çš„ç»„åˆã€‚

### step7ã€å®Œæˆä»¥åå…³é—­è¿æ¥ï¼Œé‡Šæ”¾èµ„æº

```java
channel.close(); 
conection.clouse();
```

ç”¨å®Œä¹‹åä¸»åŠ¨é‡Šæ”¾èµ„æºã€‚å¦‚æœä¸ä¸»åŠ¨é‡Šæ”¾çš„è¯ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œè¿‡ä¸€æ®µæ—¶é—´RabbitMQä¹Ÿä¼šå°†è¿™äº›èµ„æºé‡Šæ”¾æ‰ï¼Œä½†æ˜¯è¿™å°±éœ€è¦é¢å¤–æ¶ˆè€—ç³»ç»Ÿèµ„æºã€‚

## 3ã€å…³äºæ¶ˆæ¯ç›‘å¬ä¸å›æº¯

ä¸Šä¸€èŠ‚åªæ˜¯åˆ—å‡ºäº†ç”¨å¾—æœ€å¤šçš„å‡ ä¸ªå¸¸ç”¨çš„æ–¹æ³•ã€‚ä½†æ˜¯ï¼ŒRabbitMQçš„å®¢æˆ·ç«¯è¿˜æä¾›äº†å¾ˆå¤šé‡è½½æ–¹æ³•å’Œæ‰©å±•æ–¹æ³•ï¼Œè¿™äº›éœ€è¦è‡ªè¡ŒæŒæ¡ã€‚

ä¾‹å¦‚ï¼Œåœ¨æ¶ˆè´¹æ¶ˆæ¯æ˜¯ï¼Œchannelè¿˜æä¾›äº†ä¸€ä¸ªé‡è½½çš„æ–¹æ³•ï¼š

```java
String basicConsume(String queue, DeliverCallback deliverCallback, CancelCallback cancelCallback, ConsumerShutdownSignalCallback shutdownSignalCallback) throws IOException;
```

è¿™äº›callbackå®é™…ä¸Šå°±æ˜¯RabbitMQåœ¨Consumerä¸­ä¿ç•™çš„ä¸šåŠ¡æ‰©å±•ç‚¹ã€‚è¿™äº›æ‹“å±•çš„æ–¹æ³•ï¼Œå­¦ä¹ çš„æ—¶å€™å¯èƒ½æ²¡æœ‰å¤ªå¤§çš„ä½œç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ æ²¡æœ‰æå‰æ€»ç»“ï¼Œç­‰åˆ°çœŸæ­£å¼€å‘çš„æ—¶å€™ï¼Œè‚¯å®šæƒ³ä¸åˆ°è¿™äº›æ‰©å±•ç‚¹ã€‚

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå·±åšä¸€ä¸ªå°æ¡ˆä¾‹ã€‚

```java
public class CallbackConsumer {
    private static final String EXCHANGE_NAME="callbackExchange";
    private static final String ALTER_EXCHANGE_NAME="alterExchange";
    private static final String QUEUE_NAME = "callbackQueue";

    public static void main(String[] args) throws Exception {
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        Map<String,Object> params = new HashMap<>();
        params.put("alternate-exchange",ALTER_EXCHANGE_NAME);
        channel.exchangeDeclare(EXCHANGE_NAME,BuiltinExchangeType.DIRECT,true,false,params);
        channel.exchangeDeclare(ALTER_EXCHANGE_NAME,BuiltinExchangeType.DIRECT,true,false,null);

        channel.queueDeclare(QUEUE_NAME, true, false, false, null);

        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,"key1");

        channel.basicConsume(QUEUE_NAME, new DeliverCallback() {
                    @Override
                    public void handle(String consumerTag, Delivery message) throws IOException {
                        long deliveryTag = message.getEnvelope().getDeliveryTag();
                        String correlationId = message.getProperties().getCorrelationId();
                        System.out.println("received message consumerTag: " + consumerTag + "; message: " + new String(message.getBody())+";deliveryTag: "+deliveryTag+";correlationId: "+correlationId);
                        channel.basicAck(deliveryTag,false);
                    }
                }
                //å»æ§åˆ¶å°æŠŠé˜Ÿåˆ—åˆ æ‰å°±ä¼šè§¦å‘cancel
                , new CancelCallback() {
                    @Override
                    public void handle(String consumerTag) throws IOException {
                        System.out.println("canceled message consumerTag: " + consumerTag + "; ");
                    }
                }
                , new ConsumerShutdownSignalCallback() {
                    @Override
                    public void handleShutdownSignal(String consumerTag, ShutdownSignalException sig) {
                        System.out.println("consumer shutdown message consumerTag: " + consumerTag + "; Exception: " + sig);
                    }
                });
    }
}
```

ç„¶åå¾€é˜Ÿåˆ—é‡Œå¤šæ¬¡å‘é€æ¶ˆæ¯ã€‚ä½ èƒ½çœ‹åˆ°è¿™æ ·çš„ç»“æœï¼š

```
received message consumerTag: amq.ctag-6d_w_WZWpu66H61kzuUfTw; message: message;deliveryTag: 1
received message consumerTag: amq.ctag-6d_w_WZWpu66H61kzuUfTw; message: message;deliveryTag: 2
received message consumerTag: amq.ctag-6d_w_WZWpu66H61kzuUfTw; message: message;deliveryTag: 3
received message consumerTag: amq.ctag-6d_w_WZWpu66H61kzuUfTw; message: message;deliveryTag: 4
```

è¿™äº›å°±æ˜¯ä»DeliverCallbackæ¥å£ååº”å‡ºæ¥çš„ç»“æœã€‚ä»è¿™ä¸ªç»“æœä½ æ˜¯å¦èƒ½ç†è§£ä¹‹å‰æ²¡æœ‰è¯¦ç»†åˆ†äº«çš„consumerTagå’ŒdeliveryTagåˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿæ˜¯çš„ï¼Œ**consumerTagä»£è¡¨çš„æ˜¯ä¸å®¢æˆ·ç«¯çš„ä¸€ä¸ªä¼šè¯**ã€‚**deliveryTagä»£è¡¨çš„æ˜¯è¿™ä¸ªChannelå¤„ç†çš„ä¸€æ¡æ¶ˆæ¯**ã€‚è¿™éƒ½æ˜¯RabbitMQæœåŠ¡ç«¯åˆ†é…çš„ä¸€äº›å†…éƒ¨å‚æ•°ã€‚æ—¥åï¼Œå¦‚æœä½ å¸Œæœ›å¯¹Consumerå¤„ç†çš„æ¯ä¸€æ¡æ¶ˆæ¯å¢åŠ æº¯æºè¿‡åŠŸèƒ½æ—¶ï¼ŒæŠŠconsumerTag+deliveryTagä½œä¸ºæ¶ˆæ¯ç¼–å·ï¼Œä¿å­˜ä¸‹æ¥ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªä¸é”™çš„è®¾è®¡ã€‚

# ä¸‰ã€RabbitMQå¸¸ç”¨çš„æ¶ˆæ¯åœºæ™¯

![QQ_1722153617288](img\QQ_1722153617288.png)

## 1ï¼šhello worldä½“éªŒ

![QQ_1722153789138](img\QQ_1722153789138.png)

æœ€ç›´æ¥çš„æ–¹å¼ï¼Œ**Pç«¯å‘é€ä¸€ä¸ªæ¶ˆæ¯åˆ°ä¸€ä¸ªæŒ‡å®šçš„queueï¼Œä¸­é—´ä¸éœ€è¦ä»»ä½•exchangeè§„åˆ™**ã€‚Cç«¯æŒ‰queueæ–¹å¼è¿›è¡Œæ¶ˆè´¹ã€‚

å…³é”®ä»£ç ï¼š(å…¶å®å…³é”®çš„åŒºåˆ«ä¹Ÿå°±æ˜¯å‡ ä¸ªå£°æ˜ä¸Šçš„ä¸åŒã€‚)

producer:

```java
channel.queueDeclare(QUEUE_NAME,false,false,false,null);
channel.basicPublish("", QUEUE_NAME, null, message.getBytes("UTF-8"));
```

consumer:

```
channel.queueDeclare(QUEUE_NAME, false, false, false, null);
```

## 2ï¼šWork queues å·¥ä½œåºåˆ—

è¿™æ˜¯RabbitMQæœ€åŸºç¡€ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§å·¥ä½œæœºåˆ¶ã€‚![QQ_1722153802670](img\QQ_1722153802670.png)

å·¥ä½œä»»åŠ¡æ¨¡å¼ï¼Œé¢†å¯¼éƒ¨ç½²ä¸€ä¸ªä»»åŠ¡ï¼Œç”±ä¸‹é¢çš„ä¸€ä¸ªå‘˜å·¥æ¥å¤„ç†ã€‚åªå…³å¿ƒä»»åŠ¡è¢«æ­£ç¡®å¤„ç†ï¼Œä¸å…³å¿ƒç»™è°å¤„ç†ã€‚

**Produceræ¶ˆæ¯å‘é€ç»™queueï¼Œå¤šä¸ªConsumeråŒæ—¶å¾€é˜Ÿåˆ—ä¸Šæ¶ˆè´¹æ¶ˆæ¯ã€‚**

å…³é”®ä»£ç ï¼š ===ã€‹producer: å°†æ¶ˆæ¯ç›´æ¥åˆ°Queueä¸Šã€‚

```java
channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null); //ä»»åŠ¡ä¸€èˆ¬æ˜¯ä¸èƒ½å› ä¸ºæ¶ˆæ¯ä¸­é—´ä»¶çš„æœåŠ¡è€Œè¢«è€½è¯¯çš„ï¼Œæ‰€ä»¥durableè®¾ç½®æˆäº†trueï¼Œè¿™æ ·ï¼Œå³ä½¿rabbitMQæœåŠ¡æ–­äº†ï¼Œè¿™ä¸ªæ¶ˆæ¯ä¹Ÿä¸ä¼šæ¶ˆå¤±
channel.basicPublish("", TASK_QUEUE_NAME,MessageProperties.PERSISTENT_TEXT_PLAIN,
        message.getBytes("UTF-8"));
```

Consumer: æ¯æ¬¡æ‹‰å–ä¸€æ¡æ¶ˆæ¯ã€‚

```java
channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);
channel.basicQos(1);
channel.basicConsume(TASK_QUEUE_NAME, false, consumer);
```

### 4ï¸âƒ£ æ³¨æ„äº‹é¡¹

#### â‘  æ¶ˆæ¯ç¡®è®¤ï¼ˆAckï¼‰

- **å¿…é¡»**æ‰‹åŠ¨ç¡®è®¤æ¯æ¡æ¶ˆæ¯
- å¦‚æœ Consumer æœª ackï¼ŒæœåŠ¡ç«¯ä¼š **é‡å¤æŠ•é€’æ¶ˆæ¯**
- æœª ack çš„æ¶ˆæ¯ä¼šä¸€ç›´å ç”¨èµ„æºï¼Œå¯èƒ½é€ æˆ **Poison Messageï¼ˆæ¯’æ¶ˆæ¯ï¼‰é—®é¢˜ï¼‰**

------

#### â‘¡ æ¶ˆæ¯å¯é æ€§

- å³ä½¿é˜Ÿåˆ—å’Œæ¶ˆæ¯éƒ½è®¾ç½® `durable=true`ï¼Œä¹Ÿä¸èƒ½ **å®Œå…¨ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±**
- åŸå› ï¼š
  - RabbitMQ å†™å…¥æ¶ˆæ¯åˆ° **PageCache**ï¼ˆå†…å­˜ç¼“å­˜ï¼‰ï¼Œå¹¶éç«‹å³å†™å…¥ç£ç›˜
  - ç³»ç»Ÿæ–­ç”µå¯èƒ½å¯¼è‡´ PageCache æ•°æ®ä¸¢å¤±
- è§£å†³æ–¹å¼ï¼š
  - ä½¿ç”¨ **Publisher Confirmsï¼ˆå‘å¸ƒç¡®è®¤æœºåˆ¶ï¼‰**
  - é€šè¿‡åº”ç”¨å±‚ç¡®ä¿æ¶ˆæ¯å·²å®‰å…¨å†™å…¥ RabbitMQ

------

#### â‘¢ å¤šä¸ª Consumer çš„æ¶ˆæ¯åˆ†å‘

- é»˜è®¤ **è½®è¯¢ï¼ˆRound-Robinï¼‰** åˆ†å‘ï¼Œä¸è€ƒè™‘æ¶ˆè´¹è€…å¤„ç†é€Ÿåº¦
- æ”¹è¿›æ–¹æ¡ˆï¼š
  - è®¾ç½® **`prefetchCount`**ï¼ˆé€šè¿‡ `basicQos(prefetchCount)`ï¼‰
  - è¡¨ç¤ºæ¶ˆè´¹è€…èƒ½åŒæ—¶å¤„ç†çš„æœ€å¤§æœª ack æ¶ˆæ¯æ•°é‡
  - è¶…è¿‡è¿™ä¸ªå€¼ï¼ŒæœåŠ¡ç«¯ä¸ä¼šå†ç»™è¯¥æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯
  - æ³¨æ„ï¼šå¦‚æœæ‰€æœ‰æ¶ˆè´¹è€…éƒ½è¾¾åˆ°ä¸Šé™ï¼Œæ¶ˆæ¯ä¼šé˜»å¡åœ¨é˜Ÿåˆ—ä¸­ï¼Œéœ€è¦ç›‘æ§æˆ–æ‰©å®¹æ¶ˆè´¹è€…

------

#### â‘£ é˜Ÿåˆ—å®¹é‡é—®é¢˜

- å¦‚æœæ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¿™ï¼Œé˜Ÿåˆ—å¯èƒ½å †ç§¯
- åº”å¯¹ç­–ç•¥ï¼š
  - å¢åŠ æ¶ˆè´¹è€…èŠ‚ç‚¹
  - é™åˆ¶é˜Ÿåˆ—å¤§å°
  - æˆ–è€…æ ¹æ®ä¸šåŠ¡é‡‡å– **æ¶ˆæ¯é™çº§/æ‹’ç»ç­–ç•¥**

## 3ï¼šPublish/Subscribe è®¢é˜… å‘å¸ƒ æœºåˆ¶

typeä¸º**fanout** çš„exchangeï¼š

![QQ_1722155082752](img\QQ_1722155082752.png)

### 1ï¸âƒ£ æ ¸å¿ƒæ€æƒ³

- Producer **åªè´Ÿè´£å‘é€æ¶ˆæ¯ç»™ Exchange**ï¼Œä¸å…³å¿ƒæ¶ˆæ¯æœ€ç»ˆä¼šè¢«å“ªä¸ª Queue æ¶ˆè´¹ã€‚
- Exchange æ ¹æ®ç±»å‹ï¼ˆè¿™é‡Œæ˜¯ **fanout**ï¼‰å°†æ¶ˆæ¯åˆ†å‘ç»™æ‰€æœ‰ä¸å®ƒç»‘å®šçš„é˜Ÿåˆ—ã€‚
- æ¯ä¸ª Queue éƒ½å¯ä»¥æœ‰ç‹¬ç«‹çš„ Consumer æ¶ˆè´¹æ¶ˆæ¯ã€‚
- è¿™æ ·å®ç°äº† **Producer ä¸ Consumer çš„è§£è€¦**ï¼ŒProducer ä¸éœ€è¦çŸ¥é“æ¶ˆè´¹è€…çš„å­˜åœ¨ã€‚

------

### 2ï¸âƒ£ fanout Exchange ç‰¹æ€§

- **ç±»å‹**ï¼š`fanout`
- **æ¶ˆæ¯åˆ†å‘**ï¼š
  - ä¸çœ‹ RoutingKey
  - æ¶ˆæ¯ä¼šå¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šåˆ°è¯¥ Exchange çš„é˜Ÿåˆ—
- **é€‚ç”¨åœºæ™¯**ï¼š
  - éœ€è¦ä¸€æ¡æ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶å¤„ç†çš„åœºæ™¯ï¼ˆæ¯”å¦‚å¹¿æ’­é€šçŸ¥ã€æ—¥å¿—æ”¶é›†ã€å®æ—¶æ•°æ®æ¨é€ï¼‰ã€‚

------

### 3ï¸âƒ£ å…³é”®ä»£ç åˆ†æ

**Producer ç«¯ï¼š**

```
channel.exchangeDeclare(EXCHANGE_NAME, "fanout");
channel.basicPublish(EXCHANGE_NAME, "", null, message.getBytes("UTF-8"));
```

- å£°æ˜ Exchangeï¼ˆç±»å‹ fanoutï¼‰
- å°†æ¶ˆæ¯å‘å¸ƒåˆ° Exchange
- RoutingKey ä¸ºç©ºï¼Œå› ä¸º fanout ç±»å‹ä¸ä½¿ç”¨å®ƒ

**Consumer ç«¯ï¼ˆç»‘å®šé˜Ÿåˆ—ï¼‰ï¼š**

```
channel.exchangeDeclare(EXCHANGE_NAME, "fanout");
String queueName = channel.queueDeclare().getQueue(); // ä¸´æ—¶é˜Ÿåˆ—
channel.queueBind(queueName, EXCHANGE_NAME, "");      // ç»‘å®šåˆ° Exchange
```

- æ¯ä¸ª Consumer éƒ½åˆ›å»ºè‡ªå·±çš„é˜Ÿåˆ—ï¼ˆé€šå¸¸æ˜¯ä¸´æ—¶é˜Ÿåˆ—ï¼‰
- å°†é˜Ÿåˆ—ç»‘å®šåˆ° Exchange
- Exchange ä¼šæŠŠæ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—

------

### 4ï¸âƒ£ åŒºåˆ«äº Work Queue

| ç‰¹æ€§         | Work Queueï¼ˆå·¥ä½œé˜Ÿåˆ—ï¼‰     | Publish/Subscribeï¼ˆå‘å¸ƒ/è®¢é˜…ï¼‰ |
| ------------ | -------------------------- | ------------------------------ |
| æ¶ˆæ¯æ¶ˆè´¹æƒ…å†µ | ä¸€æ¡æ¶ˆæ¯åªè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç† | ä¸€æ¡æ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…å¤„ç†   |
| æ¶ˆè´¹è€…æ•°é‡   | å¯ä»¥å¤šä¸ªï¼Œä½†åªæ˜¯åˆ†æ‘Šæ¶ˆæ¯   | å¯ä»¥å¤šä¸ªï¼Œæ¯ä¸ªéƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯     |
| ç›®çš„         | æé«˜ååé‡ã€è´Ÿè½½å‡è¡¡       | å¹¿æ’­æ¶ˆæ¯ã€è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…   |

------

ğŸ’¡ **æ€»ç»“**ï¼š

- Fanout Exchange æ˜¯ **å¹¿æ’­å‹**çš„ï¼Œæ¶ˆæ¯ä¼šå‘é€ç»™æ‰€æœ‰ç»‘å®šé˜Ÿåˆ—ã€‚
- æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰è‡ªå·±çš„é˜Ÿåˆ—ï¼Œæ‰€ä»¥å³ä½¿åŒä¸€æ¡æ¶ˆæ¯ï¼Œæ‰€æœ‰æ¶ˆè´¹è€…éƒ½èƒ½æ”¶åˆ°ã€‚

## 4ï¼šRouting åŸºäºå†…å®¹çš„è·¯ç”±

typeä¸ºâ€directâ€ çš„exchange

![QQ_1722155228480](img\QQ_1722155228480.png)

è¿™ç§æ¨¡å¼ä¸€çœ‹å›¾å°±æ¸…æ™°äº†ã€‚ åœ¨ä¸Šä¸€ç«  exchange å¾€æ‰€æœ‰é˜Ÿåˆ—å‘é€æ¶ˆæ¯çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ªè·¯ç”±é…ç½®ï¼ŒæŒ‡å®šexchangeå¦‚ä½•å°†ä¸åŒç±»åˆ«çš„æ¶ˆæ¯åˆ†å‘åˆ°ä¸åŒçš„queueä¸Šã€‚

å…³é”®ä»£ç ===> Producer åŒæ ·æ˜¯å¾€Exchangeå‘é€æ¶ˆæ¯ï¼Œä½†æ˜¯éœ€è¦æŒ‡å®šä¸€ä¸ªroutingKey

```java
channel.exchangeDeclare(EXCHANGE_NAME, "direct");
channel.basicPublish(EXCHANGE_NAME, routingKey, null, message.getBytes("UTF-8"));
```

Bindings åœ¨å»ºç«‹Exchangeå’ŒQueueçš„ç»‘å®šå…³ç³»æ—¶ï¼Œéœ€è¦æŒ‡å®šroutingKeyã€‚

```java
channel.exchangeDeclare(EXCHANGE_NAME, "direct");
channel.queueBind(queueName, EXCHANGE_NAME, routingKey1);
channel.queueBind(queueName, EXCHANGE_NAME, routingKey2);
channel.basicConsume(queueName, true, consumer);
```

æ¶ˆæ¯å°±ä¼šæ ¹æ®routingkeyè½¬å‘åˆ°å¯¹åº”çš„Queueä¸Šï¼Œç„¶åç»™æ¶ˆè´¹è€…å¤„ç†ã€‚

## 5ï¼šTopics åŸºäºè¯é¢˜çš„è·¯ç”±

typeä¸º"topic" çš„exchange

![QQ_1722155353494](img\QQ_1722155353494.png)

è¿™ä¸ªæ¨¡å¼ä¹Ÿå°±åœ¨Routingæ¨¡å¼çš„åŸºç¡€ä¸Šï¼Œå¯¹routingKeyè¿›è¡Œäº†æ¨¡ç³ŠåŒ¹é…ã€‚å•è¯ä¹‹é—´ç”¨,éš”å¼€ï¼Œ* ä»£è¡¨ä¸€ä¸ªå…·ä½“çš„å•è¯ã€‚# ä»£è¡¨0ä¸ªæˆ–å¤šä¸ªå•è¯ã€‚

å…³é”®ä»£ç ===> Producerï¼Œä¾ç„¶æ˜¯å¾€Exchangeå‘é€æ¶ˆæ¯ï¼Œå¹¶ä¸”éœ€è¦å¸¦ä¸ŠroutingKeyã€‚

```java
channel.exchangeDeclare(EXCHANGE_NAME, "topic");
channel.basicPublish(EXCHANGE_NAME, routingKey, null, message.getBytes("UTF-8"));
```

Bindings: ç»‘å®šroutingKey

```java
channel.exchangeDeclare(EXCHANGE_NAME, "topic");
channel.queueBind(queueName, EXCHANGE_NAME, routingKey1);
channel.queueBind(queueName, EXCHANGE_NAME, routingKey2);
channel.basicConsume(queueName, true, consumer);
```

æ¶ˆæ¯åœ¨æ ¹æ®routingKeyè¿›è¡Œè½¬å‘æ—¶ï¼Œä¼šè¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚

## 6ï¼šPublisher Confirms å‘é€è€…æ¶ˆæ¯ç¡®è®¤

### 1ï¸âƒ£ é—®é¢˜èƒŒæ™¯

- é»˜è®¤æƒ…å†µä¸‹ï¼ŒProducer è°ƒç”¨ `basicPublish` **æ²¡æœ‰è¿”å›å€¼**ã€‚
- ä¹Ÿå°±æ˜¯è¯´ Producer å¹¶ä¸çŸ¥é“æ¶ˆæ¯æ˜¯å¦çœŸçš„æˆåŠŸåˆ°è¾¾ RabbitMQ Brokerã€‚
- å¦‚æœå‘é€å¤±è´¥ï¼ˆç½‘ç»œä¸­æ–­ã€Broker å¼‚å¸¸ç­‰ï¼‰ï¼Œæ¶ˆæ¯å¯èƒ½ä¸¢å¤±ã€‚
- **è§£å†³æ–¹æ¡ˆ**ï¼šå¼€å¯ **å‘é€è€…ç¡®è®¤æ¨¡å¼**ï¼ˆPublisher Confirmsï¼‰ã€‚

------

### 2ï¸âƒ£ å¼€å¯å‘é€è€…ç¡®è®¤æ¨¡å¼

```
channel.confirmSelect();
```

- å¿…é¡»åœ¨ Channel ä¸Šæ‰‹åŠ¨å¼€å¯ã€‚
- å¼€å¯åï¼ŒBroker ä¼šåœ¨æ¶ˆæ¯æˆåŠŸåˆ°è¾¾ Exchange åç»™ Producer è¿”å›ç¡®è®¤ï¼ˆack æˆ– nackï¼‰ã€‚

------

### 3ï¸âƒ£ ä¸‰ç§ç¡®è®¤ç­–ç•¥

#### â‘  å•æ¡æ¶ˆæ¯ç¡®è®¤

```
channel.basicPublish("", queue, null, body.getBytes());
channel.waitForConfirmsOrDie(5_000);
```

- æ¯å‘é€ä¸€æ¡æ¶ˆæ¯å°±ç­‰å¾… Broker ç¡®è®¤ã€‚
- **ä¼˜ç‚¹**ï¼šç®€å•ã€æ¶ˆæ¯å¯é æ€§æœ€é«˜ã€‚
- **ç¼ºç‚¹**ï¼š**åŒæ­¥é˜»å¡ Channel**ï¼Œååé‡ä½ã€‚
- å¦‚æœè¶…è¿‡è¶…æ—¶æ—¶é—´æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼Œä¼šæŠ›å¼‚å¸¸ï¼Œå¯åšé‡è¯•æˆ–è®°å½•æ—¥å¿—ã€‚

------

#### â‘¡ æ‰¹é‡æ¶ˆæ¯ç¡®è®¤

```java
int batchSize = 100;
int outstandingMessageCount = 0;

for (...) {
    channel.basicPublish("", queue, null, body.getBytes());
    outstandingMessageCount++;

    if (outstandingMessageCount == batchSize) {
        channel.waitForConfirmsOrDie(5_000);
        outstandingMessageCount = 0;
    }
}
if (outstandingMessageCount > 0) {
    channel.waitForConfirmsOrDie(5_000);
}
```

- ç´¯è®¡ä¸€æ‰¹æ¶ˆæ¯åå†ä¸€èµ·ç¡®è®¤ã€‚
- **ä¼˜ç‚¹**ï¼šååé‡æ¯”å•æ¡ç¡®è®¤é«˜ã€‚
- **ç¼ºç‚¹**ï¼šç¡®è®¤å¼‚å¸¸æ—¶ï¼Œæ— æ³•çŸ¥é“å“ªä¸€æ¡æ¶ˆæ¯å‡ºé”™ï¼ŒåªçŸ¥é“è¿™ä¸€æ‰¹å¤±è´¥ã€‚

------

#### â‘¢ å¼‚æ­¥ç¡®è®¤

```java
channel.addConfirmListener(ackCallback, nackCallback);
```

- æ³¨å†Œ **ConfirmCallback**ï¼š

  ```java
  void handle(long sequenceNumber, boolean multiple)
  ```

  - `sequenceNumber`ï¼šæ¶ˆæ¯å”¯ä¸€åºåˆ—å·ï¼Œç”± `channel.getNextPublishSeqNo()` è·å–ã€‚
  - `multiple`ï¼š
    - `false` â†’ ä»…ç¡®è®¤å½“å‰åºåˆ—å·çš„æ¶ˆæ¯ã€‚
    - `true` â†’ ç¡®è®¤è¯¥åºåˆ—å·åŠä¹‹å‰æ‰€æœ‰æœªç¡®è®¤çš„æ¶ˆæ¯ã€‚

- **ä¼˜ç‚¹**ï¼š

  - æ€§èƒ½æœ€å¥½ï¼Œå¼‚æ­¥å¤„ç†ã€‚
  - å¯ä»¥å•ç‹¬å¤„ç†æˆåŠŸå’Œå¤±è´¥æ¶ˆæ¯ã€‚

- **ç¼ºç‚¹**ï¼š

  - éœ€è¦è‡ªå·±ç»´æŠ¤åºåˆ—å·ä¸æ¶ˆæ¯çš„æ˜ å°„å…³ç³»ã€‚

------

### 4ï¸âƒ£ è¿›ä¸€æ­¥ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±

- **ç¡®è®¤æ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ° Queue**ï¼š
  - Publisher å¯ä»¥æ³¨å†Œ **ReturnListener**ã€‚
  - ç›‘æ§æ¶ˆæ¯æ˜¯å¦ä» Exchange æˆåŠŸè·¯ç”±åˆ° Queueã€‚
  - å¦‚æœè·¯ç”±å¤±è´¥ï¼Œå¯ä»¥é€šè¿‡ **alternate-exchange** å±æ€§å°†æ¶ˆæ¯è½¬åˆ°å…œåº• Exchangeã€‚
- **æ€»ç»“**ï¼š
  1. **å•æ¡ç¡®è®¤** â†’ ç®€å•å¯é ï¼Œä½†æ€§èƒ½å·®
  2. **æ‰¹é‡ç¡®è®¤** â†’ æ€§èƒ½å¥½ï¼Œä½†å¼‚å¸¸æ— æ³•å®šä½å•æ¡æ¶ˆæ¯
  3. **å¼‚æ­¥ç¡®è®¤** â†’ æœ€ä¼˜æ–¹æ¡ˆï¼Œæ€§èƒ½é«˜ï¼Œå¯ç²¾ç¡®å¤„ç†æ¯æ¡æ¶ˆæ¯

## 7ã€Headers å¤´éƒ¨è·¯ç”±æœºåˆ¶

### 1ï¸âƒ£ Headers äº¤æ¢æœºæ¦‚å¿µ

- **ç±»å‹**ï¼š`BuiltinExchangeType.HEADERS`
- **ç‰¹ç‚¹**ï¼š
  - æ¶ˆæ¯è·¯ç”± **ä¸ä¾èµ– routingKey**ã€‚
  - æ¶ˆæ¯é€šè¿‡ **å¤´ä¿¡æ¯ï¼ˆHeadersï¼‰** çš„é”®å€¼å¯¹æ¥åŒ¹é…æ¶ˆè´¹è€…ã€‚
  - æ¶ˆè´¹è€…åœ¨ç»‘å®šé˜Ÿåˆ—æ—¶ï¼Œå¯ä»¥æŒ‡å®šå¯¹å“ªäº›å¤´ä¿¡æ¯æ„Ÿå…´è¶£ã€‚
- **åŒ¹é…æ–¹å¼**ï¼š
  - `"x-match" = "all"` â†’ æ‰€æœ‰æŒ‡å®šçš„å¤´ä¿¡æ¯éƒ½å¿…é¡»åŒ¹é…ã€‚
  - `"x-match" = "any"` â†’ åªè¦åŒ¹é…ä»»æ„ä¸€ä¸ªå¤´ä¿¡æ¯å³å¯ã€‚

> ç›¸æ¯” directã€fanoutã€topic è¿™äº›åŸºäº routingKey çš„äº¤æ¢æœºï¼ŒHeaders æ›´çµæ´»ï¼Œä½†æ€§èƒ½è¾ƒä½ï¼Œé€‚åˆç‰¹æ®Šä¸šåŠ¡åœºæ™¯ã€‚

------

### 2ï¸âƒ£ Consumer ç«¯ç»‘å®šç¤ºä¾‹

```java
Map<String, Object> headers = new HashMap<>();
headers.put("x-match","any");       // åŒ¹é…æ–¹å¼: all æˆ– any
headers.put("loglevel", "info");    // æ¶ˆè´¹è€…æ„Ÿå…´è¶£çš„å¤´ä¿¡æ¯
headers.put("buslevel", "product");
headers.put("syslevel", "admin");

Connection connection = RabbitMQUtil.getConnection();
Channel channel = connection.createChannel();

// å£°æ˜ headers ç±»å‹çš„ exchange
channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.HEADERS);

// å£°æ˜é˜Ÿåˆ—
String queueName = channel.queueDeclare("ReceiverHeader", true, false, false, null).getQueue();

// å°†é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœºï¼Œå¸¦ä¸Š headers
channel.queueBind(queueName, EXCHANGE_NAME, "", headers);
```

- æ³¨æ„ `routingKey` åœ¨ headers æ¨¡å¼ä¸‹ä¸è¢«ç”¨ä½œè·¯ç”±ï¼Œä½† API ä»ç„¶è¦æ±‚ä¼ å…¥ï¼Œå¯ä»¥ç•™ç©ºæˆ–å­˜æ”¾å…¶ä»–ä¸šåŠ¡ä¿¡æ¯ã€‚
- é˜Ÿåˆ—ç»‘å®šæ—¶ï¼ŒæŒ‡å®šçš„å¤´ä¿¡æ¯ä¼šå‘Šè¯‰äº¤æ¢æœºå“ªäº›æ¶ˆæ¯éœ€è¦è·¯ç”±åˆ°è¿™ä¸ªé˜Ÿåˆ—ã€‚

------

### 3ï¸âƒ£ Producer ç«¯å‘é€ç¤ºä¾‹

```java
Map<String, Object> headers = new HashMap<>();
headers.put("loglevel", "error");
headers.put("buslevel", "product");
headers.put("syslevel", "admin");

String message = "LOG INFO asdfasdf";

Connection connection = RabbitMQUtil.getConnection();
Channel channel = connection.createChannel();

// å£°æ˜ headers ç±»å‹çš„ exchange
channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.HEADERS);

// æ„å»ºæ¶ˆæ¯å±æ€§
AMQP.BasicProperties.Builder builder = new AMQP.BasicProperties.Builder(); 
builder.deliveryMode(MessageProperties.PERSISTENT_TEXT_PLAIN.getDeliveryMode());
builder.priority(MessageProperties.PERSISTENT_TEXT_PLAIN.getPriority());
builder.headers(headers);

// å‘å¸ƒæ¶ˆæ¯åˆ° exchange
channel.basicPublish(EXCHANGE_NAME, "ourTestRoutingKey", builder.build(), message.getBytes("UTF-8"));

channel.close();
connection.close();
```

- æ¶ˆæ¯é€šè¿‡ `builder.headers(headers)` æºå¸¦å¤´ä¿¡æ¯ã€‚
- æ¶ˆè´¹è€…ç»‘å®šæ—¶åŒ¹é…çš„å¤´ä¿¡æ¯å†³å®šäº†æ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ°è¯¥é˜Ÿåˆ—ã€‚

------

### 4ï¸âƒ£ ä½¿ç”¨åœºæ™¯

- æ¶ˆæ¯è·¯ç”±é€»è¾‘éœ€è¦æ ¹æ® **å¤šç»´åº¦å±æ€§** æ¥åŒ¹é…ï¼Œè€Œä¸ä»…ä»…æ˜¯å­—ç¬¦ä¸² routingKeyã€‚
- é€‚åˆæ—¥å¿—ç³»ç»Ÿã€æƒé™æ¶ˆæ¯åˆ†å‘ã€ç­–ç•¥è·¯ç”±ç­‰åœºæ™¯ã€‚
- ä¸é€‚åˆé«˜ååé‡æˆ–å¤§è§„æ¨¡æ¶ˆæ¯åœºæ™¯ï¼Œå› ä¸ºæ€§èƒ½æ¯” direct/topic/fanout å·®ã€‚

------

ğŸ’¡ **æ€»ç»“**ï¼š

1. Headers äº¤æ¢æœºä½¿ç”¨ **é”®å€¼å¯¹åŒ¹é…** è·¯ç”±æ¶ˆæ¯ï¼Œè€Œé routingKeyã€‚
2. `"x-match"` å†³å®š **all/any** åŒ¹é…ç­–ç•¥ã€‚
3. æ¶ˆè´¹è€…åœ¨ç»‘å®šé˜Ÿåˆ—æ—¶æŒ‡å®šè‡ªå·±å…³å¿ƒçš„å¤´ä¿¡æ¯ã€‚
4. Producer åœ¨å‘é€æ¶ˆæ¯æ—¶æºå¸¦å¤´ä¿¡æ¯ã€‚
5. æ€§èƒ½ä½äºå…¶ä»–äº¤æ¢æœºï¼Œä¸é€‚åˆå¤§è§„æ¨¡ä½¿ç”¨ã€‚

# å››ã€SpringBooté›†æˆRabbitMQ

## 1ï¸âƒ£ å¼•å…¥ä¾èµ–

Spring Boot å®˜æ–¹æä¾›äº† RabbitMQ çš„ Starterï¼Œåªéœ€è¦åœ¨ `pom.xml` ä¸­å¼•å…¥ï¼š

```
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

- **æ ¸å¿ƒä½œç”¨**ï¼šè‡ªåŠ¨å¸®ä½ å¯¼å…¥ RabbitMQ å®¢æˆ·ç«¯åº“å’Œ Spring AMQP å°è£…åº“ã€‚
- **æ³¨æ„**ï¼šä¸åŒç‰ˆæœ¬ Spring Boot å¯¹åº”çš„ RabbitMQ é…ç½®æ–¹å¼å¯èƒ½ç•¥æœ‰ä¸åŒï¼Œå°¤å…¶æ˜¯ Spring Boot 3.x å’Œ 2.x åœ¨é»˜è®¤åºåˆ—åŒ–ã€æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ç­‰ä¸Šæœ‰å·®å¼‚ã€‚

------

## 2ï¸âƒ£ é…ç½®å…³é”®å‚æ•°

åœ¨ `application.properties` æˆ– `application.yml` ä¸­é…ç½® RabbitMQ çš„åŸºç¡€å‚æ•°ï¼Œä¾‹å¦‚ï¼š

```java
spring.rabbitmq.host=localhost
spring.rabbitmq.port=5672
spring.rabbitmq.username=guest
spring.rabbitmq.password=guest
spring.rabbitmq.virtual-host=/
```

- æ‰€æœ‰é…ç½®é¡¹éƒ½ä»¥ `spring.rabbitmq` å¼€å¤´ã€‚
- ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€è¿æ¥æ± ã€æ¨¡æ¿ç­‰çš„é»˜è®¤è¡Œä¸ºéƒ½å¯ä»¥åœ¨è¿™é‡Œé…ç½®ã€‚
- è¯¦ç»†å‚æ•°å¯ä»¥å‚è€ƒ `RabbitProperties` ç±»æºç æˆ–å®˜æ–¹ GitHubï¼š[spring-amqp](https://github.com/spring-projects/spring-amqp?utm_source=chatgpt.com)ã€‚

------

## 3ï¸âƒ£ å£°æ˜ Exchangeã€Queue å’Œ Binding

Spring Boot ä¸­å£°æ˜è¿™äº›å¯¹è±¡ä¸éœ€è¦åƒåŸç”Ÿ API ä¸€æ ·æ‰‹åŠ¨è°ƒç”¨ `channel.exchangeDeclare` æˆ– `channel.queueDeclare`ã€‚
 å¯ä»¥é€šè¿‡ **Bean å£°æ˜** çš„æ–¹å¼è‡ªåŠ¨åˆ›å»ºï¼š

```java
@Bean
public Queue myQueue() {
    return new Queue("myQueue", true); // durable = true
}

@Bean
public DirectExchange myExchange() {
    return new DirectExchange("myExchange");
}

@Bean
public Binding binding(Queue myQueue, DirectExchange myExchange) {
    return BindingBuilder.bind(myQueue).to(myExchange).with("routingKey");
}
```

- **ç‰¹ç‚¹**ï¼š
  - Spring å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨æ£€æŸ¥ RabbitMQ ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºã€‚
  - å¯ä»¥ç»‘å®šå·²æœ‰çš„é˜Ÿåˆ—å’Œäº¤æ¢æœºï¼Œé€šè¿‡ `spring.rabbitmq.*` é…ç½®æˆ– Bean æ³¨å…¥æ§åˆ¶ã€‚

------

## 4ï¸âƒ£ ä½¿ç”¨ `RabbitTemplate` å‘é€æ¶ˆæ¯

Spring Boot ä¼šè‡ªåŠ¨åˆå§‹åŒ– `RabbitTemplate`ï¼Œå‘é€æ¶ˆæ¯ç›´æ¥ä½¿ç”¨ï¼š

```java
@Autowired
private RabbitTemplate rabbitTemplate;

public void sendMessage(String message) {
    rabbitTemplate.convertAndSend("myExchange", "routingKey", message);
}
```

- `RabbitTemplate` å°è£…äº† RabbitMQ çš„åŸç”Ÿ APIï¼ˆå¦‚ `basicPublish`ï¼‰ã€‚
- å¯ä»¥è®¾ç½®æ¶ˆæ¯ç¡®è®¤ã€è¶…æ—¶ã€åºåˆ—åŒ–ã€è½¬æ¢å™¨ç­‰å±æ€§ã€‚

------

## 5ï¸âƒ£ ä½¿ç”¨ `@RabbitListener` å£°æ˜æ¶ˆè´¹è€…

æ¶ˆè´¹è€…é€šè¿‡æ³¨è§£å£°æ˜ï¼š

```java
@RabbitListener(queues = "myQueue")
public void receiveMessage(String message) {
    System.out.println("Received: " + message);
}
```

- **è‡ªåŠ¨åº”ç­”**ï¼šé»˜è®¤ `ackMode = null`ï¼Œè¡¨ç¤ºè‡ªåŠ¨åº”ç­”ã€‚
- å¯ä»¥è‡ªå®šä¹‰ `ackMode` ä¸ºæ‰‹åŠ¨åº”ç­”ã€æ‰¹é‡åº”ç­”ç­‰ã€‚
- Spring Boot ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªæ¶ˆè´¹è€…åˆ›å»º Channelï¼Œå¹¶ç®¡ç†çº¿ç¨‹æ± ã€‚

------

## 6ï¸âƒ£ æ ¸å¿ƒè¦ç‚¹æ€»ç»“

1. Spring Boot å°è£…äº† RabbitMQ åŸç”Ÿ APIï¼Œå¼€å‘è€…æ— éœ€æ‰‹åŠ¨ç®¡ç† Connectionã€Channelã€‚
2. æ¶ˆæ¯å‘é€å’Œæ¶ˆè´¹çš„æ¨¡å‹è¢«ç»Ÿä¸€æˆ Spring AMQP çš„æ¨¡å‹ï¼ˆå¦‚ `RabbitTemplate`ã€`Message`ï¼‰ï¼Œå¹¶ä¸æ˜¯åŸç”Ÿ RabbitMQ å¯¹è±¡ï¼Œä½†æ¦‚å¿µä¸Šå¯¹åº”ã€‚
3. å¯¹äºå¤æ‚çš„ç¡®è®¤æœºåˆ¶ã€äº‹åŠ¡ã€QoSã€Headers äº¤æ¢æœºç­‰ï¼Œä¾ç„¶å»ºè®®ç†è§£åŸç”Ÿ RabbitMQ APIï¼Œè¿™æ ·åœ¨ Spring Boot å°è£…ä¹‹ä¸Šä½¿ç”¨æ—¶æ‰ä¸ä¼šè¸©å‘ã€‚
4. é€šè¿‡æ³¨è§£ã€Bean é…ç½®ï¼Œå¯ä»¥å¿«é€Ÿå®Œæˆ Exchangeã€Queueã€Binding çš„å£°æ˜å’Œæ¶ˆæ¯ç›‘å¬ã€‚
