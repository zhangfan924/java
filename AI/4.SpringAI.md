<h1 align="center">SpringAI</h1>

<p align="center">
  <img src="https://img.shields.io/badge/Markdown-æ¨¡æ¿-blue.svg" />
  <img src="https://img.shields.io/badge/Version-1.0-green.svg" />
</p>

# ğŸŒŸ 1. **Spring AIä»‹ç»**

## ğŸ¤– 1.1. **ä»€ä¹ˆæ˜¯Spring AI**

**Spring AIæ˜¯é¢å‘ Java å’Œ Spring ç”Ÿæ€çš„åŸç”Ÿç”Ÿæˆå¼äººå·¥æ™ºèƒ½æ¡†æ¶**ã€‚å®ƒä¸æ˜¯ç®€å•åœ°å°† Python ä¸­çš„ LangChain æˆ– LlamaIndex ç§»æ¤åˆ° Javaï¼Œè€Œæ˜¯ä¾æ® Spring çš„è®¾è®¡ç†å¿µâ€”â€”å¦‚ä¾èµ–æ³¨å…¥ã€POJOã€æ¨¡å—åŒ–å’Œå¯é…ç½®â€”â€”é‡æ„ç”Ÿæˆå¼ AI çš„å…¨æµç¨‹ã€‚**é€šè¿‡ Spring Boot çš„è‡ªåŠ¨è£…é…æœºåˆ¶ï¼Œå¼€å‘è€…å¯ä»¥åƒè°ƒç”¨æ•°æ®åº“æˆ– Web API ä¸€æ ·è½»æ¾åœ°æ¥å…¥èŠå¤©ã€åµŒå…¥ã€å›¾åƒç”Ÿæˆã€è¯­éŸ³å¤„ç†ç­‰ AI èƒ½åŠ›**ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ¯«ä¸è´¹åŠ›åœ°å°†ä¼ä¸šå†…éƒ¨æ•°æ®ä¸ AI æ¨¡å‹å…³è”èµ·æ¥ï¼ˆå¦‚åŒ RAG æ£€ç´¢å¢å¼ºç”Ÿæˆä¸­å¸¸ç”¨çš„æ•°æ®æ³¨å…¥æ–¹å¼ï¼‰ã€‚

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/8b697cdc95914482a80d529bfa582de2.jpg)

Spring AI å€¡å¯¼â€œä¸€å¥—æ¥å£ï¼Œå¤šç§å®ç°â€ï¼Œå¼€å‘è€…æ— é¡»ä¸ºä¸åŒ AI æä¾›å•†é€ä¸€é€‚é…ï¼Œè€Œæ˜¯å¯ä»¥é€šè¿‡ç»Ÿä¸€æŠ½è±¡å®ç°è½»æ¾åˆ‡æ¢ï¼Œæ¯”å¦‚ OpenAIã€Anthropicã€Bedrockã€Hugging Faceã€Vertex AIã€Ollama ç­‰æœåŠ¡ã€‚

- ğŸŒ **Spring AI å®˜ç½‘åœ°å€**: [spring.io/projects/spring-ai](https://spring.io/projects/spring-ai?utm_source=chatgpt.com)
- ğŸ“š **Spring AI æ–‡æ¡£åœ°å€**: [docs.spring.io/spring-ai/reference/index.html](https://docs.spring.io/spring-ai/reference/index.html?utm_source=chatgpt.com)
- ğŸ‡¨ğŸ‡³ **Spring AI ä¸­æ–‡æ–‡æ¡£åœ°å€**: [spring-ai.spring-doc.cn/docs/1.0.0/index.html](https://spring-ai.spring-doc.cn/docs/1.0.0/index.html?utm_source=chatgpt.com)

## ğŸš€ 1.2. **Spring AI ç‰¹ç‚¹**

Spring AI åŠŸèƒ½æ¨¡å—ä¸°å¯Œï¼Œæ¶µç›–AIåº”ç”¨å¼€å‘çš„å„ä¸ªç¯èŠ‚ï¼Œå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š

### âœ… 1. **å¤šä¾›åº”å•†æ¨¡å‹æ”¯æŒ**

æ”¯æŒä¸»æµçš„AIæ¨¡å‹æä¾›å•†ï¼Œä¾‹å¦‚ï¼šAnthropicã€OpenAIã€Microsoftã€Amazonã€Googleã€Ollama ç­‰æ¨¡å‹æœåŠ¡ã€‚é€šè¿‡è¿™äº›æ¨¡å‹å¯ä»¥å®ç°èŠå¤©ã€æ–‡æœ¬åµŒå…¥ã€æ–‡ç”Ÿå›¾ã€éŸ³é¢‘è½¬å½•ã€æ–‡æœ¬è½¬è¯­éŸ³ã€å†…å®¹å®¡æ ¸ç­‰å¤šç§èƒ½åŠ›ã€‚

### ğŸ”— 2. **ç»Ÿä¸€æŠ½è±¡API**

æä¾›å¦‚ `ChatClient`, `EmbeddingModel`, `ImageModel` ç­‰ç»Ÿä¸€æ¥å£ï¼Œæ— è®ºåˆ‡æ¢åˆ°å“ªå®¶ AI å¹³å°ï¼Œè°ƒç”¨æ–¹å¼ä¸€è‡´ï¼ŒåŒæ—¶æ”¯æŒåŒæ­¥ä¸æµå¼è°ƒç”¨ï¼Œä¹Ÿèƒ½å¤Ÿè®¿é—®æ¨¡å‹ç‰¹å®šåŠŸèƒ½ã€‚

### ğŸ§© 3. **Spring Booté›†æˆ**

ä»¥ Starter å’Œè‡ªåŠ¨è£…é…æ–¹å¼æ”¯æŒ AI æ¨¡å‹ã€å‘é‡æ•°æ®åº“ã€ETL å·¥å…·ç­‰ï¼Œå¼€å‘è€…å¯é€šè¿‡ Initializr å¿«é€Ÿä¸Šæ‰‹ã€‚

### ğŸ›¡ï¸ 4. **ç»“æ„åŒ–è¾“å‡ºä¸ç±»å‹å®‰å…¨**

æ¨¡å‹çš„å“åº”å¯è§£æå¹¶æ˜ å°„åˆ° Java POJOï¼Œä¿è¯åç»­å¤„ç†çš„ç±»å‹å®‰å…¨ä¸å¯ç»´æŠ¤æ€§ã€‚

### ğŸ” 5. **å‘é‡å­˜å‚¨ä¸RAG**

é›†æˆäº†ä¸»æµå‘é‡æ•°æ®åº“ï¼ˆPostgreSQL/pgvectorã€Pineconeã€Qdrantã€Redisã€Weaviate ç­‰ï¼‰åŠå…¶å…ƒæ•°æ®è¿‡æ»¤ï¼Œé€šè¿‡å†…ç½®çš„ ETL æ–‡æ¡£å¤„ç†æµç¨‹ï¼Œç»“åˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰å®ç°æ–‡æ¡£é—®ç­”å’ŒèŠå¤©æ£€ç´¢ã€‚

### ğŸ§³ 6. **Tool/Function Calling**

æ”¯æŒæ¨¡å‹å‘èµ·å‡½æ•°è°ƒç”¨ï¼ˆç±»ä¼¼ OpenAI Function Callingï¼‰ï¼Œå¯ä»¥æ³¨å†Œ Spring Bean ä½œä¸ºå¯è°ƒç”¨å·¥å…·ï¼Œä»è€Œè®¿é—®å®æ—¶ä¸šåŠ¡ç³»ç»Ÿæˆ–æ‰§è¡Œå¤–éƒ¨æ“ä½œã€‚

### ğŸ“Š 7. **å¯è§‚æµ‹æ€§ä¸è¯„ä¼°**

å†…å»ºå¯¹äº AI è°ƒç”¨çš„ç›‘æ§æŒ‡æ ‡ä¸æ—¥å¿—ã€æ¨¡å‹è¯„ä¼°å·¥å…·ï¼Œå¯ç”¨äºæ£€æµ‹å“åº”å‡†ç¡®æ€§ã€é˜²æ­¢â€œå¹»è§‰â€ã€‚

## ğŸ 1.3. **Spring AI å¿«é€Ÿä¸Šæ‰‹**

### ğŸ”§ 1.3.1. ç¯å¢ƒè¦æ±‚

Spring AI æ„å»ºåœ¨ Spring Boot 3.x ä¹‹ä¸Šï¼ŒSpring Boot 3.xç³»åˆ—æœ€ä½ Java è¦æ±‚ç‰ˆæœ¬æ˜¯ JDK17ï¼Œä¸æ”¯æŒ Java8/11/16 ç­‰ä½äº 17 çš„ç‰ˆæœ¬ï¼Œæ¨èä½¿ç”¨ Maven3.6 åŠä»¥ä¸Šç‰ˆæœ¬ã€‚

æˆ‘ä»¬åç»­ä½¿ç”¨ Spring AI æ—¶ï¼Œå¯¹åº”ç¯å¢ƒç‰ˆæœ¬å¦‚ä¸‹ï¼š

- SpringBoot 3.5.0ç‰ˆæœ¬
- JDK17ç‰ˆæœ¬
- Maven3.9.9ç‰ˆæœ¬

è¿™é‡Œåœ¨ Windows ä¸­ä¸‹è½½å¹¶å®‰è£… JDK17ã€‚ä½¿ç”¨å¦‚ä¸‹é“¾æ¥ä¸‹è½½ JDK 17 åè¿›è¡Œå®‰è£…ï¼Œè¿™é‡Œå®‰è£…åœ¨ D ç›˜â€œD:\Program Files\Java\jdk17\jdkâ€ä¸­ï¼Œä¸éœ€è¦é…ç½®ç¯å¢ƒå˜é‡ï¼Œåªéœ€è¦åœ¨ç›¸åº”çš„ SpringBoot é¡¹ç›®ä¸­è®¾ç½®ä½¿ç”¨çš„ JDK17 ç‰ˆæœ¬å³å¯ã€‚

ğŸ”— **JDK17ä¸‹è½½åœ°å€**: [Oracle JDK 17](https://www.oracle.com/cn/java/technologies/downloads/?utm_source=chatgpt.com#java17)

### ğŸ§‘â€ğŸ’» 1.3.2. Deepseekå¯¹è¯æ¡ˆä¾‹

ä¸‹é¢ä»¥ Spring AI ä¸­é€šè¿‡ä¸ Deepseek æ¨¡å‹å¯¹è¯ä¸ºä¾‹ï¼Œæ¼”ç¤º Spring AI ç›¸å…³é…ç½®ã€‚

**1) åˆ›å»º SpringBoot é¡¹ç›®ï¼Œå‘½åä¸º â€œSpringAIQuickStartâ€**

![img](img\90abdbf0743b4bb1830bc8d1b3981081.jpg) 

![df7ec41d1dfe4678a2d07e54d54ba6e0](img\df7ec41d1dfe4678a2d07e54d54ba6e0.jpg)

**2) é…ç½®é¡¹ç›®pom.xml**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIQuickStart</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIQuickStart</name>
    <description>SpringAIQuickStart</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-deepseek</artifactId>
        </dependency>
    </dependencies>


    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

**3) é…ç½®resources/application.properties**

```properties
spring.application.name=SpringAIQuickStart

server.port=8080

#é…ç½® Deepseekçš„åŸºç¡€URLã€å¯†é’¥å’Œä½¿ç”¨æ¨¡å‹
spring.ai.deepseek.base-url=https://api.deepseek.com
spring.ai.deepseek.api-key=sk-81bxxx62c6a821
spring.ai.deepseek.chat.options.model=deepseek-chat

# ä»‹äº0å’Œ2ä¹‹é—´ï¼Œ0è¡¨ç¤ºéšæœºæ€§æœ€å°ï¼Œ2è¡¨ç¤ºéšæœºæ€§æœ€å¤§ã€‚
spring.ai.deepseek.chat.options.temperature=0.8
```

**4) åˆ›å»ºcontrolleråŒ…ï¼Œå¹¶åˆ›å»ºChatController.javaæ–‡ä»¶**

```java
import org.springframework.ai.deepseek.DeepSeekChatModel;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/ai")
public class ChatController {
    @Autowired
    private DeepSeekChatModel chatModel;

    @GetMapping("/generate")
    public String generate(@RequestParam(value = "message", defaultValue = "ç»™æˆ‘è®²ä¸ªç¬‘è¯") String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š"+message);
        String result = chatModel.call(message);
        //æ¨¡å‹è¿”å›çš„å†…å®¹
        System.out.println(result);
        return result;
    }

}
```

**5) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥â€œhttp://localhost:8080/ai/generate?message=ä½ æ˜¯è°â€ï¼Œå¯ä»¥çœ‹åˆ°è¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š

```
æˆ‘æ˜¯DeepSeek Chatï¼Œç”±æ·±åº¦æ±‚ç´¢å…¬å¸ï¼ˆDeepSeekï¼‰å¼€å‘çš„æ™ºèƒ½AIåŠ©æ‰‹ï¼âœ¨ æˆ‘å¯ä»¥å¸®ä½ è§£ç­”é—®é¢˜ã€æä¾›å»ºè®®ã€é™ªä½ èŠå¤©ï¼Œè¿˜èƒ½å¤„ç†å„ç§æ–‡æœ¬ã€æ–‡æ¡£ç­‰å†…å®¹ã€‚æ— è®ºæ˜¯å­¦ä¹ ã€å·¥ä½œï¼Œè¿˜æ˜¯æ—¥å¸¸ç”Ÿæ´»ä¸­çš„ç–‘é—®ï¼Œéƒ½å¯ä»¥æ¥é—®æˆ‘å“¦ï¼ğŸ˜Š æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
```

ä¸ºäº†æ›´å¥½çš„å¯è§†åŒ–ä¸Deepseekæ¨¡å‹èŠå¤©ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨é¡¹ç›®çš„â€œresources/staticâ€ç›®å½•ä¸‹åˆ›å»ºâ€œindex.htmlâ€å®ç°èŠå¤©å¯è§†åŒ–ï¼Œindex.htmlå†…å®¹å¦‚ä¸‹ï¼š

```html
<!-- src/main/resources/static/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI èŠå¤©</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        textarea {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #response {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        /* Loading Spinner */
        #loading {
            display: none;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<h1>ä¸ AI èŠå¤©</h1>
<textarea id="userMessage" rows="4" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea><br><br>
<button onclick="sendMessage()">å‘é€</button>

<div id="loading"></div>
<div id="response"></div>

<script>
    function sendMessage() {
        const message = document.getElementById('userMessage').value;
        if (!message) {
            alert('è¯·è¾“å…¥æ¶ˆæ¯');
            return;
        }

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        document.getElementById('loading').style.display = 'block';

        fetch(`/ai/generate?message=${encodeURIComponent(message)}`)
            .then(response => response.text())
            .then(data => {
                // éšè—åŠ è½½åŠ¨ç”»
                document.getElementById('loading').style.display = 'none';
                document.getElementById('response').innerHTML = marked.parse(data);
            })
            .catch(error => {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                // éšè—åŠ è½½åŠ¨ç”»
                document.getElementById('loading').style.display = 'none';
            });
    }
</script>
</body>
</html>
```

é‡å¯Springbooté¡¹ç›®åï¼Œç›´æ¥è®¿é—®â€œhttp://localhost:8080â€å¯ä»¥ç›´æ¥è®¿é—®åˆ°resource/static/index.htmlè¿›è¡Œå¯è§†åŒ–ä¸æ¨¡å‹å¯¹è¯ï¼š

![c6e52536db324c8e806c52caeda3ff77](img\c6e52536db324c8e806c52caeda3ff77.jpg)

# ğŸŒŸ2. **Models æ¨¡å‹**

## ğŸ¤– 2.1. **Chat Models**

Spring AI çš„ Chat Model API æä¾›ä¸€å¥—ç»Ÿä¸€æ¥å£ï¼Œæ–¹ä¾¿å¼€å‘è€…åœ¨åº”ç”¨ä¸­é›†æˆ AI èŠå¤©å®ŒæˆåŠŸèƒ½ã€‚å®ƒæ”¯æŒåˆ‡æ¢ä¸åŒå‚å•†çš„èŠå¤©æ¨¡å‹ï¼Œå¦‚ OpenAIã€Anthropicã€Google Geminiã€Amazon Bedrockã€Ollama ç­‰ï¼Œå¤šæ•°å®ç°æ”¯æŒæµå¼è¾“å‡ºå’Œå‡½æ•°è°ƒç”¨ç­‰åŠŸèƒ½ã€‚

å¦‚ä¸‹ä»¥Deepseekæ¨¡å‹ä¸ºä¾‹ï¼Œæ¼”ç¤ºChatModelç›¸å…³åŠŸèƒ½ï¼Œæ›´å¤šæ¨¡å‹çš„ä½¿ç”¨æ–¹å¼å‚è€ƒï¼šhttps://docs.spring.io/spring-ai/reference/api/chatmodel.html

### âœ… **1. åŸºæœ¬èŠå¤©**

å‚è€ƒSpring AIå¿«é€Ÿä¸Šæ‰‹æ¡ˆä¾‹éƒ¨åˆ†ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```java
@GetMapping("/generate")
public String generate(@RequestParam(value = "message", defaultValue = "ç»™æˆ‘è®²ä¸ªç¬‘è¯") String message) {
    System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š"+message);
    String result = chatModel.call(message);
    //æ¨¡å‹è¿”å›çš„å†…å®¹
    System.out.println(result);
    return result;
}
```

### ğŸ”— **2. Streamæµå¼èŠå¤©**

Spring AIä¸­ä½¿ç”¨å¯¹è¯æ¨¡å‹æ—¶ï¼Œä¹Ÿæ”¯æŒæµå¼èŠå¤©ã€‚ä»¥Deepseekä¸ºä¾‹ï¼Œåœ¨â€œSpringAIQuickStartâ€é¡¹ç›®çš„â€œ/controller/ChatController.javaâ€ä»£ç ä¸­å‡†å¤‡å¦‚ä¸‹æ–¹æ³•ï¼š

```java
//æµå¼è·å–æ¨¡å‹è¿”å›çš„å†…å®¹ï¼Œè·å–è¿”å›çš„ ChatResponse å¯¹è±¡å†…å®¹
@GetMapping("/generateStream1")
public Flux<ChatResponse> generateStream1(@RequestParam(value = "message", defaultValue = "ç»™æˆ‘è®²ä¸ªç¬‘è¯") String message) {
    System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š"+message);
    var prompt = new Prompt(new UserMessage(message));
    return chatModel.stream(prompt);
}

//æµå¼è·å–æ¨¡å‹è¿”å›çš„å†…å®¹ï¼Œè·å–è¿”å›çš„ Text å†…å®¹
@GetMapping("/generateStream2")
public Flux<String> generateStream2(
        @RequestParam(value = "message", defaultValue = "ç»™æˆ‘è®²ä¸ªç¬‘è¯") String message,
        HttpServletResponse response) {
    // é¿å…è¿”å›ä¹±ç 
    response.setCharacterEncoding("UTF-8");

    System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š"+message);
    var prompt = new Prompt(new UserMessage(message));
    Flux<String> result = chatModel.stream(prompt)
            .map(chatResponse -> chatResponse.getResult().getOutput().getText());

    return result;
}
```

ä»¥ä¸Šä»£ç ä¸­æ³¨æ„å¦‚ä¸‹å‡ ç‚¹ï¼š

- â€œgenerateStream1â€æ–¹æ³•è¿”å›Fluxå¯¹è±¡ï¼ŒFluxè¡¨ç¤ºâ€œ0åˆ°Nä¸ªå…ƒç´ â€çš„å¼‚æ­¥æ•°æ®æµï¼Œç”¨äºæ¨¡å‹è¿”å›å¼‚æ­¥æ•°æ®çš„è¾“å‡ºã€‚
- ChatResponseå¯¹è±¡å†…å®¹å¦‚ä¸‹ï¼š

```json
[
{
	"result":{
		"metadata":{"finishReason":"","contentFilters":[],"empty":true},
		"output":{"messageType":"ASSISTANT","metadata":{"finishReason":"","id":"e392c615-9d42-4a8f-a819-1640cd3a7d68","role":"ASSISTANT","messageType":"ASSISTANT"},"toolCalls":[],"media":[],"prefix":null,"reasoningContent":null,"text":""}},
	"metadata":{"id":"e392c615-9d42-4a8f-a819-1640cd3a7d68","model":"deepseek-chat","rateLimit":{"requestsRemaining":0,"requestsReset":"PT0S","requestsLimit":0,"tokensReset":"PT0S","tokensRemaining":0,"tokensLimit":0},"usage":{"completionTokens":0,"promptTokens":0,"nativeUsage":{},"totalTokens":0},"promptMetadata":[],"empty":false},
	"results":[{"metadata":{"finishReason":"","contentFilters":[],"empty":true},"output":{"messageType":"ASSISTANT","metadata":{"finishReason":"","id":"e392c615-9d42-4a8f-a819-1640cd3a7d68","role":"ASSISTANT","messageType":"ASSISTANT"},"toolCalls":[],"media":[],"prefix":null,"reasoningContent":null,"text":""}}]
},
{
	"result":{"metadata":{"finishReason":"","contentFilters":[],"empty":true},"output":{"messageType":"ASSISTANT","metadata":{"finishReason":"","id":"e392c615-9d42-4a8f-a819-1640cd3a7d68","role":"ASSISTANT","messageType":"ASSISTANT"},"toolCalls":[],"media":[],"prefix":null,"reasoningContent":null,"text":"å¥½çš„"}},
	"metadata":{"id":"e392c615-9d42-4a8f-a819-1640cd3a7d68","model":"deepseek-chat","rateLimit":{"requestsRemaining":0,"requestsReset":"PT0S","requestsLimit":0,"tokensReset":"PT0S","tokensRemaining":0,"tokensLimit":0},"usage":{"completionTokens":0,"promptTokens":0,"nativeUsage":{},"totalTokens":0},"promptMetadata":[],"empty":false},
	"results":[{"metadata":{"finishReason":"","contentFilters":[],"empty":true},"output":{"messageType":"ASSISTANT","metadata":{"finishReason":"","id":"e392c615-9d42-4a8f-a819-1640cd3a7d68","role":"ASSISTANT","messageType":"ASSISTANT"},"toolCalls":[],"media":[],"prefix":null,"reasoningContent":null,"text":"å¥½çš„"}}]
},
....
]
```

- generateStream2æ–¹æ³•è¿”å›Fluxå¯¹è±¡ï¼Œè¿™é‡Œè·å–ChatResponseå¯¹è±¡ä¸­æ¨¡å‹è¿”å›çš„textå†…å®¹ã€‚
- å¯åŠ¨é¡¹ç›®åï¼Œå¯ä»¥åœ¨æµè§ˆå™¨è¾“å…¥â€œhttp://localhost:8080/ai/generateStream2?message=ä½ æ˜¯è°â€æŸ¥çœ‹æ¨¡å‹Streamæµå¼è¿”å›ç»“æœã€‚

### **ğŸ§© 3. è¿è¡Œæ—¶å‚æ•°è®¾ç½®**

Spring AI ä½¿ç”¨æ¨¡å‹æ—¶ï¼Œå¯ä»¥é€šè¿‡é¡¹ç›®ä¸­application.propertiesé…ç½®æ–‡ä»¶æ¥è®¾ç½®å…³äºæ¨¡å‹çš„å…¨å±€é»˜è®¤å‚æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```properties
spring.ai.openai.base-url: https://api.deepseek.com
spring.ai.openai.api-key: ${DEEPSEEK_API_KEY}
spring.ai.openai.chat.options.model: deepseek-chat
spring.ai.openai.chat.options.temperature: 0.7
... ...
```

å¯¹äºä¸€äº›è¯·æ±‚å¯èƒ½éœ€è¦ä¸åŒçš„è¡Œä¸ºå‚æ•°ï¼Œä¾‹å¦‚ï¼šæ¨¡å‹å›å¤æ›´é«˜çš„éšæœºæ€§ï¼Œè¿™æ—¶å€™å°±éœ€è¦åœ¨é¡¹ç›®è¿è¡Œæ—¶è¿›è¡Œå‚æ•°è¦†ç›–ï¼Œè¿™å°±æ˜¯Spring AIçš„è¿è¡Œæ—¶å‚æ•°è®¾ç½®ã€‚

åœ¨è¿è¡Œæ—¶è®¾ç½®å‚æ•°æ—¶ï¼Œå¯ä»¥åœ¨è°ƒç”¨æ¨¡å‹æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªpromptï¼Œå¹¶åµŒå…¥ä¸€ä¸ªæ–°çš„DeepSeekChatOptions æ¥è¦†ç›–å¯åŠ¨é…ç½®ã€‚

åœ¨â€œSpringAIQuickStartâ€é¡¹ç›®çš„â€œ/controller/ChatController.javaâ€ä»£ç ä¸­å‡†å¤‡å¦‚ä¸‹æ–¹æ³•ï¼š

```java
@GetMapping("/runtimeOptions")
public String runtimeOptions(
        @RequestParam(value = "message") String message,
        @RequestParam(value = "temp", required = false) Double temp
) {
    System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š"+message);

    Prompt prompt;
    if (temp != null) {
        // æ„å»ºå¸¦ temperature çš„ DeepSeekChatOptionsï¼Œè¦†ç›–é»˜è®¤ temperature
        var opts = DeepSeekChatOptions.builder()
                .temperature(temp)
                .build();
        prompt = new Prompt(message, opts);
        System.out.println("ä½¿ç”¨è¿è¡Œæ—¶è¦†ç›– temperature=" + temp);
    } else {
        // æ—  temperature ä¼ å…¥æ—¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
        prompt = new Prompt(message);
        System.out.println("ä½¿ç”¨é»˜è®¤ temperature");
    }

    ChatResponse resp = chatModel.call(prompt);
    String result = resp.getResult().getOutput().getText();
    System.out.println("æ¨¡å‹è¿”å›ï¼š"+ result);
    return result;
}
```

ä»¥ä¸Šä»£ç ç¼–å†™å¥½åï¼Œé‡å¯é¡¹ç›®ï¼Œå¯ä»¥ä¼ å…¥ä¸åŒçš„å‚æ•°ï¼š

â€œhttp://localhost:8080/ai/runtimeOptions?message=1åŠ 1ç­‰äºå‡ &temp=0.1â€ï¼Œæ¨¡å‹è¿”å›å¦‚ä¸‹ï¼š

![d2f9b1c8ba3247269dac8300abff5410](img\d2f9b1c8ba3247269dac8300abff5410.jpg)

â€œhttp://localhost:8080/ai/runtimeOptions?message=1åŠ 1ç­‰äºå‡ &temp=2â€ï¼Œæ¨¡å‹è¿”å›å¦‚ä¸‹ï¼š

![152cd492562042889a0c688618563d9c](img\152cd492562042889a0c688618563d9c.jpg)

## ğŸš€ 2.2. **Embedding Models**

### ğŸŒ **1. Embedding ä»‹ç»**

**Embedding** æ˜¯ä¸€ç§å°†æ–‡æœ¬ï¼ˆä¹Ÿå¯æ‰©å±•è‡³å›¾åƒã€è§†é¢‘ï¼‰è½¬æ¢æˆæ•°å­—å‘é‡çš„æŠ€æœ¯ï¼Œè¿™äº›å‘é‡è¡¨ç¤ºäº†è¾“å…¥å†…å®¹åœ¨è¯­ä¹‰ç©ºé—´ä¸­çš„ä½ç½®ï¼Œèƒ½å¤Ÿåæ˜ å®ƒä»¬ä¹‹é—´çš„ç›¸ä¼¼åº¦ã€‚**å‘é‡è·ç¦»è¶Šè¿‘ï¼Œå†…å®¹è¶Šç›¸ä¼¼**ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒEmbedding æŠ€æœ¯ä½¿å¾—è®¡ç®—æœºèƒ½å¤Ÿç†è§£å’Œæ¯”è¾ƒä¸åŒçš„å†…å®¹ã€‚

âš™ï¸ **Spring AI EmbeddingModel æ¥å£**

Spring AI æä¾›äº† **ç»Ÿä¸€ã€ç®€å•ã€å¯æ›¿æ¢çš„è®¿é—®æ–¹å¼**ã€‚é€šè¿‡å…¶ **EmbeddingModel** æ¥å£ï¼Œç”¨æˆ·å¯ä»¥è½»æ¾åˆ‡æ¢ä¸åŒçš„åº•å±‚æ¨¡å‹ï¼ˆå¦‚ **OpenAI**ã€**Titan**ã€**Azure**ã€**Ollama**ã€**æ™ºè°±**ç­‰ï¼‰ï¼Œåªéœ€è¦ä¿®æ”¹é…ç½®ï¼Œè€Œæ— éœ€ä¿®æ”¹è°ƒç”¨é€»è¾‘ã€‚

ğŸ“Œ **Embedding çš„åº”ç”¨åœºæ™¯**

- **ç›¸ä¼¼åº¦è®¡ç®— / è¯­ä¹‰æœç´¢**
   å°†æŸ¥è¯¢å’Œæ–‡æ¡£è½¬æ¢ä¸ºå‘é‡ï¼Œæ„å»ºå‘é‡æ•°æ®åº“è¿›è¡Œ**è¿‘é‚»æ£€ç´¢**ã€‚
- **èšç±»ä¸åˆ†ç±»**
   ä½¿ç”¨ä¼ ç»Ÿç®—æ³•å¯¹è½¬æ¢åçš„æ–‡æœ¬å‘é‡è¿›è¡Œ**èšç±»**æˆ–**åˆ†ç±»**ï¼Œå®ç°ç²¾å‡†çš„æ•°æ®åˆ†æã€‚
- **æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰**
   åˆ©ç”¨å‘é‡æœç´¢è·å–ç›¸å…³çŸ¥è¯†ï¼Œå†ç»“åˆ**ç”Ÿæˆæ¨¡å‹**æä¾›æ™ºèƒ½å›ç­”ã€‚
- **æ¨èç³»ç»Ÿ**
   æ”¯æŒ**é—®ç­”æ¨è**ã€**å†…å®¹æ¨è**ç­‰å¤šç§ä¸ªæ€§åŒ–æ¨èåœºæ™¯ã€‚
- **å¼‚å¸¸æ£€æµ‹**
   å®ç°**è¯­ä¹‰å¼‚å¸¸å†…å®¹æ£€æµ‹**ï¼Œå¸®åŠ©è¯†åˆ«ä¸æ­£å¸¸æˆ–ä¸ç›¸å…³çš„å†…å®¹ã€‚

### ğŸ“Œ **2. æ™ºæ™®AI Embedding ä½¿ç”¨ç¤ºä¾‹**

#### ğŸ“Š 2.1 **æ™ºæ™®AI ä»‹ç»**

**æ™ºæ™®AIï¼ˆåŒ—äº¬æ™ºè°±åç« ç§‘æŠ€æœ‰é™å…¬å¸ï¼‰** æ˜¯ç”±æ¸…åå¤§å­¦çŸ¥è¯†å·¥ç¨‹å®éªŒå®¤æˆæœè½¬åŒ–æˆç«‹çš„å¤§æ¨¡å‹ç ”å‘å…¬å¸ï¼Œä¸“æ³¨äºæ„å»ºâ€œè®¤çŸ¥æ™ºèƒ½â€ä½“ç³»ã€‚å…¶äº§å“çº¿åŒ…æ‹¬ï¼š

- **æ–‡å­—å¯¹è¯æ¨¡å‹**ï¼ˆå¦‚ **ChatGLM**ã€**GLM-4**ï¼‰
- **å›¾åƒåŠè§†é¢‘ç†è§£æ¨¡å‹**ï¼ˆå¦‚ **GLM-4V-Plus**ï¼‰
- **æ–‡æœ¬è§†é¢‘ç”Ÿæˆæ¨¡å‹**ï¼ˆå¦‚ **CogVideoX** / â€œæ¸…å½±â€ï¼‰

æ™ºæ™®AI çš„äº§å“è¦†ç›– **æ–‡å­—ã€å›¾åƒã€éŸ³è§†é¢‘ç­‰å¤šç§æ¨¡æ€**ï¼Œå¹¿æ³›åº”ç”¨äºå¤šä¸ªé¢†åŸŸï¼Œæä¾›å¼ºå¤§çš„AIæœåŠ¡ã€‚

#### **ğŸŒ 2.2 æ™ºæ™®AIç›¸å…³ç½‘ç«™**

åœ¨ä½¿ç”¨æ™ºæ™®AIæœåŠ¡æ—¶ï¼Œéœ€åœ¨ä»¥ä¸‹ç½‘ç«™è¿›è¡Œæ³¨å†Œå’Œå……å€¼ï¼š

- å®˜ç½‘åœ°å€ï¼š[æ™ºæ™®AIå®˜ç½‘](https://open.bigmodel.cn/?utm_source=chatgpt.com)
- API Keyåœ°å€ï¼š[æ™ºæ™®AI Key](https://open.bigmodel.cn/usercenter/proj-mgmt/apikeys?utm_source=chatgpt.com)
- å……å€¼åœ°å€ï¼š[æ™ºæ™®AIå……å€¼](https://open.bigmodel.cn/finance/pay?utm_source=chatgpt.com)
- æ¨¡å‹è´¹ç”¨æŸ¥è¯¢ï¼š[æ™ºæ™®AIæ¨¡å‹è´¹ç”¨](https://www.bigmodel.cn/pricing?utm_source=chatgpt.com)
   æä¾›å¤šç§æ¨¡å‹ä»·æ ¼ï¼ŒåŒ…æ‹¬å…è´¹æ¨¡å‹ã€‚
- æ–‡æ¡£åœ°å€ï¼š[æ™ºæ™®AIæ–‡æ¡£](https://open.bigmodel.cn/dev/howuse/introduction?utm_source=chatgpt.com)
   æä¾›è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—ä¸APIæ–‡æ¡£ã€‚

#### ğŸ§‘â€ğŸ’» 2.3 **Spring AI ä¸­ä½¿ç”¨æ™ºæ™®AI Embedding**

åœ¨Spring AI ä¸­ä½¿ç”¨Embeddingæ—¶ï¼Œéœ€è¦å¯¹åº”çš„AIæ¨¡å‹æ”¯æŒEmbeddingï¼Œ**deepseekä¸­ç›®å‰æ²¡æœ‰Embeddingæ¨¡å‹**ï¼Œè¿™é‡Œ**ä½¿ç”¨æ™ºæ™®AIçš„â€œembedding-2â€æ¨¡å‹æ¥æ¼”ç¤ºEmbeddingä½¿ç”¨**ã€‚ä»¥ä¸‹ç¤ºä¾‹ä¸­æ¼”ç¤ºå¦‚ä½•åœ¨SpringBootä¸­é…ç½®æ™ºæ™®AIä½œä¸ºEmbeddingæ¨¡å‹ï¼Œå¹¶å¯¹æ–‡æœ¬æ•°æ®å‘é‡åŒ–æ“ä½œã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå‘½åä¸ºâ€œSpringAIEmbeddingâ€**

![1d6e4d5db6974578b7fa388154760720](img\1d6e4d5db6974578b7fa388154760720.jpg)

![0bf6040610654509a2711c07eee744b0](img\0bf6040610654509a2711c07eee744b0.jpg)

**2) é…ç½®é¡¹ç›®pom.xml**

pom.xmlå†…å®¹å¦‚ä¸‹ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIEmbedding</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIEmbedding</name>
    <description>SpringAIEmbedding</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-zhipuai</artifactId>
        </dependency>

        <!-- spring-ai-client-chat ä¸­åŒ…æ‹¬ TokenTextSplitterã€TextReaderã€Document ç­‰å·¥å…· -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-client-chat</artifactId>
            <version>1.0.0</version>
        </dependency>

    </dependencies>

    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

ç‰¹åˆ«æ³¨æ„ï¼šéœ€è¦åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®çš„pom.xmlä¸­å¯¼å…¥â€œspring-ai-starter-model-zhipuaiâ€ä¾èµ–ã€‚â€œspring-ai-client-chatâ€ä¾èµ–åŒ…éœ€è¦å¯¹æ–‡æ¡£è¿›è¡Œåˆ‡åˆ†å¤„ç†æ—¶æ‰€ä½¿ç”¨çš„ä¾èµ–åŒ…ã€‚

**3) é…ç½®resources/application.properties**

```properties
spring.application.name=SpringAIEmbedding

server.port=8080

#ä½¿ç”¨ æ™ºæ™®AI Embedding æ¨¡å‹ï¼Œéœ€è¦åœ¨pom.xmlä¸­å¼•å…¥å¯¹åº”ä¾èµ–
spring.ai.zhipuai.api-key=d...GA4
spring.ai.zhipuai.base-url=https://open.bigmodel.cn/api/paas
spring.ai.zhipuai.embedding.options.model=embedding-2

#ä½¿ç”¨ æ™ºæ™®AI Chat æ¨¡å‹ï¼Œéœ€è¦åœ¨pom.xmlä¸­å¼•å…¥å¯¹åº”ä¾èµ–
spring.ai.zhipuai.chat.options.model=GLM-4-Flash
```

**4) åˆ›å»ºControlleråŒ…å¹¶åˆ›å»ºEmbeddingControllerç±»**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®ä¸­åˆ›å»ºâ€œcontrollerâ€åŒ…ï¼Œåœ¨è¯¥åŒ…ä¸‹ç¼–å†™â€œEmbeddingController.javaâ€ç±»ï¼Œè¯¥ç±»ä¸­å®ç°embedæ–¹æ³•æ¥å°†ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹é€šè¿‡æ™ºæ™®AI Embeddingè¿›è¡Œå‘é‡åŒ–ã€‚

```java
import com.example.springaiembedding.service.EmbeddingService;
import org.springframework.ai.embedding.EmbeddingModel;
import org.springframework.ai.embedding.EmbeddingResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.Map;

@RestController
@RequestMapping("/ai")
public class EmbeddingController {
    @Autowired
    private EmbeddingModel embeddingModel;

    //æµ‹è¯• embedding
    @GetMapping("/embedding")
    public Map embed(@RequestParam(value = "message", defaultValue = "ç»™æˆ‘è®²ä¸ªç¬‘è¯") String message) {
        // è°ƒç”¨ embed æ–¹æ³•ï¼Œå°†æ–‡æœ¬è½¬æ¢æˆå‘é‡ï¼Œé»˜è®¤å‘é‡ç»´åº¦ä¸º 1024
        float[] vector = embeddingModel.embed(message);

        return Map.of(
                "message", message,
                "vector", vector
        );
    }
}
```

ä»¥ä¸Šä»£ç ä¸­å¯¹ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹å‘é‡åŒ–ï¼Œåªéœ€è¦è°ƒç”¨â€œembeddingModel.embed(æ–‡æœ¬)â€å³å¯ï¼Œå¦‚æœå¯¹å¤šæ¡æ–‡æœ¬è¿›è¡Œå‘é‡åŒ–è½¬æ¢ï¼Œå¯ä»¥è°ƒç”¨â€œembeddingModel.embed(List<T>)â€æ“ä½œã€‚

**5) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥â€œhttp://localhost:8080/ai/embedding?message=ä»Šå¤©å¤©æ°”å¾ˆå¥½â€ï¼Œå¯ä»¥çœ‹åˆ°è¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š

```json
{"message":"ä»Šå¤©å¤©æ°”å¾ˆå¥½","vector":[-0.07260562,0.005600141,-0.0378431,-0.034070812,-0.018191425,-0.0034634115,-0.029991228,0.038196057,0.025889568,0.001633238,-0.016376244,-0.040188957,-0.017353531,0.047503855,-0.018386343,0.014544255,-0.021725116,0.002996758,-0.011191875,0.011162163,-0.019570969,0.017660921,0.03319585,-0.065318294,-2.5312623E-4,-0.067810364,0.013731177,0.008502983,0.02763537,-0.009782783,0.011306662,0.005104383,0.00480137,0.04124188,-0.012842868,0.039708782,-0.02221145...]}
```

å¯ä»¥çœ‹åˆ°é€šè¿‡æ™ºæ™®AIçš„â€œembedding-2â€æ¨¡å‹å°†ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬è¿›è¡Œè¿›è¡Œäº†å‘é‡åŒ–ã€‚â€Œâ€Œâ€Œâ€Œ

### ğŸ§³ **3. Embeddingæ¡ˆä¾‹1ï¼šæŸ¥æ‰¾ç›¸ä¼¼æ–‡æœ¬**

æœ¬æ¡ˆä¾‹ä¸­å®ç°é€šè¿‡æ™ºæ™®AI çš„Embeddingæ¨¡å‹å®ç°å¯¹ç”¨æˆ·è¾“å…¥æ–‡æœ¬çš„å‘é‡åŒ–ï¼Œç„¶åé€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦ä¸å·²æœ‰çš„æœ¬åœ°çŸ¥è¯†å†…å®¹è¿›è¡ŒåŒ¹é…ï¼ŒæŸ¥æ‰¾å¹¶è¾“å‡ºä¸ç”¨æˆ·è¾“å…¥ç›¸ä¼¼çš„æ–‡æœ¬å†…å®¹ã€‚

ğŸ“Œ **åˆ›å»ºServiceè¿›è¡Œæ–‡æœ¬å‘é‡åŒ–å’Œç›¸ä¼¼åº¦è®¡ç®—**

åœ¨Spring Bootä¸­åˆ›å»ºä¸€ä¸ªServiceï¼Œå½“æœåŠ¡å¯åŠ¨æ—¶ï¼Œæ‰¹é‡å°†æ‰€æœ‰æœ¬åœ°çŸ¥è¯†é€šè¿‡`embed(List<T>)`æ–¹æ³•è½¬æ¢ä¸ºå‘é‡ã€‚

åœ¨Serviceä¸­å®šä¹‰`queryBestMatch`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ï¼š

- **æ–‡æœ¬å‘é‡åŒ–**ï¼šé¦–å…ˆå°†ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬é€šè¿‡Embeddingæ¨¡å‹è½¬æ¢ä¸ºå‘é‡ã€‚
- **ç›¸ä¼¼åº¦è®¡ç®—**ï¼šç„¶åé€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œå°†è¯¥å‘é‡ä¸æœ¬åœ°çŸ¥è¯†åº“ä¸­çš„å‘é‡è¿›è¡Œè®¡ç®—ã€‚
- **è¿”å›æœ€ç›¸ä¼¼å†…å®¹**ï¼šæ ¹æ®ç›¸ä¼¼åº¦æ‰¾åˆ°æœ€åŒ¹é…çš„æœ¬åœ°çŸ¥è¯†å†…å®¹ã€‚

ğŸ§‘â€ğŸ’» **åˆ›å»ºControlleræš´éœ²æ¥å£ä¾›ç”¨æˆ·è®¿é—®**

åœ¨Spring Bootä¸­åˆ›å»ºControllerï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®è¯¥Controllerä¸­çš„`similarity`æ–¹æ³•ã€‚

`similarity`æ–¹æ³•è°ƒç”¨Serviceä¸­çš„`queryBestMatch`æ–¹æ³•ï¼Œè¿”å›ä¸ç”¨æˆ·è¾“å…¥æœ€ç›¸ä¼¼çš„æœ¬åœ°çŸ¥è¯†å†…å®¹ã€‚

#### ğŸ“Š **3.1 ä½™å¼¦ç›¸ä¼¼åº¦**

ä½™å¼¦ç›¸ä¼¼åº¦æ˜¯ä¸€ç§è¡¡é‡ä¸¤ä¸ªå‘é‡æ–¹å‘ç›¸ä¼¼ç¨‹åº¦çš„åº¦é‡æ–¹æ³•ï¼Œé€šè¿‡è®¡ç®—å®ƒä»¬å¤¹è§’çš„ä½™å¼¦å€¼æ¥è¯„ä¼°ç›¸ä¼¼æ€§ï¼Œå¹¿æ³›åº”ç”¨äºæ–‡æœ¬åˆ†æã€æ•°æ®æŒ–æ˜ç­‰é¢†åŸŸâ€Œã€‚

ä½™å¼¦ç›¸ä¼¼åº¦çš„æ•°å­¦æœ¬è´¨æ˜¯å‘é‡ç©ºé—´æ¨¡å‹ä¸­å¤¹è§’çš„ä½™å¼¦å€¼ï¼Œè®¡ç®—å…¬å¼ä¸ºä¸¤ä¸ªå‘é‡çš„ç‚¹ç§¯é™¤ä»¥å®ƒä»¬çš„æ¨¡é•¿ä¹˜ç§¯ã€‚å¯¹äºnç»´å‘é‡Aå’ŒBï¼Œå…¬å¼å¯è¡¨ç¤ºä¸ºï¼š

![9b83011f6cc046719545e3737b1a471e](img\9b83011f6cc046719545e3737b1a471e.jpg)

å…¶å€¼èŒƒå›´åœ¨-1åˆ°1ä¹‹é—´ï¼Œ1è¡¨ç¤ºå®Œå…¨ç›¸åŒï¼Œ-1è¡¨ç¤ºå®Œå…¨ç›¸åï¼Œ0è¡¨ç¤ºæ— å…³ã€‚

ä½™å¼¦ç›¸ä¼¼åº¦å…¸å‹åº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š

- æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—â€Œï¼šå°†æ–‡æ¡£è½¬åŒ–ä¸ºè¯é¢‘å‘é‡åï¼Œé€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦æ¯”è¾ƒå†…å®¹ç›¸ä¼¼æ€§ã€‚â€Œâ€Œ
- èšç±»åˆ†æâ€Œï¼šè¡¡é‡æ•°æ®ç‚¹åœ¨é«˜ç»´ç©ºé—´ä¸­çš„åˆ†å¸ƒæ–¹å‘æ˜¯å¦ç›¸è¿‘ï¼Œå¸¸ç”¨äºæ¨èç³»ç»Ÿæˆ–å¼‚å¸¸æ£€æµ‹ã€‚

#### ğŸ§‘â€ğŸ’» **3.2 æ¡ˆä¾‹å®ç°**

**1) å‡†å¤‡ServiceåŠå¯¹åº”æ–¹æ³•**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®ä¸­åˆ›å»ºâ€œserviceâ€åŒ…ï¼Œå¹¶åœ¨è¯¥åŒ…ä¸­åˆ›å»ºâ€œEmbeddingService.javaâ€ç±»ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š

```java
import org.springframework.ai.embedding.EmbeddingModel;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class EmbeddingService {

    private EmbeddingModel embeddingModel;

    private final List<float[]> docVectors;

    // 1. å‡†å¤‡çŸ¥è¯†åº“æ–‡æœ¬å†…å®¹
    private final List<String> docs = List.of(
            "ç¾é£Ÿéå¸¸ç¾å‘³ï¼ŒæœåŠ¡å‘˜ä¹Ÿå¾ˆå‹å¥½ã€‚",
            "è¿™éƒ¨ç”µå½±æ—¢åˆºæ¿€åˆä»¤äººå…´å¥‹ã€‚",
            "é˜…è¯»ä¹¦ç±æ˜¯æ‰©å±•çŸ¥è¯†çš„å¥½æ–¹æ³•ã€‚"
    );

    public EmbeddingService(EmbeddingModel embeddingModel) {
        this.embeddingModel = embeddingModel;
        // 2. å¯åŠ¨æ—¶ï¼Œå°†æ‰€æœ‰æ–‡æ¡£å‘é‡åŒ–
        this.docVectors = this.embeddingModel.embed(docs);
    }

    /**
     * è¾“å…¥ç”¨æˆ·æŸ¥è¯¢ï¼Œè¿”å›æœ€ç›¸ä¼¼æ–‡æ¡£çš„ç´¢å¼• ï¼ˆä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ï¼‰
     * @param query ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢æ–‡æœ¬
     * @return æœ€ç›¸ä¼¼çš„çŸ¥è¯†åº“æ–‡æœ¬
     */
    public String queryBestMatch(String query) {
        //å°†ç”¨æˆ·çš„è¾“å…¥é€šè¿‡EmbeddingModelè½¬æ¢æˆå‘é‡
        float[] queryVec = embeddingModel.embed(query);

        int bestIdx = -1; //è®°å½•ç›®å‰æœ€åŒ¹é…æ–‡æ¡£åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ä½ç½®
        double bestSim = -1; //è®°å½•ç›®å‰çš„æœ€é«˜ç›¸ä¼¼åº¦

        // éå†æ‰€æœ‰æ–‡æ¡£å¯¹åº”çš„å‘é‡ï¼Œè®¡ç®—ä¸æŸ¥è¯¢å‘é‡çš„ç›¸ä¼¼åº¦
        for (int i = 0; i < docVectors.size(); i++) {
            //è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
            double sim = cosineSimilarity(queryVec, docVectors.get(i));
            if (sim > bestSim) {
                bestSim = sim;
                bestIdx = i;
            }
        }
        return docs.get(bestIdx);
    }

    // ä½™å¼¦ç›¸ä¼¼åº¦å®ç°
    // è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œæ•°å€¼èŒƒå›´åœ¨ [-1, 1] ä¹‹é—´
    // ç›¸ä¼¼åº¦è¶Šé«˜ï¼Œè¶Šæ¥è¿‘1ï¼Œè¶Šæ¥è¿‘0ï¼Œè¶Šä¸ç›¸ä¼¼
    private double cosineSimilarity(float[] a, float[] b) {
        double dot = 0, na = 0, nb = 0;
        for (int i = 0; i < a.length; i++) {
            dot += a[i] * b[i];
            na += a[i] * a[i];
            nb += b[i] * b[i];
        }
        return dot / (Math.sqrt(na) * Math.sqrt(nb));
    }

}
```

**2) å‡†å¤‡ControlleråŠå¯¹åº”æ–¹æ³•**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®ä¸­çš„â€œcontroller/EmbeddingController.javaâ€ç±»ä¸­æ³¨å…¥å¦‚ä¸‹ä¾èµ–å’Œå¢åŠ å¦‚ä¸‹æ–¹æ³•ï¼š

```java
@Autowired
private EmbeddingService service;

//æ–‡æœ¬ç›¸ä¼¼æ£€æµ‹
@GetMapping("/similarity")
public Map<String, String> similarity(@RequestParam("query") String query) {
    String ans = service.queryBestMatch(query);
    return Map.of("query", query, "answer", ans);
}
```

**3) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨Spring Booté¡¹ç›®ï¼Œæµè§ˆå™¨ä¸­è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œç›¸ä¼¼æ–‡æœ¬æŸ¥æ‰¾ï¼š

```json
#è¾“å…¥http://localhost:8080/ai/similarity?query=ç¾é£Ÿ
{
  "query": "ç¾é£Ÿ",
  "answer": "ç¾é£Ÿéå¸¸ç¾å‘³ï¼ŒæœåŠ¡å‘˜ä¹Ÿå¾ˆå‹å¥½ã€‚"
}

#è¾“å…¥http://localhost:8080/ai/similarity?query=ç”µå½±
{
  "query": "ç”µå½±",
  "answer": "è¿™éƒ¨ç”µå½±æ—¢åˆºæ¿€åˆä»¤äººå…´å¥‹ã€‚"
}

#è¾“å…¥http://localhost:8080/ai/similarity?query=ä¹¦ç±
{
  "query": "ä¹¦ç±",
  "answer": "é˜…è¯»ä¹¦ç±æ˜¯æ‰©å±•çŸ¥è¯†çš„å¥½æ–¹æ³•ã€‚"
}
```

æµ‹è¯•ç»“æœï¼š

![cee3809c973144968e8ee54f092a964d](img\cee3809c973144968e8ee54f092a964d.jpg)

### ğŸš€**4. Embeddingæ¡ˆä¾‹2ï¼šRAGæœ¬åœ°çŸ¥è¯†åº“æ£€ç´¢**

#### ğŸ”— **4.1. ä»€ä¹ˆæ˜¯RAG**

æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRetrieval-Augmented Generationï¼Œç®€ç§° RAGï¼‰æ˜¯ä¸€ç§**å°†å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ä¸å¤–éƒ¨çŸ¥è¯†æºç›¸ç»“åˆçš„äººå·¥æ™ºèƒ½æŠ€æœ¯**ã€‚ğŸ“Œ**é€šè¿‡åœ¨ç”Ÿæˆå“åº”å‰æ£€ç´¢ç›¸å…³ä¿¡æ¯ğŸ“Œï¼ŒRAG èƒ½å¤Ÿä¸ºæ¨¡å‹æä¾›æœ€æ–°ä¸”ç‰¹å®šé¢†åŸŸçš„çŸ¥è¯†ï¼Œä»è€Œæé«˜å›ç­”çš„å‡†ç¡®æ€§å’Œç›¸å…³æ€§**ã€‚

RAGçš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

![f34fd0dfb4744d449ed04a12f72a2cf0](img\f34fd0dfb4744d449ed04a12f72a2cf0.jpg)

##### ğŸ§‘â€ğŸ’» 1 **æ–‡æ¡£è§£æä¸åµŒå…¥æ¨¡å‹ç´¢å¼•**

æˆ‘ä»¬æ‹¥æœ‰è‡ªå·±çš„æ–‡æ¡£èµ„æºï¼ŒåŒ…æ‹¬URLã€PDFã€TXTæ–‡ä»¶ã€æ•°æ®åº“ç­‰ã€‚è¿™äº›æ–‡æ¡£ä½œä¸ºç”¨æˆ·çš„æœ¬åœ°çŸ¥è¯†åº“ï¼Œé¦–å…ˆéœ€è¦ç»è¿‡è§£æå¤„ç†ï¼Œå°†æ–‡æ¡£å†…å®¹æ‹†è§£ä¸º**chunks**ï¼ˆå°å—ï¼‰ï¼Œæ¯ä¸ª**chunk**ä»£è¡¨æ–‡æ¡£ä¸­çš„ä¸€éƒ¨åˆ†ä¿¡æ¯ã€‚

æ¥ä¸‹æ¥ï¼Œè¿™äº›æ–‡æœ¬ä¿¡æ¯ä¼šé€šè¿‡**Embedding Model**ï¼ˆåµŒå…¥æ¨¡å‹ï¼‰è¿›è¡Œè½¬æ¢ï¼Œè½¬æ¢æˆ**å‘é‡ï¼ˆVectorï¼‰**ï¼Œå³æ•°å­—è¡¨ç¤ºã€‚å‘é‡åŒ–åçš„æ–‡æœ¬å°†ä»¥å‘é‡çš„å½¢å¼ä¿å­˜åœ¨**å‘é‡æ•°æ®åº“**ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º**Indexing**ï¼ˆç´¢å¼•ï¼‰ã€‚

##### ğŸŒ 2  **é—®é¢˜å¤„ç†ä¸æ£€ç´¢**

å½“ç”¨æˆ·æå‡ºé—®é¢˜æ—¶ï¼Œé¦–å…ˆé€šè¿‡ç›¸åŒçš„**Embedding Model**å°†é—®é¢˜æ–‡æœ¬è½¬æ¢æˆå‘é‡ã€‚ç„¶åï¼Œä½¿ç”¨è¯¥å‘é‡å»**å‘é‡æ•°æ®åº“**ä¸­è¿›è¡Œæ£€ç´¢ï¼ˆRetrieveï¼‰ã€‚æ£€ç´¢çš„è¿‡ç¨‹å°±æ˜¯åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°ä¸é—®é¢˜æœ€ç›¸å…³çš„æ–‡æ¡£å†…å®¹ã€‚

##### ğŸ§© 3 ç»“åˆä¸Šä¸‹æ–‡ä¸ç”Ÿæˆå›ç­”

å°†æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£å†…å®¹å’Œé—®é¢˜ä¸€èµ·æ‰“åŒ…ï¼Œç»“åˆé€‚å½“çš„**æç¤ºè¯ï¼ˆPromptï¼‰**ï¼Œä¼ é€’ç»™å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚GPTï¼‰ã€‚è¿™æ ·ï¼Œå¤§æ¨¡å‹å°±èƒ½è·å¾—å¦‚ä½•å›ç­”è¯¥é—®é¢˜çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ç»“åˆå¤§æ¨¡å‹å¼ºå¤§çš„æ¨ç†èƒ½åŠ›ï¼Œç”Ÿæˆè¿è´¯ä¸”ç›¸å…³çš„ç­”æ¡ˆï¼Œæœ€ç»ˆè¿”å›ç»™ç”¨æˆ·ã€‚

#### ğŸ“Š**4.2. æ¡ˆä¾‹å®ç°**

å¦‚ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„RAG(Retrieval-Augmented Generation)æ¡ˆä¾‹ï¼Œè¯¥æ¡ˆä¾‹ä¸­ä½¿ç”¨Spring AI ã€æ™ºæ™®AI Embeddingã€æ™ºæ™® Chat Modelæ¥å®Œæˆã€‚

è¯¥æ¡ˆä¾‹å®ç°æ€è·¯å¦‚ä¸‹:

1. **åŠ è½½æœ¬åœ°çŸ¥è¯†åº“**

   - **æœ¬åœ°çŸ¥è¯†åº“æ–‡ä»¶**å­˜æ”¾åœ¨é¡¹ç›®çš„`resources`èµ„æºç›®å½•ä¸­ã€‚

   - é€šè¿‡`ClassPathResource`åŠ è½½è¿™äº›æ–‡ä»¶åˆ°é¡¹ç›®ä¸­ã€‚

2. **æ–‡æ¡£æ‹†åˆ†ä¸å‘é‡åŒ–å¤„ç†**

   - å°†æ–‡æ¡£å†…å®¹æŒ‰ç…§**æŒ‡å®šçš„ç¬¦å·**è¿›è¡Œæ‹†åˆ†ï¼Œåˆ†æˆå¤šä¸ª**ç‰‡æ®µ**ï¼ˆchunksï¼‰ã€‚

   - ä½¿ç”¨**æ™ºæ™®AI Embedding**æ¨¡å‹å¯¹è¿™äº›ç‰‡æ®µè¿›è¡Œ**å‘é‡åŒ–å¤„ç†**ã€‚

   - å‘é‡åŒ–åçš„å†…å®¹ä¿å­˜åœ¨**å†…å­˜ä¸­**ï¼Œä»¥ä¾¿åç»­æ£€ç´¢ä½¿ç”¨ã€‚

3. **ç”¨æˆ·é—®é¢˜çš„å‘é‡åŒ–ä¸ç›¸ä¼¼åº¦æ£€ç´¢**

   - å½“ç”¨æˆ·è¾“å…¥é—®é¢˜æ—¶ï¼Œé¦–å…ˆé€šè¿‡**æ™ºæ™®AI Embedding**å°†é—®é¢˜è¿›è¡Œå‘é‡åŒ–ã€‚

   - ç„¶ååœ¨å†…å­˜ä¸­æ‰¾å‡ºä¸é—®é¢˜æœ€ç›¸å…³çš„**Top 2**ä¸ªæœ¬åœ°çŸ¥è¯†å†…å®¹ã€‚

4. **ç”Ÿæˆå›ç­”**

   - å°†æŸ¥æ‰¾åˆ°çš„ä¸ç”¨æˆ·é—®é¢˜æœ€ç›¸å…³çš„**Top 2**ä¸ªæœ¬åœ°å†…å®¹å’Œç”¨æˆ·çš„**é—®é¢˜**ä¸€èµ·ä½œä¸º**prompt**ä¼ é€’ç»™**æ™ºæ™®AI Chatæ¨¡å‹**ã€‚

   - **æ™ºæ™®AI Chatæ¨¡å‹**ç»“åˆè¿™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç”Ÿæˆç»Ÿä¸€å›å¤ï¼Œç»™ç”¨æˆ·è¿”å›æœ€ç»ˆç­”æ¡ˆã€‚

ä¸‹é¢æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®ä¸­å®ç°RAGæœ¬åœ°çŸ¥è¯†åº“ä¿¡æ¯æ£€ç´¢ã€‚

**1) å‡†å¤‡æ™ºæ™®AI Chatæ¨¡å‹é…ç½®**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®çš„resources/application.propertiesä¸­åŠ å…¥å¦‚ä¸‹chatæ¨¡å‹é…ç½®ï¼Œè¯¥chatæ¨¡å¼å°†ç”¨äºæ•´åˆçŸ¥è¯†ç‰‡æ®µå›å¤ã€‚

```properties
#ä½¿ç”¨ æ™ºæ™®AI Chat æ¨¡å‹ï¼Œéœ€è¦åœ¨pom.xmlä¸­å¼•å…¥å¯¹åº”ä¾èµ–
spring.ai.zhipuai.chat.options.model=GLM-4-Flash
```

**2) å‡†å¤‡æœ¬åœ°çŸ¥è¯†**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®çš„resourcesèµ„æºç›®å½•ä¸‹æ”¾å…¥â€œå¤ä»£è¯—æ­Œå¸¸ç”¨æ„å‘.txtâ€æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```properties
å¤ä»£è¯—æ­Œä¸­å¸¸ç”¨çš„æ„è±¡
----
1ï¼æ¤ç‰©ç±»
è‰ï¼šç”Ÿå‘½åŠ›å¼ºã€ç”Ÿç”Ÿä¸æ¯ã€å¸Œæœ›ã€è’å‡‰ã€ç¦»æ¨ã€å‘å¾®ã€‚
é»„å¶ï¼šå‡‹é›¶ã€åˆ«ç¦»ã€ç¾äººè¿Ÿæš®ã€æ–°é™ˆä»£è°¢ã€‚
ç»¿å¶ï¼šç”Ÿå‘½åŠ›ã€é•¿ä¹…ã€æ´»åŠ›ã€å¸Œæœ›ã€‚
æ¢§æ¡ï¼šæ‚²ç§‹ã€å‡„è‹¦ã€æ„Ÿä¼¤ï¼Œè¿˜å¯è¡¨è¾¾é«˜è´µã€‚
èŠ­è•‰ï¼šå­¤ç‹¬ã€ç¦»åˆ«ã€‚
æŸ³ï¼šé€åˆ«ã€æ€äº²ã€æŒ½ç•™ã€æ“å®ˆ(ä»‹ä¹‹æ¨)ã€‚
èŠ±å¼€ï¼šé’æ˜¥ã€å¸Œæœ›ã€äººç”Ÿçš„ç¾å¥½ã€‚
èŠ±è½ï¼šæƒœæ˜¥ã€å‡‹é›¶ã€å¤±æ„ã€äº‹ä¸šçš„æŒ«æŠ˜ã€å¯¹ç¾å¥½äº‹ç‰©çš„ç•™æ‹ã€‚
ç¦¾é»ï¼šé»ç¦»ä¹‹æ‚²(å›½å®¶è¡°è´¥)ã€‚
æ¨èŠ±ï¼šæ¼‚æ³Šã€æµæ•£ã€æ— æƒ…ã€‚
ç‰¡ä¸¹ï¼šå¯Œè´µã€ç¾å¥½ã€æ†§æ†¬ã€‚
è²ï¼šæ€œã€çˆ±ã€çº¯æ´ã€‚
æ¢…å­ï¼šå°‘å¥³æ€€æ˜¥ã€‚
ä¸é¦™ï¼šæ„æ€ã€æƒ…ç»“ã€‚
è™ç¾äººï¼šç½‚ç²Ÿç§‘ä¸€å¹´ç”Ÿè‰æœ¬èŠ±å‰ï¼Œäº¦ç§°ä¸½æ˜¥ã€èµ›ç‰¡ä¸¹ã€‚ç›¸ä¼ æ­¤èŠ±ç³»è¥¿æ¥šéœ¸ç‹é¡¹ç¾½çˆ±å¦¾è™å§¬è‡ªåˆå“ä¸‹ç¢§è¡€æ‰€åŒ–ï¼Œæ•…æœ‰é—»è™å…®æ­Œè€Œèµ·èˆä¹‹è¯´ã€‚å†ä»£æ–‡äººé›…å£«æ­Œå’æ­¤èŠ±ï¼Œå¤šæ¶‰åŠè¿™ä¸€æ‚²å£®ä¼ è¯´ã€‚
çº¢è±†ï¼šã€Šå—å·è®°ã€‹ç§°ä¸ºæµ·çº¢è±†ï¼Œã€Šæœ¬è‰ã€‹ç§°å…¶ä¸ºâ€œç›¸æ€å­â€ã€‚å¸¸ç”¨ä»¥è±¡å¾çˆ±æƒ…æˆ–ç›¸æ€ã€‚
è±†è”»ï¼šè±†è”»æ˜¯ä¸€ç§å¤šå¹´ç”Ÿè‰æœ¬æ¤ç‰©ã€‚åæ¥ç§°å¥³å­åä¸‰å››å²çš„å¹´çºªä¸ºè±†è”»å¹´åã€‚
å²å¯’ä¸‰å‹ï¼šæŒ‡å¤è¯—æ–‡ä¸­ç»å¸¸æåˆ°çš„æ¾ã€ç«¹ã€æ¢…ã€‚æ¾ï¼Œæ˜¯è€å¯’æ ‘æœ¨ï¼Œç»ˆå†¬ä¸å‡‹ï¼Œå¸¸è¢«çœ‹åšåˆšæ­£èŠ‚æ“çš„è±¡å¾ã€‚ç«¹ï¼Œä¹Ÿç»å†¬ä¸å‡‹ï¼Œä¸”è‡ªæˆç¾æ™¯ï¼Œå®ƒåˆšç›´ã€è°¦é€Šã€ä¸å‘ä¸äº¢ï¼Œæ½‡æ´’å¤„ä¸–ï¼Œå¸¸è¢«çœ‹åšä¸åŒæµä¿—çš„é«˜é›…ä¹‹å£«çš„è±¡å¾ã€‚æ¢…ï¼Œè¿å¯’è€Œå¼€ï¼Œç¾ä¸½ç»ä¿—ï¼Œæ˜¯åšå¿ä¸æ‹”çš„äººæ ¼çš„è±¡å¾ã€‚
èŠ±ä¸­å››å›å­ï¼šå¤è¯—äººä¸­å¸¸æåˆ°çš„æ¢…ã€å…°ã€ç«¹ã€èŠã€‚å…°ï¼Œä¸€åˆ™èŠ±æœµè‰²æ·¡é¦™æ¸…ï¼ŒäºŒåˆ™å¤šç”Ÿäºå¹½åƒ»ä¹‹å¤„ï¼Œæ•…å¸¸è¢«çœ‹åšæ˜¯è°¦è°¦å›å­çš„è±¡å¾ã€‚èŠï¼Œå®ƒä¸ä»…æ¸…ä¸½æ·¡é›…ã€èŠ³é¦™è¢­äººï¼Œè€Œä¸”å…·æœ‰å‚²éœœæ–—é›ªçš„ç‰¹å¾ï¼›å®ƒè‰³äºç™¾èŠ±å‡‹åï¼Œä¸ä¸ç¾¤èŠ³äº‰è‰³ï¼Œæ•…å†æ¥è¢«ç”¨æ¥è±¡å¾æ¬ç„¶è‡ªå¤„ã€å‚²ç„¶ä¸å±ˆçš„é«˜å°šå“æ ¼ã€‚(â€œæ¢…ã€ç«¹â€è§ä¸Šæ¡ã€‚)
----
2ï¼åŠ¨ç‰©ç±»
é¹§é¸ªï¼šè¡Œä¸å¾—ä¹Ÿå“¥å“¥ã€ç¦»æ„ã€ç‰©æ˜¯äººéã€‚
ç‡•ï¼šå®¶å›­ã€ç‰©æ˜¯äººéã€‚
é¹°ï¼šè‡ªç”±ã€å¼ºåŠ²ã€äººç”Ÿæå‡»ã€äº‹ä¸šæˆåŠŸã€‚
ä¹Œé¸¦ï¼šå°äººã€å¥¸è‡£ã€ä¿—å®¢åº¸å¤«ã€å“€ä¼¤ã€‚
æ²™é¸¥ï¼šé£˜é›¶ã€æ— ä¾ã€ä¼¤æ„Ÿã€‚
é±¼ï¼šè‡ªç”±ã€æƒ¬æ„ã€‚
é²¤é±¼ï¼šå°ºç´ ä¹¦ã€ä¿¡ã€‚
å¯’è‰ï¼šæ‚²ç§‹ã€é«˜æ´ä¹‹å£«ã€‚
é¸¡ç‹—ï¼šç”°å›­ã€ä¸–ä¿—ç”Ÿæ´»ã€‚
çŒ¿çŒ´ï¼šå‡„æ¸…ã€å“€ä¼¤ã€è’è¿œã€‚
é©¬ï¼šè¿½æ±‚ã€ä»•é€”ã€æ¼‚æ³Š(ç˜¦é©¬)ã€‚
é¸¿é›ï¼šã€Šæ±‰ä¹¦Â·è‹æ­¦ä¼ ã€‹è½½æœ‰å¤§é›ä¼ ä¹¦äº‹ï¼Œåå› ä»¥ä¹‹å–»ä¹¦ä¿¡ã€‚
é¸¿é¹„ï¼šé¸¿é¹„é£å¾—å¾ˆé«˜ï¼Œå¸¸ç”¨æ¥æ¯”å–»å¿—æ°”é«˜è¿œçš„äººã€‚
æœé¹ƒï¼šæœé¹ƒé¸Ÿä¿—ç§°å¸ƒè°·ï¼Œä¹Ÿå«å­å½’ã€å­é¹ƒã€‚æ˜¥å¤å­£èŠ‚ï¼Œæœé¹ƒå½»å¤œä¸åœå•¼é¸£ï¼Œå•¼å£°æ¸…è„†è€ŒçŸ­ä¿ƒï¼Œå”¤èµ·äººä»¬å¤šç§æƒ…æ€ã€‚æœé¹ƒå£è…”ä¸Šçš®å’ŒèˆŒéƒ¨éƒ½ä¸ºçº¢è‰²ï¼Œå¤äººè¯¯ä»¥ä¸ºå®ƒä»¬å•¼å¾—æ»¡å˜´æµè¡€ï¼Œå‡‘å·§æœé¹ƒé«˜æ­Œä¹‹æ—¶ï¼Œæ­£æ˜¯æœé¹ƒèŠ±å¼€ä¹‹é™…ï¼Œäººä»¬è§æœé¹ƒèŠ±å¼€å¾—é‚£æ ·é²œçº¢ï¼Œä¾¿æŠŠè¿™ç§é¢œè‰²è¯´æˆæ˜¯æœé¹ƒå•¼çš„è¡€ã€‚
æ¯”ç¿¼é¸Ÿï¼šä¼ è¯´ä¸­çš„ä¸€ç§é¸Ÿï¼Œé›Œé›„è€åœ¨ä¸€èµ·é£ï¼Œå¤å…¸è¯—æ­Œé‡Œç”¨ä½œæ©çˆ±å¤«å¦»çš„æ¯”å–»ã€‚
----
3ï¼æ™¯è±¡ç±»
è‰åŸï¼šè¾½é˜”ã€äººç”Ÿå¢ƒç•Œã€äººçš„èƒ¸è¥Ÿã€‚
æµ·ï¼šè¾½é˜”ã€æ·±é‚ƒã€åŠ›é‡ã€èƒ¸è¥Ÿã€äººç”Ÿçš„èµ·ä¼ã€‚
æ±Ÿæ°´ï¼šæ—¶å…‰æµé€ã€å²æœˆçŸ­æš‚ã€æ„è‹¦ç»µé•¿ã€‚
çƒŸé›¾ï¼šæƒ…æ„Ÿæœ¦èƒ§ã€å‘½è¿æƒ¨æ·¡ã€å‰é€”è¿·æƒ˜ã€ç†æƒ³å¹»ç­ã€‚
å°é›¨ï¼šæ˜¥æ™¯ã€ç”Ÿæœºæ´»åŠ›ã€å¸Œæœ›ã€ä¼¤æ„Ÿã€æ½œç§»é»˜åŒ–å¼çš„æ•™åŒ–ã€‚
æš´é›¨ï¼šçƒ­æƒ…ã€åŠ¨è¡ã€å·¨å˜ã€æ”¿æ²»æ–—äº‰ã€æ¶åŠ¿åŠ›ã€è¡æ¶¤æ±¡ç§½çš„åŠ›é‡ã€‚
ç‹‚é£ï¼šä½œä¹±ã€æ¶åŠ¿åŠ›ã€æ‘§æ¯æ—§ä¸–ç•Œçš„åŠ›é‡ã€‚
ä¸œé£ï¼šæ˜¥é£ã€æ¬¢æ„‰ã€å¸Œæœ›ã€ç¾å¥½ã€æ—¶å…‰ã€‚
è¥¿é£ï¼šæ‚²ç§‹ã€è½å¯ã€æƒ†æ€…ã€è¡°è´¥ã€æ¸¸å­æ€å½’ã€‚
éœœï¼šæ‰“å‡»ã€è€ƒéªŒã€å˜æ˜“ã€æŒ«æŠ˜ã€ç¤¾ä¼šç¯å¢ƒæ¶åŠ£ï¼Œæ¶åŠ¿åŠ›çŒ–ç‹‚ã€äººç”Ÿè·¯é€”åå·ã€‚
é›ªï¼šçº¯æ´ã€ç¾å¥½ã€å¯’å†·ã€ç¯å¢ƒæ¶åŠ£ã€æ¶åŠ¿åŠ›ã€‚
éœ²ï¼šäººç”ŸçŸ­ä¿ƒã€ç”Ÿå‘½æ˜“é€ã€‚
é˜´ï¼šå‹æŠ‘ã€æ„è‹¦ã€å¯‚å¯ã€‚
æ™´ï¼šæ¬¢æ™¯ã€å…‰æ˜ã€å¸Œæœ›ã€‚
äº‘ï¼šæ¸¸å­ã€é£˜æ³Šã€å½’éšã€è½»æµ®ã€‚
å¤•é˜³ï¼šè¿Ÿæš®ã€å¤±è½ã€æ¶ˆæ²‰ã€ç¾å¥½è€ŒçŸ­æš‚çš„äº‹ç‰©ã€‚
æœˆäº®ï¼šåœ†æ»¡ã€ç¼ºæ†¾ã€æ€ä¹¡ã€æ€äº²ã€å˜æ˜“ã€ç¦»åˆ«ã€‚
ç ´æ™“ï¼šæ¸…é™ã€è¿·èŒ«ã€å¸Œæœ›ã€‚
æš®å¤œï¼šæ„æ€ã€æ€€æ—§ã€å­¤ç‹¬ã€æ¸…å†·ã€‚
å¤©åœ°ï¼šäººçš„æ¸ºå°ã€äººç”ŸçŸ­æš‚ã€å¿ƒèƒ¸å¹¿é˜”ã€æƒ…æ„Ÿå­¤ç‹¬ã€‚
ç§‹æ°´ï¼šç§‹æ°´ï¼Œå–»æŒ‡çœ¼ç›ï¼Œå½¢å®¹ç›¼æœ›çš„è¿«åˆ‡ã€‚
----
4ï¼äººæ–‡ç±»
è‹±é›„ï¼šå†å²é£äº‘äººç‰©ã€åŠŸä¸šæœ‰æˆè€…ã€ä»¤äººè¿½æ…•è€…ã€è®©äººè‡ªæ„§ä¸å¦‚è€…ã€‚ 
å°äººï¼šå¥¸äººã€è¢«é„™å¤·çš„ã€è¢«é­æŒçš„ã€ä½¿äººåæ€è€…ã€‚
å¤è¿¹ï¼šå¤è¥å’ã€æ—§æ¥¼å°ï¼Œè¡°è´¥ã€è§æ¡ã€æ€€æ—§æ˜å¿—ã€æ˜”ç››ä»Šè¡°ã€‚
ä¹¡æ‘ï¼šæ€å½’ã€ä¸–ä¿—ã€ç”°å›­é£å…‰ã€ç”Ÿæ´»æ°”æ¯ã€çº¯æœ´å®é™çš„ç”Ÿæ´»ã€‚
å—æµ¦ï¼šé€åˆ«ã€æ„Ÿä¼¤ã€‚
äº­ï¼šé•¿äº­çŸ­äº­ï¼Œé€åˆ«ã€æŒ½ç•™ã€ä¾æ‹ã€‚
éƒ½å¸‚ï¼šå¸‚äº•ç¹è£ã€å¯Œè´µå¥¢åã€ä¸–ä¿—ååˆ©ã€‚
ä»™å¢ƒï¼šé£˜é€¸ã€å¿˜å°˜åŒä¿—ã€å¹»æƒ³ã€è™šå¹»ã€‚
é…’ï¼šé•¿ä¹…ã€é€åˆ«ã€æ¬¢æ‚¦ã€å¾—æ„ã€å¤±æ„ã€æ„è‹¦ã€‚
äº‘å¸†ï¼šæŠ±è´Ÿã€ç¦»åˆ«ã€æ€ä¹¡ã€‚
ç´ç‘Ÿï¼š(1)æ¯”å–»å¤«å¦‡æ„Ÿæƒ…å’Œè°ï¼Œäº¦ä½œâ€œç‘Ÿç´â€ã€‚(2)æ¯”å–»å…„å¼Ÿæœ‹å‹çš„æƒ…è°Šã€‚
æ¢¨å›­ï¼šæ¢¨å›­åŸæ˜¯çš‡å¸ç¦è‹‘ä¸­çš„æœæœ¨å›­åœƒï¼Œå”ç„å®—å¼€å…ƒå¹´é—´ï¼Œå°†å…¶ä½œä¸ºæ•™ä¹ æ­Œèˆçš„åœ°æ–¹ï¼Œä¸”åœ¨è¿™é‡ŒåŸ¹å…»å‡ºäº†å¤§æ‰¹ä¼˜ç§€çš„éŸ³ä¹èˆè¹ˆè¡¨æ¼”äººæ‰ï¼Œåœ¨å†å²ä¸Šäº§ç”Ÿäº†æ·±è¿œçš„å½±å“ã€‚å› æ­¤ï¼Œåä¸–çš„æˆæ›²ç­ç¤¾å¸¸ä»¥â€œæ¢¨å›­â€ä¸ºå…¶ä»£ç§°ï¼Œæˆæ›²è‰ºäººç§°â€œæ¢¨å›­å¼Ÿå­â€ã€‚
ç¥å™¨ï¼šæŒ‡åœ°ä½ã€æ”¿æƒã€‚
æœˆè€ï¼šä¼ è¯´å”æœéŸ¦å›ºæœˆå¤œé‡Œç»è¿‡å®‹åŸï¼Œé‡è§ä¸€ä¸ªè€äººåç€ç¿»æ£€ä¹¦æœ¬ã€‚éŸ¦å›ºå‰å¾€çª¥è§†ï¼Œä¸€ä¸ªå­—ä¹Ÿä¸è®¤å¾—ã€‚å‘è€äººè¯¢é—®åï¼Œæ‰çŸ¥é“è€äººæ˜¯ä¸“ç®¡äººé—´å©šå§»çš„ç¥ä»™ï¼Œç¿»æ£€çš„ä¹¦æ˜¯å©šå§»ç°¿ã€‚(è§ã€Šç»­å¹½æ€ªå½•Â·å®šå©šåº—ã€‹)åæ¥å› æ­¤ç§°åª’äººä¸ºæœˆä¸‹è€äººï¼Œæˆ–æœˆè€ã€‚
é™¶æœ±ï¼šæ˜¥ç§‹æ—¶è¶Šå›½å¤§å¤«èŒƒè ¡çš„åˆ«å·ã€‚ç›¸ä¼ ä»–å¸®åŠ©å‹¾è·µç­å´åï¼Œç¦»å¼€è¶Šå›½åˆ°é™¶ï¼Œå–„äºç»è¥ç”Ÿè®¡ï¼Œç§¯ç´¯äº†å¾ˆå¤šè´¢å¯Œï¼Œåä¸–å› æ­¤ä»¥â€œé™¶æœ±â€æˆ–â€œé™¶æœ±å…¬â€æ¥ç§°å¯Œå•†ã€‚
ç¥èï¼šä¼ è¯´ä¸­æ¥šå›½å”è¯‰ç¥–å…ˆï¼Œä¸ºé«˜è¾›æ°å¸å–¾çš„ç«æ­£(æŒç«ä¹‹å®˜)ï¼Œä»¥å…‰æ˜å››æµ·è€Œæˆä¸ºç¥èï¼Œåä¸–ç¥€ä¸ºç«ç¥ã€‚ç”±æ­¤ï¼Œç«ç¾ç§°ä¸ºç¥èä¹‹ç¾ã€‚
é’æ¢…ç«¹é©¬ï¼šå‡ºè‡ªæç™½çš„ã€Šé•¿å¹²è¡Œã€‹ï¼šâ€œéƒéª‘ç«¹é©¬æ¥ï¼Œç»•åºŠå¼„é’æ¢…ã€‚åŒå±…é•¿å¹²é‡Œï¼Œä¸¤å°æ— å«ŒçŒœã€‚â€åæ¥ç”¨â€œé’æ¢…ç«¹é©¬â€å½¢å®¹ç”·å¥³å°çš„æ—¶å€™å¤©çœŸæ— é‚ªï¼Œä¹ŸæŒ‡å¹¼å°æ—¶å°±ç›¸è¯†çš„ä¼´ä¾£ã€‚
é—®é¼ï¼šã€Šå·¦ä¼ Â·å®£å…¬ä¸‰å¹´ã€‹ï¼šâ€œæ¥šå­ä¼é™†æµ‘ä¹‹æˆï¼Œéš§è‡³äºé›’è§‚å…µäºå‘¨ç–†ã€‚å®šç‹ä½¿ç‹å­™æ»¡åŠ³æ¥šå­ï¼Œæ¥šå­é—®é¼ä¹‹å¤§å°è½»é‡ç„‰ã€‚â€ä¸‰ä»£ä»¥ä¹é¼ä¸ºä¼ å›½å®ï¼Œæ¥šå­é—®é¼ï¼Œæœ‰è§Šè§å‘¨å®¤ä¹‹æ„ã€‚åé‚ä»¥é—®é¼æ¯”å–»å›¾è°‹å¸ç‹æƒä½ã€‚
é€é¹¿ï¼šã€Šæ±‰ä¹¦Â·è’¯é€šä¼ ã€‹ï¼šâ€œä¸”ç§¦å¤±å…¶é¹¿ï¼Œå¤©ä¸‹å…±é€ä¹‹ã€‚â€é¢œå¸ˆå¤æ³¨å¼•å¼ æ™æ›°ï¼šâ€œä»¥é¹¿å–»å¸ä½ã€‚â€åæ¥ç”¨é€é¹¿æ¯”å–»ç¾¤é›„å¹¶èµ·ï¼Œäº‰å¤ºå¤©ä¸‹ã€‚
ä¸‰å°ºï¼šä¸‰å°ºï¼Œä¹Ÿå«â€œä¸‰å°ºæ³•â€ï¼Œæ˜¯æ³•å¾‹çš„ä»£åè¯ã€‚å¤ä»£æŠŠæ³•å¾‹å†™åœ¨ä¸‰å°ºé•¿çš„ç«¹ç®€ä¸Šï¼Œæ‰€ä»¥ç§°â€œä¸‰å°ºæ³•â€ã€‚
æœåº·ï¼šã€Šè¯´æ–‡è§£å­—Â·å·¾éƒ¨ã€‹ï¼šâ€œå¤è€…å°‘åº·åˆä½œç®•å¸šï¼Œå°‘åº·ï¼Œæœåº·ä¹Ÿã€‚â€åå³ä»¥æœåº·ä½œä¸ºé…’çš„ä»£ç§°ã€‚
ç§¦æ™‹ï¼šæ˜¥ç§‹æ—¶ï¼Œç§¦æ™‹ä¸¤å›½ä¸–ä¸ºå©šå§»ï¼Œåå› ç§°ä¸¤å§“è”å§»ä¸ºâ€œç§¦æ™‹ä¹‹å¥½â€ã€‚
å½­ç¥–ï¼šä¼ è¯´æ•…äº‹äººç‰©ï¼Œç”Ÿäºå¤ä»£ï¼Œè‡³æ®·æœ«æ—¶å·²å…«ç™¾ä½™å²ï¼Œæ—§æ—¶æŠŠå½­ç¥–ä½œä¸ºé•¿å¯¿çš„è±¡å¾ï¼Œä»¥â€œå¯¿å¦‚å½­ç¥–â€æ¥ç¥äººé•¿å¯¿ã€‚
è°¢å®¶ï¼šå”è¯—å®‹è¯ä¸è¾¾æ„ä¹‹å¤„å¸¸ç”¨â€œè°¢å®¶â€ä¹‹å…¸ï¼Œå…¶æ„æœ‰ï¼š
(1)ç”¨è°¢å®‰ã€è°¢ç„å®¶äº‹ï¼Œæ„æŒ‡äººæœ‰é£åº¦ã€‚
(2)ä¸“æŒ‡è°¢å®‰ä¾„å¥³è°¢é“éŸ«ä¹‹äº‹ï¼Œè¡¨ç¤ºæœ‰æ‰æœ‰è²Œä¹‹ç¾å¥³ã€‚
(3)æŒ‡å±±æ°´è¯—äººè°¢çµè¿äº‹ã€‚
å©µå¨Ÿï¼šå©µå¨Ÿï¼Œå§¿æ€ç¾å¥½ï¼Œå¤šç”¨æ¥å½¢å®¹å¥³å­ï¼›å› äººä»¬å¸¸å–»æœˆä¸ºç¾å¥³ï¼Œæ•…æœˆäº®ç§°ä¸ºå©µå¨Ÿã€‚
çŒ®èŠ¹ï¼šã€Šåˆ—å­Â·æ¨æœ±ã€‹æœ‰ä¸€ä¸ªæ•…äº‹è¯´ï¼Œä»å‰æœ‰ä¸€ä¸ªäººåœ¨ä¹¡é‡Œçš„è±ªç»…é¢å‰å¤§è‚†å¹å˜˜èŠ¹èœå¦‚ä½•å¥½åƒï¼Œè±ªç»…å°äº†ä¹‹åï¼Œç«Ÿâ€œèœ‡äºå£ï¼Œæƒ¨äºè…¹â€ã€‚åæ¥å°±ç”¨â€œçŒ®èŠ¹â€è°¦ç§°èµ äººçš„ç¤¼å“è²è–„ï¼Œæˆ–æ‰€æçš„å»ºè®®æµ…é™‹ã€‚ä¹Ÿè¯´â€œèŠ¹çŒ®â€ã€‚
æ‰§ç‰›è€³ï¼šå¤ä»£è¯¸ä¾¯è®¢ç«‹ç›Ÿçº¦ï¼Œè¦æ¯äººå°ä¸€ç‚¹ç‰²è¡€ï¼Œä¸»ç›Ÿçš„äººäº²è‡ªå‰²ç‰›è€³å–è¡€ï¼Œæ•…ç”¨â€œæ‰§ç‰›è€³â€æŒ‡ç›Ÿä¸»ã€‚åæ¥æŒ‡åœ¨æŸä¸€æ–¹é¢å±…é¢†å¯¼åœ°ä½ã€‚
```

**3) å‡†å¤‡ServiceåŠå¯¹åº”æ–¹æ³•**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®ä¸­åˆ›å»ºservice/RagService.javaæ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š

```java
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.embedding.EmbeddingModel;
import org.springframework.core.io.ClassPathResource;
import org.springframework.core.io.Resource;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;

@Service
public class RagService {
    private final EmbeddingModel em; //åµŒå…¥æ¨¡å‹ï¼Œç”¨äºç”Ÿæˆæ–‡æœ¬çš„å‘é‡
    private final ChatClient chatClient; // èŠå¤©å®¢æˆ·ç«¯ï¼Œç”¨äºä¸ AI è¿›è¡Œäº¤äº’
    private final List<String> docs = new ArrayList<>();//å­˜å‚¨æœ¬åœ°æ–‡æ¡£å†…å®¹
    private final List<float[]> vectors = new ArrayList<>();//å­˜å‚¨æœ¬åœ°æ–‡æ¡£å‘é‡

    public RagService(EmbeddingModel embeddingModel, ChatClient.Builder chatBuilder) throws IOException {
        this.em = embeddingModel;
        this.chatClient = chatBuilder.build(); // åˆ›å»º æ™ºæ™®AI Chat èŠå¤©å®¢æˆ·ç«¯

        // åŠ è½½æœ¬åœ°æ–‡æ¡£
        Resource res = new ClassPathResource("å¤ä»£è¯—æ­Œå¸¸ç”¨æ„è±¡.txt");
        String content = new String(res.getInputStream().readAllBytes(), StandardCharsets.UTF_8);

        // åˆ†å‰²æ–‡æ¡£å†…å®¹å¹¶ç”Ÿæˆå‘é‡
        for (String part : content.split("----")) {
            System.out.println("part: " + part);
            if (part.isBlank()) continue;
            docs.add(part);// å­˜å‚¨åˆ‡åˆ†çš„æ–‡æ¡£å†…å®¹
            vectors.add(em.embed(part)); // å°†æ–‡æ¡£ç”Ÿæˆ embedding å¹¶å­˜å‚¨
        }
    }

    // å¯¹ç”¨æˆ·è¾“å…¥çš„é—®é¢˜è¿›è¡Œå›ç­”
    public String answer(String q) {
        // ç”Ÿæˆç”¨æˆ·é—®é¢˜çš„å‘é‡
        float[] qv = em.embed(q);

        // æœ€ç›¸ä¼¼ä¸¤ä¸ªæ–‡æ¡£çš„ç´¢å¼•
        int index1 = -1, index2 = -1;
        // æœ€ç›¸ä¼¼ä¸¤ä¸ªæ–‡æ¡£çš„ç›¸ä¼¼åº¦
        double v1 = -1, v2 = -1;
        // æ‰¾åˆ°æœ€ç›¸ä¼¼çš„ä¸¤ä¸ªæ–‡æ¡£
        for (int i = 0; i < vectors.size(); i++) {
            // è®¡ç®—ç”¨æˆ·é—®é¢˜å‘é‡ä¸åˆ‡åˆ†çš„æ¯ä¸ªæ–‡æ¡£å‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦
            double sim = cosineSimilarity(qv, vectors.get(i));
            if (sim > v1) {
                index2 = index1;
                v2 = v1;
                index1 = i;
                v1 = sim;
            } else if (sim > v2) {
                index2 = i;
                v2 = sim;
            }
        }

        //è·å–ä¸¤ä¸ªæœ€ç›¸ä¼¼æ–‡æ¡£çš„å†…å®¹ï¼Œæ‹¼æ¥åœ¨ä¸€èµ·ä½œä¸ºä¸Šä¸‹æ–‡
        String ctx = docs.get(index1) + (index2 >= 0 ? "\n---\n" + docs.get(index2) : "");

        //æ„å»º AI æ¨¡å‹çš„æç¤ºä¿¡æ¯ï¼ŒåŒ…å«ä¸Šä¸‹æ–‡å’Œç”¨æˆ·é—®é¢˜
        String prompt = "ä»¥ä¸‹æ˜¯çŸ¥è¯†å†…å®¹ï¼š\n" + ctx + "\nè¯·åŸºäºä¸Šè¿°çŸ¥è¯†å›ç­”ç”¨æˆ·é—®é¢˜ï¼šâ€œ" + q + "â€";

        // ä½¿ç”¨ ChatClient æµå¼æ„å»º
        var response = chatClient
                .prompt()
                .system("ä½ æ˜¯çŸ¥è¯†åŠ©æ‰‹ï¼Œç»“åˆä¸Šä¸‹æ–‡å›ç­”é—®é¢˜")  // æ·»åŠ ç³»ç»Ÿæç¤º
                .user(prompt)                                // ç”¨æˆ· + ä¸Šä¸‹æ–‡
                .call();                                     // å‘èµ·åŒæ­¥è°ƒç”¨

        // è·å–å†…å®¹æ–‡æœ¬
        return response.content();
    }

    // ä½™å¼¦ç›¸ä¼¼åº¦å®ç°
    // è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œæ•°å€¼èŒƒå›´åœ¨ [-1, 1] ä¹‹é—´
    // ç›¸ä¼¼åº¦è¶Šé«˜ï¼Œè¶Šæ¥è¿‘1ï¼Œè¶Šæ¥è¿‘0ï¼Œè¶Šä¸ç›¸ä¼¼
    private double cosineSimilarity(float[] a, float[] b) {
        double dot = 0, na = 0, nb = 0;
        for (int i = 0; i < a.length; i++) {
            dot += a[i] * b[i];
            na += a[i] * a[i];
            nb += b[i] * b[i];
        }
        return dot / (Math.sqrt(na) * Math.sqrt(nb));
    }
}
```

ç‰¹åˆ«æ³¨æ„ï¼šä»¥ä¸Šä»£ç ä¸­ç”¨æˆ·è‡ªå·±å°†æœ¬åœ°çŸ¥è¯†åº“æ–‡ä»¶åˆ‡åˆ†å¹¶é€šè¿‡Embedding æ¨¡å‹è½¬æ¢æˆå‘é‡ï¼Œç„¶åè·å–ä¸ç”¨æˆ·è¾“å…¥é—®é¢˜å‘é‡æœ€ç›¸ä¼¼çš„Top2æ–‡æ¡£äº¤ç»™å¤§æ¨¡å‹å¤„ç†ã€‚

**4) å‡†å¤‡ControlleråŠå¯¹åº”æ–¹æ³•**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®ä¸­åˆ›å»ºcontroller/RagController.javaæ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š

```java
import com.example.springaiembedding.service.RagService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.Map;

@RestController
@RequestMapping("/rag")
public class RagController {
    @Autowired
    private RagService ragService;

    @GetMapping("/ask")
    public Map<String, String> ask(@RequestParam("question") String question) {
        String answer = ragService.answer(question);
        return Map.of("question", question, "answer", answer);
    }
}
```

**5) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

é‡æ–°å¯åŠ¨â€œSpringAIEmbeddingâ€é¡¹ç›®ï¼Œç„¶åæµè§ˆå™¨è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡ŒRAGæœ¬åœ°çŸ¥è¯†åº“æ£€ç´¢æµ‹è¯•:

```java
http://localhost:8080/rag/ask?question=å¤ä»£è¯—æ­Œå¸¸ç”¨æ„è±¡æœ‰å“ªäº›ï¼Ÿ
```

å¯ä»¥çœ‹åˆ°ç­”æ¡ˆå¦‚ä¸‹ï¼Œæˆ‘ä»¬å‘ç°å…³äºç”¨æˆ·æé—®çš„å›å¤å¹¶ä¸æ˜¯å¤ªç²¾å‡†ï¼Œåªæ˜¯è¿”å›çš„éƒ¨åˆ†å†…å®¹ï¼Œä¸»è¦åŸå› è¯¦è§ä¸‹ä¸ªå°èŠ‚ã€‚

![8353e38575bd49f580561ddc67e67bb1](img\8353e38575bd49f580561ddc67e67bb1.jpg)

### **ğŸ” 5. Embeddingæ¡ˆä¾‹3ï¼šRAGæœ¬åœ°çŸ¥è¯†åº“æ£€ç´¢å‡çº§**

#### â“ **5.1. æ‰‹åŠ¨åˆ‡åˆ†æ–‡æ¡£å­˜åœ¨é—®é¢˜**

1. **åŒ¹é…ä¸åˆ°è¶³å¤Ÿçš„ä¿¡æ¯**ï¼šåªè¿”å›æœ€ç›¸å…³çš„å‰ä¸¤ä¸ªç‰‡æ®µï¼ˆTop 2ï¼‰ï¼Œå½“æ–‡æ¡£å†…å®¹è¾ƒå¤šä¸”ç”¨æˆ·çš„é—®é¢˜è·¨è¶Šå¤šä¸ªä¸»é¢˜æ—¶ï¼Œå¯èƒ½æ²¡æ³•æ¶µç›–å®Œæ•´çš„èƒŒæ™¯ä¿¡æ¯ã€‚
2. **è¯­ä¹‰ä¸å®Œæ•´**ï¼šå¦‚æœåˆ‡åˆ†è§„åˆ™ä¸å½“ï¼Œè¿”å›çš„ç‰‡æ®µå¯èƒ½ä¸å®Œæ•´ï¼Œå¯¼è‡´æœ€ç»ˆæ¨¡å‹çš„å›ç­”æ•ˆæœè¾ƒå·®ã€‚

##### ğŸ§‘â€ğŸ’» 1. **è°ƒæ•´Chunkåˆ†æ®µç­–ç•¥**

- **é—®é¢˜**ï¼šåˆ†ç‰‡è¿‡å¤§å¯èƒ½ä¼šå¯¼è‡´å¤šä¸ªä¸»é¢˜æ··æ‚ï¼Œåˆ†ç‰‡è¿‡å°åˆ™æ— æ³•å‡†ç¡®è¡¨è¾¾æ„æ€ã€‚
- **å»ºè®®**ï¼šåˆ‡åˆ†çš„ç‰‡æ®µå¤§å°åº”è¯¥é€‚ä¸­ï¼Œé€šå¸¸åœ¨200~500ä¸ªå­—ç¬¦ä¹‹é—´ï¼Œå…·ä½“å¯ä»¥æ ¹æ®æ–‡æ¡£çš„ç»“æ„è¿›è¡Œè°ƒæ•´ã€‚è¿™æ ·å¯ä»¥åœ¨ä¿è¯è¯­ä¹‰è¿è´¯æ€§çš„åŒæ—¶é¿å…ç‰‡æ®µå¤ªå¤§æˆ–å¤ªå°çš„é—®é¢˜ã€‚

##### ğŸŒ 2. **æ ¹æ®ç›¸ä¼¼åº¦é˜ˆå€¼æ¥ç¡®å®šè·å–çš„çŸ¥è¯†ç‰‡æ®µ**

- **é—®é¢˜**ï¼šå•çº¯è¿”å›Top 2çš„ç‰‡æ®µï¼Œå¯èƒ½ä¼šæ¼æ‰å…¶ä»–ç›¸å…³ä¿¡æ¯ã€‚
- **å»ºè®®**ï¼šåœ¨è®¡ç®—å‘é‡ç›¸ä¼¼åº¦æ—¶ï¼Œå¯ä»¥è®¾å®šä¸€ä¸ªç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œè¿”å›æ‰€æœ‰é«˜äºè¯¥é˜ˆå€¼çš„ç‰‡æ®µï¼Œæˆ–è€…è¿”å›Top Kä¸ªç›¸å…³ç‰‡æ®µï¼ˆä¾‹å¦‚Top 5æˆ–Top 10ï¼‰ã€‚è¿™ç§æ–¹æ³•èƒ½æ›´å…¨é¢åœ°æ•è·ç›¸å…³ä¿¡æ¯ï¼Œå‡å°‘ä¿¡æ¯é—æ¼ã€‚
- **æ³¨æ„**ï¼šå¦‚æœç›¸ä¼¼åº¦é˜ˆå€¼è¿‡ä½ï¼Œå¯èƒ½ä¼šå¼•å…¥å¾ˆå¤šå™ªå£°ï¼Œå¯¼è‡´æ‹¼æ¥çš„ä¸Šä¸‹æ–‡è¶…å‡ºæ¨¡å‹çš„æœ€å¤§è¾“å…¥é•¿åº¦ï¼Œå½±å“æ€§èƒ½ã€‚

##### ğŸ§© 3. **è·å–ç›¸å…³çŸ¥è¯†ç‰‡æ®µçš„ç›¸é‚»ç‰‡æ®µ**

- **é—®é¢˜**ï¼šå•ç‹¬çš„ç‰‡æ®µå¯èƒ½ä¸¢å¤±ä¸Šä¸‹æ–‡è¯­å¢ƒï¼Œå¯¼è‡´ä¿¡æ¯ä¸å®Œæ•´ã€‚
- **å»ºè®®**ï¼šåœ¨é€‰æ‹©ç›¸å…³ç‰‡æ®µæ—¶ï¼Œä¸ä»…è¦è·å–è¯¥ç‰‡æ®µï¼Œè¿˜è¦æŠŠè¯¥ç‰‡æ®µå‰åç›¸é‚»çš„1~2ä¸ªç‰‡æ®µä¸€èµ·åŠ å…¥ä¸Šä¸‹æ–‡ï¼Œä»¥å¢å¼ºä¸Šä¸‹æ–‡çš„è¿è´¯æ€§ã€‚ä¾‹å¦‚ï¼ŒæŸä¸ªå¥å­è¢«åˆ‡å‰²æˆäº†ä¸¤éƒ¨åˆ†ï¼Œå•ç‹¬çœ‹å¯èƒ½ä¸å®Œæ•´ï¼Œé€šè¿‡æŠŠç›¸é‚»çš„ç‰‡æ®µä¸€èµ·åŠ å…¥ä¸Šä¸‹æ–‡ï¼Œèƒ½ä½¿è¯­ä¹‰æ›´å®Œæ•´ã€‚

#### ğŸŒ **5.2. æ¡ˆä¾‹å®ç°**

**1) å‡†å¤‡æ™ºæ™®AI Chatæ¨¡å‹é…ç½®åŠå¯¼å…¥ä¾èµ–**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®çš„resources/application.propertiesä¸­åŠ å…¥å¦‚ä¸‹chatæ¨¡å‹é…ç½®ï¼Œè¯¥chatæ¨¡å¼å°†ç”¨äºæ•´åˆçŸ¥è¯†ç‰‡æ®µå›å¤ã€‚

```properties
#ä½¿ç”¨ æ™ºæ™®AI Chat æ¨¡å‹ï¼Œéœ€è¦åœ¨pom.xmlä¸­å¼•å…¥å¯¹åº”ä¾èµ–
spring.ai.zhipuai.chat.options.model=GLM-4-Flash
```

åœ¨é¡¹ç›®pom.xmlä¸­å¯¼å…¥å¦‚ä¸‹ä¾èµ–ï¼Œè¯¥ä¾èµ–å°†ç”¨äºæ–‡æ¡£åˆ‡åˆ†æ“ä½œã€‚

```xml
<!-- spring-ai-client-chat ä¸­åŒ…æ‹¬ TokenTextSplitterã€TextReaderã€Document ç­‰å·¥å…· -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-client-chat</artifactId>
    <version>1.0.0</version>
</dependency>
```

**2) å‡†å¤‡æœ¬åœ°çŸ¥è¯†**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®çš„resourcesèµ„æºç›®å½•ä¸‹æ”¾å…¥â€œå¤ä»£è¯—æ­Œå¸¸ç”¨æ„å‘.txtâ€æ–‡ä»¶ï¼Œè¯¥æ­¥éª¤åœ¨ä¸Šä¸ªæ¡ˆä¾‹ä¸­å·²ç»æ“ä½œï¼Œå¯å¿½ç•¥ã€‚

**3) å‡†å¤‡ServiceåŠå¯¹åº”æ–¹æ³•**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®ä¸­åˆ›å»ºservice/RagService2.javaæ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š

```java
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.document.Document;
import org.springframework.ai.embedding.EmbeddingModel;
import org.springframework.ai.reader.TextReader;
import org.springframework.ai.transformer.splitter.TokenTextSplitter;
import org.springframework.core.io.ClassPathResource;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;
import java.util.TreeSet;
import java.util.stream.Collectors;

@Service
public class RagService2 {
    private final EmbeddingModel em;//åµŒå…¥æ¨¡å‹ï¼Œç”¨äºç”Ÿæˆæ–‡æœ¬çš„å‘é‡
    private final ChatClient chatClient;// èŠå¤©å®¢æˆ·ç«¯ï¼Œç”¨äºä¸ AI è¿›è¡Œäº¤äº’
    private final List<String> docs = new ArrayList<>(); //å­˜å‚¨æœ¬åœ°æ–‡æ¡£å†…å®¹
    private final List<float[]> vectors = new ArrayList<>(); //å­˜å‚¨æœ¬åœ°æ–‡æ¡£å‘é‡

    public RagService2(EmbeddingModel embeddingModel, ChatClient.Builder chatBuilder) throws Exception {
        this.em = embeddingModel;
        this.chatClient = chatBuilder.build();// åˆ›å»º æ™ºæ™®AI Chat èŠå¤©å®¢æˆ·ç«¯

        // 1. ä» resources è¯»å–é•¿æ–‡æœ¬æ–‡æ¡£
        var resource = new ClassPathResource("å¤ä»£è¯—æ­Œå¸¸ç”¨æ„è±¡.txt");
        // åˆ›å»º TextReader å¹¶è¯»å–æ–‡æ¡£å†…å®¹
        TextReader reader = new TextReader(resource);
        List<Document> rawDocs = reader.read();

        // 2. ä½¿ç”¨ TokenTextSplitter å·¥å…·å°†é•¿æ–‡æœ¬æ‹†åˆ†ä¸ºåˆç†å¤§å°ç‰‡æ®µ
        TokenTextSplitter splitter = TokenTextSplitter.builder()
                .withChunkSize(800)            // æ‹†åˆ†æ¯æ®µæœ€å¤š 800 token
                .withMinChunkSizeChars(400)    // æ¯æ®µæœ€å°å…è®¸ 400 å­—ç¬¦
                .withKeepSeparator(true)       // ä¿ç•™åˆ†éš”ç¬¦ï¼Œæé«˜ä¸Šä¸‹æ–‡è¿è´¯
                .build();
        //æŒ‰ç…§è®¾ç½®çš„å‚æ•°æ‹†åˆ†é•¿æ–‡æœ¬ä¸ºå¤šä¸ªChunk
        List<Document> chunks = splitter.apply(rawDocs);

        // 3. éå†æ¯ä¸ª chunkï¼Œç”Ÿæˆ embedding å¹¶å­˜å‚¨
        for (Document d : chunks) {
            // è·å–æ–‡æœ¬å†…å®¹ï¼Œå¹¶å»é™¤é¦–å°¾ç©ºç™½
            String text = d.getText().strip();
            System.out.println("text: " + text);
            if (text.isBlank()) continue;
            docs.add(text);// å­˜å‚¨åˆ‡åˆ†çš„æ–‡æ¡£å†…å®¹
            vectors.add(em.embed(text));// å°†æ–‡æ¡£ç”Ÿæˆ embedding å¹¶å­˜å‚¨
        }
    }

    public String answer(String q) {
        // 4. å°†ç”¨æˆ·æé—® embedding
        float[] qVec = em.embed(q);

        // 5. è®¡ç®—æ¯ä¸ª chunk ä¸æé—®çš„ç›¸ä¼¼åº¦ï¼Œå¹¶æ‰¾å‡ºå‰ K é«˜
        int K = 5;
        double threshold = 0.05;  // ç›¸ä¼¼åº¦é˜ˆå€¼
        // è¯¥åˆ—è¡¨ç”¨äºå­˜å‚¨ å¤§äºé˜ˆå€¼çš„ chunk ä¿¡æ¯(chunkç´¢å¼•å’Œç›¸ä¼¼åº¦ï¼‰
        List<IndexSim> sims = new ArrayList<>();
        for (int i = 0; i < vectors.size(); i++) {
            // è®¡ç®—ç”¨æˆ·é—®é¢˜å‘é‡ä¸åˆ‡åˆ†çš„æ¯ä¸ªæ–‡æ¡£å‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦
            double sim = cosineSimilarity(qVec, vectors.get(i));
            if (sim >= threshold) {
                sims.add(new IndexSim(i, sim));
            }
        }

        // æŒ‰ç›¸ä¼¼åº¦é™åºæ’åº
        sims.sort((a, b) -> Double.compare(b.sim, a.sim));
        // å–ç›¸ä¼¼åº¦æœ€é«˜çš„å‰ K ä¸ªç‰‡æ®µ
        List<IndexSim> topKs = sims.stream().limit(K).collect(Collectors.toList());

        // 6. æ‰©å±•ä¸Šä¸‹æ–‡èŒƒå›´ï¼šåœ¨æ¯ä¸ªåŒ¹é…ç‰‡æ®µåŸºç¡€ä¸ŠåŠ å…¥å…¶å‰åç›¸é‚»ç‰‡æ®µ
        // ä¸ºäº†é¿å…é‡å¤ï¼Œä½¿ç”¨ TreeSet æ¥å­˜å‚¨æ‰€æœ‰éœ€è¦çš„ç‰‡æ®µç´¢å¼•ï¼ŒTreeSet ä¼šè‡ªåŠ¨å»é‡å¹¶æ’åºï¼Œä¿æŒä»å°åˆ°å¤§é¡ºåº
        Set<Integer> idxSet = new TreeSet<>();
        for (IndexSim is : topKs) {
            idxSet.add(is.index);
            if (is.index - 1 >= 0) idxSet.add(is.index - 1);
            if (is.index + 1 < docs.size()) idxSet.add(is.index + 1);
        }

        // 7. å°†è¿™äº›ç‰‡æ®µæ‹¼æ¥æˆæœ€ç»ˆä¸Šä¸‹æ–‡å†…å®¹ï¼Œç”¨äºç”Ÿæˆå›ç­”
        String context = idxSet.stream()
                .map(docs::get)
                .collect(Collectors.joining("\n---\n"));
        String prompt = "ä»¥ä¸‹æ˜¯ç›¸å…³çŸ¥è¯†ç‰‡æ®µï¼š\n" + context + "\nè¯·åŸºäºè¿™äº›å†…å®¹å›ç­”é—®é¢˜ï¼šâ€œ" + q + "â€";

        // 8. è°ƒç”¨ ChatClient ç”Ÿæˆå›ç­”
        var response = chatClient
                .prompt()
                .system("ä½ æ˜¯ä¸€ä¸ªçŸ¥è¯†åŠ©æ‰‹ï¼Œè¯·ç»“åˆä¸Šä¸‹æ–‡è¿›è¡Œå›ç­”")
                .user(prompt)
                .call();

        // è¿”å›å¤§æ¨¡å‹çš„å›ç­”ç»“æœ
        return response.content();
    }

    // è¾…åŠ©ç±»ï¼šè®°å½• index ä¸ ç›¸ä¼¼åº¦
    static class IndexSim {
        int index;// æ–‡æ¡£ç´¢å¼•
        double sim;// ç›¸ä¼¼åº¦
        IndexSim(int index, double sim) {
            this.index = index;
            this.sim = sim;
        }
    }

    // ä½™å¼¦ç›¸ä¼¼åº¦å®ç°
    // è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œæ•°å€¼èŒƒå›´åœ¨ [-1, 1] ä¹‹é—´
    // ç›¸ä¼¼åº¦è¶Šé«˜ï¼Œè¶Šæ¥è¿‘1ï¼Œè¶Šæ¥è¿‘0ï¼Œè¶Šä¸ç›¸ä¼¼
    private double cosineSimilarity(float[] a, float[] b) {
        double dot = 0, na = 0, nb = 0;
        for (int i = 0; i < a.length; i++) {
            dot += a[i] * b[i];
            na += a[i] * a[i];
            nb += b[i] * b[i];
        }
        return dot / (Math.sqrt(na) * Math.sqrt(nb));
    }
}
```

åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œä½¿ç”¨äº† `TextReader` æ¥è¯»å–æ–‡æ¡£å†…å®¹ï¼Œå¹¶é€šè¿‡ `TokenTextSplitter` æŒ‡å®šäº†æ–‡æœ¬æ‹†åˆ†è§„åˆ™ï¼Œç›¸æ¯”ä¸Šä¸ªæ¡ˆä¾‹ï¼Œæ–‡æ¡£åˆ†æ®µé€»è¾‘å¾—åˆ°äº†æ”¹è¿›ã€‚å…·ä½“æ”¹è¿›ç‚¹å¦‚ä¸‹ï¼š

1. **æ–‡æ¡£åˆ†æ®µé€»è¾‘ä¼˜åŒ–**
    `TokenTextSplitter` é€šè¿‡ **token** æ•°é‡è¿›è¡Œæ‹†åˆ†ï¼Œè®¾ç½®äº†æœ€å¤§å€¼ä¸º **800ä¸ªtoken**ã€‚è¿™ç¡®ä¿äº†æ¯ä¸ªåˆ‡ç‰‡ä¸ä¼šè¶…è¿‡æ¨¡å‹çš„è¾“å…¥é™åˆ¶ï¼ŒåŒæ—¶å…è®¸é€‚å½“çš„ **overlap**ï¼ˆé‡å ï¼‰ï¼Œä»¥å¢å¼ºä¸Šä¸‹æ–‡è¿è´¯æ€§ã€‚
2. **ç›¸ä¼¼åº¦æ¯”å¯¹ä¸ä¸Šä¸‹æ–‡è·å–**
    åœ¨ç”¨æˆ·è¾“å…¥é—®é¢˜åï¼Œç³»ç»Ÿä¼šè¿›è¡Œ **å‘é‡ç›¸ä¼¼åº¦æ¯”å¯¹**ã€‚ä¸ºäº†ä¼˜åŒ–è¿”å›çš„çŸ¥è¯†ç‰‡æ®µï¼Œä»£ç ä¸­åŠ å…¥äº† **0.05çš„ç›¸ä¼¼åº¦é˜ˆå€¼**ï¼ŒåŸºäºæ­¤é˜ˆå€¼ï¼Œç³»ç»Ÿä»…è·å– **Top 5ç›¸å…³ç‰‡æ®µ**ï¼ŒåŒæ—¶ç¡®ä¿è¿™äº›ç‰‡æ®µçš„å‰åç›¸é‚»ç‰‡æ®µä¹Ÿè¢«åŒ…å«åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Œäº¤ç”±æ¨¡å‹ç»„ç»‡å›å¤ï¼Œè¿›ä¸€æ­¥æå‡å›ç­”çš„å‡†ç¡®æ€§å’Œè¿è´¯æ€§ã€‚
3. **å­—ç¬¦æ•°ä¸tokenæ•°çš„ç»“åˆ**
   - `.withChunkSize(800)`ï¼šè¿™è¡¨ç¤ºæ¯ä¸ªchunkçš„ **tokenæ•°æœ€å¤šä¸º800**ï¼Œä¿è¯æ¯æ®µæ–‡æœ¬ä¸ä¼šè¶…å‡ºæ¨¡å‹è¾“å…¥é™åˆ¶ã€‚
   - `.withMinChunkSizeChars(400)`ï¼šè¯¥è®¾ç½®ç”¨äºåˆå¹¶ç­–ç•¥ã€‚å¦‚æœåˆå¹¶åçš„æ–‡æœ¬é•¿åº¦å°äº **400ä¸ªå­—ç¬¦**ï¼Œç³»ç»Ÿä¼šå°è¯•å°†è¯¥æ®µæ–‡æœ¬ä¸ä¸‹ä¸€æ®µåˆå¹¶ï¼Œç¡®ä¿æ¯ä¸ªç‰‡æ®µè‡³å°‘æ»¡è¶³æœ€å°å­—ç¬¦æ•°è¦æ±‚ã€‚

é€šè¿‡è¿™äº›ä¼˜åŒ–ï¼Œæ–‡æ¡£çš„åˆ‡åˆ†æ›´åŠ çµæ´»ï¼ŒåŒæ—¶é¿å…äº†è¶…é•¿æ–‡æœ¬å¯¼è‡´çš„ä¸Šä¸‹æ–‡ä¸¢å¤±å’Œæ¨¡å‹è¾“å…¥è¶…é™çš„é—®é¢˜ã€‚

**4) å‡†å¤‡ControlleråŠå¯¹åº”æ–¹æ³•**

åœ¨â€œSpringAIEmbeddingâ€é¡¹ç›®ä¸­åˆ›å»ºcontroller/RagController.javaæ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š

```java
@Autowired
private RagService2 ragService2;

@GetMapping("/ask2")
public Map<String, String> ask2(@RequestParam("question") String question) {
    String answer = ragService2.answer(question);
    return Map.of("question", question, "answer", answer);
}
```

**5) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

é‡æ–°å¯åŠ¨â€œSpringAIEmbeddingâ€é¡¹ç›®ï¼Œç„¶åæµè§ˆå™¨è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡ŒRAGæœ¬åœ°çŸ¥è¯†åº“æ£€ç´¢æµ‹è¯•:

```java
http://localhost:8080/rag/ask2?question=å¤ä»£è¯—æ­Œå¸¸ç”¨æ„è±¡æœ‰å“ªäº›ï¼Ÿ
```

å¯ä»¥çœ‹åˆ°ç­”æ¡ˆå¦‚ä¸‹ï¼Œæœ¬æ¬¡ç»è¿‡ä¼˜åŒ–çš„RAGæœ¬åœ°çŸ¥è¯†åº“æ£€ç´¢å›å¤æ¯”è¾ƒå…¨é¢ï¼š

![a7cdef5fef5e42caacc363a27533f088](img\a7cdef5fef5e42caacc363a27533f088.jpg)

## ğŸ“Š 2.3. **Image Models**

Spring çš„å›¾åƒæ¨¡å‹ API æ—¨åœ¨æä¾›ä¸€ä¸ªç®€å•ä¸”å¯ç§»æ¤çš„æ¥å£ï¼Œç”¨äºä¸å„ç§ä¸“æ³¨äºå›¾åƒç”Ÿæˆçš„ AI æ¨¡å‹äº¤äº’ã€‚è¯¥ API å…è®¸å¼€å‘è€…åœ¨ä¸åŒçš„å›¾åƒæ¨¡å‹ä¹‹é—´åˆ‡æ¢æ—¶ï¼Œä»…éœ€åšæœ€å°çš„ä»£ç ä¿®æ”¹ã€‚

Spring AIé€šè¿‡é…å¥—ç±»å¦‚ ImagePromptï¼ˆç”¨äºå°è£…è¾“å…¥ï¼‰å’Œ ImageResponseï¼ˆç”¨äºå¤„ç†è¾“å‡ºï¼‰ï¼Œå›¾åƒæ¨¡å‹ API å®ç°äº†ä¸å›¾åƒç”Ÿæˆ AI æ¨¡å‹ä¹‹é—´é€šä¿¡çš„ç»Ÿä¸€åŒ–ï¼Œå‘å¼€å‘è€…æä¾›ç›´æ¥ç®€æ´çš„ API æ¥å£æ¥è°ƒç”¨å›¾åƒç”ŸæˆåŠŸèƒ½ã€‚

### ğŸ§‘â€ğŸ’» **Image Modelsæ¡ˆä¾‹-ç”Ÿæˆå›¾ç‰‡**

å¦‚ä¸‹åœ¨Spring AI ä¸­ä½¿ç”¨æ™ºæ™®AIæ¥ç”Ÿæˆå›¾ç‰‡ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤å®ç°ã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå‘½åä¸ºâ€œSpringAIImageâ€**

![5bd390a5594d446f83f9f53f8e2285d9](img\5bd390a5594d446f83f9f53f8e2285d9.jpg)

![8249333e26844bfaa0408d9349addbc7](img\8249333e26844bfaa0408d9349addbc7.jpg)

**2) é…ç½®é¡¹ç›®pom.xml**

pom.xmlå†…å®¹å¦‚ä¸‹ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIImage</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIImage</name>
    <description>SpringAIImage</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>


    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-zhipuai</artifactId>
        </dependency>
    </dependencies>

    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

ç‰¹åˆ«æ³¨æ„ï¼šéœ€è¦åœ¨â€œSpringAIImageâ€é¡¹ç›®çš„pom.xmlä¸­å¯¼å…¥â€œspring-ai-starter-model-zhipuaiâ€ä¾èµ–ã€‚

**3) é…ç½®resources/application.properties**

```properties
spring.application.name=SpringAIImage


#ä½¿ç”¨ æ™ºæ™®AI Image æ¨¡å‹ï¼Œéœ€è¦åœ¨pom.xmlä¸­å¼•å…¥å¯¹åº”ä¾èµ–
spring.ai.zhipuai.api-key=ddd2557084494c46ss6xxxGFUGA4
spring.ai.zhipuai.base-url=https://open.bigmodel.cn/api/paas
# CogView-3-Flash ä¸ºå…è´¹å›¾åƒç”Ÿæˆæ¨¡å‹ï¼Œå…¶ä»–æ¨¡å‹éœ€è¦ä»˜è´¹ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼šhttps://www.bigmodel.cn/pricing
spring.ai.zhipuai.image.options.model=CogView-3-Flash
```

**4) åˆ›å»ºServiceåŒ…å¹¶åˆ›å»ºImageServiceç±»**

åœ¨â€œSpringAIImageâ€é¡¹ç›®ä¸­åˆ›å»ºâ€œserviceâ€åŒ…ï¼Œåœ¨è¯¥åŒ…ä¸‹ç¼–å†™â€œImageService.javaâ€ç±»ï¼Œè¯¥ç±»ä¸­å®ç°generateImageæ–¹æ³•æ¥å°†ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹é€šè¿‡æ™ºæ™®AI Imageæ¨¡å‹ç”Ÿæˆå›¾ç‰‡ã€‚

```java
package com.example.springaiimage.service;

import org.springframework.ai.image.*;
import org.springframework.ai.zhipuai.ZhiPuAiImageModel;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class ImageService {
    @Autowired
    private ZhiPuAiImageModel imageModel;

    public Image generateImage(String prompt) {
        ImageOptions options = ImageOptionsBuilder.builder()
                //.model("cogview-3")
                .N(1) // ç”Ÿæˆçš„å›¾ç‰‡æ•°é‡
                .width(512) // å›¾ç‰‡å®½åº¦
                .height(512)// å›¾ç‰‡é«˜åº¦
                .build();

        // åˆ›å»º ImagePrompt å¯¹è±¡ï¼Œç”¨äºå°è£…æœ¬æ¬¡å›¾åƒç”Ÿæˆè¯·æ±‚
        ImagePrompt ip = new ImagePrompt(
                java.util.List.of(new org.springframework.ai.image.ImageMessage(prompt)),
                options
        );

        //è°ƒç”¨ ZhiPuAiImageModel çš„ call() æ–¹æ³•ï¼Œä¼ å…¥ ImagePrompt
        ImageResponse resp = imageModel.call(ip);
        System.out.println("è¿”å›å›¾ç‰‡ä¿¡æ¯"+resp.getResult().getOutput());
        return resp.getResult().getOutput();
    }
}
```

**5) åˆ›å»ºControlleråŒ…å¹¶åˆ›å»ºImageControllerç±»**

åœ¨â€œSpringAIImageâ€é¡¹ç›®ä¸­åˆ›å»ºâ€œcontrollerâ€åŒ…ï¼Œåœ¨è¯¥åŒ…ä¸‹ç¼–å†™â€œImageController.javaâ€ç±»ï¼Œè¯¥ç±»ä¸­å®ç°genRedirectæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå°†ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹è°ƒç”¨ImageService.generateImageæ–¹æ³•ç”Ÿæˆå›¾ç‰‡ï¼Œå¹¶å°†è¯¥å›¾ç‰‡çš„urlè¿”å›ç»™æµè§ˆå™¨è¿›è¡Œé‡å®šå‘ã€‚

```java
package com.example.springaiimage.controller;

import jakarta.servlet.http.HttpServletResponse;
import org.springframework.ai.image.*;
import com.example.springaiimage.service.ImageService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.io.IOException;
import java.util.Map;

@RestController
@RequestMapping("/ai")
public class ImageController {
    @Autowired
    private ImageService svc;

    @GetMapping("/generateImage")
    public void genRedirect(
            @RequestParam(value = "prompt", defaultValue = "ç”»ä¸€åªå°ç‹—") String prompt,
            HttpServletResponse response
    ) throws IOException {
        //è°ƒç”¨serviceç”Ÿæˆå›¾ç‰‡ Image å¯¹è±¡
        Image image = svc.generateImage(prompt);
        //è·å–å›¾ç‰‡çš„url
        String url = image.getUrl();
        //ç›´æ¥å°†æµè§ˆå™¨é‡å®šå‘åˆ°è¯¥URL
        if (url == null) {
            response.sendError(HttpServletResponse.SC_NOT_FOUND, "å›¾ç‰‡ç”Ÿæˆå¤±è´¥");
        } else {
            // ç›´æ¥é‡å®šå‘ï¼Œæµè§ˆå™¨ä¼šå»åŠ è½½è¯¥ URL å¹¶å±•ç¤ºå›¾åƒ
            response.sendRedirect(url);
        }
    }

}
```

**6) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥â€œhttp://localhost:8080/ai/generateImage?prompt=ä¸¤ä¸ªä¸­å›½ç¾å¥³â€ï¼Œå¯ä»¥çœ‹åˆ°é¡¹ç›®è¿”å›å›¾ç‰‡å†…å®¹å¦‚ä¸‹ï¼š

```json
è¿”å›å›¾ç‰‡ä¿¡æ¯Image{url='https://aigc-files.bigmodel.cn/api/cogview/202506181536164147c44d280d478f_0.png', b64Json='null'}
```

æµè§ˆå™¨é‡å®šå‘æ˜¾ç¤ºå›¾ç‰‡å¦‚ä¸‹ï¼š

![ce46cdbb8f784c5793ebacec150b42e8](img\ce46cdbb8f784c5793ebacec150b42e8.jpg)

## ğŸŒ 2.4. **Audio Models**

### ğŸ§© 1. **Spring AI - éŸ³é¢‘æ¨¡å‹ï¼ˆAudio Modelsï¼‰**

**Spring AI** ä¸­çš„ **éŸ³é¢‘æ¨¡å‹**ï¼ˆAudio Modelsï¼‰åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š

1. **æ–‡æœ¬è½¬è¯­éŸ³**ï¼ˆText-to-Speechï¼ŒTTSï¼‰
2. **éŸ³é¢‘è½¬æ–‡å­—**ï¼ˆTranscriptionï¼‰

ç›®å‰ï¼Œè¿™ä¸¤éƒ¨åˆ†çš„åŠŸèƒ½ä¸»è¦ä¾èµ–äº **OpenAI** æä¾›çš„æ¨¡å‹ï¼š

- **æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰**ï¼šé€šè¿‡ OpenAI æä¾›çš„ **TTS æ¨¡å‹**ï¼ˆå¦‚ `tts-1` å’Œ `tts-1-hd`ï¼‰å°†æ–‡æœ¬è½¬æ¢ä¸ºè¯­éŸ³ã€‚
- **éŸ³é¢‘è½¬æ–‡å­—**ï¼šé€šè¿‡ OpenAI çš„ **Whisper-1 æ¨¡å‹** å°†éŸ³é¢‘è½¬æ¢ä¸ºæ–‡å­—ã€‚

è¿™ä¸¤ä¸ªåŠŸèƒ½éƒ½é€šè¿‡ **ç»Ÿä¸€é…ç½®**ã€**Beanè‡ªåŠ¨æ³¨å…¥**ã€**åŒæ­¥/æµå¼è°ƒç”¨æ–¹å¼** æä¾›æ˜“ç”¨ã€å¯æ‰©å±•çš„ API æ¥å£ï¼Œç¡®ä¿å¼€å‘è€…åœ¨ä¸åŒåº”ç”¨åœºæ™¯ä¸‹çš„é«˜æ•ˆé›†æˆã€‚

#### ğŸ§‘â€ğŸ’» **ä¸»è¦ç‰¹ç‚¹ï¼š**

1. **ç»Ÿä¸€çš„é…ç½®å’Œæ˜“ç”¨æ¥å£**
    Spring AI æä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡é…ç½®å’Œè‡ªåŠ¨æ³¨å…¥æ–¹å¼è½»æ¾é›†æˆéŸ³é¢‘è½¬åŒ–åŠŸèƒ½ã€‚
2. **åŒæ­¥å’Œæµå¼è°ƒç”¨**
    API æ¥å£æ”¯æŒ **åŒæ­¥** å’Œ **æµå¼** è°ƒç”¨ï¼Œæ»¡è¶³ä¸åŒéœ€æ±‚ï¼Œé€‚åº”äºå¤šç§ä½¿ç”¨åœºæ™¯ã€‚
3. **çµæ´»æ€§ä¸æ‰©å±•æ€§**
    é€šè¿‡ Spring çš„çµæ´»æ¶æ„ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®éœ€æ±‚æ‰©å±•æ›´å¤šçš„éŸ³é¢‘å¤„ç†åŠŸèƒ½ï¼Œå¿«é€Ÿé€‚åº”ä¸åŒä¸šåŠ¡éœ€æ±‚ã€‚

#### ğŸŒ **API Key è·å–ä¸è´¹ç”¨**

- **API Key è·å–**ï¼š
   OpenAI çš„ **API Key** å¯ä»¥é€šè¿‡ OpenAI å®˜ç½‘è´­ä¹°ï¼ˆæ³¨æ„ï¼šåœ¨å›½å†…è´­ä¹°å¯èƒ½å­˜åœ¨å°å·é£é™©ï¼‰ã€‚æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŸå®æœç´¢ï¼Œè´­ä¹°å•†å®¶æä¾›çš„ä¸­è½¬ **API Key**ï¼Œç»§ç»­ä½¿ç”¨ OpenAI çš„ç›¸å…³æ¨¡å‹ã€‚
- **è´¹ç”¨é—®é¢˜**ï¼š
   ä½¿ç”¨ OpenAI ä¸­çš„è¯­éŸ³è½¬æ¢ç›¸å…³æ¨¡å‹ï¼ˆå¦‚ TTS å’Œ Whisper-1ï¼‰ç›¸å¯¹è¾ƒè´µã€‚å…·ä½“è´¹ç”¨æ ‡å‡†ï¼Œå¯ä»¥å‚è€ƒ OpenAI å®˜æ–¹çš„ä»·æ ¼é¡µé¢ï¼š[OpenAI Pricing](https://platform.openai.com/docs/pricing?utm_source=chatgpt.com)ã€‚

#### ğŸ§© **æ³¨æ„äº‹é¡¹ï¼š**

- **å°å·é£é™©**ï¼šå›½å†…ç”¨æˆ·ä½¿ç”¨ OpenAI API æ—¶éœ€æ³¨æ„å¯èƒ½å­˜åœ¨å°å·é£é™©ï¼Œå› æ­¤å»ºè®®é€‰æ‹©å¯é çš„ä»£ç†å•†æä¾›çš„ API Keyã€‚
- **è´¹ç”¨è€ƒé‡**ï¼šåœ¨å¼€å‘æ—¶ï¼Œéœ€å……åˆ†è€ƒè™‘ä½¿ç”¨ OpenAI ç›¸å…³æ¨¡å‹çš„è´¹ç”¨ï¼Œç¡®ä¿åœ¨é¢„ç®—å†…åˆç†ä½¿ç”¨ã€‚

![f1b5256354b6428bbd01ebba736192eb](img\f1b5256354b6428bbd01ebba736192eb.jpg)

### ğŸ” **2. æ–‡æœ¬è½¬è¯­éŸ³**

Spring AI æŠ½è±¡å‡º SpeechModel æ¥å£è¿›è¡Œå…¼å®¹æœªæ¥å¤šç§æ¨¡å‹ä¾›åº”å•†ï¼Œä»¥ä¾¿è¿›è¡Œæ–‡æœ¬è½¬è¯­éŸ³ã€‚ç›®å‰è¯¥æ¥å£ä»…æœ‰OpenAiAudioSpeechModelä¸€ä¸ªå®ç°ç±»ï¼Œåªèƒ½ä½¿ç”¨Open AIä¸­tts-1 æˆ–è€… tts-1-hd æ¨¡å‹è¿›è¡Œæ–‡æœ¬è½¬è¯­éŸ³æ“ä½œã€‚

å¦‚ä¸‹æ¡ˆä¾‹ä¸­åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå¹¶æ„å»ºå¯¹åº”Controllerå’ŒServiceå®ç°æ–‡æœ¬è½¬è¯­éŸ³æ“ä½œã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå‘½åä¸ºâ€œSpringAIAudioâ€**

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/b76db854fbb0499aae5f8e1f8551d9fe.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/6acfb0080af54650a3c409fec1e5690b.jpg)

**2) é…ç½®é¡¹ç›®pom.xml**

pom.xmlå†…å®¹å¦‚ä¸‹ï¼š

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIAudio</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIAudio</name>
    <description>SpringAIAudio</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-openai</artifactId>
        </dependency>
    </dependencies>

    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

ç‰¹åˆ«æ³¨æ„ï¼šéœ€è¦åœ¨â€œSpringAIAudioâ€é¡¹ç›®çš„pom.xmlä¸­å¯¼å…¥â€œspring-ai-starter-model-openaiâ€ä¾èµ–ã€‚

**3) é…ç½®resources/application.properties**

```
spring.application.name=SpringAIAudio

#æ–‡æœ¬è½¬è¯­éŸ³æ–‡ä»¶å­˜æ”¾çš„è·¯å¾„
tts.audio-output-dir=D:\\idea_space\\SpringAICode\\SpringAIAudio\\src\\main\\audio-output

#ä½¿ç”¨ Open AI ç›¸å…³æ¨¡å‹ï¼Œå®ç°æ–‡å­—è½¬è¯­éŸ³åŠŸèƒ½ã€è¯­éŸ³è½¬æ–‡å­—åŠŸèƒ½
spring.ai.openai.base-url=https://api.uchat.site/
spring.ai.openai.api-key=sk-...8A

#ä½¿ç”¨ Open AI ç›¸å…³æ¨¡å‹ï¼Œå®ç°æ–‡å­—è½¬è¯­éŸ³åŠŸèƒ½
spring.ai.openai.audio.speech.options.model=tts-1
#æŒ‡å®šåˆæˆçš„è¯­éŸ³ï¼Œå¯ä»¥è®¾ç½®ä¸ºalloy, echo, fable, onyx, nova å’Œ shimmer
spring.ai.openai.audio.speech.options.voice=alloy
```

æ³¨æ„ï¼šâ€œtts.audio-output-dirâ€é…ç½®é¡¹ä¸ºç”¨æˆ·è‡ªå®šä¹‰é…ç½®å‚æ•°ï¼ŒæŒ‡å®šçš„ç›®å½•ç”¨äºå­˜å‚¨ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶ã€‚

**4) åˆ›å»ºServiceåŒ…å¹¶åˆ›å»ºTtsServiceç±»**

åœ¨â€œSpringAIAudioâ€é¡¹ç›®ä¸­åˆ›å»ºâ€œserviceâ€åŒ…ï¼Œåœ¨è¯¥åŒ…ä¸‹ç¼–å†™â€œTtsService.javaâ€ç±»ï¼Œè¯¥ç±»ä¸­å®ç°textToFileæ–¹æ³•æ¥å°†ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬è½¬æ¢æˆmp3æ–‡ä»¶å­˜å…¥é…ç½®çš„ç›®å½•ä¸­ã€‚

```
import org.springframework.ai.openai.OpenAiAudioSpeechModel;
import org.springframework.ai.openai.OpenAiAudioSpeechOptions;
import org.springframework.ai.openai.api.OpenAiAudioApi;
import org.springframework.ai.openai.audio.speech.SpeechPrompt;
import org.springframework.ai.openai.audio.speech.SpeechResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;

@Service
public class TtsService {

    // æ³¨å…¥ OpenAI çš„è¯­éŸ³æ¨¡å‹å¯¹è±¡
    @Autowired
    private OpenAiAudioSpeechModel speechModel;

    // ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–è¯­éŸ³è¾“å‡ºç›®å½•
    @Value("${tts.audio-output-dir}")
    private String audioOutputDir;

    /**
     * å°†æ–‡æœ¬è½¬æ¢ä¸º MP3 æ–‡ä»¶å¹¶ä¿å­˜åˆ°é…ç½®çš„ç›®å½•ï¼Œè¿”å›æ–‡ä»¶è·¯å¾„
     */
    public String textToFile(String text) throws IOException {
        // æ„å»ºè¯­éŸ³åˆæˆçš„é…ç½®é¡¹
        OpenAiAudioSpeechOptions options = OpenAiAudioSpeechOptions.builder()
                //.model("tts-1")
                .voice(OpenAiAudioApi.SpeechRequest.Voice.ALLOY) // ä½¿ç”¨ alloy å£°éŸ³
                .responseFormat(OpenAiAudioApi.SpeechRequest.AudioResponseFormat.MP3) // éŸ³é¢‘æ ¼å¼ä¸º mp3
                .speed(1.0f)// è®¾ç½®è¯­é€Ÿä¸º 1.0ï¼ˆæ­£å¸¸é€Ÿåº¦ï¼‰
                .build();

        // åˆ›å»ºè¯­éŸ³è¯·æ±‚æç¤ºå¯¹è±¡
        SpeechPrompt prompt = new SpeechPrompt(text, options);
        // è°ƒç”¨æ¨¡å‹ç”Ÿæˆè¯­éŸ³
        SpeechResponse response = speechModel.call(prompt);

        System.out.println("response: " + response);

        // è·å–éŸ³é¢‘äºŒè¿›åˆ¶å†…å®¹
        byte[] audio = response.getResult().getOutput();

        // ä½¿ç”¨é…ç½®çš„ç›®å½•ä¿å­˜æ–‡ä»¶
        File dir = new File(audioOutputDir);

        // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
        if (!dir.exists()) {
            dir.mkdirs();
        }

        // åˆ›å»ºè¾“å‡ºæ–‡ä»¶åï¼Œä½¿ç”¨å½“å‰æ—¶é—´æˆ³é˜²æ­¢é‡å¤
        File out = new File(dir, "tts-" + System.currentTimeMillis() + ".mp3");

        // å°†éŸ³é¢‘å†…å®¹å†™å…¥æ–‡ä»¶
        try (FileOutputStream fos = new FileOutputStream(out)) {
            fos.write(audio);
        }

        // è¿”å›ç”Ÿæˆçš„æ–‡ä»¶å®Œæ•´è·¯å¾„
        return out.getAbsolutePath();
    }
}
```

**5) åˆ›å»ºControlleråŒ…å¹¶åˆ›å»ºTtsControllerç±»**

åœ¨â€œSpringAIAudioâ€é¡¹ç›®ä¸­åˆ›å»ºâ€œcontrollerâ€åŒ…ï¼Œåœ¨è¯¥åŒ…ä¸‹ç¼–å†™â€œTtsController.javaâ€ç±»ï¼Œè¯¥ç±»ä¸­å®ç°ttsæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå°†ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹è°ƒç”¨TtsService.textToFileæ–¹æ³•è½¬æ¢æˆè¯­éŸ³æ–‡ä»¶ã€‚

```
import com.example.springaiaudio.service.TtsService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.io.IOException;

@RestController
@RequestMapping("/ai")
public class TtsController {
    @Autowired
    private TtsService ttsService;

    @GetMapping("/tts")
    public ResponseEntity<String> tts(@RequestParam("text") String text) {
        try {
            String filePath = ttsService.textToFile(text);
            return ResponseEntity.ok("æ–‡æœ¬è½¬è¯­éŸ³æˆåŠŸï¼Œæ–‡ä»¶ä¿å­˜è·¯å¾„ï¼š" + filePath);
        } catch (IOException e) {
            return ResponseEntity.status(500).body("æ–‡æœ¬è½¬è¯­éŸ³å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

**6) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥â€œhttp://localhost:8080/ai/tts?text=åœ¨è¿™ä¸ªä¿¡æ¯åŒ–æ—¶ä»£ï¼Œäººå·¥æ™ºèƒ½æŠ€æœ¯æ·±åˆ»åœ°æ”¹å˜ç€æˆ‘ä»¬çš„ç”Ÿæ´»æ–¹å¼å’Œå·¥ä½œæ¨¡å¼ã€‚â€ï¼Œå¯ä»¥çœ‹åˆ°é¡¹ç›®è¿”å›å†…å®¹å¦‚ä¸‹ï¼š

```
æ–‡æœ¬è½¬è¯­éŸ³æˆåŠŸï¼Œæ–‡ä»¶ä¿å­˜è·¯å¾„ï¼šD:\idea_space\SpringAICode\SpringAIAudio\src\main\audio-output\tts-1750sss224.mp3
```

æ£€æŸ¥å¯¹åº”çš„ç›®å½•æ‰¾åˆ°è½¬æ¢çš„mp3æ’­æ”¾åå¯ä»¥å¬åˆ°å¯¹åº”è¾“å…¥çš„æ–‡å­—å·²ç»è¢«è½¬æ¢æˆè¯­éŸ³ã€‚

### ğŸ§³ **3. éŸ³é¢‘è½¬æ–‡å­—**

Spring AI æä¾›äº†OpenAiAudioTranscriptionModelç±»å®ç°é€šè¿‡Open AI çš„Whisper æ¨¡å‹å°†éŸ³é¢‘è½¬æ¢æˆæ–‡å­—ï¼Œè¾“å‡ºçš„æ ¼å¼å¯ä»¥ä¸ºjson, text, srt, verbose_json, vttã€‚

å¦‚ä¸‹æ¡ˆä¾‹ä¸­åœ¨â€œSpringAIAudioâ€é¡¹ç›®ä¸­åˆ›å»ºå¯¹åº”Controllerå’ŒServiceå®ç°è¯­éŸ³è½¬æ–‡å­—æ“ä½œã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®**

è¿™é‡Œä½¿ç”¨â€œSpringAIAudioâ€é¡¹ç›®ï¼Œæ— éœ€é‡æ–°åˆ›å»ºã€‚

**2) é…ç½®resources/application.properties**

åœ¨resources/application.propertiesæ–‡ä»¶ä¸­è¿½åŠ äº†â€œè¯­éŸ³è½¬æ–‡å­—â€çš„whisperæ¨¡å‹ï¼š

```properties
spring.application.name=SpringAIAudio

#æ–‡æœ¬è½¬è¯­éŸ³æ–‡ä»¶å­˜æ”¾çš„è·¯å¾„
tts.audio-output-dir=D:\\idea_space\\SpringAICode\\SpringAIAudio\\src\\main\\audio-output

#ä½¿ç”¨ Open AI ç›¸å…³æ¨¡å‹ï¼Œå®ç°æ–‡å­—è½¬è¯­éŸ³åŠŸèƒ½ã€è¯­éŸ³è½¬æ–‡å­—åŠŸèƒ½
spring.ai.openai.base-url=https://api.uchat.site/
spring.ai.openai.api-key=sk-xxx...P1HwVlJDjAQDACCPx8A

#ä½¿ç”¨ Open AI ç›¸å…³æ¨¡å‹ï¼Œå®ç°æ–‡å­—è½¬è¯­éŸ³åŠŸèƒ½
spring.ai.openai.audio.speech.options.model=tts-1
#æŒ‡å®šåˆæˆçš„è¯­éŸ³ï¼Œå¯ä»¥è®¾ç½®ä¸ºalloy, echo, fable, onyx, nova å’Œ shimmer
spring.ai.openai.audio.speech.options.voice=alloy

#ä½¿ç”¨ Open AI ç›¸å…³æ¨¡å‹ï¼Œå®ç°è¯­éŸ³è½¬æ–‡å­—åŠŸèƒ½
spring.ai.openai.audio.transcription.options.model=whisper-1
```

æ³¨æ„ï¼šâ€œtts.audio-output-dirâ€é…ç½®é¡¹ä¸ºç”¨æˆ·è‡ªå®šä¹‰é…ç½®å‚æ•°ï¼ŒæŒ‡å®šçš„ç›®å½•ä¸­å­˜å‚¨ä¹‹å‰ç”Ÿæˆçš„mp3éŸ³é¢‘æ–‡ä»¶ã€‚

**3) åˆ›å»ºServiceåŒ…å¹¶åˆ›å»ºTranscribeServiceç±»**

åœ¨â€œSpringAIAudioâ€é¡¹ç›®ä¸­åˆ›å»ºâ€œserviceâ€åŒ…ï¼Œåœ¨è¯¥åŒ…ä¸‹ç¼–å†™â€œTranscribeService.javaâ€ç±»ï¼Œè¯¥ç±»ä¸­å®ç°transcribeFromFileæ–¹æ³•æ¥å°†mp3éŸ³é¢‘æ–‡ä»¶è½¬æ¢æˆæ–‡å­—ã€‚

```java
import org.springframework.ai.audio.transcription.AudioTranscriptionPrompt;
import org.springframework.ai.audio.transcription.AudioTranscriptionResponse;
import org.springframework.ai.openai.OpenAiAudioTranscriptionModel;
import org.springframework.ai.openai.OpenAiAudioTranscriptionOptions;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.io.FileSystemResource;
import org.springframework.core.io.Resource;
import org.springframework.stereotype.Service;

import java.io.File;

@Service
public class TranscribeService {

    // æ³¨å…¥ OpenAI éŸ³é¢‘è½¬å½•æ¨¡å‹çš„å¯¹è±¡
    @Autowired
    private OpenAiAudioTranscriptionModel transcriptionModel;

    /**
     * ä»æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–é…ç½®ç›®å½•ä¸‹çš„ mp3 æ–‡ä»¶è¿›è¡Œè½¬å½•ï¼Œå¹¶è¿”å›å¯¹åº”æ–‡æœ¬
     * @param fileFullPath mp3 æ–‡ä»¶å…¨è·¯å¾„
     * @param options      è½¬å½•æ—¶çš„å¯é€‰å‚æ•°ï¼ˆè¯­è¨€ã€æ ¼å¼ç­‰ï¼‰
     * @return             è½¬å†™åçš„æ–‡å­—ç»“æœ
     */
    public String transcribeFromFile(String fileFullPath, OpenAiAudioTranscriptionOptions options) {
        // æ ¹æ®ä¼ å…¥è·¯å¾„æ„é€  File å¯¹è±¡
        File file = new File(fileFullPath);

        // æ ¡éªŒæ–‡ä»¶å­˜åœ¨ä¸”æ˜¯æ™®é€šæ–‡ä»¶ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸
        if (!file.exists() || !file.isFile()) {
            throw new IllegalArgumentException("æ–‡ä»¶ä¸å­˜åœ¨: " + file.getAbsolutePath());
        }

        // å°† File å°è£…ä¸º Resource å¯¹è±¡ï¼Œé€‚é…æ¨¡å‹è¾“å…¥
        Resource audio = new FileSystemResource(file);

        // åˆ›å»ºè½¬å½•è¯·æ±‚æç¤ºå¯¹è±¡ï¼ŒåŒ…å«éŸ³é¢‘èµ„æºå’Œè½¬å½•é€‰é¡¹
        AudioTranscriptionPrompt prompt = new AudioTranscriptionPrompt(audio, options);
        // è°ƒç”¨æ¨¡å‹å¤„ç†è¯·æ±‚ï¼Œè¿”å›å“åº”å¯¹è±¡
        AudioTranscriptionResponse resp = transcriptionModel.call(prompt);
        System.out.println("response: " + resp.toString());

        // ä»å“åº”ä¸­è·å–ç¬¬ä¸€æ¡ç»“æœçš„æ–‡å­—è¾“å‡ºå¹¶è¿”å›ï¼ˆWhisper é€šå¸¸åªè¿”å›ä¸€æ¡ï¼‰
        return resp.getResults().get(0).getOutput();
    }

}
```

**4) åˆ›å»ºControlleråŒ…å¹¶åˆ›å»ºTranscribeControllerç±»**

åœ¨â€œSpringAIAudioâ€é¡¹ç›®ä¸­åˆ›å»ºâ€œcontrollerâ€åŒ…ï¼Œåœ¨è¯¥åŒ…ä¸‹ç¼–å†™â€œTranscribeController.javaâ€ç±»ï¼Œè¯¥ç±»ä¸­å®ç°transcribeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå°†æŒ‡å®šç›®å½•ä¸‹çš„mp3æ–‡ä»¶ä¼ å…¥åˆ°TranscribeService.transcribeFromFileæ–¹æ³•å°†è¯­éŸ³è½¬æ¢æˆæ–‡æœ¬ã€‚

```java
@RestController
@RequestMapping("/ai")
public class TranscribeController {

    @Autowired
    private TranscribeService service;

    // ä»åº”ç”¨é…ç½®ä¸­è¯»å–éŸ³é¢‘ç›®å½•ï¼Œç”¨æ¥å­˜æ”¾å¾…è½¬å½•çš„ mp3 æ–‡ä»¶
    @Value("${tts.audio-output-dir}")
    private String audioOutputDir;

    // å®šä¹‰ GET ç±»å‹çš„ /ai/transcribe æ¥å£ï¼Œè¿”å›è½¬å½•ç»“æœ
    @GetMapping("/transcribe")
    public ResponseEntity<Map<String, String>> transcribe() {
        // åˆ›å»º File å¯¹è±¡ï¼ŒæŒ‡å‘é…ç½®çš„éŸ³é¢‘ç›®å½•
        File dir = new File(audioOutputDir);
        if (!dir.exists() || !dir.isDirectory()) {
            return ResponseEntity.badRequest()
                    .body(Map.of("error", "ç›®å½•ä¸å­˜åœ¨æˆ–ä¸æ˜¯æ–‡ä»¶å¤¹: " + audioOutputDir));
        }

        // åˆ—å‡ºæ‰€æœ‰åç¼€ä¸º .mp3 çš„æ–‡ä»¶
        File[] mp3Files = dir.listFiles((d, name) -> name.toLowerCase().endsWith(".mp3"));
        if (mp3Files == null || mp3Files.length == 0) {
            return ResponseEntity.ok(Map.of("message", "ç›®å½•ä¸‹æ²¡æœ‰ MP3 æ–‡ä»¶"));
        }

        // æ„å»º OpenAI è½¬å½•é€‰é¡¹ï¼šæ–‡æœ¬æ ¼å¼ã€æ¸©åº¦è®¾ä¸º 0ã€è¯­è¨€ä¸ºä¸­æ–‡ï¼ˆzhï¼‰
        OpenAiAudioTranscriptionOptions opts = OpenAiAudioTranscriptionOptions.builder()
                .responseFormat(OpenAiAudioApi.TranscriptResponseFormat.TEXT)// è®¾ç½®è¾“å‡ºä¸ºæ–‡æœ¬
                .temperature(0f)// è®¾ç½®æ¸©åº¦ä¸º 0ï¼Œå–å€¼èŒƒå›´ä¸º 0â€“1ï¼Œç¡®ä¿è¾“å‡ºç¨³å®šï¼Œè¶Šå¤§ä¸ç¡®å®šåº¦è¶Šé«˜
                .language("zh")//æŒ‡å®šä¸­æ–‡éŸ³é¢‘
                .build();

        Map<String, String> results = new HashMap<>();
        for (File f : mp3Files) {
            String relPath = f.getName();  // ä½¿ç”¨æ–‡ä»¶åä½œä¸º classpathLocation
            try {
                // è°ƒç”¨æœåŠ¡è¿›è¡Œè½¬å½•
                String text = service.transcribeFromFile(f.getAbsolutePath(), opts);
                results.put(relPath, text);
            } catch (Exception e) {
                results.put(relPath, "FAILED: " + e.getMessage());
            }
        }

        // è¿”å›æ‰€æœ‰æ–‡ä»¶çš„è½¬å½•ç»“æœ
        return ResponseEntity.ok(results);
    }
}
```

**5) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥â€œhttp://localhost:8080/ai/transcribeâ€ï¼Œå¯ä»¥çœ‹åˆ°é¡¹ç›®è¿”å›å†…å®¹å¦‚ä¸‹ï¼Œå·²ç»å°†éŸ³é¢‘æ­£ç¡®çš„è½¬æ¢æˆæ–‡å­—ã€‚

```
{
  "tts-1750xxx74224.mp3": "åœ¨è¿™ä¸ªä¿¡æ¯åŒ–æ—¶ä»£,äººå·¥æ™ºèƒ½æŠ€æœ¯æ·±åˆ»åœ°æ”¹å˜ç€æˆ‘ä»¬çš„ç”Ÿæ´»æ–¹å¼å’Œå·¥ä½œæ¨¡å¼ã€‚\n"
}
```

# 3. **Spring AIç»“åˆOllama**

Ollama æ˜¯ä¸€ä¸ªå¼€æºçš„å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¹³å°ï¼ŒOllama æä¾›äº†ç®€æ´æ˜“ç”¨çš„å‘½ä»¤è¡Œç•Œé¢å’ŒæœåŠ¡å™¨ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿè½»æ¾ä¸‹è½½ã€è¿è¡Œå’Œç®¡ç†å„ç§å¼€æº LLMï¼Œé€šè¿‡ Ollamaï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°åŠ è½½å’Œä½¿ç”¨å„ç§é¢„è®­ç»ƒçš„è¯­è¨€æ¨¡å‹ï¼Œæ”¯æŒæ–‡æœ¬ç”Ÿæˆã€ç¿»è¯‘ã€ä»£ç ç¼–å†™ã€é—®ç­”ç­‰å¤šç§è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ã€‚

ollamaå®˜ç½‘ï¼š[https://ollama.com](https://ollama.com/)

Spring AIæ”¯æŒä½¿ç”¨Ollamaç®¡ç†çš„æ¨¡å‹ï¼Œä¸‹é¢ä»‹ç»Spring AIä¸­å¦‚ä½•ä½¿ç”¨OllamaChatå’ŒOllama Embeddingsã€‚è¿™é‡Œé»˜è®¤å·²ç»å®‰è£…å¥½ollamaã€‚

## 3.1. **Ollamaä¸‹è½½ä¸å®‰è£…**

Ollamaä¸‹è½½åœ°å€:https://github.com/ollama/ollama,è¿™é‡Œä»¥windowä¸­ä¸‹è½½ä¸ºä¾‹ï¼š

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/4f9fb3960a304e4e94f2a0c6060df23d.jpg)

ä¸‹è½½å®ŒæˆååŒå‡»â€œOllamaSetup.exeâ€è¿›è¡Œå®‰è£…ï¼Œé»˜è®¤å®‰è£…åœ¨â€œC\users\{user}\AppData\Local\Programsâ€ç›®å½•ä¸‹ï¼Œå»ºè®®Cç›˜è‡³å°‘è¦æœ‰10G å‰©ä½™çš„ç£ç›˜ç©ºé—´ï¼Œå› ä¸ºåç»­Ollamaä¸­è¿˜è¦ä¸‹è½½å…¶ä»–æ¨¡å‹åˆ°ç›¸åº”ç›®å½•ä¸­ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/721db03a57724526827e50f91658c5a0.jpg)

å®‰è£…å®Œæˆåï¼Œç”µè„‘å³ä¸‹è§’è‡ªåŠ¨æœ‰â€œOllamaâ€å›¾æ ‡å¹¶å¼€æœºå¯åŠ¨ã€‚å¯ä»¥åœ¨cmdä¸­è¿è¡Œæ¨¡å‹è¿›è¡Œä¼šè¯

```
#å‘½ä»¤ ollama run +æ¨¡å‹ deepseek-r1:1.5b
ollama run deepseek-r1:1.5b
>>> ä½ æ˜¯è°ï¼Ÿ
<think>
</think>
æ‚¨å¥½ï¼æˆ‘æ˜¯ç”±ä¸­å›½çš„æ·±åº¦æ±‚ç´¢ï¼ˆDeepSeekï¼‰å…¬å¸å¼€å‘çš„æ™ºèƒ½åŠ©æ‰‹DeepSeek-R1ã€‚å¦‚æ‚¨æœ‰ä»»ä½•ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä¼šå°½æˆ‘æ‰€èƒ½ä¸ºæ‚¨æä¾›å¸®åŠ©ã€‚
>>>
```

æ³¨æ„ï¼šä½¿ç”¨runå‘½ä»¤ç¬¬ä¸€æ¬¡è¿è¡Œæ¨¡å‹ï¼Œå¦‚æœæ¨¡å‹ä¸å­˜åœ¨ä¼šè‡ªåŠ¨ä¸‹è½½ï¼Œç„¶åè¿›å…¥æ¨¡å‹äº¤äº’çª—å£ã€‚åç»­ä½¿ç”¨ä¼šè‡ªåŠ¨è¿›å…¥åˆ°äº¤äº’çª—å£ã€‚

åœ¨æµè§ˆå™¨ä¸­è¾“å…¥â€œlocalhost:11434â€å¯ä»¥è®¿é—®ollamaï¼Œè¾“å‡ºâ€œOllama is runningâ€ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒOllama æœåŠ¡ä»…ç›‘å¬æœ¬åœ°å›ç¯åœ°å€ï¼ˆ127.0.0.1ï¼‰ï¼Œè¿™æ„å‘³ç€åªæœ‰åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºæ‰èƒ½è®¿é—®è¯¥æœåŠ¡ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨â€œwindows ip:11434â€è®¿é—®ollamaéœ€è¦åœ¨ç¯å¢ƒå˜é‡ä¸­åŠ å…¥â€œOLLAMA_HOSTâ€ä¸ºâ€œ0.0.0.0â€,è¿™æ ·å°±å°† Ollama çš„ç›‘å¬åœ°å€è®¾ç½®ä¸º 0.0.0.0ï¼Œä½¿å…¶ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£ï¼ŒåŒ…æ‹¬æœ¬æœº IP åœ°å€ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/f2391be5b2dd4f28b7e1bf5fbda3173b.jpg)

æ³¨æ„ï¼šä»¥ä¸Šç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆåï¼Œéœ€è¦é‡å¯ollamaã€‚

## 3.2. **Ollama Chat**

ä¸‹é¢ä»¥Spring AIä¸­é€šè¿‡ä¸Ollamaä¸­æ¨¡å‹å¯¹è¯ä¸ºä¾‹ï¼Œæ¼”ç¤ºSpring AIç›¸å…³é…ç½®ã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå‘½åä¸ºâ€œSpringAIOllamaâ€**

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/458a6bdd6a9540969dbe10263098e99e.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/df53ca580e51473db025d6bf43c5a112.jpg)

**2) é…ç½®é¡¹ç›®pom.xml**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIOllama</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIOllama</name>
    <description>SpringAIOllama</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
   å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>


    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-ollama</artifactId>
        </dependency>

    </dependencies>

    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

**3) é…ç½®resources/application.properties**

```
spring.application.name=SpringAIOllama

server.port=8080

#é…ç½® Ollama çš„åŸºç¡€ URL å’Œä½¿ç”¨æ¨¡å‹
spring.ai.ollama.base-url=http://localhost:11434
spring.ai.ollama.chat.options.model=deepseek-r1:1.5b
spring.ai.ollama.chat.options.temperature=0.8
```

### **3.2.1. åŸºæœ¬èŠå¤©**

åœ¨â€œSpringAIOllamaâ€é¡¹ç›®ä¸­åˆ›å»ºâ€œcontrollerâ€åŒ…ï¼Œåœ¨è¯¥åŒ…ä¸‹ç¼–å†™â€œChatController.javaâ€ç±»ï¼Œå®ç°ä¸Ollamaä¸­æ¨¡å‹çš„åŸºæœ¬èŠå¤©åŠŸèƒ½ã€‚

```
import org.springframework.ai.deepseek.DeepSeekChatModel;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/ai")
public class ChatController {
    @Autowired
    private DeepSeekChatModel chatModel;

    @GetMapping("/generate")
    public String generate(@RequestParam(value = "message", defaultValue = "ç»™æˆ‘è®²ä¸ªç¬‘è¯") String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š"+message);
        String result = chatModel.call(message);
        //æ¨¡å‹è¿”å›çš„å†…å®¹
        System.out.println(result);
        return result;
    }

}
```

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥â€œhttp://localhost:8080/ai/generate?message=ä½ æ˜¯è°â€ï¼Œå¯ä»¥çœ‹åˆ°è¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š

```
æˆ‘æ˜¯DeepSeek Chatï¼Œç”±æ·±åº¦æ±‚ç´¢å…¬å¸ï¼ˆDeepSeekï¼‰å¼€å‘çš„æ™ºèƒ½AIåŠ©æ‰‹ï¼âœ¨ æˆ‘å¯ä»¥å¸®ä½ è§£ç­”é—®é¢˜ã€æä¾›å»ºè®®ã€é™ªä½ èŠå¤©ï¼Œè¿˜èƒ½å¤„ç†å„ç§æ–‡æœ¬ã€æ–‡æ¡£ç­‰å†…å®¹ã€‚æ— è®ºæ˜¯å­¦ä¹ ã€å·¥ä½œï¼Œè¿˜æ˜¯æ—¥å¸¸ç”Ÿæ´»ä¸­çš„ç–‘é—®ï¼Œéƒ½å¯ä»¥æ¥é—®æˆ‘å“¦ï¼ğŸ˜Š æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
```

### **3.2.2. Streamæµå¼èŠå¤©**

Sparing AI ä½¿ç”¨Ollamaä¸­çš„æ¨¡å‹ä¸Chat Models-deepseekéƒ¨åˆ†ä¸€æ ·ï¼Œç›´æ¥åœ¨â€œSpringAIOllamaâ€é¡¹ç›®ä¸­â€œ/controller/ChatController.javaâ€ä¸­å‡†å¤‡å¦‚ä¸‹ä»£ç å®ç°Streamæµå¼èŠå¤©ï¼š

```
//æµå¼è·å–æ¨¡å‹è¿”å›çš„å†…å®¹ï¼Œè·å–è¿”å›çš„ Text å†…å®¹
@GetMapping("/generateStream2")
public Flux<String> generateStream2(
        @RequestParam(value = "message", defaultValue = "ç»™æˆ‘è®²ä¸ªç¬‘è¯") String message,
        HttpServletResponse response) {
    // é¿å…è¿”å›ä¹±ç 
    response.setCharacterEncoding("UTF-8");

    System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š"+message);
    var prompt = new Prompt(new UserMessage(message));
    Flux<String> result = chatModel.stream(prompt)
            .map(chatResponse -> chatResponse.getResult().getOutput().getText());

    return result;
}
```

é‡æ–°å¯åŠ¨é¡¹ç›®åï¼Œå¯ä»¥åœ¨æµè§ˆå™¨è¾“å…¥â€œhttp://localhost:8080/ai/generateStream2?message=ä½ æ˜¯è°â€æŸ¥çœ‹æ¨¡å‹Streamæµå¼è¿”å›ç»“æœã€‚

### **3.2.3. è¿è¡Œæ—¶å‚æ•°è®¾ç½®**

Spring AI ä½¿ç”¨Ollamaä¸­çš„æ¨¡å¼æ—¶ä¹Ÿæ”¯æŒè¿è¡Œå‚æ•°è®¾ç½®ï¼Œå¯ä»¥åœ¨è°ƒç”¨æ¨¡å‹æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªpromptï¼Œå¹¶åµŒå…¥ä¸€ä¸ªæ–°çš„OllamaOptionsæ¥è¦†ç›–å¯åŠ¨é…ç½®ã€‚

åœ¨â€œSpringAIOllamaâ€é¡¹ç›®çš„â€œ/controller/ChatController.javaâ€ä»£ç ä¸­å‡†å¤‡å¦‚ä¸‹æ–¹æ³•ï¼š

```
//è¿è¡Œæ—¶å‚æ•°è®¾ç½®
@GetMapping("/runtimeOptions")
public String runtimeOptions(
        @RequestParam(value = "message") String message,
        @RequestParam(value = "temp", required = false) Double temp
) {
    System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š"+message);

    Prompt prompt;
    if (temp != null) {
        // æ„å»ºå¸¦ temperature çš„ DeepSeekChatOptionsï¼Œè¦†ç›–é»˜è®¤ temperature
        var opts = OllamaOptions.builder()
                .temperature(temp)
                .build();
        prompt = new Prompt(message, opts);
        System.out.println("ä½¿ç”¨è¿è¡Œæ—¶è¦†ç›– temperature=" + temp);
    } else {
        // æ—  temperature ä¼ å…¥æ—¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
        prompt = new Prompt(message);
        System.out.println("ä½¿ç”¨é»˜è®¤ temperature");
    }

    ChatResponse resp = chatModel.call(prompt);
    String result = resp.getResult().getOutput().getText();
    System.out.println("æ¨¡å‹è¿”å›ï¼š"+ result);
    return result;
}
```

ä»¥ä¸Šä»£ç ç¼–å†™å¥½åï¼Œé‡å¯é¡¹ç›®ï¼Œå¯ä»¥ä¼ å…¥ä¸åŒçš„å‚æ•°ï¼š

â€œhttp://localhost:8080/ai/runtimeOptions?message=1åŠ 1ç­‰äºå‡ &temp=0.1â€

## 3.3. **Ollama Embeddings**

Ollama Embeddings æ˜¯åŸºäº Spring AI ä¸­ EmbeddingModel æ¥å£çš„å®ç°ï¼Œä½¿ç”¨ Ollama æœ¬åœ°éƒ¨ç½²çš„æ¨¡å‹ç”Ÿæˆæ–‡æœ¬åµŒå…¥ï¼ˆembeddingsï¼‰ã€‚ä½¿ç”¨Ollam Embeddingsä½ éœ€è¦å‡†å¤‡å¦‚ä¸‹å†…å®¹ï¼š

- æœ¬åœ°å®‰è£…Ollama
- Ollamaä¸­æ‹‰å–ä¸‹è½½äº†Embeddingæ¨¡å‹

### **3.3.1. ä¸‹è½½Embeddingæ¨¡å‹**

Ollamaæ”¯æŒå¾ˆå¤šæ¨¡å‹ï¼Œå¯ä»¥é€šè¿‡â€œhttps://ollama.com/libraryâ€æŸ¥çœ‹å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨ï¼Œåœ¨æœ¬æœºOllamaè¿è¡Œ7Bæ¨¡å‹è‡³å°‘éœ€è¦8GBå†…å­˜ï¼›è¿è¡Œ13Bæ¨¡å‹è‡³å°‘éœ€è¦16Gå†…å­˜ï¼›è¿è¡Œ33Bæ¨¡å‹è‡³å°‘éœ€è¦32Gå†…å­˜ã€‚

æ³¨æ„ï¼š"7B"ã€"13B" å’Œ "33B" åˆ†åˆ«è¡¨ç¤ºæ¨¡å‹ä¸­å‚æ•°çš„æ•°é‡çº§ï¼Œåˆ†åˆ«ä¸º 70 äº¿ã€130 äº¿å’Œ 330 äº¿ä¸ªå‚æ•°ã€‚æ¨¡å‹çš„å‚æ•°æ•°é‡ç›´æ¥å½±å“å…¶å¯¹å†…å­˜çš„éœ€æ±‚ï¼Œå‚æ•°è¶Šå¤šï¼Œæ¨¡å‹è¶Šå¤æ‚ï¼Œæ‰€éœ€çš„å†…å­˜ä¹Ÿå°±è¶Šå¤§ï¼Œè¿è¡Œè¿™äº›æ¨¡å‹æ—¶ï¼Œç¡®ä¿ç³»ç»Ÿå…·æœ‰è¶³å¤Ÿçš„å†…å­˜ã€‚

è¿™é‡Œåœ¨Ollamaä¸­ä¸‹è½½â€œnomic-embed-text:latestâ€åµŒå…¥æ¨¡å‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

```
ollama pull nomic-embed-text
```

### **3.3.2. Embeddingæ¡ˆä¾‹-æŸ¥æ‰¾ç›¸ä¼¼æ–‡æœ¬**

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤å®ŒæˆOllama Embeddingæ¡ˆä¾‹ï¼Œè¯¥æ¡ˆä¾‹å’Œä¸Šä¸€ç« èŠ‚ä¸­ â€œEmbeddingæ¡ˆä¾‹1â€ä»£ç ä¸€æ ·ï¼Œåªæ˜¯æ¢æˆäº†Ollamaä¸­çš„Embeddingæ¨¡å‹ï¼Œéœ€è¦å‡†å¤‡å¦‚ä¸‹å†…å®¹ï¼š

- åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå¼•å…¥â€œspring-ai-starter-model-ollamaâ€ç›¸å…³ä¾èµ–
- åœ¨resources/application.propertiesé…ç½®ä¸­å¼•å…¥Ollamaçš„åµŒå…¥æ¨¡å‹

**1) å‡†å¤‡ServiceåŠå¯¹åº”æ–¹æ³•**

åœ¨â€œSpringAIOllamaâ€é¡¹ç›®ä¸­åˆ›å»ºâ€œserviceâ€åŒ…ï¼Œå¹¶åœ¨è¯¥åŒ…ä¸­åˆ›å»ºâ€œEmbeddingService.javaâ€ç±»ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š

```
import org.springframework.ai.embedding.EmbeddingModel;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class EmbeddingService {

    private EmbeddingModel embeddingModel;

    private final List<float[]> docVectors;

    // 1. å‡†å¤‡çŸ¥è¯†åº“æ–‡æœ¬å†…å®¹
    private final List<String> docs = List.of(
            "ç¾é£Ÿéå¸¸ç¾å‘³ï¼ŒæœåŠ¡å‘˜ä¹Ÿå¾ˆå‹å¥½ã€‚",
            "è¿™éƒ¨ç”µå½±æ—¢åˆºæ¿€åˆä»¤äººå…´å¥‹ã€‚",
            "é˜…è¯»ä¹¦ç±æ˜¯æ‰©å±•çŸ¥è¯†çš„å¥½æ–¹æ³•ã€‚"
    );

    public EmbeddingService(EmbeddingModel embeddingModel) {
        this.embeddingModel = embeddingModel;
        // 2. å¯åŠ¨æ—¶ï¼Œå°†æ‰€æœ‰æ–‡æ¡£å‘é‡åŒ–
        this.docVectors = this.embeddingModel.embed(docs);
    }

    /**
     * è¾“å…¥ç”¨æˆ·æŸ¥è¯¢ï¼Œè¿”å›æœ€ç›¸ä¼¼æ–‡æ¡£çš„ç´¢å¼• ï¼ˆä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ï¼‰
     * @param query ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢æ–‡æœ¬
     * @return æœ€ç›¸ä¼¼çš„çŸ¥è¯†åº“æ–‡æœ¬
     */
    public String queryBestMatch(String query) {
        //å°†ç”¨æˆ·çš„è¾“å…¥é€šè¿‡EmbeddingModelè½¬æ¢æˆå‘é‡
        float[] queryVec = embeddingModel.embed(query);

        int bestIdx = -1; //è®°å½•ç›®å‰æœ€åŒ¹é…æ–‡æ¡£åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ä½ç½®
        double bestSim = -1; //è®°å½•ç›®å‰çš„æœ€é«˜ç›¸ä¼¼åº¦

        // éå†æ‰€æœ‰æ–‡æ¡£å¯¹åº”çš„å‘é‡ï¼Œè®¡ç®—ä¸æŸ¥è¯¢å‘é‡çš„ç›¸ä¼¼åº¦
        for (int i = 0; i < docVectors.size(); i++) {
            //è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
            double sim = cosineSimilarity(queryVec, docVectors.get(i));
            if (sim > bestSim) {
                bestSim = sim;
                bestIdx = i;
            }
        }
        return docs.get(bestIdx);
    }

    // ä½™å¼¦ç›¸ä¼¼åº¦å®ç°
    // è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œæ•°å€¼èŒƒå›´åœ¨ [-1, 1] ä¹‹é—´
    // ç›¸ä¼¼åº¦è¶Šé«˜ï¼Œè¶Šæ¥è¿‘1ï¼Œè¶Šæ¥è¿‘0ï¼Œè¶Šä¸ç›¸ä¼¼
    private double cosineSimilarity(float[] a, float[] b) {
        double dot = 0, na = 0, nb = 0;
        for (int i = 0; i < a.length; i++) {
            dot += a[i] * b[i];
            na += a[i] * a[i];
            nb += b[i] * b[i];
        }
        return dot / (Math.sqrt(na) * Math.sqrt(nb));
    }

}
```

**2) å‡†å¤‡ControlleråŠå¯¹åº”æ–¹æ³•**

åœ¨â€œSpringAIOllamaâ€é¡¹ç›®ä¸­çš„â€œcontroller/EmbeddingController.javaâ€ç±»ä¸­æ³¨å…¥å¦‚ä¸‹ä¾èµ–å’Œå¢åŠ å¦‚ä¸‹æ–¹æ³•ï¼š

```
@Autowired
private EmbeddingService service;

//æ–‡æœ¬ç›¸ä¼¼æ£€æµ‹
@GetMapping("/similarity")
public Map<String, String> similarity(@RequestParam("query") String query) {
    String ans = service.queryBestMatch(query);
    return Map.of("query", query, "answer", ans);
}
```

**3) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨Spring Booté¡¹ç›®ï¼Œæµè§ˆå™¨ä¸­è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œç›¸ä¼¼æ–‡æœ¬æŸ¥æ‰¾ï¼ˆç”±äºEmbeddingæ¨¡å‹å¤§å°åŸå› ï¼Œå¯¼è‡´åŒ¹é…ä¸ç²¾å‡†ï¼‰ï¼š

```
#è¾“å…¥http://localhost:8080/ai/similarity?query=ç¾é£Ÿ
{
  "query": "ç¾é£Ÿ",
  "answer": "ç¾é£Ÿéå¸¸ç¾å‘³ï¼ŒæœåŠ¡å‘˜ä¹Ÿå¾ˆå‹å¥½ã€‚"
}

#è¾“å…¥http://localhost:8080/ai/similarity?query=ç”µå½±
{
  "answer": "ç¾é£Ÿéå¸¸ç¾å‘³ï¼ŒæœåŠ¡å‘˜ä¹Ÿå¾ˆå‹å¥½ã€‚",
  "query": "ç”µå½±"
}

#è¾“å…¥http://localhost:8080/ai/similarity?query=ä¹¦ç±
{
  "answer": "ç¾é£Ÿéå¸¸ç¾å‘³ï¼ŒæœåŠ¡å‘˜ä¹Ÿå¾ˆå‹å¥½ã€‚",
  "query": "ä¹¦ç±"
}
```

# 4. **Chat Client**

åœ¨å‰é¢â€œChat Modelsâ€å°èŠ‚å†…å®¹ä¸­ï¼Œæˆ‘ä»¬åœ¨ä¸å„ä¸ªæ¨¡å‹è¿›è¡Œå¯¹è¯æ—¶ä½¿ç”¨çš„æ˜¯å¯¹åº”æ¨¡å‹çš„ChatModelå¯¹è±¡ï¼Œä¾‹å¦‚ï¼šDeepSeekChatModelã€OllamaChatModelã€‚ç„¶åé€šè¿‡chatModel.call(...)ã€chatModel.stream(...)ç›´æ¥è°ƒç”¨æ¨¡å‹ï¼Œè¿™å…¶ä¸­æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ„é€ Promptã€å¤„ç†æµå“åº”ï¼ˆä¾‹å¦‚å°†è¿”å›å°è£…æˆå¯¹è±¡ã€ä»æ¨¡å‹å“åº”ä¸­è·å–å›å¤å†…å®¹ï¼‰ã€æ‹¼è£…è°ƒç”¨é“¾ï¼ˆRAGéœ€è¦è‡ªå·±æ„å»ºæµç¨‹ï¼‰ç­‰æ“ä½œã€‚

ä»¥ä¸Šä½¿ç”¨ChatModelä¸æ¨¡å‹è¿›è¡Œå¯¹è¯æ–¹å¼ä¸­ï¼Œå¦‚æœåœ¨é¡¹ç›®ä¸­ä½¿ç”¨å¤§æ¨¡å‹æ¶‰åŠåˆ°è®°å¿†ä¸Šä¸‹æ–‡ã€Promptæ¨¡ç‰ˆåŒ–ã€RAGå¼€å‘ã€è¿”å›å†…å®¹æ˜ å°„ä¸ºå®ä½“ç­‰æ“ä½œæ—¶ï¼Œå•çº¯çš„ChatModelä»£ç é‡å¾ˆå¤šï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼Œä¸ºäº†ç®€åŒ–è¿™ä¸ªæµç¨‹ï¼ŒSpring AI ä¸­æä¾›äº†ChatClientå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥çœ‹åšä¸€ä¸ªæ›´é«˜çº§çš„â€œå®¢æˆ·ç«¯ APIâ€ï¼Œå»ºç«‹åœ¨ChatModelä¹‹ä¸Šï¼Œå¯ä»¥ç”¨é“¾å¼çš„æ–¹å¼å¿«é€Ÿæ­é… Promptã€ç³»ç»Ÿè®¾å®šã€å˜é‡æ›¿æ¢ã€ä¸Šä¸‹æ–‡è®°å¿†ç­‰ï¼Œå¹¶æ”¯æŒæ–‡æœ¬/JSON/å®ä½“å¯¹è±¡ç­‰å¤šç§å½¢å¼çš„è¾“å‡ºã€‚

ChatModelå’ŒChat Clientå¯¹è±¡å¯¹æ¯”å¦‚ä¸‹ï¼š

| **æ–¹é¢**        | **ChatModel**                           | **ChatClient**                    |
| --------------- | --------------------------------------- | --------------------------------- |
| **Promptæ„å»º**  | éœ€æ‰‹åŠ¨new Prompt(...)                   | é“¾å¼.prompt().user(...)ä½¿ç”¨       |
| **æµå¼å¤„ç†**    | æ‰‹åŠ¨å¤„ç†æµå¯¹è±¡                          | .stream().content()ç®€æ´è·å–æµå†…å®¹ |
| **ä¸Šä¸‹æ–‡/è®°å¿†** | æ‰‹åŠ¨æ‹¼æ¥å†å²ä¸Šä¸‹æ–‡                      | æ”¯æŒå†…ç½®ChatMemoryå’ŒAdvisor       |
| **RAGæ¶æ„**     | éœ€è‡ªè¡Œç¼–å†™æ£€ç´¢ã€æ£€ç´¢ç»“æœæ¨è¿›æµç¨‹        | æœ‰å†…ç½®Advisoræ”¯æŒRAGç®€åŒ–          |
| **è¾“å‡ºæ˜ å°„**    | .chatResponse()åè‡ªå·±è§£æJSONæ˜ å°„åˆ°å®ä½“ | .entity(...)å¯ç›´æ¥æ˜ å°„å®ä½“ç±»      |

**ç‰¹åˆ«æ³¨æ„**ï¼šChatClient ç›®å‰åªæ”¯æŒ Chatï¼ˆå¯¹è¯ï¼‰æ¨¡å‹ï¼Œä¸åŒ…æ‹¬ Embeddingã€Imageã€Audio ç­‰å¤šæ¨¡æ€æ¨¡å‹è¦ä½¿ç”¨ Embeddingã€Image æˆ– Audio ç­‰æ¨¡å‹ï¼Œéœ€è¦ç›´æ¥ä½¿ç”¨ Spring AI æä¾›çš„å¯¹åº” APIï¼Œæ¯”å¦‚ EmbeddingModelã€ImageModelã€AudioModelã€‚

## 4.1. **ä½¿ç”¨ChatClient**

ä¸‹é¢ä»¥ä½¿ç”¨DeepSeekä¸ºä¾‹æ¥æ¼”ç¤ºSpring AIä¸­å¦‚ä½•ä½¿ç”¨ChatClientã€‚æ¶‰åŠChatClientåˆ›å»ºã€è®¾ç½®æç¤ºè¯ã€æµå¼å›å¤ã€å›å¤æ˜ å°„åˆ°å¯¹è±¡æ“ä½œã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå‘½åä¸ºâ€œSpringAIChatClientâ€**

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/35f51cc1faae44ab83022ffb4f31a82f.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/4232e7656be545609fc20ab4d1983c4d.jpg)

**2) é…ç½®é¡¹ç›®pom.xml**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIChatClient</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIChatClient</name>
    <description>SpringAIChatClient</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-deepseek</artifactId>
        </dependency>
    </dependencies>


    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

ä»¥ä¸Špom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-model-deepseekâ€ä¾èµ–ã€‚

**3) é…ç½®resources/application.properties**

```
spring.application.name=SpringAIChatClient

server.port=8080

#é…ç½® Deepseekçš„åŸºç¡€URLã€å¯†é’¥å’Œä½¿ç”¨æ¨¡å‹
spring.ai.deepseek.base-url=https://api.deepseek.com
spring.ai.deepseek.api-key=sk-...c6a821
spring.ai.deepseek.chat.options.model=deepseek-chat
```

**4) åˆ›å»ºpojoåŒ…å¹¶åˆ›å»ºStudent.javaç±»**

ç”±äºåç»­ä¸å¤§æ¨¡å‹å¯¹è¯æ—¶éœ€è¦è‡ªåŠ¨æ˜ å°„ä¸ºå®ä½“å¯¹è±¡ï¼Œè¿™é‡Œåˆ›å»ºStudent.javaç±»ï¼š

```
public class Student {
    private Long id;
    private String name;
    private Integer age;

    public Student() {}

    public Student(Long id, String name, Integer age) {
        this.id = id;
        this.name = name;
        this.age = age;
    }

    // Getter å’Œ Setter
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    public Integer getAge() { return age; }
    public void setAge(Integer age) { this.age = age; }

    @Override
    public String toString() {
        return "Student{id=" + id + ", name='" + name + "', age=" + age + "}";
    }
}
```

**5) åˆ›å»ºcontrolleråŒ…ï¼Œå¹¶åˆ›å»ºChatController.javaæ–‡ä»¶**

```
package com.example.springaichatclient.controller;

import com.example.springaichatclient.pojo.Student;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.model.ChatResponse;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import reactor.core.publisher.Flux;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/ai")
public class ChatController {

    private final ChatClient chatClient;

    public ChatController(ChatClient.Builder builder) {
        // åœ¨ controller æ„é€ å‡½æ•°ä¸­ç›´æ¥å»ºç«‹ ChatClientï¼Œ
        // å¹¶è®¾ç½®é»˜è®¤ system æç¤ºè¯
        this.chatClient = builder
                .defaultSystem("ä½ æ˜¯ä¸€ä¸ªèŠå¤©åŠ©æ‰‹ï¼Œåå­—å«å°æ™ºã€‚")
                .build();
    }

    //ä½¿ç”¨æ–‡æœ¬å“åº”ç”¨æˆ·é—®é¢˜ã€è®¾ç½®Promptæç¤ºè¯
    @GetMapping("/chat")
    public Map<String, String> chatText(@RequestParam("message") String message) {
        String reply = chatClient.prompt("å¦‚æœç”¨æˆ·è®©ä½ è®²æ•…äº‹ï¼Œåªèƒ½è®²è§£ç¥è¯æ•…äº‹ï¼Œä¸èƒ½è®²å…¶ä»–çš„ã€‚")
                .user(message)
                .call()
                .content();
        return Map.of("reply", reply);
    }


    @GetMapping("/response")
    public ChatResponse chatResponse(@RequestParam("message") String message) {
        return chatClient.prompt()
                .user(message)
                .call()
                .chatResponse();
    }

    @GetMapping("/getOneStudent")
    public Student getOneEntity() {
        return chatClient.prompt()
                .user("ç”Ÿæˆ1ä¸ªStudentå¯¹è±¡ï¼Œè¾“å‡ºå•ä¸ªJSONå¯¹è±¡ï¼Œå­—æ®µï¼šidï¼ˆLongï¼‰ï¼Œnameï¼ˆStringï¼‰ï¼Œageï¼ˆIntegerï¼‰")
                .call()
                .entity(Student.class);
    }

    @GetMapping("/getStudentList")
    public List<Student> getStudentList() {
        return chatClient.prompt()
                .user("ç”Ÿæˆ3ä¸ªStudentå¯¹è±¡ï¼ŒJSONæ•°ç»„æ ¼å¼ï¼Œå­—æ®µï¼šidï¼ˆLongï¼‰ï¼Œnameï¼ˆStringï¼‰ï¼Œageï¼ˆIntegerï¼‰")
                .call()
                .entity(new ParameterizedTypeReference<List<Student>>() {});
    }

    @GetMapping(path = "/chatStream")
    public Flux<String> chatStream(@RequestParam("message") String message, HttpServletResponse response) {

        // é¿å…è¿”å›ä¹±ç 
        response.setCharacterEncoding("UTF-8");

        return chatClient.prompt()
                .user(message)
                .stream()// å¼€å¯æµå¼å“åº”
                .content();
    }
}
```

ä»¥ä¸Šä»£ç ä¸­éœ€è¦æ³¨æ„ï¼šdefaultSystem(...)æ˜¯è®¾ç½®å…¨å±€ç³»ç»Ÿæç¤ºè¯ï¼›prompt(...)æ˜¯è®¾ç½®å½“å‰å¯¹è¯æç¤ºè¯ï¼›user(...)ä¸ºç”¨æˆ·è¾“å…¥æ¶ˆæ¯å†…å®¹ã€‚

**6) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œæµ‹è¯•ï¼š

```
# http://localhost:8080/ai/chat?message=ç»™æˆ‘è®²ä¸ªæ•…äº‹
{
  "reply": "å¥½çš„ï¼Œæˆ‘å¾ˆé«˜å…´ä¸ºæ‚¨è®²ä¸€ä¸ªç¥è¯æ•…äº‹ã€‚ä»Šå¤©æˆ‘è¦è®²çš„æ˜¯ä¸­å›½ä¸Šå¤ç¥è¯ã€Šå¤¸çˆ¶è¿½æ—¥ã€‹ï¼š\n\nå¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œåœ¨åŒ—æ–¹çš„å¤§è’ä¹‹ä¸­ï¼Œä½ç€ä¸€ä¸ªåå«å¤¸çˆ¶çš„å·¨äººã€‚ä»–æ˜¯ååœŸç¥çš„å­™å­ï¼Œä¿¡ç¥çš„å„¿å­ã€‚å¤¸çˆ¶èº«é«˜å¦‚å±±ï¼ŒåŠ›å¤§æ— ç©·ï¼Œè€³æœµä¸ŠæŒ‚ç€ä¸¤æ¡é»„è›‡ï¼Œæ‰‹é‡Œä¹Ÿæ¡ç€ä¸¤æ¡é»„è›‡ã€‚\n\né‚£æ—¶å€™ï¼Œå¤ªé˜³æ¯å¤©ä»ä¸œè¾¹å‡èµ·ï¼Œè¥¿è¾¹è½ä¸‹ï¼Œå¤¸çˆ¶è§‰å¾—å¤ªé˜³è·‘å¾—å¤ªå¿«äº†ï¼Œå¤§åœ°ä¸Šçš„æ—¶é—´å¤ªçŸ­æš‚ã€‚äºæ˜¯ä»–å†³å®šè¦è¿½ä¸Šå¤ªé˜³ï¼Œè®©å®ƒæ…¢ä¸‹æ¥ã€‚\n\nå¤¸çˆ¶è¿ˆå¼€å·¨å¤§çš„æ­¥ä¼ï¼Œå¼€å§‹è¿½é€å¤ªé˜³ã€‚ä»–è·‘å•Šè·‘å•Šï¼Œè·¨è¿‡ä¸€åº§åº§é«˜å±±ï¼Œè¶Šè¿‡ä¸€æ¡æ¡å¤§æ²³ã€‚å¤ªé˜³åœ¨å¤©ä¸Šè·‘ï¼Œå¤¸çˆ¶åœ¨åœ°ä¸Šè¿½ã€‚çœ¼çœ‹å°±è¦åœ¨ç¦ºè°·è¿½ä¸Šå¤ªé˜³äº†ï¼Œå¤¸çˆ¶å´æ„Ÿåˆ°å£æ¸´éš¾å¿ã€‚\n\nä»–ä¿¯ä¸‹èº«æ¥ï¼Œä¸€å£æ°”å–å¹²äº†é»„æ²³çš„æ°´ï¼Œåˆå–å¹²äº†æ¸­æ²³çš„æ°´ï¼Œè¿˜æ˜¯è§‰å¾—å£æ¸´ã€‚äºæ˜¯ä»–å‘åŒ—è·‘å»ï¼Œæƒ³è¦å–å¤§æ³½çš„æ°´ã€‚å¯æ˜¯è¿˜æ²¡è·‘åˆ°å¤§æ³½ï¼Œå¤¸çˆ¶å°±å› ä¸ºæåº¦å¹²æ¸´è€Œå€’ä¸‹äº†ã€‚\n\nä¸´æ­»å‰ï¼Œå¤¸çˆ¶æ‰”å‡ºäº†ä»–çš„æ‰‹æ–ã€‚é‚£æ‰‹æ–åŒ–ä½œäº†ä¸€ç‰‡æ¡ƒæ—ï¼Œç»“æ»¡äº†é²œç¾çš„æ¡ƒå­ï¼Œä¸ºåæ¥è·¯è¿‡çš„äººè§£æ¸´ã€‚\n\nè¿™ä¸ªæ•…äº‹å±•ç°äº†å¤äººå¾æœè‡ªç„¶çš„é›„å¿ƒå£®å¿—ï¼Œä¹Ÿå‘Šè¯‰æˆ‘ä»¬åšäº‹è¦é‡åŠ›è€Œè¡Œã€‚æ‚¨è§‰å¾—è¿™ä¸ªç¥è¯æ•…äº‹æ€ä¹ˆæ ·ï¼Ÿ"
}


# http://localhost:8080/ai/response?message=ä½ æ˜¯è°
{
... ...
"results": [
    {
      "metadata": {
        "finishReason": "STOP",
        "contentFilters": [],
        "empty": true
      },
      "output": {
        "messageType": "ASSISTANT",
        "metadata": {
          "finishReason": "STOP",
          "index": 0,
          "id": "f68527d6-6a26-4bbb-89c0-ca849e17b900",
          "role": "ASSISTANT",
          "messageType": "ASSISTANT"
        },
        "toolCalls": [],
        "media": [],
        "prefix": null,
        "reasoningContent": null,
        "text": "ä½ å¥½ï¼æˆ‘æ˜¯å°æ™ºï¼Œä¸€ä¸ªæ™ºèƒ½èŠå¤©åŠ©æ‰‹ï¼Œéšæ—¶ä¸ºä½ æä¾›å¸®åŠ©å’Œè§£ç­”é—®é¢˜ã€‚æ— è®ºæ˜¯æ—¥å¸¸ç–‘é—®ã€å­¦ä¹ è¾…å¯¼ï¼Œè¿˜æ˜¯é—²èŠæ”¾æ¾ï¼Œæˆ‘éƒ½å¯ä»¥é™ªä½ èŠèŠï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼ŸğŸ˜Š"
      }
    }
  ]
}

# http://localhost:8080/ai/getOneStudent
{
  "id": 1,
  "name": "å¼ ä¸‰",
  "age": 20
}

# http://localhost:8080/ai/getStudentList
[
  {
    "id": 1,
    "name": "å¼ ä¸‰",
    "age": 20
  },
  {
    "id": 2,
    "name": "æå››",
    "age": 21
  },
  {
    "id": 3,
    "name": "ç‹äº”",
    "age": 22
  }
]
```

## 4.2. **ä¸€ä¸ªé¡¹ç›®ä½¿ç”¨å¤šä¸ªèŠå¤©æ¨¡å‹**

åœ¨â€œSpringAIChatClientâ€é¡¹ç›®ä¸­ï¼Œå¦‚æœæ­¤åˆ»æˆ‘ä»¬éœ€è¦åªç”¨æ™ºæ™®AIè¿›è¡Œå›¾ç‰‡çš„è¯†åˆ«ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨é¡¹ç›®pom.xmlä¸­å¼•å…¥æ™ºæ™®AIç›¸å…³ä¾èµ–ï¼Œç„¶åå†åœ¨â€œresources/application.propertiesâ€ä¸­é…ç½®æ™ºæ™®AIç›¸å…³çš„URL/ApiKey/Modelç­‰ä¿¡æ¯ï¼Œè¿™æ ·å°±ä¸èƒ½å†ä½¿ç”¨DeepSeekæ¨¡å‹ï¼Œå› ä¸ºé»˜è®¤Spring AIåªé…ç½®ä¸€ä¸ªChatClient.Builderã€‚

å¦‚æœåœ¨ä¸€ä¸ªé¡¹ç›®ä¸­éœ€è¦ä½¿ç”¨å¤šä¸ªæ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼æ‰‹åŠ¨ç®¡ç†å¤šä¸ªChatClientå®ä¾‹ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

**1. åœ¨SpringBooté¡¹ç›®ä¸­å¼•å…¥å¤šä¸ªæ¨¡å‹çš„ä¾èµ–åŒ…**

**2. å…³é—­ChatClient.Builder è‡ªåŠ¨åˆ›å»ºï¼Œæ”¹ä¸ºæ‰‹åŠ¨ç®¡ç†ChatClientåˆ›å»º**

åœ¨resources/application.propertiesé…ç½®æ–‡ä»¶ä¸­é…ç½®â€œspring.ai.chat.client.enabled=falseâ€ï¼Œè¯¥é…ç½®é¡¹é»˜è®¤ä¸ºtrueï¼ŒSpring Boot ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª ChatClient.Builder Bean å¯ä»¥ç›´æ¥æ³¨å…¥ä½¿ç”¨ï¼Œæ‰‹åŠ¨ç®¡ç† ChatClient çš„åˆ›å»ºéœ€è¦è®¾ç½®ä¸ºfalseï¼Œå³ä¸å†ä½¿ç”¨ChatClient.Builder Bean æ³¨å…¥

**3. è‡ªå®šä¹‰é…ç½®ç±»å®ç°å¤šæ¨¡å‹ChatClientåˆ›å»º**

å¦‚ä¸‹ï¼š

```
@Configuration
public class ChatClientConfig {
    @Bean
    public ChatClient deepseekClient(OpenAiChatModel openAiChatModel) {
        return ChatClient.create(openAiChatModel);
    }

    @Bean
    public ChatClient zhipuaiClient(ZhiPuAIChatModel zhipuAiChatModel) {
        return ChatClient.create(zhipuAiChatModel);
    }
}
```

é€šè¿‡@Configuration å‘Šè¯‰ Springï¼šè¿™æ˜¯é…ç½®ç±»ï¼Œç±»é‡Œçš„ @Bean æ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼Œè¿”å›çš„å¯¹è±¡å°†æ³¨å†Œä¸º Spring ç®¡ç†çš„ Beanã€‚

**4. Controllerä¸­å¼•å…¥å¤šä¸ªChatClient**

å¦‚ä¸‹ï¼š

```
private final ChatClient deepseekClient;
private final ChatClient zhipuaiClient;

public MultiModelController(
      @Qualifier("deepseekClient") ChatClient deepseekClient,
      @Qualifier("zhipuaiClient") ChatClient zhipuaiClient) {
  this.deepseekClient = deepseekClient;
  this.zhipuaiClient = zhipuaiClient;
}
```

åœ¨ Springï¼ˆåŒ…æ‹¬ Spring Bootï¼‰ä¸­ï¼Œ@Qualifier æ³¨è§£ç”¨äºè§£å†³å¤šä¸ªç›¸åŒç±»å‹ Bean æ³¨å…¥æ—¶çš„æ­§ä¹‰é—®é¢˜ï¼Œå½“å®¹å™¨ä¸­å­˜åœ¨å¤šä¸ª ChatClient Bean æ—¶ï¼ŒSpring æ— æ³•è‡ªåŠ¨è¯†åˆ«åˆ°åº•æ³¨å…¥å“ªä¸€ä¸ªï¼Œè¿™æ—¶å°±éœ€è¦ @Qualifier æ¥æŒ‡å®š Bean åç§°ã€‚ä¾‹å¦‚ï¼š@Qualifier("deepseekClient") å‘Šè¯‰ Springï¼Œâ€œä»å®¹å™¨ä¸­æ‰¾åˆ°åå­—ä¸º deepseekClient çš„ Bean æ³¨å…¥æ­¤å‚æ•°â€ã€‚

### **4.2.1. åˆ›å»ºé¡¹ç›®å¹¶é…ç½®å¤šæ¨¡å‹**

ä¸‹é¢åœ¨ä¸€ä¸ªSpringBooté¡¹ç›®ä¸­ä½¿ç”¨DeepSeekã€æ™ºæ™®AIä¸¤ä¸ªæ¨¡å‹ï¼ŒDeepSeekæ¨¡å‹ç”¨äºèŠå¤©ï¼Œæ™ºæ™®AIæ¨¡å‹ç”¨äºå›¾åƒå†…å®¹è¯†åˆ«ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

**1) åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå‘½åä¸ºâ€œSpringAIChatClientâ€**

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/dd41e1da274842cab9eccdee0b7f8c83.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/d51a495167eb421492f5df8d5dabc884.jpg)

**2) é…ç½®é¡¹ç›®pom.xml**

åœ¨é¡¹ç›®çš„pom.xmlä¸­å¼•å…¥äº†deepseekå’Œzhipuaiç›¸å…³çš„ä¾èµ–åŒ…ã€‚

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIMutiModelClient</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIMutiModelClient</name>
    <description>SpringAIMutiModelClient</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- å¼•å…¥ DeepSeek æ¨¡å‹ -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-deepseek</artifactId>
        </dependency>

        <!-- å¼•å…¥ æ™ºæ™®AI æ¨¡å‹-->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-zhipuai</artifactId>
        </dependency>

    </dependencies>


    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

**3) é…ç½®resources/application.properties**

åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®spring.ai.chat.client.enabled=falseï¼Œå…³é—­ChatClient.Builderè‡ªåŠ¨åˆ›å»ºã€‚è¿™é‡Œå¼•å…¥äº†DeepSeekçš„deepseek-chatèŠå¤©æ¨¡å‹å’Œæ™ºæ™®AIçš„GLM-4V-Flashå›¾åƒç†è§£æ¨¡å‹ã€‚

```
spring.application.name=SpringAIMutiModelClient

# é»˜è®¤ä¸ºtrueï¼ŒSpring Boot ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª ChatClient.Builder Bean å¯ä»¥ç›´æ¥æ³¨å…¥ä½¿ç”¨
# æ‰‹åŠ¨ç®¡ç† ChatClient çš„åˆ›å»ºéœ€è¦è®¾ç½®ä¸ºfalseï¼Œå³ä¸å†ä½¿ç”¨ChatClient.Builder Bean æ³¨å…¥
spring.ai.chat.client.enabled=false

#é…ç½® Deepseekçš„åŸºç¡€URLã€å¯†é’¥å’Œä½¿ç”¨æ¨¡å‹
spring.ai.deepseek.base-url=https://api.deepseek.com
spring.ai.deepseek.api-key=sk-...21
spring.ai.deepseek.chat.options.model=deepseek-chat

#ä½¿ç”¨ æ™ºæ™®AI Image æ¨¡å‹ï¼Œéœ€è¦åœ¨pom.xmlä¸­å¼•å…¥å¯¹åº”ä¾èµ–
spring.ai.zhipuai.api-key=dd...GA4
spring.ai.zhipuai.base-url=https://open.bigmodel.cn/api/paas
# å›¾åƒè¯†åˆ« / å›¾åƒç†è§£åŠŸèƒ½ï¼ˆå¤šæ¨¡æ€æ¨¡å‹ï¼‰
# GLM-4V-Flash ä¸ºå…è´¹å›¾åƒç†è§£æ¨¡å‹ï¼Œå…¶ä»–æ¨¡å‹éœ€è¦ä»˜è´¹ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼šhttps://www.bigmodel.cn/pricing
spring.ai.zhipuai.chat.options.model=GLM-4V-Flash
```

**4) åˆ›å»ºconfigåŒ…å¹¶åˆ›å»ºèŠå¤©é…ç½®ç±»**

åœ¨é¡¹ç›®ä¸­åˆ›å»ºconfigåŒ…ï¼Œå¹¶åœ¨è¯¥åŒ…ä¸‹åˆ›å»ºChatClientConfigç±»ï¼Œå®ç°å¤šæ¨¡å‹ChatClientçš„åˆ›å»ºã€‚

ChatClientConfig.javaå†…å®¹å¦‚ä¸‹ï¼Œå¯ä»¥è®¾ç½®ç³»ç»Ÿçº§åˆ«æç¤ºè¯ï¼Œä¹Ÿå¯ä»¥ä¸è®¾ç½®ã€‚

```
package com.example.springaimutimodelclient.config;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.deepseek.DeepSeekChatModel;
import org.springframework.ai.zhipuai.ZhiPuAiChatModel;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class ChatClientConfig {
    @Bean
    public ChatClient deepseekClient(DeepSeekChatModel deepSeekChatModel) {
        // åˆ›å»ºDeepSeekChatModelå®ä¾‹
        //return ChatClient.create(deepSeekChatModel);
        return ChatClient.builder(deepSeekChatModel)
                .defaultSystem("ä½ æ˜¯ä¸€ä¸ªäººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œä½ çš„åå­—å«åšå°æ™ºï¼Œå¯ä»¥å›ç­”ä»»ä½•é—®é¢˜ã€‚")
                .build();
    }

    @Bean
    public ChatClient zhipuaiClient(ZhiPuAiChatModel zhipuAiChatModel) {
        // åˆ›å»ºZhiPuAiChatModelå®ä¾‹
        return ChatClient.create(zhipuAiChatModel);
    }

}
```

### **4.2.2. å¤šæ¨¡å‹èŠå¤©ç¤ºä¾‹**

**1) åˆ›å»ºcontrolleråŒ…ï¼Œå¹¶åˆ›å»ºMultiModelController.javaæ–‡ä»¶**

åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œå¼•å…¥é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„ä¸¤ä¸ªChatClientï¼Œå¯ä»¥åœ¨ä¸åŒçš„controlleræ–¹æ³•ä¸­ä½¿ç”¨å¯¹åº”æ¨¡å‹çš„ChatClientæ¥è¿›è¡Œå¯¹è¯ã€‚

```
package com.example.springaimutimodelclient.controller;

import com.example.springaimutimodelclient.pojo.IdCardInfo;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.core.io.ClassPathResource;
import org.springframework.core.io.Resource;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;

@RestController
@RequestMapping("/ai")
public class MultiModelController {
    private final ChatClient deepseekClient;
    private final ChatClient zhipuaiClient;

    public MultiModelController(
            @Qualifier("deepseekClient") ChatClient deepseekClient,
            @Qualifier("zhipuaiClient") ChatClient zhipuaiClient) {
        this.deepseekClient = deepseekClient;
        this.zhipuaiClient = zhipuaiClient;
    }

    @GetMapping("/deepseek")
    public String chatWithDeepseek(@RequestParam("message") String message) {
        return deepseekClient.prompt()
                .user(message)
                .call()
                .content();
    }

    @GetMapping("/zhipuai")
    public String chatWithZhipuai(@RequestParam("message") String message) {
        return zhipuaiClient.prompt()
                .user(message)
                .call()
                .content();
    }
}
```

**2) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œæµ‹è¯•ï¼š

```
# http://localhost:8080/ai/deepseek?message=ä½ æ˜¯è°
ä½ å¥½ï¼æˆ‘æ˜¯å°æ™ºï¼Œä¸€ä¸ªæ™ºèƒ½AIåŠ©æ‰‹ï¼Œéšæ—¶å‡†å¤‡ä¸ºä½ è§£ç­”é—®é¢˜ã€æä¾›å¸®åŠ©æˆ–é™ªä½ èŠå¤©ã€‚æ— è®ºæ˜¯å­¦ä¹ ã€å·¥ä½œï¼Œè¿˜æ˜¯æ—¥å¸¸ç”Ÿæ´»ä¸­çš„ç–‘é—®ï¼Œéƒ½å¯ä»¥é—®æˆ‘å“¦ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ 

# http://localhost:8080/ai/zhipuai?message=ä½ æ˜¯è°
æˆ‘æ˜¯ä¸€ä¸ªåå«æ™ºè°±æ¸…è¨€çš„äººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œæˆ‘çš„ä½¿å‘½æ˜¯å¸®åŠ©äººä»¬è§£å†³é—®é¢˜å’Œæä¾›ä¿¡æ¯ã€‚æˆ‘ç”±æ™ºè°±AIå…¬å¸å¼€å‘ï¼Œä½¿ç”¨çš„æ˜¯å¤§å‹è¯­è¨€æ¨¡å‹GPT-4ã€‚æˆ‘çš„ç›®æ ‡æ˜¯å°½å¯èƒ½å‡†ç¡®åœ°å›ç­”é—®é¢˜å¹¶æä¾›æœ‰ç”¨çš„ä¿¡æ¯ã€‚å¦‚æœæ‚¨æœ‰ä»»ä½•å…¶ä»–é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥çš„å¸®åŠ©ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ã€‚è°¢è°¢ï¼
```

### **4.2.3. å›¾ç‰‡å†…å®¹è¯†åˆ«ç¤ºä¾‹**

**1) å‡†å¤‡å›¾ç‰‡**

å°†å›¾ç‰‡â€œimg.pngâ€å’Œâ€œèº«ä»½è¯.jpgâ€ä¸Šä¼ è‡³é¡¹ç›®â€œSpringAIMutiModelClientâ€çš„resourcesèµ„æºç›®å½•ä¸‹ã€‚

![img](https://:0/)![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/92e3e39836564f6c944f57ef3e538fb3.jpg)

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/255181ad4fde4badb7aaea7b93ae45f8.jpg)

**2) åˆ›å»ºpojoåŒ…å¹¶åˆ›å»ºIdCardInfo.javaç±»**ç”±äºåç»­ä¸å¤§æ¨¡å‹å¯¹è¯è®°æ€§èº«ä»½è¯è¯†åˆ«æ—¶éœ€è¦è‡ªåŠ¨æ˜ å°„ä¸ºå®ä½“å¯¹è±¡ï¼Œè¿™é‡Œåˆ›å»ºIdCardInfo.javaç±»ï¼š

```
package com.example.springaimutimodelclient.pojo;

public class IdCardInfo {
    private String name;
    private String sex;
    private String nation;
    private String birth;
    private String address;
    private String idNo;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getSex() {
        return sex;
    }

    public void setSex(String sex) {
        this.sex = sex;
    }

    public String getNation() {
        return nation;
    }

    public void setNation(String nation) {
        this.nation = nation;
    }

    public String getBirth() {
        return birth;
    }

    public void setBirth(String birth) {
        this.birth = birth;
    }

    public String getAddress() {
        return address;
    }

    public void setAddress(String address) {
        this.address = address;
    }

    public String getIdNo() {
        return idNo;
    }

    public void setIdNo(String idNo) {
        this.idNo = idNo;
    }

    @Override
    public String toString() {
        return "IdCardInfo{" +
                "name='" + name + '\'' +
                ", sex='" + sex + '\'' +
                ", nation='" + nation + '\'' +
                ", birth='" + birth + '\'' +
                ", address='" + address + '\'' +
                ", idNo='" + idNo + '\'' +
                '}';
    }
}
```

**3) åˆ›å»ºcontrolleråŒ…ï¼Œå¹¶åˆ›å»ºImgAnanlyController.javaæ–‡ä»¶**

```
package com.example.springaimutimodelclient.controller;

import com.example.springaimutimodelclient.pojo.IdCardInfo;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.core.io.ClassPathResource;
import org.springframework.core.io.Resource;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;

@RestController
@RequestMapping("/ai")
public class MultiModelController {
    private final ChatClient deepseekClient;
    private final ChatClient zhipuaiClient;

    public MultiModelController(
            @Qualifier("deepseekClient") ChatClient deepseekClient,
            @Qualifier("zhipuaiClient") ChatClient zhipuaiClient) {
        this.deepseekClient = deepseekClient;
        this.zhipuaiClient = zhipuaiClient;
    }

    @GetMapping("/deepseek")
    public String chatWithDeepseek(@RequestParam("message") String message) {
        return deepseekClient.prompt()
                .user(message)
                .call()
                .content();
    }

    @GetMapping("/zhipuai")
    public String chatWithZhipuai(@RequestParam("message") String message) {
        return zhipuaiClient.prompt()
                .user(message)
                .call()
                .content();
    }

}
```

**4) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œæµ‹è¯•ï¼š

```
# http://localhost:8080/ai/imgAnaly
è¿™å¼ å›¾ç‰‡å±•ç¤ºäº†ä¸€ä¸ªé‡‘å±åˆ¶çš„åœ†å½¢æ°´æœç¯®ï¼Œç¯®å­ä¸­æ”¾ç½®äº†ä¸‰æ ¹é¦™è•‰å’Œä¸¤ä¸ªè‹¹æœã€‚ ç¯®å­çš„è®¾è®¡ç®€çº¦è€Œç°ä»£ï¼ŒèƒŒæ™¯æ˜¯ç°è‰²çš„å¢™å£ï¼Œæ•´ä½“ç»™äººä¸€ç§ç®€æ´ã€å¹²å‡€çš„æ„Ÿè§‰ã€‚

# http://localhost:8080/ai/idCardAnaly
{
  "name": "é‡‘é˜³",
  "sex": "å¥³",
  "nation": "æ±‰",
  "birth": "1978-10-27",
  "address": "åŒ—äº¬å¸‚å¸‚è¾–åŒºå¤å…´é—¨å¤–å¤§è¡—999å·é™¢11å·æ¥¼3å•å…ƒ502å®¤",
  "idNo": "110102197810272321"
}
```

# 5. **Chat Memory èŠå¤©è®°å¿†**

å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰æ˜¯æ— çŠ¶æ€çš„ï¼Œå³å®ƒä»¬ä¸ä¼šè‡ªåŠ¨ä¿ç•™å…ˆå‰å¯¹è¯ä¿¡æ¯ã€‚è¿™åœ¨éœ€è¦è·¨å¤šæ¬¡äº¤äº’ä¿æŒä¸Šä¸‹æ–‡æˆ–çŠ¶æ€æ—¶ï¼Œæ˜¯ä¸€ä¸ªæ˜¾è‘—é™åˆ¶ã€‚Spring AI å¼•å…¥ Chat Memory åŠŸèƒ½ï¼Œå…è®¸ä½ åœ¨å¤šè½®å¯¹è¯ä¸­å­˜å‚¨å¹¶æ£€ç´¢ä¿¡æ¯ï¼Œä»¥è§£å†³è¿™ä¸€é—®é¢˜ã€‚

Spring AIä¸­çš„Chat Memoryå¯ä»¥å°†æœ€è¿‘Næ¬¡å¯¹è¯ä¸Šä¸‹æ–‡ä¿¡æ¯ä¿å­˜åœ¨å†…å­˜æˆ–è€…å¤–éƒ¨æ•°æ®åº“ï¼ˆä¾‹å¦‚PostgreSQLã€MySQLã€SQL Serverã€HSQLDBã€Cassandraã€Neo4jï¼‰ä¸­ï¼Œä»¥ä¾¿LLMåœ¨åŒä¸€ä¼šè¯çš„å¤šè½®äº’åŠ¨ä¸­ä¿æŒè¯­ä¹‰è¿è´¯ï¼Œé»˜è®¤Nä¸º20ï¼ˆåŒ…æ‹¬USERã€ASSISTANTæ¶ˆæ¯ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”¨æˆ·æ¥æŒ‡å®šï¼Œè¶…å‡ºåæŒ‰æ—¶é—´é¡ºåºæ¸…ç†ï¼ˆsystem æ¶ˆæ¯ä¸€ç›´å­˜åœ¨ï¼Œä¸è®¡å…¥20æ¡å†…ï¼‰ã€‚

## 5.1. **ChatMemoryæŠ½è±¡ä¸ä½¿ç”¨æ–¹å¼**

ChatMemoryä½¿ç”¨ä¸­æ¶‰åŠå¦‚ä¸‹ä¸¤ä¸ªæ¥å£ï¼š

Ã˜ ChatMemoryæ¥å£ï¼šæä¾›åœ¨æŒ‡å®šå¯¹è¯ä¸­æ·»åŠ æ¶ˆæ¯ã€æ£€ç´¢è®°å¿†å†…å®¹ã€ä»¥åŠæ¸…ç†æ—§æ¶ˆæ¯çš„èƒ½åŠ›ã€‚

Ã˜ ChatMemoryRepositoryæ¥å£ï¼šè´Ÿè´£æ¶ˆæ¯çš„åº•å±‚å‚¨å­˜ä¸æå–ã€‚

ChatMemoryé»˜è®¤å®ç°ä¸ºMessageWindowChatMemoryç±»ï¼Œå¦‚ä¸‹æ–¹å¼åˆ›å»ºChatMemory:

```
MessageWindowChatMemory memory = MessageWindowChatMemory.builder()
    .maxMessages(20)
    .build();
```

ä»¥ä¸Šè¿™ç§æ–¹å¼åˆ›å»ºChatMemoryå¯¹è±¡é»˜è®¤å°†ä¿å­˜æœ€è¿‘Næ¡å¯¹è¯ä¿¡æ¯ï¼ˆé»˜è®¤20æ¡ï¼‰ï¼Œè¶…å‡ºåæŒ‰æ—¶é—´é¡ºåºæ¸…ç†ï¼ˆç³»ç»Ÿæ¶ˆæ¯ä¸ä¼šè¢«æ¸…é™¤ï¼‰ã€‚æœ€è¿‘Næ¡å¯¹è¯æ¶ˆæ¯å­˜å‚¨åˆ°å“ªé‡Œç”±ChatMemoryRepositoryçš„å®ç°å†³å®šï¼ˆå­˜å‚¨åç«¯ï¼‰ï¼ŒChatMemoryRepositoryæœ‰å¦‚ä¸‹å››ç§å®ç°ï¼š

- InMemoryChatMemoryRepositoryï¼šä½¿ç”¨ ConcurrentHashMap å­˜å‚¨æ¶ˆæ¯ï¼Œè¿™ç§ä¹Ÿæ˜¯é»˜è®¤æ–¹å¼ã€‚
- JdbcChatMemoryRepositoryï¼šåŸºäº JDBC çš„å…³ç³»å‹æ•°æ®åº“ï¼ˆPostgreSQLã€MySQLã€SQL Serverã€HSQLDBï¼‰å­˜å‚¨æ•°æ®ï¼Œæ”¯æŒé€šè¿‡ Spring å±æ€§é…ç½® schema åˆå§‹åŒ–æ—¶æœºä¸è„šæœ¬ä½ç½®ã€‚
- CassandraChatMemoryRepositoryï¼šä½¿ç”¨ Cassandraï¼Œå¯é…ç½® TTLï¼ˆä¾‹å¦‚ 3 å¹´ï¼‰å®ç°è‡ªåŠ¨è¿‡æœŸã€‚
- Neo4jChatMemoryRepositoryï¼šåŸºäºå›¾æ•°æ®åº“ Neo4jå­˜å‚¨æ¶ˆæ¯ã€‚

**åœ¨SpringBooté¡¹ç›®ä¸­ï¼Œä½¿ç”¨ChatMemoryçš„æ­¥éª¤å¦‚ä¸‹ï¼š**

**1. åœ¨é¡¹ç›®ä¸­é…ç½®ChatMemory Bean**

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
#ä½¿ç”¨é»˜è®¤å†…å­˜æ–¹å¼
@Bean
ChatMemory chatMemory() {
    // ä¿ç•™ 20æ¡æœ€è¿‘æ¶ˆæ¯
    return MessageWindowChatMemory.builder()
            .maxMessages(20)
            .build();
}

#ä½¿ç”¨JDBCæ–¹å¼
@Bean
ChatMemory chatMemory(JdbcChatMemoryRepository repo) {
    return MessageWindowChatMemory.builder()
            .chatMemoryRepository(repo)
            .maxMessages(20)
            .build();
}
```

**2. åˆ›å»ºChatClientæ—¶åŠ å…¥ChatMemoryè®°å¿†å†…å®¹**

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
ChatClient client = ChatClient.builder(chatModel)
    .defaultAdvisors(
      MessageChatMemoryAdvisor.builder(chatMemory).build()
    )
    .build();
```

Advisorï¼ˆé¡¾é—®ï¼‰æ˜¯ Spring AI ä¸­ç”¨äºå¢å¼ºæ–¹æ³•æ‰§è¡Œé€»è¾‘çš„ç»„ä»¶ï¼Œç±»ä¼¼äºä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œé€šè¿‡ Advisorï¼Œå¯ä»¥åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ’å…¥è‡ªå®šä¹‰é€»è¾‘ï¼Œä»è€Œæå‡ä»£ç çš„å¯æ‰©å±•æ€§ä¸çµæ´»æ€§ï¼Œå¸¸ç”¨äºä»»åŠ¡å¢å¼ºã€æ•°æ®é¢„å¤„ç†ç­‰åœºæ™¯ã€‚è¿™é‡Œé€šè¿‡Advisorå®ç°å°† ChatMemory é›†æˆåˆ°ChatClientä¸­ã€‚

**3. ä½¿ç”¨ChatClientæ—¶ä¼ å…¥å¯¹è¯ID**

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
chatClient.prompt()
        .user(message)
        .advisors(a -> a.param(ChatMemory.CONVERSATION_ID, conversationId))
        .call()
        .content();
```

ä¸æ¨¡å‹äº¤äº’æ—¶é€šè¿‡CONVERSATION_IDæ ‡è®°ä¼šè¯ï¼Œadvisorä¼šè‡ªåŠ¨ä¸Šä¸‹æ–‡ç®¡ç†ã€‚

## 5.2. **ChatMemoryå­˜å‚¨åœ¨å†…å­˜æ¡ˆä¾‹**

ä»¥ä¸‹æ¡ˆä¾‹æ˜¯å°†ChatMemoryå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤å®ç°å³å¯ã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå‘½åä¸ºâ€œSpringAIChatMemoryInMemoryâ€**

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/56297cd4f5cb4cb08a49b235b713fc5d.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/ce5f4cd353374b879cf5aa0d7fe365e4.jpg)

**2) é…ç½®é¡¹ç›®pom.xml**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.2</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIChatMemoryInMemory</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIChatMemoryInMemory</name>
    <description>SpringAIChatMemoryInMemory</description>


    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-deepseek</artifactId>
        </dependency>
    </dependencies>


    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

ä»¥ä¸Špom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-model-deepseekâ€ä¾èµ–ã€‚

**3) é…ç½®resources/application.properties**

```
spring.application.name=SpringAIChatMemoryInMemory

server.port=8080

#é…ç½® Deepseekçš„åŸºç¡€URLã€å¯†é’¥å’Œä½¿ç”¨æ¨¡å‹
spring.ai.deepseek.base-url=https://api.deepseek.com
spring.ai.deepseek.api-key=sk-...21
spring.ai.deepseek.chat.options.model=deepseek-chat
```

**4) åˆ›å»ºconfigåŒ…å¹¶åˆ›å»ºConfig.javaç±»**

```
package com.example.springaichatmemoryinmemory.config;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.memory.MessageWindowChatMemory;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class Config {

    @Bean
    ChatMemory chatMemory() {
        // è¿”å› ChatMemory ç±»å‹çš„ Beanï¼Œç”¨äºç®¡ç†å¯¹è¯ä¸­çš„ä¸Šä¸‹æ–‡è®°å¿†
        // è¿™é‡Œä½¿ç”¨ MessageWindowChatMemory å®ç°ï¼Œæœ€å¤šä¿ç•™ 20 æ¡æ¶ˆæ¯
        // é»˜è®¤ä¼šä¿ç•™ç³»ç»Ÿæ¶ˆæ¯ï¼ˆsystem messageï¼‰ä¸è¢«æ¸…é™¤
        return MessageWindowChatMemory.builder()
                .maxMessages(20)
                .build();
    }

    @Bean
    ChatClient chatClient(ChatModel chatModel, ChatMemory memory) {
        // æ ¹æ® ChatModel å’Œ ChatMemory æ¥æ„å»º ChatClient å®ä¾‹
        // ChatClient æ˜¯ä¸ LLM äº¤äº’çš„å®¢æˆ·ç«¯ï¼Œæ”¯æŒæ·»åŠ å¤šä¸ª Advisorï¼ˆé¡¾é—®ï¼‰æ¥å¢å¼ºåŠŸèƒ½
        return ChatClient.builder(chatModel)
                // å®‰è£…ä¸€ä¸ª MessageChatMemoryAdvisorï¼Œå°† ChatMemory é›†æˆåˆ°ChatClientä¸­
                .defaultAdvisors(MessageChatMemoryAdvisor.builder(memory).build())
                .build();
    }
}
```

é€šè¿‡@Configuration å‘Šè¯‰ Springï¼šè¿™æ˜¯é…ç½®ç±»ï¼Œç±»é‡Œçš„ @Bean æ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼Œè¿”å›çš„å¯¹è±¡å°†æ³¨å†Œä¸º Spring ç®¡ç†çš„ Beanã€‚

**5) åˆ›å»ºcontrolleråŒ…ï¼Œå¹¶åˆ›å»ºChatMemoryController.javaæ–‡ä»¶**

```
package com.example.springaichatmemoryinmemory.controller;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/ai")
public class ChatMemoryController {

    private final ChatClient chatClient;

    public ChatMemoryController(ChatClient chatClient) {
        this.chatClient = chatClient;
    }

    @GetMapping("/chatMemory")
    public String chatMemory(@RequestParam(value = "cid") String conversationId,
                             @RequestParam(value = "message", defaultValue = "ä½ æ˜¯è°") String message) {

        System.out.println("conversationIdï¼š"+conversationId);

        return chatClient.prompt()
                .user(message)
                // è®¾ç½® advisor å‚æ•°ï¼šå‘Šè¯‰ memory ä½¿ç”¨è°çš„ä¸Šä¸‹æ–‡
                // è¿™é‡Œéœ€è¦ä½¿ç”¨ç¨³å®šçš„ conversationIdï¼Œä¿æŒä¸Šä¸‹æ–‡ä¸€è‡´
                // conversationId ä¸è¦ä½¿ç”¨æ¯æ¬¡æ–°ç”Ÿæˆçš„ UUIDï¼Œå¦åˆ™å°†æ— æ³•ä¿ç•™ä¸Šä¸‹æ–‡
                .advisors(a -> a.param(ChatMemory.CONVERSATION_ID, conversationId))
                .call()
                .content();
    }
}
```

**6) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œæµ‹è¯•ï¼š

```
# http://localhost:8080/ai/chatMemory?cid=123&message=1åŠ 1ç­‰äºå‡ 
1åŠ 1çš„ç­”æ¡ˆå–å†³äºå…·ä½“çš„æ•°å­¦ä½“ç³»æˆ–ä¸Šä¸‹æ–‡ï¼š 1. **åè¿›åˆ¶ç®—æœ¯**ï¼šåœ¨å¸¸è§„çš„åè¿›åˆ¶ç³»ç»Ÿä¸­ï¼Œ1 + 1 = 2ã€‚ 2. **äºŒè¿›åˆ¶ç³»ç»Ÿ**ï¼š1 + 1 = 10ï¼ˆè¯»ä½œâ€œä¸€é›¶â€ï¼‰ï¼Œå› ä¸ºäºŒè¿›åˆ¶é€¢äºŒè¿›ä¸€ã€‚ 3. **å¸ƒå°”ä»£æ•°**ï¼š1 + 1 = 1ï¼ˆé€»è¾‘â€œæˆ–â€è¿ç®—ä¸­ï¼ŒçœŸå€¼ç›¸åŠ ä»ä¸ºçœŸï¼‰ã€‚ 4. **å…¶ä»–æƒ…å¢ƒ**ï¼š - åœ¨åŒ–å­¦ä¸­ï¼Œ1å‡æ°´åŠ 1å‡é…’ç²¾ï¼Œä½“ç§¯å¯èƒ½å°äº2å‡ï¼ˆåˆ†å­é—´ç©ºéš™å˜åŒ–ï¼‰ã€‚ - åœ¨æŠ½è±¡ä»£æ•°ä¸­ï¼ŒæŸäº›è‡ªå®šä¹‰è¿ç®—å¯èƒ½æœ‰ä¸åŒç»“æœã€‚ **å¸¸è§è¯¯è§£**ï¼š - æŸäº›å¹½é»˜æˆ–è„‘ç­‹æ€¥è½¬å¼¯ä¼šå›ç­”â€œ1 + 1 = 11â€ï¼ˆæ•°å­—æ‹¼æ¥ï¼‰ï¼Œä½†è¿™ä¸å±äºæ•°å­¦èŒƒç•´ã€‚ å¦‚éœ€ç‰¹å®šé¢†åŸŸçš„è§£é‡Šï¼Œå¯ä»¥è¿›ä¸€æ­¥è¯´æ˜ï¼

# http://localhost:8080/ai/chatMemory?cid=123&message=è¿™ä¸ªæ•°å†åŠ ä¸Š1ç­‰äºå‡ ï¼Ÿ
æ ¹æ®ä¸åŒçš„æ•°å­¦ä½“ç³»æˆ–ä¸Šä¸‹æ–‡ï¼Œ**â€œè¿™ä¸ªæ•°æ®å†åŠ ä¸Š1â€**çš„ç»“æœä¼šæœ‰æ‰€ä¸åŒã€‚ä»¥ä¸‹æ˜¯å‡ ç§å¸¸è§æƒ…å†µçš„åˆ†æï¼š --- ### 1. **è‹¥åŸæ•°æ®æ˜¯å¸¸è§„ç®—æœ¯ç»“æœï¼ˆ1+1=2ï¼‰** - **åè¿›åˆ¶**ï¼š2 + 1 = **3** - **äºŒè¿›åˆ¶**ï¼š10ï¼ˆäºŒè¿›åˆ¶çš„2ï¼‰ + 1 = **11**ï¼ˆäºŒè¿›åˆ¶çš„3ï¼‰ - **åå…­è¿›åˆ¶**ï¼š2 + 1 = **3**ï¼ˆä¸åè¿›åˆ¶ç›¸åŒï¼‰ ### 2. **è‹¥åŸæ•°æ®æ˜¯äºŒè¿›åˆ¶ç»“æœï¼ˆ1+1=10ï¼‰** - 10ï¼ˆäºŒè¿›åˆ¶çš„2ï¼‰ + 1 = **11**ï¼ˆäºŒè¿›åˆ¶çš„3ï¼‰ ### 3. **è‹¥åŸæ•°æ®æ˜¯å¸ƒå°”ä»£æ•°ç»“æœï¼ˆ1+1=1ï¼‰** - é€»è¾‘â€œæˆ–â€è¿ç®—ä¸­ï¼š1ï¼ˆçœŸï¼‰ + 1ï¼ˆçœŸï¼‰ä»ä¸º **1**ï¼ˆçœŸï¼‰ï¼Œå› ä¸ºçœŸå€¼å åŠ ä¸æ”¹å˜ç»“æœã€‚ ### 4. **å…¶ä»–æƒ…å¢ƒ** - **åŒ–å­¦æ··åˆ**ï¼šè‹¥åŸæ•°æ®æ˜¯1å‡æ°´åŠ 1å‡é…’ç²¾çš„ä½“ç§¯ï¼ˆçº¦1.93å‡ï¼‰ï¼Œå†åŠ 1å‡å…¶ä»–æ¶²ä½“ï¼Œç»“æœå–å†³äºå…·ä½“ç‰©è´¨çš„æ€§è´¨ã€‚ - **å­—ç¬¦ä¸²æ‹¼æ¥**ï¼šè‹¥â€œ1+1=11â€æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œåˆ™â€œ11â€ + â€œ1â€ = **â€œ111â€**ã€‚ --- ### å…³é”®ç‚¹æ€»ç»“ - **æ•°å­¦é»˜è®¤**ï¼šé€šå¸¸ç†è§£ä¸ºåè¿›åˆ¶ï¼Œç»“æœæ˜¯ **3**ã€‚ - **ç¼–ç¨‹/é€»è¾‘**ï¼šéœ€æ˜ç¡®å˜é‡ç±»å‹ï¼ˆå¦‚äºŒè¿›åˆ¶ã€å¸ƒå°”å€¼ç­‰ï¼‰ã€‚ - **è¶£å‘³å›ç­”**ï¼šè‹¥å»¶ç»­è„‘ç­‹æ€¥è½¬å¼¯é€»è¾‘ï¼Œå¯èƒ½æ˜¯â€œ111â€æˆ–â€œç‹â€ï¼ˆæ±‰å­—å åŠ ï¼‰ã€‚ éœ€è¦æ›´å…·ä½“çš„ä¸Šä¸‹æ–‡å—ï¼Ÿå¯ä»¥å‘Šè¯‰æˆ‘æ‚¨æ‰€æŒ‡çš„â€œæ•°æ®â€ç±»å‹ï¼

#http://localhost:8080/ai/chatMemory?cid=1234&message=è¿™ä¸ªæ•°å†åŠ ä¸Š1ç­‰äºå‡ ï¼Ÿ
### åˆå§‹ç†è§£é—®é¢˜ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®é—®é¢˜çš„é™ˆè¿°ï¼šâ€œè¿™ä¸ªæ•°å†åŠ ä¸Š1ç­‰äºå‡ ï¼Ÿâ€è¿™å¥è¯çœ‹èµ·æ¥éå¸¸ç®€å•ï¼Œä½†å®ƒæœ‰å‡ ä¸ªå…³é”®éƒ¨åˆ†éœ€è¦æ‹†è§£ï¼š 1. â€œè¿™ä¸ªæ•°â€ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡ä»£è¯ï¼ŒæŒ‡çš„æ˜¯æŸä¸ªç‰¹å®šçš„æ•°ã€‚ä½†åœ¨å½“å‰çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæ²¡æœ‰æ˜ç¡®è¯´æ˜â€œè¿™ä¸ªæ•°â€å…·ä½“æ˜¯å“ªä¸ªæ•°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘â€œè¿™ä¸ªæ•°â€å¯èƒ½æŒ‡ä»£çš„æ˜¯ä»€ä¹ˆã€‚ ....
```

å¯ä»¥çœ‹åˆ°ç›¸åŒçš„ä¼šè¯IDä¸­å¯ä»¥ä½¿ç”¨ChatMemoryï¼Œä¸åŒçš„ä¼šè¯IDä¸­ChatMemoryä¸èƒ½å…±äº«ã€‚

## 5.3. **ChatMemoryå­˜å‚¨åœ¨MySQLæ¡ˆä¾‹**

ä»¥ä¸‹æ¡ˆä¾‹æ˜¯å°†ChatMemoryå­˜å‚¨åœ¨MySQLä¸­ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤å®ç°å³å¯ã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå‘½åä¸ºâ€œSpringAIChatMemoryInMySQLâ€**

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/d50072eed72e41cfb941242813763ca2.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/a3e292c06b9540a184c01f699a9072c8.jpg)

**2) é…ç½®é¡¹ç›®pom.xml**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.3</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIChatMemoryInMySQL</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIChatMemoryInMySQL</name>
    <description>SpringAIChatMemoryInMySQL</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-deepseek</artifactId>
        </dependency>

        <!--å°† ChatMemory å­˜å‚¨åˆ°å…³ç³»æ•°æ®åº“ ä¾èµ–åŒ…-->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-chat-memory-repository-jdbc</artifactId>
        </dependency>

        <!-- å¼•å…¥ MySQL é©±åŠ¨åŒ…-->
        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <version>8.0.33</version>
        </dependency>

    </dependencies>


    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

ä»¥ä¸Špom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-model-deepseekâ€ä¾èµ–ã€â€œspring-ai-starter-model-chat-memory-repository-jdbcâ€ã€â€œmysql-connector-jâ€ä¾èµ–åŒ…ã€‚

**3) é…ç½®resources/application.properties**

```
spring.application.name=SpringAIChatMemoryInMySQL

server.port=8080

#MySQL é…ç½® ï¼Œæå‰åœ¨MySQLä¸­åˆ›å»ºæ•°æ®åº“å’Œè¡¨
spring.datasource.url=jdbc:mysql://localhost:3306/chat_memory?useUnicode=true&characterEncoding=UTF-8&connectionCollation=utf8mb4_unicode_ci
spring.datasource.username=root
spring.datasource.password=123456
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

#è‡ªåŠ¨åˆ›å»ºChatMemoryå­˜å‚¨çš„è¡¨ç»“æ„
spring.ai.chat.memory.repository.jdbc.initialize-schema=always
#å‘Šè¯‰æ¡†æ¶å½“å‰æ•°æ®åº“æ˜¯ MariaDB/MySQLï¼Œä¼šåŠ è½½ schema-mariadb.sql åˆå§‹åŒ–è„šæœ¬ï¼Œè‡ªè¡Œåˆ›å»ºè¡¨ SPRING_AI_CHAT_MEMORYè¡¨
spring.ai.chat.memory.repository.jdbc.platform=mariadb
#ç¡®ä¿æ¯æ¡ JDBC è¿æ¥éƒ½ä½¿ç”¨ utf8mb4 å­—ç¬¦é›†å¹¶æŒ‡å®š utf8mb4_unicode_ci æ’åº
spring.datasource.hikari.connection-init-sql=SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci

#é…ç½® Deepseekçš„åŸºç¡€URLã€å¯†é’¥å’Œä½¿ç”¨æ¨¡å‹
spring.ai.deepseek.base-url=https://api.deepseek.com
spring.ai.deepseek.api-key=sk-...821
spring.ai.deepseek.chat.options.model=deepseek-chat
```

å…³äºä»¥ä¸Šé…ç½®é¡¹çš„è§£é‡Šå¦‚ä¸‹ï¼š

- spring.datasource.urlï¼šè¿æ¥æœ¬åœ° MySQL æ•°æ®åº“ chat_memory
- useUnicode=true&characterEncoding=UTF-8ï¼šç¡®ä¿ JDBC ä½¿ç”¨ Unicode å’Œ UTF8 ç¼–ç ã€‚
- connectionCollation=utf8mb4_unicode_ciï¼šè®¾ç½®æ•°æ®åº“è¿æ¥ä½¿ç”¨çš„å­—ç¬¦æ’åºè§„åˆ™ä¸º utf8mb4_unicode_ciï¼Œç”¨äºå®Œå…¨æ”¯æŒè¡¨æƒ…ç¬¦ï¼ˆemojiï¼‰å’Œå¤šè¯­è¨€å­—ç¬¦ã€‚
- initialize-schema=alwaysï¼šSpring AI çš„ JdbcChatMemoryRepository ä¼šå°è¯•è‡ªåŠ¨åˆ›å»ºæ‰€éœ€è¡¨ç»“æ„ï¼ˆå¦‚ ai_chat_memoryï¼‰ï¼Œè®¾ç½®ä¸º always è¡¨ç¤º æ— è®ºæ•°æ®åº“ç±»å‹ éƒ½å¼ºåˆ¶æ‰§è¡Œç»“æ„åˆå§‹åŒ–
- platform=mariadbï¼šå‘Šè¯‰æ¡†æ¶å½“å‰æ•°æ®åº“æ˜¯ MariaDB/MySQLï¼Œç”¨äºæ›¿æ¢ SQL è„šæœ¬æˆ–å¤„ç†æ–¹è¨€åŒ¹é…ä¸­çš„ @@platform@@ å ä½ç¬¦ã€‚
- spring.datasource.hikari.connection-init-sqlï¼šç¡®ä¿æ¯æ¡ JDBC è¿æ¥éƒ½ä½¿ç”¨ utf8mb4 å­—ç¬¦é›†å¹¶æŒ‡å®š utf8mb4_unicode_ci æ’åºã€‚

**4) åœ¨mysqlä¸­åˆ›å»ºå¯¹åº”æ•°æ®åº“**

è¿™é‡Œä½¿ç”¨çš„æ˜¯Mysql8æ•°æ®åº“ï¼Œåœ¨æ•°æ®åº“ä¸­åˆ›å»ºapplication.propertiesé…ç½®çš„æ•°æ®åº“chat_memory

```
CREATE DATABASE chat_memory
  DEFAULT CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;
```

æ³¨æ„ï¼š"COLLATE utf8mb4_unicode_ci"æ˜¯è®¾ç½®é»˜è®¤æ’åºè§„åˆ™ä¸º utf8mb4_unicode_ciï¼Œæ”¯æŒåŒºåˆ†æˆ–ç­‰åŒå¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼Œä¿è¯å¤šè¯­è¨€ä¸€è‡´æ€§ï¼Œé¿å…å› æ’åºæ–¹å¼ä¸åŒå¯¼è‡´çš„æŸ¥è¯¢æˆ–æ˜¾ç¤ºå¼‚å¸¸ã€‚

**5) åˆ›å»ºconfigåŒ…å¹¶åˆ›å»ºConfig.javaç±»**

```
package com.example.springaichatmemoryinmysql.config;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.memory.MessageWindowChatMemory;
import org.springframework.ai.chat.memory.repository.jdbc.JdbcChatMemoryRepository;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class Config {
    /**
     * é…ç½® ChatMemory Beanï¼Œå¹¶ä½¿ç”¨ JDBC å­˜å‚¨å®ç°ï¼š
     *   - æ³¨å…¥ç³»ç»Ÿä¸­å·²æœ‰çš„ JdbcChatMemoryRepositoryï¼›
     *   - ä½¿ç”¨ MessageWindowChatMemory ç­–ç•¥ï¼Œæœ€å¤šä¿ç•™ 20 æ¡æ¶ˆæ¯ï¼›
     *   - æ¯æ¬¡è¶…å‡ºåï¼Œä¼šåˆ é™¤æœ€æ—§çš„æ¶ˆæ¯ï¼ˆç³»ç»Ÿæ¶ˆæ¯é™¤å¤–ï¼‰ã€‚
     */
    @Bean
    ChatMemory chatMemory(JdbcChatMemoryRepository repo) {
        return MessageWindowChatMemory.builder()
                .chatMemoryRepository(repo)// ä½¿ç”¨ JDBC åç«¯æ¥å­˜å–è®°å¿†
                .maxMessages(20)// æœ€å¤šä¿ç•™ 20 æ¡æ¶ˆæ¯
                .build();
    }

    @Bean
    ChatClient chatClient(ChatModel chatModel, ChatMemory memory) {
        // æ ¹æ® ChatModel å’Œ ChatMemory æ¥æ„å»º ChatClient å®ä¾‹
        // ChatClient æ˜¯ä¸ LLM äº¤äº’çš„å®¢æˆ·ç«¯ï¼Œæ”¯æŒæ·»åŠ å¤šä¸ª Advisorï¼ˆé¡¾é—®ï¼‰æ¥å¢å¼ºåŠŸèƒ½
        return ChatClient.builder(chatModel)
                // å®‰è£…ä¸€ä¸ª MessageChatMemoryAdvisorï¼Œå°† ChatMemory é›†æˆåˆ°ChatClientä¸­
                .defaultAdvisors(MessageChatMemoryAdvisor.builder(memory).build())
                .build();
    }

}
```

é€šè¿‡@Configuration å‘Šè¯‰ Springï¼šè¿™æ˜¯é…ç½®ç±»ï¼Œç±»é‡Œçš„ @Bean æ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼Œè¿”å›çš„å¯¹è±¡å°†æ³¨å†Œä¸º Spring ç®¡ç†çš„ Beanã€‚

**6) åˆ›å»ºcontrolleråŒ…ï¼Œå¹¶åˆ›å»ºCmInMySQLController.javaæ–‡ä»¶**

```
package com.example.springaichatmemoryinmysql.controller;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/ai")
public class CmInMySQLController {

    private final ChatClient chatClient;

    public CmInMySQLController(ChatClient chatClient) {
        this.chatClient = chatClient;
    }

    @GetMapping("/chatMemory")
    public String chatMemory(@RequestParam(value = "cid") String conversationId,
                       @RequestParam(value = "message", defaultValue = "ä½ æ˜¯è°") String message) {

        System.out.println("conversationIdï¼š"+conversationId);

        return chatClient.prompt()
                .user(message)
                // è®¾ç½® advisor å‚æ•°ï¼šå‘Šè¯‰ memory ä½¿ç”¨è°çš„ä¸Šä¸‹æ–‡
                // è¿™é‡Œéœ€è¦ä½¿ç”¨ç¨³å®šçš„ conversationIdï¼Œä¿æŒä¸Šä¸‹æ–‡ä¸€è‡´
                // conversationId ä¸è¦ä½¿ç”¨æ¯æ¬¡æ–°ç”Ÿæˆçš„ UUIDï¼Œå¦åˆ™å°†æ— æ³•ä¿ç•™ä¸Šä¸‹æ–‡
                .advisors(a -> a.param(ChatMemory.CONVERSATION_ID, conversationId))
                .call()
                .content();
    }
}
```

**7) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œæµ‹è¯•ï¼š

```
# http://localhost:8080/ai/chatMemory?cid=123&message=1åŠ 1ç­‰äºå‡ 
1åŠ 1ç­‰äº2ã€‚è¿™æ˜¯åŸºæœ¬çš„æ•°å­¦åŠ æ³•è¿ç®—ç»“æœã€‚ å¦‚æœä½ æœ‰å…¶ä»–æƒ…å¢ƒä¸‹çš„ç‰¹æ®Šå«ä¹‰ï¼ˆæ¯”å¦‚äºŒè¿›åˆ¶ã€å¸ƒå°”ä»£æ•°ç­‰ï¼‰ï¼Œå¯ä»¥è¿›ä¸€æ­¥è¯´æ˜ï¼Œæˆ‘ä¼šä¸ºä½ è¯¦ç»†è§£ç­”ï¼ ğŸ˜Š

# http://localhost:8080/ai/chatMemory?cid=123&message=è¿™ä¸ªæ•°å†åŠ ä¸Š1ç­‰äºå‡ ï¼Ÿ
åœ¨ä¹‹å‰çš„åŠ æ³•ç»“æœ **1 + 1 = 2** çš„åŸºç¡€ä¸Šï¼š **2 + 1 = 3** å¦‚æœæ¶‰åŠå…¶ä»–æƒ…å¢ƒï¼ˆæ¯”å¦‚äºŒè¿›åˆ¶ã€è®¡æ•°å™¨æº¢å‡ºç­‰ï¼‰ï¼Œç»“æœå¯èƒ½ä¸åŒã€‚ä¾‹å¦‚ï¼š - **äºŒè¿›åˆ¶**ï¼š10ï¼ˆäºŒè¿›åˆ¶çš„2ï¼‰ + 1 = 11ï¼ˆäºŒè¿›åˆ¶çš„3ï¼‰ - **æ•°å­—ç³»ç»Ÿä¸Šé™**ï¼šæ¯”å¦‚8ä½æ— ç¬¦å·æ•´æ•°ä¸­ï¼Œ255 + 1 = 0ï¼ˆæº¢å‡ºï¼‰ éœ€è¦å…·ä½“åœºæ™¯çš„è¯ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘ï¼ ğŸ˜„

#http://localhost:8080/ai/chatMemory?cid=1234&message=è¿™ä¸ªæ•°å†åŠ ä¸Š1ç­‰äºå‡ ï¼Ÿ
### é—®é¢˜é™ˆè¿° **é—®é¢˜ï¼š** è¿™ä¸ªæ•°å†åŠ ä¸Š1ç­‰äºå‡ ï¼Ÿ ### åˆæ­¥ç†è§£ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®é—®é¢˜çš„å«ä¹‰ã€‚é—®é¢˜é—®çš„æ˜¯â€œè¿™ä¸ªæ•°â€åŠ ä¸Š1ç­‰äºå¤šå°‘ã€‚å…³é”®åœ¨äºâ€œè¿™ä¸ªæ•°â€æŒ‡çš„æ˜¯å“ªä¸ªæ•°ã€‚ç”±äºé—®é¢˜ä¸­æ²¡æœ‰æ˜ç¡®ç»™å‡ºâ€œè¿™ä¸ªæ•°â€çš„å…·ä½“å€¼ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å‡ ç§å¯èƒ½æ€§...
```

å¯ä»¥çœ‹åˆ°ç›¸åŒçš„ä¼šè¯IDä¸­å¯ä»¥ä½¿ç”¨ChatMemoryï¼Œä¸åŒçš„ä¼šè¯IDä¸­ChatMemoryä¸èƒ½å…±äº«ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹MySqlå¯¹åº”çš„spring_ai_chat_memoryè¡¨ï¼Œè¯¥è¡¨å°†æ¯æ¬¡ä¼šè¯ä¿¡æ¯éƒ½å­˜å‚¨ä¸‹æ¥ï¼Œå­˜å‚¨å†…å®¹å¦‚ä¸‹ï¼š

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/0ab2122800fc4b7ca4645cdbcb999708.jpg)

# 6. **Tool Calling å·¥å…·è°ƒç”¨**

Toolâ€¯Callingï¼ˆå·¥å…·è°ƒç”¨ï¼‰ï¼Œä¹Ÿç§°ä¸ºå‡½æ•°è°ƒç”¨ï¼Œæ˜¯è®©å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰åœ¨å¯¹è¯ä¸­â€œè°ƒç”¨â€å¤–éƒ¨å®šä¹‰çš„å·¥å…·æˆ– API çš„æœºåˆ¶ï¼Œé€šè¿‡è¿™ä¸ªæœºåˆ¶ï¼Œæ¨¡å‹å¯ä»¥åœ¨ç”Ÿæˆå›ç­”å‰æå‡ºéœ€è¦æ‰§è¡Œçš„æ“ä½œï¼ˆå¦‚è·å–å®æ—¶å¤©æ°”ã€è®¾ç½®æ•°æ®åº“è®°å½•ã€è§¦å‘ä¸šåŠ¡æµç¨‹ç­‰ï¼‰ï¼Œç„¶åç”±åº”ç”¨ç«¯æ‰§è¡Œå·¥å…·ï¼Œç»“æœå†åé¦ˆå›æ¨¡å‹ï¼Œæœ€ç»ˆç»™ç”¨æˆ·å®Œæ•´å›å¤ã€‚

Tool Callingä¸»è¦åº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š

- ä¿¡æ¯æ£€ç´¢ï¼šä»å¤–éƒ¨æºï¼ˆå¦‚æ•°æ®åº“ã€Web æœåŠ¡ã€æ–‡ä»¶ç³»ç»Ÿæˆ– Web æœç´¢å¼•æ“ï¼‰æ£€ç´¢ä¿¡æ¯ï¼Œå¢å¼ºæ¨¡å‹çš„çŸ¥è¯†ï¼Œä½¿å…¶èƒ½å¤Ÿå›ç­”å…¶ä»–æ–¹å¼æ— æ³•å›ç­”çš„é—®é¢˜ã€‚
- æ‰§è¡Œæ“ä½œï¼šåœ¨è½¯ä»¶ç³»ç»Ÿä¸­æ‰§è¡Œç‰¹å®šæ“ä½œï¼Œå¦‚å‘é€ç”µå­é‚®ä»¶ã€åœ¨æ•°æ®åº“ä¸­åˆ›å»ºæ–°è®°å½•ã€æäº¤è¡¨å•æˆ–è§¦å‘å·¥ä½œæµã€‚ç›®æ ‡æ˜¯è‡ªåŠ¨æ‰§è¡ŒåŸæœ¬éœ€è¦äººå·¥å¹²é¢„æˆ–æ˜¾å¼ç¼–ç¨‹çš„ä»»åŠ¡ã€‚

Spring AI æä¾›äº†æ–¹ä¾¿çš„ API æ¥å®šä¹‰å·¥å…·ã€è§£ææ¥è‡ªæ¨¡å‹çš„å·¥å…·è°ƒç”¨è¯·æ±‚ä»¥åŠæ‰§è¡Œå·¥å…·è°ƒç”¨ã€‚

## 6.1. **å·¥å…·å®šä¹‰ä¸ä½¿ç”¨**

Spring AIä¸­å·¥å…·è°ƒç”¨æµç¨‹ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/1bd8767c2cc94ef2890e379d39f003fc.jpg)

1. å¼€å‘è€…å®šä¹‰å·¥å…·ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚
2. æ¨¡å‹åœ¨ç”Ÿæˆå“åº”æ—¶ï¼Œè¯†åˆ«åˆ°éœ€è¦è°ƒç”¨å·¥å…·ï¼Œä¼šç”ŸæˆåŒ…å«å·¥å…·è°ƒç”¨ä¿¡æ¯çš„å“åº”ã€‚
3. åº”ç”¨ç¨‹åºæ¥æ”¶åˆ°æ¨¡å‹çš„å“åº”åï¼Œè§£æå…¶ä¸­çš„å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼Œæ‰§è¡Œç›¸åº”çš„å·¥å…·ã€‚
4. å·¥å…·æ‰§è¡Œå®Œæˆåï¼Œå°†ç»“æœè¿”å›ç»™åº”ç”¨ç¨‹åºã€‚
5. åº”ç”¨ç¨‹åºå°†å·¥å…·æ‰§è¡Œç»“æœä½œä¸ºä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¼ é€’ç»™æ¨¡å‹ã€‚
6. æ¨¡å‹ä½¿ç”¨å·¥å…·æ‰§è¡Œç»“æœï¼Œç”Ÿæˆæœ€ç»ˆçš„å“åº”ã€‚

- **å·¥å…·å®šä¹‰ï¼š**

å¼€å‘è€…å¯ä»¥é€šè¿‡åœ¨æ–¹æ³•ä¸Šæ·»åŠ @Toolæ³¨è§£å®šä¹‰å·¥å…·ï¼Œè¯¥æ³¨è§£å…è®¸æä¾›å·¥å…·çš„åç§°ã€æè¿°å’Œè¾“å…¥å‚æ•°ç­‰ä¿¡æ¯ï¼Œæ¨¡å‹åœ¨è°ƒç”¨å·¥å…·æ—¶ï¼Œä¼šæ ¹æ®è¿™äº›ä¿¡æ¯ç”Ÿæˆç›¸åº”çš„è°ƒç”¨è¯·æ±‚ã€‚

å®šä¹‰å·¥å…·ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
@Component
public class Tools {

    @Tool(description = "è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´")
    public String getCurrentDateTime() {
        return å½“å‰æ—¥æœŸ...;
    }

    @Tool(description = "è®¾ç½®é—¹é’Ÿ")
    public void setAlarm(@ToolParam(description = "é—¹é’Ÿæ—¶é—´") String alarmTime) {
        // è®¾ç½®é—¹é’Ÿçš„é€»è¾‘
    }
}
```

ä»¥ä¸Šæ³¨æ„ç‚¹ï¼š

a. @Component åŠ åˆ°ç±»ä¸­ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œå…³é”®æ˜¯å°†å·¥å…·ç±»è®©Springå®¹å™¨ç®¡ç†èµ·æ¥ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨@Configurationã€@Serviceæ ‡è®°ç±»ï¼Œåªè¦Spring èƒ½æ‰«æåˆ°å¹¶å°†å…¶å®ä¾‹ç®¡ç†èµ·æ¥å°±å¯ä»¥ã€‚

b. å·¥å…·æ–¹æ³•ä½¿ç”¨@Toolæ ‡æ³¨ï¼›å·¥å…·åç§°é»˜è®¤å°±æ˜¯æ–¹æ³•æœ¬èº«ï¼Œä¹Ÿå¯ä»¥é€šè¿‡@Tool(name="tool name")æ–¹å¼æ¥æŒ‡å®šã€‚

c. @Tool(description="...")ä¸­ï¼Œè¿™é‡Œçš„descriptionæ˜¯å·¥å…·æè¿°ï¼Œå¤§æ¨¡å‹æ ¹æ®è¯¥æè¿°å†³å®šè¦ä¸è¦è°ƒç”¨è¯¥å·¥å…·ã€‚

d. å·¥å…·æ–¹æ³•ä¸­éœ€è¦ä¼ å…¥å‚æ•°çš„ï¼Œé€šè¿‡ä½¿ç”¨@ToolParamæ ‡æ³¨ï¼Œå¤§æ¨¡å‹è‡ªåŠ¨å†³å®šè°ƒç”¨æ—¶æœºå’Œè‡ªåŠ¨æ ¹æ®è¯­ä¹‰ä¼ å…¥å‚æ•°ï¼Œè°ƒç”¨å®Œæˆåç”Ÿæˆæœ€ç»ˆå¯¹è¯ã€‚

e. å·¥å…·ä¸æ”¯æŒå¦‚ä¸‹ç±»å‹ä½œä¸ºå‚æ•°æˆ–è¿”å›å€¼:Optionalã€å¼‚æ­¥ç±»å‹ï¼ˆå¦‚ CompletableFutureã€Futureï¼‰ã€å“åº”å¼ç±»å‹ï¼ˆå¦‚ Flowã€Monoã€Fluxï¼‰ã€å‡½æ•°å¼ç±»å‹ï¼ˆå¦‚ Functionã€Supplierã€Consumerï¼‰ã€‚

- **å·¥å…·ä½¿ç”¨ï¼š**

```
//æ³¨å†Œå¤šä¸ªå·¥å…·
ChatClient chatClient = ChatClient.builder(chatModel)
		.defaultSystem("ä½ æ˜¯ä¸€ä¸ªéå¸¸æœ‰å¸®åŠ©çš„åŠ©æ‰‹ï¼Œä½ å¯ä»¥ä½¿ç”¨å·¥å…·æ¥å¸®åŠ©å›ç­”é—®é¢˜")
		.defaultTools(new ATools(),new BTools,new CTools ...)
		.build();

//ä¸æ¨¡å‹è¿›è¡Œå¯¹è¯
String result = chatClient.prompt()
		.user("ç»™æˆ‘è®¾ç½®10åˆ†é’Ÿåçš„é—¹é’Ÿ")
		.call()
		.content();
```

## 6.2. **Tool Calling ä½¿ç”¨æ¡ˆä¾‹**

å¦‚ä¸‹åˆ›å»ºSpringBooté¡¹ç›®ï¼Œåœ¨è¯¥é¡¹ç›®ä¸­å®šä¹‰å¤šä¸ªå·¥å…·æ¼”ç¤ºSpring AIä¸­å·¥å…·ä½¿ç”¨ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤å®ç°å³å¯ã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®ï¼Œå‘½åä¸ºâ€œSpringAIToolCallingâ€**

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/f1effdd487f649b99aba882b931a80d3.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/5e688be77e214fc9947f1a798c78b481.jpg)

**2) é…ç½®é¡¹ç›®pom.xml**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.3</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIToolCalling</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIToolCalling</name>
    <description>SpringAIToolCalling</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-deepseek</artifactId>
        </dependency>
    </dependencies>


    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

ä»¥ä¸Špom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-model-deepseekâ€ä¾èµ–åŒ…ã€‚

**3) é…ç½®resources/application.properties**

```
spring.application.name=SpringAIToolCalling

server.port=8080

#é…ç½® Deepseekçš„åŸºç¡€URLã€å¯†é’¥å’Œä½¿ç”¨æ¨¡å‹
spring.ai.deepseek.base-url=https://api.deepseek.com
spring.ai.deepseek.api-key=sk-...21
spring.ai.deepseek.chat.options.model=deepseek-chat
```

**4) åˆ›å»ºtoolsåŒ…å¹¶åˆ›å»ºMyTools.javaç±»**

```
package com.example.springaitoolcalling.tools;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.ai.tool.annotation.Tool;
import org.springframework.ai.tool.annotation.ToolParam;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

@Component
public class MyTools {

    Logger log = LoggerFactory.getLogger(MyTools.class);

    @Tool(description = "è¿”å›å½“å‰ç³»ç»Ÿæ—¶é—´")
    public String getCurrentTime() {
        log.info("è°ƒç”¨ getCurrentTime å·¥å…·ï¼Œå½“å‰æ—¶é—´ï¼š"+java.time.LocalDateTime.now().toString());
        return java.time.LocalDateTime.now().toString();
    }

    @Tool(description = "å¯¹ä¸¤ä¸ªæ•°å­—æ‰§è¡ŒåŠ ã€å‡ã€ä¹˜ã€é™¤è¿ç®—")
    public double calculate(
            @ToolParam(description = "ç¬¬ä¸€ä¸ªæ•°å­—") double a,
            @ToolParam(description = "ç¬¬äºŒä¸ªæ•°å­—") double b,
            @ToolParam(description = "è¿ç®—ç±»å‹") String operation) {
        log.info("è°ƒç”¨ calculate å·¥å…·ï¼Œç¬¬ä¸€ä¸ªæ•°å­—ï¼š"+a+",ç¬¬äºŒä¸ªæ•°å­—ï¼š"+b+",è¿ç®—ç±»å‹ï¼š"+operation);

        double result = 0;

        switch (operation) {
            case "add":
                result = a + b;
                break;
            case "subtract":
                result = a - b;
                break;
            case "multiply":
                result = a * b;
                break;
            case "divide":
                if (b != 0) {
                    result = a / b;
                }
        }

        return result;
    }

    private RestTemplate restTemplate = new RestTemplate();
    private
    String baseUrl = "http://shanhe.kim/api/youjia/youjia.php";

    @Tool(description = "æŸ¥è¯¢æŒ‡å®šçœä»½çš„æ²¹ä»·ï¼Œç›´æ¥è¿”å›å®Œæ•´ JSON å­—ç¬¦ä¸²")
    public String getOilPriceJson(@ToolParam(description = "çœä»½åç§°") String province) {
        log.info("è°ƒç”¨ getOilPriceJson å·¥å…·ï¼ŒæŸ¥è¯¢çœä»½ï¼š"+province);
        String url = String.format("%s?province=%s", baseUrl, province);
        return restTemplate.getForObject(url, String.class);
    }
}
```

åœ¨MyTools.javaç±»ä¸­æˆ‘ä»¬å®šä¹‰äº†ä¸‰ä¸ªå·¥å…·ï¼Œæ¯ä¸ªæ–¹æ³•ä¸­è¿›è¡Œäº†logæ—¥å¿—è¾“å‡ºï¼š

- getCurrentTimeï¼šè¿”å›å½“å‰ç³»ç»Ÿæ—¶é—´ã€‚
- calculate:å¯¹ä¸¤ä¸ªæ•°å­—æ‰§è¡ŒåŠ ã€å‡ã€ä¹˜ã€é™¤è¿ç®—ã€‚
- getOilPriceJson:æŸ¥è¯¢æŒ‡å®šçœä»½çš„æ²¹ä»·ï¼Œç›´æ¥è¿”å›å®Œæ•´ JSON å­—ç¬¦ä¸²ã€‚

**5) åˆ›å»ºcontrolleråŒ…ï¼Œå¹¶åˆ›å»ºToolUseController.javaæ–‡ä»¶**

```
package com.example.springaitoolcalling.controller;

import com.example.springaitoolcalling.tools.MyTools;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/ai")
public class ToolUseController {
    private final ChatClient chatClient;

    public ToolUseController(ChatModel chatModel, MyTools tools) {
        this.chatClient = ChatClient.builder(chatModel)
                .defaultSystem("ä½ æ˜¯ä¸€ä¸ªéå¸¸æœ‰å¸®åŠ©çš„åŠ©æ‰‹ï¼Œä½ å¯ä»¥ä½¿ç”¨å·¥å…·æ¥å¸®åŠ©å›ç­”é—®é¢˜")
                .defaultTools(tools)
                .build();
    }

    @GetMapping("/chat")
    public String chat(@RequestParam("message") String message) {

        return chatClient.prompt()
                .user(message)
                .call()
                .content();
    }
}
```

**6) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨é¡¹ç›®åï¼Œæµè§ˆå™¨è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œæµ‹è¯•ï¼š

```
# http://localhost:8080/ai/chat?message=ä»Šå¤©æ˜¯ä»€ä¹ˆæ—¥æœŸï¼Ÿ
ä»Šå¤©æ˜¯xxxå¹´xxæœˆxxæ—¥

# http://localhost:8080/ai/chat?message=123ä¹˜ä»¥200æ˜¯å¤šå°‘ï¼Ÿ
123ä¹˜ä»¥200ç­‰äº24600ã€‚

# http://localhost:8080/ai/chat?message=åŒ—äº¬æ²¹ä»·æ˜¯å¤šå°‘ï¼Ÿ
åŒ—äº¬çš„æ²¹ä»·å¦‚ä¸‹ï¼š - 92å·æ±½æ²¹ï¼š7.17 å…ƒ/å‡ - 95å·æ±½æ²¹ï¼š7.64 å…ƒ/å‡ - 98å·æ±½æ²¹ï¼š9.14 å…ƒ/å‡ - 0å·æŸ´æ²¹ï¼š6.86 å…ƒ/å‡ æ•°æ®æ›´æ–°æ—¶é—´ï¼šxxx xxx

# http://localhost:8080/ai/chat?message=ä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ
æˆ‘æ— æ³•ç›´æ¥è·å–å¤©æ°”ä¿¡æ¯ï¼Œä½†æ‚¨å¯ä»¥å‘Šè¯‰æˆ‘æ‚¨æ‰€åœ¨çš„åŸå¸‚æˆ–åœ°åŒºï¼Œæˆ‘å¯ä»¥å°è¯•ä¸ºæ‚¨æä¾›ç›¸å…³çš„å¤©æ°”æŸ¥è¯¢å»ºè®®æˆ–é“¾æ¥ã€‚
```

ç‰¹åˆ«æç¤ºï¼š

- ä»¥ä¸Šä»£ç è¿è¡Œåï¼Œä¸å·¥å…·è°ƒç”¨ç›¸å…³çš„æé—®å¯ä»¥çœ‹åˆ°åå°æ‰“å°çš„æ—¥å¿—ä¼šè°ƒç”¨åˆ°å·¥å…·å¯¹åº”çš„æ–¹æ³•ã€‚
- æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨â€œToolUseController.javaâ€ä¸­è®¾ç½®ä¸ä½¿ç”¨å·¥å…·ï¼Œå°†â€œdefaultToolsï¼ˆnew MyToolsï¼‰â€æ³¨é‡Šæ‰å†è¿›è¡Œæµ‹è¯•ï¼Œä¼šå‘ç°ä»¥ä¸Šè®¿é—®ä¸ä¼šè°ƒç”¨å·¥å…·ï¼Œéƒ½ç”±å¤§æ¨¡å‹æ ¹æ®å·²æœ‰çŸ¥è¯†è¿›è¡Œå›å¤ï¼Œå¯èƒ½å­˜åœ¨ä¸ç²¾å‡†æƒ…å†µã€‚

# 7. **MCPæ¨¡å‹ä¸Šä¸‹æ–‡åè®®**

## 7.1. **MCPä»‹ç»ä¸åŸç†**

MCPï¼ˆModel Context Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼‰æ˜¯ Anthropic äº 2024 å¹´ 11 æœˆæ¨å‡ºçš„å¼€æ”¾æ ‡å‡†ï¼Œæ—¨åœ¨ä¸ºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰æä¾›ç»Ÿä¸€æ¥å£ï¼Œä»¥ä¾¿è¿æ¥å’Œè°ƒç”¨å¤–éƒ¨æ•°æ®æºå’Œå·¥å…·ã€‚

ç›®å‰ï¼Œå„å¤§ LLM å¹³å°ï¼ˆå¦‚ Deepseekã€ChatGPTã€Claudeï¼‰æ™®éæ”¯æŒ Function Callingï¼Œå…è®¸æ¨¡å‹åœ¨éœ€è¦æ—¶è°ƒç”¨ç‰¹å®šå‡½æ•°ï¼ˆå¦‚è®¿é—®ç½‘ç»œã€æŸ¥è¯¢æ•°æ®åº“ç­‰ï¼‰æ¥æ‰©å±•èƒ½åŠ›ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/9a25458c571c431bafa22b896450b361.jpg)

ç„¶è€Œï¼Œä¸åŒå¹³å°çš„ Function Call API å­˜åœ¨å®ç°å·®å¼‚ï¼Œå¯¼è‡´å¼€å‘è€…åœ¨åˆ‡æ¢å¹³å°æ—¶éœ€è¦é‡æ–°é€‚é…ï¼Œå¢åŠ äº†å¼€å‘æˆæœ¬ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/b7256bb7d28e4bafbdfe53019f8a4a22.jpg)

**MCPçš„æ ¸å¿ƒæ˜¯å¯¹å¤§æ¨¡å‹è°ƒç”¨å¤–éƒ¨å·¥å…·å»ºç«‹ä¸€ä¸ªæ ‡å‡†åŒ–æµç¨‹**ã€‚MCPåŸºäº Function Callingï¼Œè¿›ä¸€æ­¥å®šä¹‰äº†ä»è¯·æ±‚æ„å»ºã€å‘é€ã€æ‰§è¡Œåˆ°ç»“æœè¿”å›çš„æ ‡å‡†åŒ–æµç¨‹ã€‚é€šè¿‡ MCPï¼Œæ¨¡å‹å¯ä»¥ä»¥ç»Ÿä¸€æ–¹å¼ä¸å„ç§å¤–éƒ¨å·¥å…·å’Œæ•°æ®æºäº¤äº’ï¼Œæå¤§æå‡äº†è·¨å¹³å°å…¼å®¹æ€§å’Œ AI åº”ç”¨å¼€å‘æ•ˆç‡ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/43a7611169004e1cb1ad8821e57dc23f.jpg)

**MCP ä¸ Function Calling çš„åŒºåˆ«å’Œè”ç³»å¦‚ä¸‹ï¼š**

- Function Calling ï¼šæ˜¯ LLM å†…éƒ¨å®šä¹‰çš„ä¸€ç»„å‡½æ•°ï¼Œé€šè¿‡ JSON schema è®© LLMçŸ¥é“æœ‰å“ªäº›åŠŸèƒ½èƒ½è°ƒç”¨ã€‚
- MCP:åœ¨ Function Calling åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥æ ‡å‡†åŒ–äº†å‡½æ•°è°ƒç”¨çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬è¯·æ±‚çš„æ„å»ºã€å‘é€ã€æ‰§è¡Œä»¥åŠç»“æœçš„è¿”å›ã€‚

ç®€å•æ¥è¯´ï¼ŒMCP æ˜¯å¯¹ Function Calling çš„æ‰©å±•ä¸å‡çº§ï¼Œå®ç°äº†æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡å’Œæ›´å¼ºçš„å¯æ‰©å±•æ€§ã€‚å¯ä»¥å°† MCP ç†è§£ä¸º AI ä¸–ç•Œé‡Œçš„â€œUSB-Cæ ‡å‡†â€ï¼Œä¸ºæ¨¡å‹æ¥å…¥å„ç§æ•°æ®æºå’Œå·¥å…·æä¾›äº†ç»Ÿä¸€æ¥å£ï¼Œç¡®ä¿è¿æ¥ä¾¿æ·ä¸”å®‰å…¨ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/c3a233ea28834d2eaa432534d7522f36.jpg)

MCP éµå¾ªå®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„ï¼Œè§’è‰²ä¸»è¦åŒ…å«ä¸‰éƒ¨åˆ†ï¼š

- **MCP Host**

è¿è¡Œ LLMï¼ˆå¦‚ Claudeã€ChatGPTã€Deepseekï¼‰çš„å®ä½“èŠ‚ç‚¹ï¼Œå¦‚æœä½¿ç”¨çš„LLMä¸ºçº¿ä¸Šæ¨¡å‹ï¼Œå¯ä»¥å¿½ç•¥è¿™éƒ¨åˆ†ã€‚

- **MCP Client**

**è¿è¡Œç€ä¸å¤§æ¨¡å‹å¯¹è¯çš„å®¢æˆ·ç«¯ï¼ˆå¯èƒ½ä¼šä½¿ç”¨å·¥å…·ï¼‰å«åšMCP Client**ã€‚å…¶ä¸ MCP Server ä¿æŒ 1:1 è¿æ¥ï¼Œè´Ÿè´£è§£ææ¨¡å‹è¯·æ±‚ï¼Œå¦‚æœä½¿ç”¨å·¥å…·ä¼šå°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº” MCP Serverã€‚

- **MCP Server**

**å®é™…è¿è¡Œå¤–éƒ¨å·¥å…·ï¼ˆå¦‚è®¿é—®æ–‡ä»¶ç³»ç»Ÿã€å‘é€é‚®ä»¶ã€æŸ¥è¯¢æ—¥å†ï¼‰çš„æœåŠ¡ç«¯å«åšMCP Server**ã€‚è´Ÿè´£å¤„ç†è¯·æ±‚å¹¶å°†ç»“æœè¿”å›ç»™ Clientã€‚

MCP Cilentä¸MCP Serverä¹‹é—´æœ‰ä¸¤ç§é€šä¿¡æœºåˆ¶ï¼šStdioï¼ˆæ ‡å‡†è¾“å…¥/è¾“å‡ºï¼‰å’ŒSSE(Server-Sent-Eventï¼ŒæœåŠ¡å™¨å‘é€äº‹ä»¶)ï¼Œä¸¤ç§æœºåˆ¶ä»‹ç»å¦‚ä¸‹ï¼š

- Stdioï¼ˆæ ‡å‡†è¾“å…¥/è¾“å‡ºï¼‰ï¼šå½“æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åŒæ—¶è¿è¡Œåœ¨æœ¬æœºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨Stdioæœºåˆ¶ã€‚
- SSE(Server-Sent-Event)ï¼šå½“æœåŠ¡å™¨éƒ¨ç½²åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼Œå®¢æˆ·ç«¯é€šè¿‡HTTP è¯·æ±‚å‘é€æ¶ˆæ¯ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚

## 7.2. **MCP Java SDK æ¶æ„**

ä¸‹å›¾æ˜¯MCP Java SDK æ¶æ„ç¤ºæ„å›¾ï¼š

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/f08bba841f504681a49e0c9205a0fb76.jpg)

ä¸Šå›¾ä¸­ï¼ŒMcpClientå¤„ç†å®¢æˆ·ç«¯æ“ä½œï¼ŒMcpServerç®¡ç†æœåŠ¡ç«¯æ“ä½œï¼Œä¸¤è€…éƒ½ä½¿ç”¨McpSessionè¿›è¡Œé€šä¿¡ç®¡ç†ã€‚ä¼ è¾“å±‚ï¼ˆMcp Transportï¼‰è´Ÿè´£å¤„ç†JSON-RPC æ¶ˆæ¯çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ”¯æŒä¸‰ç§ä¼ è¾“å®ç°ï¼šSTDIOã€Spring MVC SSEã€Spring WebFlux SSEï¼Œä¸‰è€…åŒºåˆ«å¦‚ä¸‹:

- STDIO:åŸºäºè¿›ç¨‹é—´çš„æ ‡å‡†è¾“å…¥/è¾“å‡ºï¼ˆSTDIOï¼‰ä¼ è¾“ï¼Œæ”¯æŒå•è¿›ç¨‹ï¼ŒåŒæ­¥äº¤äº’å¤„ç†æ¶ˆæ¯ã€‚é€‚ç”¨äºMCP æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šé›†æˆã€‚
- Spring MVC SSEï¼ˆHTTP SSEï¼‰:åŸºäºSpring MVCçš„SSEä¼ è¾“ï¼Œæ”¯æŒServletçº¿ç¨‹æ± ï¼Œé˜»å¡å¼å¤„ç†æ¶ˆæ¯ã€‚é€‚ç”¨äºæ™®é€šçš„Webåº”ç”¨ã€‚
- Spring WebFlux SSE:å®˜æ–¹å»ºè®®æ–¹å¼ã€‚åŸºäºSpring WebFluxçš„ååº”å¼SSEï¼Œæ”¯æŒé«˜å¹¶å‘ã€ä½å»¶è¿Ÿï¼Œå“åº”å¼å¤„ç†æ¶ˆæ¯ã€‚é€‚ç”¨äºé«˜å¹¶å‘çš„webå¾®æœåŠ¡ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/8885efc19d02491a853aa7522a41ac12.jpg)

å¯¹äºä»¥ä¸Šä¸åŒçš„ä¼ è¾“æ–¹å¼ï¼ŒSpring AI æä¾›äº†å¤šä¸ªå¯åŠ¨å™¨ï¼ˆstarterï¼‰ï¼Œç®€åŒ–MCPåœ¨SpringBootä¸­çš„ä½¿ç”¨ã€‚

- **å®¢æˆ·ç«¯Starter:**

spring-ai-starter-mcp-clientï¼šæ”¯æŒ STDIO ä¸ HTTP-SSEã€‚

spring-ai-starter-mcp-client-webfluxï¼šåŸºäº WebFlux çš„ SSE å®¢æˆ·ç«¯å®ç°ã€‚

- **æœåŠ¡ç«¯Starter:**

spring-ai-starter-mcp-serverï¼šæ”¯æŒ STDIO ä¼ è¾“ã€‚

spring-ai-starter-mcp-server-webmvcï¼šåŸºäº Spring MVC çš„ SSE æœåŠ¡ç«¯å®ç°ã€‚

spring-ai-starter-mcp-server-webfluxï¼šåŸºäº WebFlux çš„ SSE æœåŠ¡ç«¯å®ç°ã€‚

## 7.3. **MCP æ¡ˆä¾‹-Stdioä¼ è¾“æ¨¡å¼**

åœ¨è¯¥æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºMCP Server å’ŒMCP Client ä¸¤ä¸ªSpringBooté¡¹ç›®ï¼ŒMCP Serveré¡¹ç›®ä¸­ä¼šåˆ›å»ºä¸€ä¸ªgetWeatherå·¥å…·ï¼Œè¯¥å·¥å…·é€šè¿‡OpenWeatherå¯ä»¥æŸ¥è¯¢æŸä¸ªåŸå¸‚å¤©æ°”æƒ…å†µï¼›MCP Client é¡¹ç›®ä¸­åˆ›å»ºç›¸åº”çš„Controllerï¼Œæ ¹æ®é…ç½®é€šè¿‡STDIO æ–¹å¼ä¸MCP Serverè¿›è¡Œé€šä¿¡ï¼Œå®ç°è°ƒç”¨å¤©æ°”å·¥å…·ã€‚

### **7.3.1. Mcp Serverå¼€å‘**

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤åˆ›å»ºMCP Serverå¯¹åº”çš„SpringBooté¡¹ç›®ã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®**

SpringBooté¡¹ç›®å‘½åä¸ºSpringAIMCPStdioServerï¼Œè®¾ç½®ä½¿ç”¨çš„JDKä¸º17ç‰ˆæœ¬ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/01fec433ad7d4bc2b7da061b05a64040.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/b090ea8a95b64e94a03acc03d4a11fdb.jpg)

**2) åœ¨é¡¹ç›®ä¸­åŠ å…¥å¦‚ä¸‹Mavenä¾èµ–**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.3</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIMCPStdioServer</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIMCPStdioServer</name>
    <description>SpringAIMCPStdioServer</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- ä¾èµ–çš„MCP åŒ… ,åªæ”¯æŒ STDIO ä¼ è¾“-->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-mcp-server</artifactId>
        </dependency>

        <!-- ä¾èµ–çš„json åŒ…-->
        <dependency>
            <groupId>org.json</groupId>
            <artifactId>json</artifactId>
            <version>20210307</version>
        </dependency>
    </dependencies>

    <!-- æ‰“åŒ…æ’ä»¶ -->
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>3.4.4</version>
                <configuration>
                    <mainClass>com.example.springaimcpstdioserver.SpringAimcpStdioServerApplication</mainClass>
                </configuration>
                <executions>
                    <execution>
                        <goals>
                            <goal>repackage</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

æ³¨æ„ï¼šåœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-mcp-serverâ€MCP ä¾èµ–åŒ…ï¼Œè¯¥åŒ…åªæ”¯æŒSTDIO ä¼ è¾“ã€‚

**3) é…ç½®resources/application.properties**

```
spring.application.name=SpringAIMCPStdioServer

#æŒ‡å®š MCP æœåŠ¡å™¨çš„åç§°ä¸º spring-ai-mcp-weather
spring.ai.mcp.server.name=spring-ai-mcp-weather

#é…ç½®åº”ç”¨ç›‘å¬çš„ç«¯å£ä¸º 8080
server.port=8086

#ç¦ç”¨ Spring Boot å¯åŠ¨æ—¶çš„æ¨ªå¹…ï¼ˆBannerï¼‰æ˜¾ç¤ºï¼Œå¯¹äºä½¿ç”¨ STDIO ä¼ è¾“çš„ MCP æœåŠ¡å™¨ï¼Œç¦ç”¨æ¨ªå¹…æœ‰åŠ©äºé¿å…è¾“å‡ºå¹²æ‰°ã€‚
spring.main.banner-mode=off

#å¦‚ä¸‹å‚æ•°å¯ç”¨å¹¶è®¾ç½®ä¸ºç©ºï¼Œå°†ç¦ç”¨æ§åˆ¶å°æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œå‡å°‘è¾“å‡ºå¹²æ‰°
logging.pattern.console=

#é…ç½®æ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ï¼Œå°†æ—¥å¿—å†™å…¥æŒ‡å®šçš„æ–‡ä»¶ä¸­
logging.file.name=D:/idea_space/SpringAICode/SpringAIMCPStdioServer/model-context-protocol/mcp-weather-stdio-server.log


#è®¿é—® OpenWeather API çš„å¯†é’¥
OPEN_WEATHER_API_KEY=f0...8
```

ç‰¹åˆ«æ³¨æ„ï¼šä»¥ä¸Šé…ç½®ä¸­logging.file.nameæŒ‡å®šäº†MCP Serverè¿è¡Œè¿‡ç¨‹ä¸­æ—¥å¿—è¾“å‡ºçš„ä½ç½®ï¼Œå¯ä»¥é€šè¿‡è¯¥æ—¥å¿—æŸ¥çœ‹Serverç«¯è¿è¡Œæƒ…å†µï¼ˆå¦‚ï¼šå·¥å…·æ˜¯å¦è¢«è°ƒç”¨ï¼‰ã€‚

**4) åˆ›å»º WeatherService.javaæ„å»ºæŸ¥è¯¢å¤©æ°”å·¥å…·**

åœ¨é¡¹ç›®ä¸­åˆ›å»ºserviceåŒ…ï¼Œåœ¨è¯¥åŒ…ä¸­åˆ›å»ºWeatherService.javaç±»ï¼Œæ„å»ºæŸ¥è¯¢å¤©æ°”å·¥å…·ï¼š

```
package com.example.springaimcpstdioserver.service;


import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;

import org.json.JSONArray;
import org.json.JSONObject;
import org.springframework.ai.tool.annotation.Tool;
import org.springframework.ai.tool.annotation.ToolParam;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * å¤©æ°”æœåŠ¡ç±»ï¼Œç”¨äºè·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯
 * @Service æ ‡è®°ä¸º Spring æœåŠ¡å±‚ç»„ä»¶
 */

@Service
public class WeatherService {
    private static final Logger logger = LoggerFactory.getLogger(WeatherService.class);

    private static final String BASE_URL = "http://api.openweathermap.org/data/2.5/weather";

    @Value("${OPEN_WEATHER_API_KEY}")
    private String OPEN_WEATHER_API_KEY;

    /**
     * æ ¹æ®åŸå¸‚åç§°è·å–å¤©æ°”ä¿¡æ¯ï¼ˆä½¿ç”¨ OpenWeatherMapï¼‰
     * @param city åŸå¸‚åç§°ï¼Œå¦‚ "Beijing"
     * @return å¤©æ°”ä¿¡æ¯æ–‡æœ¬
     */
    @Tool(description = "è·å–æŒ‡å®šåŸå¸‚çš„å½“å‰å¤©æ°”æƒ…å†µï¼Œæ ¼å¼åŒ–åçš„å¤©æ°”æŠ¥å‘Šå­—ç¬¦ä¸²ã€‚")
    public String getWeather(@ToolParam(description = "åŸå¸‚åç§°ï¼Œå¿…é¡»æ˜¯è‹±æ–‡æ ¼å¼ï¼Œæ¯”å¦‚ London æˆ– Beijing") String city) {

        logger.info("====== è°ƒç”¨äº†getWeatherå·¥å…· ======");

        try {
            String charset = "UTF-8";

            String query = String.format(
                    "q=%s&appid=%s&units=metric&lang=zh_cn",
                    URLEncoder.encode(city, charset),
                    URLEncoder.encode(OPEN_WEATHER_API_KEY, charset)
            );

            URL url = new URL(BASE_URL + "?" + query);
            logger.info("====== è®¿é—®URLï¼š ======"+url.toString());

            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("GET");

            BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), charset));

            StringBuilder response = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                response.append(line);
            }
            reader.close();

            JSONObject data = new JSONObject(response.toString());

            if (data.getInt("cod") == 404) {
                return "æœªæ‰¾åˆ°è¯¥åŸå¸‚çš„å¤©æ°”ä¿¡æ¯ã€‚";
            }

            JSONObject main = data.getJSONObject("main");
            JSONArray weatherArray = data.getJSONArray("weather");
            JSONObject weather = weatherArray.getJSONObject(0);
            JSONObject wind = data.getJSONObject("wind");

            String weatherDescription = weather.optString("description", "æ— æè¿°");
            double temperature = main.optDouble("temp", Double.NaN);
            double feelsLike = main.optDouble("feels_like", Double.NaN);
            double tempMin = main.optDouble("temp_min", Double.NaN);
            double tempMax = main.optDouble("temp_max", Double.NaN);
            int pressure = main.optInt("pressure", 0);
            int humidity = main.optInt("humidity", 0);
            double windSpeed = wind.optDouble("speed", Double.NaN);

            return String.format("""
                    åŸå¸‚: %s
                    å¤©æ°”æè¿°: %s
                    å½“å‰æ¸©åº¦: %.1fÂ°C
                    ä½“æ„Ÿæ¸©åº¦: %.1fÂ°C
                    æœ€ä½æ¸©åº¦: %.1fÂ°C
                    æœ€é«˜æ¸©åº¦: %.1fÂ°C
                    æ°”å‹: %d hPa
                    æ¹¿åº¦: %d%%
                    é£é€Ÿ: %.1f m/s
                    """,
                    data.optString("name", city),
                    weatherDescription,
                    temperature,
                    feelsLike,
                    tempMin,
                    tempMax,
                    pressure,
                    humidity,
                    windSpeed
            );

        } catch (Exception e) {
            return "è·å–å¤©æ°”ä¿¡æ¯æ—¶å‡ºé”™: " + e.getMessage();
        }
    }

    public static void main(String[] args) {
        //æµ‹è¯•æ–¹æ³•
        WeatherService client = new WeatherService();
        String beijing = client.getWeather("Beijing");
        System.out.println(beijing);
    }
}
```

æ³¨æ„å¦‚ä¸‹ä¸¤ç‚¹ï¼š

- å¦‚ä¸Šä»£ç ä¸­ä½¿ç”¨â€œ@Toolâ€æ ‡è®°äº†æ–¹æ³•getWeatherä¸ºå·¥å…·ã€‚
- ä»£ç ä¸­ä¸è¦Systemè¾“å‡ºä»»ä½•å†…å®¹ï¼Œä¼šå½±å“è¿”å›ç»“æœçš„å¤„ç†ã€‚

**5) ä¸»åº”ç”¨ç±»ä¸­åŠ å…¥å·¥å…·**

ä¸»åº”ç”¨ç±»ä¸ºSpringAimcpStdioServerApplication.javaï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
package com.example.springaimcpstdioserver;

import com.example.springaimcpstdioserver.service.WeatherService;
import org.springframework.ai.tool.ToolCallbackProvider;
import org.springframework.ai.tool.method.MethodToolCallbackProvider;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;

@SpringBootApplication
public class SpringAimcpStdioServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringAimcpStdioServerApplication.class, args);
    }


    /**
     * @Bean æ³¨è§£ç”¨äºå°†æ–¹æ³•çš„è¿”å›å€¼ä½œä¸º Spring Bean æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚
     *  Spring å®¹å™¨åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šæ‰«æå¹¶æ‰§è¡Œæ‰€æœ‰å¸¦æœ‰ @Bean æ³¨è§£çš„æ–¹æ³•ï¼Œä»¥å°†å…¶è¿”å›çš„å¯¹è±¡æ³¨å†Œåˆ°åº”ç”¨ä¸Šä¸‹æ–‡ä¸­ã€‚
     *
     * ToolCallbackProvider æ¥å£:Spring AI æä¾›çš„æ¥å£ï¼Œå…¶å®ç°ç±»è´Ÿè´£å°†å¸¦æœ‰ @Tool æ³¨è§£çš„æ–¹æ³•æ³¨å†Œä¸ºå¯ä¾› AI æ¨¡å‹è°ƒç”¨çš„å·¥å…·ã€‚
     */
    @Bean
    public ToolCallbackProvider weatherTools(WeatherService weatherService) {
        return MethodToolCallbackProvider.builder().toolObjects(weatherService).build();
    }
}
```

è¿™é‡Œåœ¨ä¸»åº”ç”¨ç±»ä¸­é€šè¿‡@Beanæ³¨è§£åˆ›å»ºToolCallbackProviderç±»å‹ï¼Œè¯¥ç±»å‹æ˜¯Spring AI æä¾›çš„æ¥å£ï¼Œå…¶å®ç°ç±»è´Ÿè´£å°†æŒ‡å®šServiceç±»ä¸­å¸¦æœ‰ @Tool æ³¨è§£çš„æ–¹æ³•æ³¨å†Œä¸ºå¯ä¾› AI æ¨¡å‹è°ƒç”¨çš„å·¥å…·ã€‚

**6) å°†SpringAIMCPStdioServeré¡¹ç›®è¿›è¡Œæ‰“åŒ…**

MCP Clientä¸MCP Serverä½¿ç”¨STDIOä¼ è¾“æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†MCP Serveré¡¹ç›®è¿›è¡Œæ‰“åŒ…ï¼Œç„¶ååœ¨MCP Clientä¸­è¿›è¡Œé…ç½®ï¼Œæ— éœ€å•ç‹¬å¯åŠ¨MCP Serverã€‚è¿™é‡Œç›´æ¥é€šè¿‡Mavenå·¥å…·è¿›è¡Œæ‰“åŒ…å³å¯ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/ca26c6cc630640d09b39b506d0f83988.jpg)

### **7.3.2. Mcp Client å¼€å‘**

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤åˆ›å»ºMCP Clientçš„SpringBooté¡¹ç›®ã€‚è¯¥MCP Client é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨ä¸åŒçš„LLMæ¨¡å‹ï¼Œåªéœ€è¦åœ¨å¯¹åº”é…ç½®æ–‡ä»¶ä¸­å¼•å…¥ä¸åŒçš„æ¨¡å‹å¯¹åº”çš„apikeyåŠç›¸å…³ä¾èµ–å³å¯ã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®**

SpringBooté¡¹ç›®å‘½åä¸ºSpringAIMCPStdioClientï¼Œè®¾ç½®ä½¿ç”¨çš„JDKä¸º17ç‰ˆæœ¬ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/923e89b0ac9f45c59224b4bf9caa9897.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/3dcfc8fb91794c348f6ef658e3aadaf8.jpg)

**2) åœ¨é¡¹ç›®ä¸­åŠ å…¥å¦‚ä¸‹Mavenä¾èµ–**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.3</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIMCPStdioClient</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIMCPStdioClient</name>
    <description>SpringAIMCPStdioClient</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- åŸºäº STDIO ä¼ è¾“å®¢æˆ·ç«¯ä¾èµ– -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-mcp-client</artifactId>
        </dependency>

        <!-- DeepSeek æ¨¡å‹ä¾èµ– -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-deepseek</artifactId>
        </dependency>
    </dependencies>


    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

æ³¨æ„ï¼šä»¥ä¸Šä¾èµ–ä¸­å¼•å…¥â€œspring-ai-starter-mcp-clientâ€åŒ…ï¼Œè¯¥åŒ…æ˜¯åŸºäºSTDIO ä¼ è¾“å®¢æˆ·ç«¯ä¾èµ–åŒ…ï¼›â€œspring-ai-starter-model-deepseekâ€åŒ…æ˜¯å¼•å…¥deepseek LLMï¼Œä½¿ç”¨å“ªä¸ªLLMå¯ä»¥å¼•å…¥ç›¸åº”çš„ä¾èµ–ï¼Œæ”¯æŒçš„æ¨¡å‹ä»¥åŠå¼•å…¥çš„åŒ…æŸ¥çœ‹ï¼šhttps://docs.spring.io/spring-ai/reference/api/chat/openai-chat.htmlã€‚

**3) é…ç½®resources/application.properties**

MCP Clienté€šè¿‡Stadioæ–¹å¼è¿æ¥åˆ°MCP Serveréœ€è¦åœ¨é¡¹ç›®çš„resources/application.propertiesæ–‡ä»¶ä¸­é…ç½®å¦‚ä¸‹å†…å®¹ï¼ŒæŒ‡å®šçš„æ–‡ä»¶ä¸­éœ€è¦è¿›è¡ŒMCP Serveré…ç½®ã€‚

```
spring.application.name=SpringAIMCPStdioClient

server.port=8087

#é…ç½® Deepseekçš„åŸºç¡€URLã€å¯†é’¥å’Œä½¿ç”¨æ¨¡å‹
spring.ai.deepseek.base-url=https://api.deepseek.com
spring.ai.deepseek.api-key=sk-8...821
spring.ai.deepseek.chat.options.model=deepseek-chat

#STDIO æ¨¡å¼ï¼ŒæŒ‡å®š MCP å®¢æˆ·ç«¯çš„æœåŠ¡å™¨é…ç½®æ–‡ä»¶è·¯å¾„
spring.ai.mcp.client.stdio.servers-configuration=classpath:/mcp-servers-config.json
```

æ³¨æ„ï¼šéœ€è¦é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šâ€œspring.ai.mcp.client.stdio.servers-configurationâ€å‚æ•°æ¥è®©MCP Clientæ‰¾åˆ°MCP Serverç›¸åº”é…ç½®ï¼Œè¿›è€Œå¯åŠ¨MCP Serverä½¿ç”¨å·¥å…·ã€‚

**4) é…ç½®mcp-server-config.json**

resources/mcp-servers-config.jsonæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```
{
  "mcpServers": {
    "spring-ai-mcp-weather": {
      "command": "D:\\Program Files\\Java\\jdk17\\jdk\\bin\\java.exe",
      "args": [
        "-Dspring.ai.mcp.server.transport=STDIO",
        "-jar",
        "D:\\idea_space\\SpringAICode\\SpringAIMCPStdioServer\\target\\SpringAIMCPStdioServer-0.0.1-SNAPSHOT.jar"
      ]
    }
  }
}
```

è¯¥é…ç½®æ–‡ä»¶ä¸­éœ€è¦æŒ‡å®šæ­£ç¡®çš„MCP Serveræ‰“å¥½çš„jaråŒ…è·¯å¾„ã€‚

**5) é¡¹ç›®ä¸­åˆ›å»ºconfig/Config.javaç±»**

Config.javaç±»ä¸ºSpring Configurationç»„ä»¶ï¼Œè¯¥ç»„ä»¶ä¸­æ³¨å†Œä¸¤ä¸ªBeanï¼š

- SyncMcpToolCallbackProvider:è‡ªåŠ¨é›†æˆ MCP Server æš´éœ²çš„å·¥å…·åˆ° ChatClientï¼Œä½¿ LLM å¯é€šè¿‡ prompt æµè°ƒç”¨å·¥å…·ã€‚
- ChatClientï¼šLLMèŠå¤©å®¢æˆ·ç«¯ã€‚æ„å»ºChatClientæ—¶é€šè¿‡â€œdefaultToolCallbacks(toolCallbackProvider)â€æ–¹æ³•é…ç½®å·¥å…·å›è°ƒæä¾›è€…ï¼Œä½¿ç”¨LLMå¯ä»¥çŸ¥é“å¯ä»¥æœ‰å¯¹åº”çš„å·¥å…·è°ƒç”¨ã€‚

```
package com.example.springaimcpstdioclient.config;

import io.modelcontextprotocol.client.McpSyncClient;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.ai.mcp.SyncMcpToolCallbackProvider;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

@Configuration
public class Config {

    /**
     * SyncMcpToolCallbackProvider:è‡ªåŠ¨é›†æˆ MCP Server æš´éœ²çš„å·¥å…·åˆ° ChatClientï¼Œä½¿ LLM å¯é€šè¿‡ prompt æµè°ƒç”¨å·¥å…·
     *  mcpSyncClient:SpringAI æ ¹æ® spring-ai-starter-mcp-client/spring-ai-starter-mcp-client-webflux
     *  ä¾èµ–æ³¨å…¥çš„ mcpSyncClients åˆ—è¡¨ï¼Œç”¨äºè°ƒç”¨å¤–éƒ¨å·¥å…·æˆ–æœåŠ¡ï¼Œæ¯ä¸ª McpSyncClient å¯¹è±¡ä»£è¡¨ä¸€ä¸ªåˆ° MCP Serverï¼ˆé€šè¿‡ STDIO æˆ– SSE ç­‰æ–¹å¼ï¼‰çš„è¿æ¥å®ä¾‹ï¼Œ
     *  å¦‚æœä½ åªé…ç½®äº†ä¸€ä¸ª MCP Serverï¼Œclients åˆ—è¡¨ä¸­å°±åªæœ‰ä¸€ä¸ª McpSyncClientï¼›å¦‚æœé…ç½®äº†å¤šä¸ª Serverï¼Œåˆ™ä¼šæœ‰å¤šä¸ªè¿æ¥ï¼Œå®ƒä»¬å¯¹åº”ä¸åŒæ¥æºçš„å·¥å…·ã€‚
     */
    @Bean
    public SyncMcpToolCallbackProvider toolCallbackProvider(List<McpSyncClient> mcpSyncClients) {
        return new SyncMcpToolCallbackProvider(mcpSyncClients);
    }


    @Bean
    public ChatClient chatClient(ChatModel chatModel,
                                 SyncMcpToolCallbackProvider toolCallbackProvider) {

        return ChatClient.builder(chatModel)
                .defaultSystem("ä½ æ˜¯ä¸€ä¸ªéå¸¸æœ‰å¸®åŠ©çš„åŠ©æ‰‹ï¼Œä½ å¯ä»¥ä½¿ç”¨å·¥å…·æ¥å¸®åŠ©å›ç­”é—®é¢˜")
                //é…ç½®å·¥å…·å›è°ƒæä¾›è€…ï¼Œä½¿ AI èƒ½è°ƒç”¨å¤–éƒ¨å·¥å…·
                .defaultToolCallbacks(toolCallbackProvider)
                .build();
    }

}
```

æ³¨æ„ï¼štoolCallbackProvideræ–¹æ³•ä¸­çš„å‚æ•°mcpSyncClientsè¡¨ç¤ºSpringAI æ ¹æ® spring-ai-starter-mcp-client/spring-ai-starter-mcp-client-webfluxä¾èµ–æ³¨å…¥çš„ mcpSyncClients åˆ—è¡¨ï¼Œç”¨äºè°ƒç”¨å¤–éƒ¨å·¥å…·æˆ–æœåŠ¡ï¼Œæ¯ä¸ª McpSyncClient å¯¹è±¡ä»£è¡¨ä¸€ä¸ªåˆ° MCP Serverï¼ˆé€šè¿‡ STDIO æˆ– SSE ç­‰æ–¹å¼ï¼‰çš„è¿æ¥å®ä¾‹ï¼Œå¦‚æœä½ åªé…ç½®äº†ä¸€ä¸ª MCP Serverï¼Œclients åˆ—è¡¨ä¸­å°±åªæœ‰ä¸€ä¸ª McpSyncClientï¼›å¦‚æœé…ç½®äº†å¤šä¸ª Serverï¼Œåˆ™ä¼šæœ‰å¤šä¸ªè¿æ¥ï¼Œå®ƒä»¬å¯¹åº”ä¸åŒæ¥æºçš„å·¥å…·ã€‚

**6) åˆ›å»ºcontroller/ChatController.javaç±»**

åœ¨Controllerä¸­ç›´æ¥åˆ›å»ºå¯¹åº”çš„æ–¹æ³•ä¸LLMè¿›è¡Œå¯¹è¯è°ƒç”¨å·¥å…·å³å¯ã€‚

```
package com.example.springaimcpstdioclient.controller;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/ai")
public class ChatController {
    private final ChatClient chatClient;

    public ChatController(ChatClient chatClient) {
        this.chatClient = chatClient;
    }

    @GetMapping("/chat")
    public String chat(@RequestParam String message) {

        return chatClient.prompt()
                .user(message)
                .call()
                .content();
    }
}
```

**7) å¯åŠ¨MCP Clientè¿›è¡Œæµ‹è¯•**

è¿è¡Œâ€œSpringAimcpStdioClientApplication.javaâ€åï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œæµ‹è¯•LLMæ¨¡å‹è‡ªåŠ¨è°ƒç”¨å·¥å…·ï¼š

```
# http://localhost:8087/ai/chat?message=åŒ—äº¬å¤©æ°”å¦‚ä½•?
åŒ—äº¬çš„å¤©æ°”æƒ…å†µå¦‚ä¸‹ï¼š - **å¤©æ°”æè¿°**: å°é›¨ - **å½“å‰æ¸©åº¦**: 27.0Â°C - **ä½“æ„Ÿæ¸©åº¦**: 30.0Â°C - **æœ€ä½æ¸©åº¦**: 27.0Â°C - **æœ€é«˜æ¸©åº¦**: 27.0Â°C - **æ°”å‹**: 1004 hPa - **æ¹¿åº¦**: 84% - **é£é€Ÿ**: 1.6 m/s è¯·æ³¨æ„æºå¸¦é›¨å…·ï¼

# http://localhost:8087/ai/chat?message=ä½ æ˜¯è°?
æˆ‘æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©ä½ å›ç­”é—®é¢˜ã€æä¾›ä¿¡æ¯ã€è§£å†³é—®é¢˜æˆ–å®Œæˆä»»åŠ¡ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼
```

å¯ä»¥åœ¨MCP Serverç«¯é…ç½®çš„æ—¥å¿—è·¯å¾„ä¸­æ‰¾åˆ°å¯¹åº”çš„æ—¥å¿—ï¼ŒæŸ¥çœ‹åˆ°æ—¥å¿—ä¸­ä¼šæœ‰ç›¸åº”å·¥å…·è°ƒç”¨ï¼š

```
WeatherService:====== è°ƒç”¨äº†getWeatherå·¥å…· ======
WeatherService:====== è®¿é—®URLï¼š ======http://api.openweathermap.org/data/2.5/weather?q=Beijing&appid=f04...8&units=metric&lang=zh_cn
```

## 7.4. **MCP æ¡ˆä¾‹-WebFlux SSEä¼ è¾“æ¨¡å¼**

åœ¨è¯¥æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºMCP Server å’ŒMCP Client ä¸¤ä¸ªSpringBooté¡¹ç›®ï¼ŒMCP Serveré¡¹ç›®ä¸­ä¼šåˆ›å»ºä¸€ä¸ªgetWeatherå·¥å…·ï¼Œè¯¥å·¥å…·é€šè¿‡OpenWeatherå¯ä»¥æŸ¥è¯¢æŸä¸ªåŸå¸‚å¤©æ°”æƒ…å†µï¼›MCP Client é¡¹ç›®ä¸­åˆ›å»ºç›¸åº”çš„Controllerï¼Œæ ¹æ®é…ç½®é€šè¿‡WebFlux SSEæ–¹å¼ä¸MCP Serverè¿›è¡Œé€šä¿¡ï¼Œå®ç°è°ƒç”¨å¤©æ°”å·¥å…·ã€‚

### **7.4.1. Mcp Serverå¼€å‘**

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤åˆ›å»ºMCP Serverå¯¹åº”çš„SpringBooté¡¹ç›®ã€‚**WebFlux SSEä¼ è¾“æ¨¡å¼ä¸­åˆ›å»ºçš„Mcp Serverç›¸æ¯”äºSTDIOä¼ è¾“æ¨¡å¼ä¸­åˆ›å»ºçš„MCPServer åªæ˜¯åœ¨pom.xmlä¸­å¼•å…¥çš„ä¾èµ–ä¸åŒè€Œå·²ã€‚**

**1) åˆ›å»ºSpringBooté¡¹ç›®**

SpringBooté¡¹ç›®å‘½åä¸ºSpringAIMCPStdioServerï¼Œè®¾ç½®ä½¿ç”¨çš„JDKä¸º17ç‰ˆæœ¬ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/a4e32ebffcf642a3aeca6b893efa0892.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/0364e3e9df6e4235928275f99404cbd9.jpg)

**2) åœ¨é¡¹ç›®ä¸­åŠ å…¥å¦‚ä¸‹Mavenä¾èµ–**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.3</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIMCPSseServer</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIMCPSseServer</name>
    <description>SpringAIMCPSseServer</description>
    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
<!--        <dependency>-->
<!--            <groupId>org.springframework.boot</groupId>-->
<!--            <artifactId>spring-boot-starter-web</artifactId>-->
<!--        </dependency>-->

        <!-- æ”¯æŒ SSE ä¼ è¾“ï¼Œä½¿ç”¨å¦‚ä¸‹ä¾èµ– -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-mcp-server-webflux</artifactId>
        </dependency>

        <!-- ä¾èµ–çš„json åŒ…-->
        <dependency>
            <groupId>org.json</groupId>
            <artifactId>json</artifactId>
            <version>20210307</version>
        </dependency>
    </dependencies>

    <!-- æ‰“åŒ…æ’ä»¶ -->
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>3.4.4</version>
                <configuration>
                    <mainClass>com.example.springaimcpstdioserver.SpringAimcpStdioServerApplication</mainClass>
                </configuration>
                <executions>
                    <execution>
                        <goals>
                            <goal>repackage</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

æ³¨æ„ï¼š

- åœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-mcp-server-webfluxâ€MCP ä¾èµ–åŒ…ï¼Œè¯¥åŒ…åªæ”¯æŒSSEä¼ è¾“ï¼›
- ä¸€ä¸ªSpringBooté¡¹ç›®MVC å’Œ WebFlux é€šå¸¸äºŒé€‰å…¶ä¸€ä½¿ç”¨ï¼Œä¸è¦å¼•å…¥â€œspring-boot-starter-webâ€ä¾èµ–åŒ…ï¼Œè¯¥åŒ…ä¼šå¯ç”¨ Spring MVC + åµŒå…¥å¼ Tomcatï¼Œç›¸å½“äºæ˜¯ä¸€å¥—HTTPæœåŠ¡å™¨ç»„ä»¶ï¼Œä¸Spring WebFlux + Reactor Netty è¿™å¥—HTTP æœåŠ¡ç»„ä»¶å†²çªäº†ï¼Œå¯¼è‡´åç»­å®¢æˆ·ç«¯HTTPè¯·æ±‚æŠ¥é”™ã€‚

**3) é…ç½®resources/application.properties**

```
spring.application.name=SpringAIMCPSseServer

#æŒ‡å®š MCP æœåŠ¡å™¨çš„åç§°ä¸º spring-ai-mcp-weather
spring.ai.mcp.server.name=spring-ai-mcp-weather

#é…ç½®åº”ç”¨ç›‘å¬çš„ç«¯å£ä¸º 8089
server.port=8089

#ç¦ç”¨ Spring Boot å¯åŠ¨æ—¶çš„æ¨ªå¹…ï¼ˆBannerï¼‰æ˜¾ç¤ºï¼Œå¯¹äºä½¿ç”¨ STDIO ä¼ è¾“çš„ MCP æœåŠ¡å™¨ï¼Œç¦ç”¨æ¨ªå¹…æœ‰åŠ©äºé¿å…è¾“å‡ºå¹²æ‰°ã€‚
spring.main.banner-mode=off
#å¦‚ä¸‹å‚æ•°å¯ç”¨å¹¶è®¾ç½®ä¸ºç©ºï¼Œå°†ç¦ç”¨æ§åˆ¶å°æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œå‡å°‘è¾“å‡ºå¹²æ‰°
logging.pattern.console=

#é…ç½®æ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ï¼Œå°†æ—¥å¿—å†™å…¥æŒ‡å®šçš„æ–‡ä»¶ä¸­
logging.file.name=D:/idea_space/SpringAICode/SpringAIMCPSseServer/model-context-protocol/mcp-weather-stdio-server.log

#è®¿é—® OpenWeather API çš„å¯†é’¥
OPEN_WEATHER_API_KEY=f04...8
```

ç‰¹åˆ«æ³¨æ„ï¼šä»¥ä¸Šé…ç½®ä¸­logging.file.nameæŒ‡å®šäº†MCP Serverè¿è¡Œè¿‡ç¨‹ä¸­æ—¥å¿—è¾“å‡ºçš„ä½ç½®ï¼Œå¯ä»¥é€šè¿‡è¯¥æ—¥å¿—æŸ¥çœ‹Serverç«¯è¿è¡Œæƒ…å†µï¼ˆå¦‚ï¼šå·¥å…·æ˜¯å¦è¢«è°ƒç”¨ï¼‰ã€‚

**4) åˆ›å»º WeatherService.javaæ„å»ºæŸ¥è¯¢å¤©æ°”å·¥å…·**

åœ¨é¡¹ç›®ä¸­åˆ›å»ºserviceåŒ…ï¼Œåœ¨è¯¥åŒ…ä¸­åˆ›å»ºWeatherService.javaç±»ï¼Œæ„å»ºæŸ¥è¯¢å¤©æ°”å·¥å…·ï¼š

```
package com.example.springaimcpsseserver.service;


import org.json.JSONArray;
import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.ai.tool.annotation.Tool;
import org.springframework.ai.tool.annotation.ToolParam;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;

/**
 * å¤©æ°”æœåŠ¡ç±»ï¼Œç”¨äºè·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯
 * @Service æ ‡è®°ä¸º Spring æœåŠ¡å±‚ç»„ä»¶
 */

@Service
public class WeatherService {
    private static final Logger logger = LoggerFactory.getLogger(WeatherService.class);

    private static final String BASE_URL = "http://api.openweathermap.org/data/2.5/weather";

    @Value("${OPEN_WEATHER_API_KEY}")
    private String OPEN_WEATHER_API_KEY;

    /**
     * æ ¹æ®åŸå¸‚åç§°è·å–å¤©æ°”ä¿¡æ¯ï¼ˆä½¿ç”¨ OpenWeatherMapï¼‰
     * @param city åŸå¸‚åç§°ï¼Œå¦‚ "Beijing"
     * @return å¤©æ°”ä¿¡æ¯æ–‡æœ¬
     */
    @Tool(description = "è·å–æŒ‡å®šåŸå¸‚çš„å½“å‰å¤©æ°”æƒ…å†µï¼Œæ ¼å¼åŒ–åçš„å¤©æ°”æŠ¥å‘Šå­—ç¬¦ä¸²ã€‚")
    public String getWeather(@ToolParam(description = "åŸå¸‚åç§°ï¼Œå¿…é¡»æ˜¯è‹±æ–‡æ ¼å¼ï¼Œæ¯”å¦‚ London æˆ– Beijing") String city) {

        logger.info("====== è°ƒç”¨äº†getWeatherå·¥å…· ======");

        try {
            String charset = "UTF-8";

            String query = String.format(
                    "q=%s&appid=%s&units=metric&lang=zh_cn",
                    URLEncoder.encode(city, charset),
                    URLEncoder.encode(OPEN_WEATHER_API_KEY, charset)
            );

            URL url = new URL(BASE_URL + "?" + query);
            logger.info("====== è®¿é—®URLï¼š ======"+url.toString());

            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("GET");

            BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), charset));

            StringBuilder response = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                response.append(line);
            }
            reader.close();

            JSONObject data = new JSONObject(response.toString());

            if (data.getInt("cod") == 404) {
                return "æœªæ‰¾åˆ°è¯¥åŸå¸‚çš„å¤©æ°”ä¿¡æ¯ã€‚";
            }

            JSONObject main = data.getJSONObject("main");
            JSONArray weatherArray = data.getJSONArray("weather");
            JSONObject weather = weatherArray.getJSONObject(0);
            JSONObject wind = data.getJSONObject("wind");

            String weatherDescription = weather.optString("description", "æ— æè¿°");
            double temperature = main.optDouble("temp", Double.NaN);
            double feelsLike = main.optDouble("feels_like", Double.NaN);
            double tempMin = main.optDouble("temp_min", Double.NaN);
            double tempMax = main.optDouble("temp_max", Double.NaN);
            int pressure = main.optInt("pressure", 0);
            int humidity = main.optInt("humidity", 0);
            double windSpeed = wind.optDouble("speed", Double.NaN);

            return String.format("""
                    åŸå¸‚: %s
                    å¤©æ°”æè¿°: %s
                    å½“å‰æ¸©åº¦: %.1fÂ°C
                    ä½“æ„Ÿæ¸©åº¦: %.1fÂ°C
                    æœ€ä½æ¸©åº¦: %.1fÂ°C
                    æœ€é«˜æ¸©åº¦: %.1fÂ°C
                    æ°”å‹: %d hPa
                    æ¹¿åº¦: %d%%
                    é£é€Ÿ: %.1f m/s
                    """,
                    data.optString("name", city),
                    weatherDescription,
                    temperature,
                    feelsLike,
                    tempMin,
                    tempMax,
                    pressure,
                    humidity,
                    windSpeed
            );

        } catch (Exception e) {
            return "è·å–å¤©æ°”ä¿¡æ¯æ—¶å‡ºé”™: " + e.getMessage();
        }
    }

    public static void main(String[] args) {
        //æµ‹è¯•æ–¹æ³•
        WeatherService client = new WeatherService();
        String beijing = client.getWeather("Beijing");
        System.out.println(beijing);
    }
}
```

æ³¨æ„å¦‚ä¸‹ä¸¤ç‚¹ï¼š

- å¦‚ä¸Šä»£ç ä¸­ä½¿ç”¨â€œ@Toolâ€æ ‡è®°äº†æ–¹æ³•getWeatherä¸ºå·¥å…·ã€‚
- ä»£ç ä¸­ä¸è¦Systemè¾“å‡ºä»»ä½•å†…å®¹ï¼Œä¼šå½±å“è¿”å›ç»“æœçš„å¤„ç†ã€‚

**5) ä¸»åº”ç”¨ç±»ä¸­åŠ å…¥å·¥å…·**

ä¸»åº”ç”¨ç±»ä¸ºSpringAimcpSseServerApplication.javaï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
package com.example.springaimcpsseserver;

import com.example.springaimcpsseserver.service.WeatherService;
import org.springframework.ai.tool.ToolCallbackProvider;
import org.springframework.ai.tool.method.MethodToolCallbackProvider;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;

@SpringBootApplication
public class SpringAimcpSseServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringAimcpSseServerApplication.class, args);
    }

    /**
     * @Bean æ³¨è§£ç”¨äºå°†æ–¹æ³•çš„è¿”å›å€¼ä½œä¸º Spring Bean æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚
     *  Spring å®¹å™¨åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šæ‰«æå¹¶æ‰§è¡Œæ‰€æœ‰å¸¦æœ‰ @Bean æ³¨è§£çš„æ–¹æ³•ï¼Œä»¥å°†å…¶è¿”å›çš„å¯¹è±¡æ³¨å†Œåˆ°åº”ç”¨ä¸Šä¸‹æ–‡ä¸­ã€‚
     *
     * ToolCallbackProvider æ¥å£:Spring AI æä¾›çš„æ¥å£ï¼Œå…¶å®ç°ç±»è´Ÿè´£å°†å¸¦æœ‰ @Tool æ³¨è§£çš„æ–¹æ³•æ³¨å†Œä¸ºå¯ä¾› AI æ¨¡å‹è°ƒç”¨çš„å·¥å…·ã€‚
     */
    @Bean
    public ToolCallbackProvider weatherTools(WeatherService weatherService) {
        return MethodToolCallbackProvider.builder().toolObjects(weatherService).build();
    }
}
```

è¿™é‡Œåœ¨ä¸»åº”ç”¨ç±»ä¸­é€šè¿‡@Beanæ³¨è§£åˆ›å»ºToolCallbackProviderç±»å‹ï¼Œè¯¥ç±»å‹æ˜¯Spring AI æä¾›çš„æ¥å£ï¼Œå…¶å®ç°ç±»è´Ÿè´£å°†æŒ‡å®šServiceç±»ä¸­å¸¦æœ‰ @Tool æ³¨è§£çš„æ–¹æ³•æ³¨å†Œä¸ºå¯ä¾› AI æ¨¡å‹è°ƒç”¨çš„å·¥å…·ã€‚

**6) å¯åŠ¨SpringAIMCPSseServeré¡¹ç›®**

MCP Clientä¸MCP Serverä½¿ç”¨SSEä¼ è¾“æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†MCP Serveré¡¹ç›®è¿›è¡Œå¯åŠ¨ã€‚

### **7.4.2. Mcp Client å¼€å‘**

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤åˆ›å»ºMCP Clientçš„SpringBooté¡¹ç›®ã€‚è¯¥MCP Client é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨ä¸åŒçš„LLMæ¨¡å‹ï¼Œåªéœ€è¦åœ¨å¯¹åº”é…ç½®æ–‡ä»¶ä¸­å¼•å…¥ä¸åŒçš„æ¨¡å‹å¯¹åº”çš„apikeyåŠç›¸å…³ä¾èµ–å³å¯ã€‚

**WebFlux SSEä¼ è¾“æ¨¡å¼ä¸­åˆ›å»ºçš„Mcp Clientç›¸æ¯”äºSTDIOä¼ è¾“æ¨¡å¼ä¸­åˆ›å»ºçš„MCP Client** **æœ‰ä¸¤ç‚¹ä¸åŒï¼š** **åœ¨pom.xmlä¸­å¼•å…¥çš„ä¾èµ–ä¸åŒ** **ã€åœ¨application.propertiesä¸­é…ç½®è¿œç¨‹Server** **ã€‚**

**1) åˆ›å»ºSpringBooté¡¹ç›®**

SpringBooté¡¹ç›®å‘½åä¸ºSpringAIMCPSseClientï¼Œè®¾ç½®ä½¿ç”¨çš„JDKä¸º17ç‰ˆæœ¬ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/73744f4a5c944ce1a67fa8e4992ac2af.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/c6e3757841524a97ab5439e78619cfc1.jpg)

**2) åœ¨é¡¹ç›®ä¸­åŠ å…¥å¦‚ä¸‹Mavenä¾èµ–**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.3</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIMCPSseClient</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIMCPSseClient</name>
    <description>SpringAIMCPSseClient</description>


    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- åŸºäº WebFlux çš„ SSE ä¼ è¾“å®ç°çš„ä¾èµ– -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-mcp-client-webflux</artifactId>
        </dependency>

        <!-- DeepSeek æ¨¡å‹ä¾èµ– -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-deepseek</artifactId>
        </dependency>
    </dependencies>


    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

æ³¨æ„ï¼šä»¥ä¸Šä¾èµ–ä¸­å¼•å…¥â€œspring-ai-starter-mcp-client-webfluxâ€åŒ…ï¼Œè¯¥åŒ…æ˜¯åŸºäºWebFlux SSEä¼ è¾“å®¢æˆ·ç«¯ä¾èµ–åŒ…ï¼›â€œspring-ai-starter-model-deepseekâ€åŒ…æ˜¯å¼•å…¥deepseek LLMï¼Œä½¿ç”¨å“ªä¸ªLLMå¯ä»¥å¼•å…¥ç›¸åº”çš„ä¾èµ–ï¼Œæ”¯æŒçš„æ¨¡å‹ä»¥åŠå¼•å…¥çš„åŒ…æŸ¥çœ‹ï¼šhttps://docs.spring.io/spring-ai/reference/api/chat/openai-chat.htmlã€‚

**3) é…ç½®resources/application.properties**

MCP Clienté€šè¿‡Web Flux SSEæ–¹å¼è¿æ¥åˆ°MCP Serveréœ€è¦åœ¨é¡¹ç›®çš„resources/application.propertiesæ–‡ä»¶ä¸­é…ç½®MCP Serveråœ°å€ã€‚

```
spring.application.name=SpringAIMCPSseClient

server.port=8087

#é…ç½® Deepseekçš„åŸºç¡€URLã€å¯†é’¥å’Œä½¿ç”¨æ¨¡å‹
spring.ai.deepseek.base-url=https://api.deepseek.com
spring.ai.deepseek.api-key=sk-...1
spring.ai.deepseek.chat.options.model=deepseek-chat

#SSE æ¨¡å¼ï¼Œé…ç½®åä¸º server1 çš„ MCP æœåŠ¡å™¨è¿æ¥ï¼Œè¿œç¨‹è¿æ¥åˆ°æŒ‡å®šçš„æœåŠ¡å™¨åœ°å€
spring.ai.mcp.client.sse.connections.server1.url=http://localhost:8089
```

æ³¨æ„ï¼šéœ€è¦é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šâ€œspring.ai.mcp.client.sse.connections.server1.urlâ€å‚æ•°æ¥è®©MCP Clientæ‰¾åˆ°MCP Serverè®¿é—®åœ°å€ã€‚

**4) é¡¹ç›®ä¸­åˆ›å»ºconfig/Config.javaç±»**

Config.javaç±»ä¸ºSpring Configurationç»„ä»¶ï¼Œè¯¥ç»„ä»¶ä¸­æ³¨å†Œä¸¤ä¸ªBeanï¼š

- SyncMcpToolCallbackProvider:è‡ªåŠ¨é›†æˆ MCP Server æš´éœ²çš„å·¥å…·åˆ° ChatClientï¼Œä½¿ LLM å¯é€šè¿‡ prompt æµè°ƒç”¨å·¥å…·ã€‚
- ChatClientï¼šLLMèŠå¤©å®¢æˆ·ç«¯ã€‚æ„å»ºChatClientæ—¶é€šè¿‡â€œdefaultToolCallbacks(toolCallbackProvider)â€æ–¹æ³•é…ç½®å·¥å…·å›è°ƒæä¾›è€…ï¼Œä½¿ç”¨LLMå¯ä»¥çŸ¥é“å¯ä»¥æœ‰å¯¹åº”çš„å·¥å…·è°ƒç”¨ã€‚

```
package com.example.springaimcpsseclient.config;

import io.modelcontextprotocol.client.McpSyncClient;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.ai.mcp.SyncMcpToolCallbackProvider;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

@Configuration
public class Config {

    /**
     * SyncMcpToolCallbackProvider:è‡ªåŠ¨é›†æˆ MCP Server æš´éœ²çš„å·¥å…·åˆ° ChatClientï¼Œä½¿ LLM å¯é€šè¿‡ prompt æµè°ƒç”¨å·¥å…·
     *  mcpSyncClient:SpringAI æ ¹æ® spring-ai-starter-mcp-client/spring-ai-starter-mcp-client-webflux
     *  ä¾èµ–æ³¨å…¥çš„ mcpSyncClients åˆ—è¡¨ï¼Œç”¨äºè°ƒç”¨å¤–éƒ¨å·¥å…·æˆ–æœåŠ¡ï¼Œæ¯ä¸ª McpSyncClient å¯¹è±¡ä»£è¡¨ä¸€ä¸ªåˆ° MCP Serverï¼ˆé€šè¿‡ STDIO æˆ– SSE ç­‰æ–¹å¼ï¼‰çš„è¿æ¥å®ä¾‹ï¼Œ
     *  å¦‚æœä½ åªé…ç½®äº†ä¸€ä¸ª MCP Serverï¼Œclients åˆ—è¡¨ä¸­å°±åªæœ‰ä¸€ä¸ª McpSyncClientï¼›å¦‚æœé…ç½®äº†å¤šä¸ª Serverï¼Œåˆ™ä¼šæœ‰å¤šä¸ªè¿æ¥ï¼Œå®ƒä»¬å¯¹åº”ä¸åŒæ¥æºçš„å·¥å…·ã€‚
     */
    @Bean
    public SyncMcpToolCallbackProvider toolCallbackProvider(List<McpSyncClient> mcpSyncClients) {
        return new SyncMcpToolCallbackProvider(mcpSyncClients);
    }


    @Bean
    public ChatClient chatClient(ChatModel chatModel,
                                 SyncMcpToolCallbackProvider toolCallbackProvider) {

        return ChatClient.builder(chatModel)
                .defaultSystem("ä½ æ˜¯ä¸€ä¸ªéå¸¸æœ‰å¸®åŠ©çš„åŠ©æ‰‹ï¼Œä½ å¯ä»¥ä½¿ç”¨å·¥å…·æ¥å¸®åŠ©å›ç­”é—®é¢˜")
                //é…ç½®å·¥å…·å›è°ƒæä¾›è€…ï¼Œä½¿ AI èƒ½è°ƒç”¨å¤–éƒ¨å·¥å…·
                .defaultToolCallbacks(toolCallbackProvider)
                .build();
    }

}
```

æ³¨æ„ï¼štoolCallbackProvideræ–¹æ³•ä¸­çš„å‚æ•°mcpSyncClientsè¡¨ç¤ºSpringAI æ ¹æ® spring-ai-starter-mcp-client/spring-ai-starter-mcp-client-webfluxä¾èµ–æ³¨å…¥çš„ mcpSyncClients åˆ—è¡¨ï¼Œç”¨äºè°ƒç”¨å¤–éƒ¨å·¥å…·æˆ–æœåŠ¡ï¼Œæ¯ä¸ª McpSyncClient å¯¹è±¡ä»£è¡¨ä¸€ä¸ªåˆ° MCP Serverï¼ˆé€šè¿‡ STDIO æˆ– SSE ç­‰æ–¹å¼ï¼‰çš„è¿æ¥å®ä¾‹ï¼Œå¦‚æœä½ åªé…ç½®äº†ä¸€ä¸ª MCP Serverï¼Œclients åˆ—è¡¨ä¸­å°±åªæœ‰ä¸€ä¸ª McpSyncClientï¼›å¦‚æœé…ç½®äº†å¤šä¸ª Serverï¼Œåˆ™ä¼šæœ‰å¤šä¸ªè¿æ¥ï¼Œå®ƒä»¬å¯¹åº”ä¸åŒæ¥æºçš„å·¥å…·ã€‚

**5) åˆ›å»ºcontroller/ChatController.javaç±»**

åœ¨Controllerä¸­ç›´æ¥åˆ›å»ºå¯¹åº”çš„æ–¹æ³•ä¸LLMè¿›è¡Œå¯¹è¯è°ƒç”¨å·¥å…·å³å¯ã€‚

```
package com.example.springaimcpsseclient.controller;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/ai")
public class ChatController {
    private final ChatClient chatClient;

    public ChatController(ChatClient chatClient) {
        this.chatClient = chatClient;
    }

    @GetMapping("/chat")
    public String chat(@RequestParam String message) {

        return chatClient.prompt()
                .user(message)
                .call()
                .content();

    }
}
```

**6) å¯åŠ¨MCP Clientè¿›è¡Œæµ‹è¯•**

è¿è¡Œâ€œSpringAimcpSseClientApplication.javaâ€åï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œæµ‹è¯•LLMæ¨¡å‹è‡ªåŠ¨è°ƒç”¨å·¥å…·ï¼š

```
# http://localhost:8087/ai/chat?message=åŒ—äº¬å¤©æ°”å¦‚ä½•?
åŒ—äº¬çš„å¤©æ°”æƒ…å†µå¦‚ä¸‹ï¼š - **å¤©æ°”æè¿°**: å°é›¨ - **å½“å‰æ¸©åº¦**: 27.0Â°C - **ä½“æ„Ÿæ¸©åº¦**: 30.0Â°C - **æœ€ä½æ¸©åº¦**: 27.0Â°C - **æœ€é«˜æ¸©åº¦**: 27.0Â°C - **æ°”å‹**: 1004 hPa - **æ¹¿åº¦**: 84% - **é£é€Ÿ**: 1.6 m/s è¯·æ³¨æ„æºå¸¦é›¨å…·ï¼

# http://localhost:8087/ai/chat?message=ä½ æ˜¯è°?
æˆ‘æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©ä½ å›ç­”é—®é¢˜ã€æä¾›ä¿¡æ¯ã€è§£å†³é—®é¢˜æˆ–å®Œæˆä»»åŠ¡ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼
```

å¯ä»¥åœ¨MCP Serverç«¯é…ç½®çš„æ—¥å¿—è·¯å¾„ä¸­æ‰¾åˆ°å¯¹åº”çš„æ—¥å¿—ï¼ŒæŸ¥çœ‹åˆ°æ—¥å¿—ä¸­ä¼šæœ‰ç›¸åº”å·¥å…·è°ƒç”¨ï¼š

```
WeatherService:====== è°ƒç”¨äº†getWeatherå·¥å…· ======
WeatherService:====== è®¿é—®URLï¼š ======http://api.openweathermap.org/data/2.5/weather?q=Beijing&appid=f04...8&units=metric&lang=zh_cn
```

# 8. **æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰**

Springâ€¯AI é€šè¿‡æ¨¡å—åŒ–æ¶æ„æ”¯æŒ RAGï¼Œæ—¢å¯ä»¥è®©ä½ è‡ªå®šä¹‰ RAG æµç¨‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Advisor API æä¾›çš„å¼€ç®±å³ç”¨ RAG æµç¨‹ï¼Œæœ¬ç« èŠ‚ç»™å¤§å®¶ä»‹ç»ä½¿ç”¨Advisor API æä¾›çš„å¼€ç®±å³ç”¨çš„RAGå†…å®¹ã€‚

åœ¨ Retrieval-Augmented Generation (RAG) ä¸­ï¼Œæˆ‘ä»¬å¸¸è§çš„æµç¨‹æ˜¯ï¼š**Query â†’ Embedding â†’ VectorStore æ£€ç´¢ â†’ é™„åŠ ä¸Šä¸‹æ–‡ â†’ LLM å›ç­”**ï¼Œä¸€èˆ¬VectorStoreæˆ‘ä»¬ä¼šé€‰æ‹©å‘é‡æ•°æ®åº“ï¼Œåœ¨å¤§æ¨¡å‹é¢†åŸŸå¸¸ç”¨çš„å‘é‡æ•°æ®åº“æ˜¯Milvusï¼Œä¸‹é¢é¦–å…ˆä»‹ç»Milvusã€‚

## 8.1. **å‘é‡æ•°æ®åº“Milvus(ç±³å°”ä¹Œæ–¯)**

Milvus æ˜¯ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½å‘é‡æ•°æ®åº“ï¼ˆVector Databaseï¼‰ï¼Œä¸“ä¸ºå­˜å‚¨ã€ç´¢å¼•å’Œæ£€ç´¢é«˜ç»´å‘é‡æ•°æ®è€Œè®¾è®¡ï¼Œå®ƒèƒ½å¤Ÿå¤„ç†å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ã€è‡ªç„¶è¯­è¨€ç­‰åµŒå…¥è¡¨ç¤ºï¼ˆembeddingsï¼‰ï¼Œæ”¯æŒæµ·é‡å‘é‡ï¼ˆä¸‡äº¿çº§ï¼‰æ¯«ç§’çº§ç›¸ä¼¼æœç´¢ã€‚

Milvus æ˜¯ RAG ç³»ç»Ÿä¸­çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ä¹‹ä¸€ï¼ŒMilvus åœ¨RAGè¿‡ç¨‹ä¸­å¯ä»¥æ‹…å½“â€œVectorStoreâ€çš„è§’è‰²ï¼Œèƒ½å¤Ÿç²¾å‡†è¯­ä¹‰æ£€ç´¢ï¼ŒæŸ¥è¯¢åˆ°ç›¸å…³æ–‡æ¡£ã€‚Milvusæ–‡æ¡£åœ°å€ï¼š[https://milvus.io/docs/zh](https://milvus.io/docs/zh,Milvus)

### **8.1.1. Milvus Standaloneæ­å»º**

Milvusæ”¯æŒä¸‰ç§æ–¹å¼æ­å»ºï¼š

- Milvus Lite:ä½œä¸º Python åº“æœ¬åœ°åµŒå…¥ï¼ˆç±»ä¼¼â€œå‘é‡ç‰ˆ SQLiteâ€ï¼‰,æ”¯æŒç™¾ä¸‡çº§åˆ«å‘é‡å­˜å‚¨ï¼Œé€‚åˆå¿«é€Ÿå­¦ä¹ ã€‚
- Milvus Standaloneï¼ˆå•æœºç‰ˆï¼‰:Docker ä¸­è¿è¡Œï¼Œæ‰€æœ‰ç»„ä»¶ï¼ˆMilvus + etcdï¼‰æ‰“åŒ…åœ¨ä¸€å°ä¸»æœºå†…ï¼Œæ”¯æŒ10äº¿å‘é‡å­˜å‚¨ï¼Œé€‚åˆä¸­å°å‹ç”Ÿäº§ç¯å¢ƒã€‚
- Milvus Distributedï¼ˆåˆ†å¸ƒå¼é›†ç¾¤ï¼‰:éƒ¨ç½²åœ¨ Kubernetes ç¯å¢ƒï¼Œé€šè¿‡ Proxyã€Queryã€Index ç­‰èŠ‚ç‚¹åˆ†ç¦»ï¼Œå®ç°é«˜å¯ç”¨ä¸å¼¹æ€§ä¼¸ç¼©ï¼Œæ”¯æŒç™¾äº¿å‘é‡å­˜å‚¨ï¼Œé€‚åˆå¤§è§„æ¨¡ã€é«˜å¯ç”¨æˆ–K8séƒ¨ç½²ã€‚

è¿™é‡Œæˆ‘ä»¬æ­å»ºMilvus Standalone ç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦é¢„å…ˆå‡†å¤‡ä¸€å°LinuxèŠ‚ç‚¹ï¼ˆé»˜è®¤å·²å‡†å¤‡å¥½ï¼‰ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤åœ¨LinuxèŠ‚ç‚¹ä¸­å®‰è£…Dockerå¹¶éƒ¨ç½²Milvusã€‚

**1) åœ¨Linuxä¸­å®‰è£…docker**

è¿™é‡Œåœ¨node2å®‰è£…dockerã€‚è·å–docker repoæ–‡ä»¶

```
#ä»é˜¿é‡Œæºè·å–docker repoæ–‡ä»¶
wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

#ä»æ¸…åæºè·å–docker repoæ–‡ä»¶
wget -O /etc/yum.repos.d/docker-ce.repo  https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo

#ä»dockerå®˜æ–¹æºè·å–docker repoæ–‡ä»¶
wget -O /etc/yum.repos.d/docker-ce.repo  https://download.docker.com/linux/centos/docker-ce.repo
```

æŸ¥çœ‹dockerå¯ä»¥å®‰è£…çš„ç‰ˆæœ¬ï¼š

```
yum list docker-ce.x86_64 --showduplicates | sort -r
```

å®‰è£…docker:è¿™é‡ŒæŒ‡å®šdockerç‰ˆæœ¬ä¸º26.1.4ç‰ˆæœ¬:

```
yum -y install docker-ce-26.1.4-1.el7
```

è®¾ç½®docker å¼€æœºå¯åŠ¨ï¼Œå¹¶å¯åŠ¨dockerï¼š

```
systemctl enable docker
systemctl start docker
```

æŸ¥çœ‹dockerç‰ˆæœ¬

```
docker version
```

ä¿®æ”¹cgroupæ–¹å¼ï¼Œå¹¶é‡å¯dockerã€‚

```
vim /etc/docker/daemon.json

{
        "exec-opts": ["native.cgroupdriver=systemd"],
        "registry-mirrors":[
          "https://docker.m.daocloud.io",
          "https://docker.rainbond.cc",
          "https://docker.lmirror.top"
       ]
}

#é‡å¯docker
systemctl restart docker
```

**2) ä½¿ç”¨docker compose å®‰è£…Milvus**

```
#åˆ›å»ºç›®å½•å¹¶è¿›å…¥
mkdir -p /software/milvus && cd /software/milvus

#ä¸‹è½½compose é…ç½®,æˆ–è€…ç›´æ¥å°†èµ„æ–™ä¸­ docker-compose.ymlä¸Šä¼ è‡³ç›®å½•ä¸‹
wget https://github.com/milvus-io/milvus/releases/download/v2.5.14/milvus-standalone-docker-compose.yml -O docker-compose.yml

#å¯åŠ¨ Milvus
docker compose up -d

#åœæ­¢Milvus
docker compose down
```

ç‰¹åˆ«æ³¨æ„ï¼šé€šè¿‡å¦‚ä¸‹å‘½ä»¤å°†linuxä¸­dockerçš„æ‰€æœ‰imageæ‰“åŒ…åˆ°â€œall_milvus_images.tarâ€ä¸­ï¼š

```
docker save -o all_milvus_images.tar milvusdb/milvus:v2.5.14 quay.io/coreos/etcd:v3.5.18 minio/minio:RELEASE.2024-05-28T17-19-04Z
```

åœ¨ç›®æ ‡linuxèŠ‚ç‚¹ä¸Šï¼ˆå·²å®‰è£…dockerï¼‰ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å°†all_milvus_images.tarå¯¼å…¥åˆ°ç›®æ ‡è®¡ç®—æœºä¸­ï¼š

```
docker load -i all_milvus_images.tar
```

**3) è®¿é—®Milvus WebUI**

æµè§ˆå™¨è¾“å…¥ http://node2:9091/webui/ æŸ¥çœ‹Milvus WebUIã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/79e0be5262d14c9299add9c808470449.jpg)

**4) å®‰è£… attuå¯è§†åŒ–æ“ä½œMilvus**

Attuæ˜¯ä¸€æ¬¾ä¸“ä¸ºMilvuså‘é‡æ•°æ®åº“æ‰“é€ çš„å¼€æºæ•°æ®åº“ç®¡ç†å·¥å…·ï¼Œæä¾›äº†ä¾¿æ·çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œæå¤§åœ°ç®€åŒ–äº†å¯¹Milvusæ•°æ®åº“çš„æ“ä½œä¸ç®¡ç†æµç¨‹ã€‚

åŒå‡»èµ„æ–™ä¸­â€œattu-Setup-2.5.12.exeâ€è¿›è¡ŒAttuå®‰è£…ï¼Œå®‰è£…å®Œæˆåè¿›å…¥Attuå¹¶è¿æ¥Milvusï¼š

![img](https://:0/)![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/7a01e8c5b20a42c9a558d167345329a7.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/f450868c43bd45918f20100df2c41911.jpg)

### **8.1.2. Milvus æ ¸å¿ƒæ¦‚å¿µ**

Milvusæ ¸å¿ƒæ¦‚å¿µæœ‰æ•°æ®åº“ã€Collectionsã€Schemaï¼Œä¸‹é¢åˆ†åˆ«ä»‹ç»ã€‚

**1. æ•°æ®åº“**

åœ¨ Milvus ä¸­ï¼Œæ•°æ®åº“æ˜¯ç»„ç»‡å’Œç®¡ç†æ•°æ®çš„é€»è¾‘å•å…ƒã€‚ä¸ºäº†æé«˜æ•°æ®å®‰å…¨æ€§å¹¶å®ç°å¤šç§Ÿæˆ·ï¼Œä½ å¯ä»¥åˆ›å»ºå¤šä¸ªæ•°æ®åº“ï¼Œä¸ºä¸åŒçš„åº”ç”¨ç¨‹åºæˆ–ç§Ÿæˆ·ä»é€»è¾‘ä¸Šéš”ç¦»æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ä¸ªæ•°æ®åº“ç”¨äºå­˜å‚¨ç”¨æˆ· A çš„æ•°æ®ï¼Œå¦ä¸€ä¸ªæ•°æ®åº“ç”¨äºå­˜å‚¨ç”¨æˆ· B çš„æ•°æ®ã€‚ä¸å…³ç³»å‹æ•°æ®åº“ä¸­æ‰€è¯´çš„æ•°æ®åº“ä¸€ä¸ªæ¦‚å¿µã€‚

**2. Collections**

åœ¨ Milvus ä¸­ï¼ŒCollection å¯ä»¥æ¯”ä½œå…³ç³»å­˜å‚¨ç³»ç»Ÿä¸­çš„è¡¨ã€‚Collections æ˜¯ Milvus ä¸­æœ€å¤§çš„æ•°æ®å•å…ƒï¼Œåœ¨ Milvus ä¸­ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ˜¯æŒ‰ Collectionsï¼ˆé›†åˆï¼‰ã€shardï¼ˆåˆ†ç‰‡ï¼‰ã€partitionï¼ˆåˆ†åŒºï¼‰ã€segmentï¼ˆæ•°æ®ç‰‡æ®µï¼‰ å’Œ entity ï¼ˆæ•°æ®å®ä½“ï¼Œä¸€è¡Œæ•°æ®å°±æ˜¯ä¸€ä¸ªå®ä½“ï¼‰ç»„ç»‡çš„ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/48bc1d9c0e714bba9c79931a641e5057.jpg)

ä¸ºäº†åœ¨å†™å…¥æ•°æ®æ—¶å……åˆ†åˆ©ç”¨é›†ç¾¤çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›ï¼ŒMilvus ä¸­çš„ Collection å¿…é¡»å°†æ•°æ®å†™å…¥æ“ä½œåˆ†æ•£åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ª Collections åŒ…å«ä¸¤ä¸ªåˆ†ç‰‡ï¼Œæ ¹æ®ä½ çš„æ•°æ®é›†å®¹é‡ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ª Collection ä¸­æ‹¥æœ‰æ›´å¤šçš„åˆ†ç‰‡ã€‚Milvus ä½¿ç”¨ä¸»å¯†é’¥æ•£åˆ—æ–¹æ³•è¿›è¡Œåˆ†ç‰‡ã€‚å…³äºMilvusæ•°æ®æ¨¡å‹å‚è€ƒï¼šhttps://milvus.io/zh/blog/deep-dive-1-milvus-architecture-overview.md#Shard

Collection æ˜¯ä¸€ä¸ªäºŒç»´è¡¨ï¼Œå…·æœ‰å›ºå®šçš„åˆ—å’Œå˜åŒ–çš„è¡Œã€‚æ¯åˆ—ä»£è¡¨ä¸€ä¸ªå­—æ®µï¼Œæ¯è¡Œä»£è¡¨ä¸€ä¸ªå®ä½“ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†ä¸€ä¸ªæœ‰ 8 åˆ—å’Œ 6 ä¸ªå®ä½“çš„ Collectionã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/707c5f6cb382427d8362a5773bc8878f.jpg)

**3. Schema**

Schema å®šä¹‰äº† Collections çš„æ•°æ®ç»“æ„ã€‚åœ¨åˆ›å»ºä¸€ä¸ª Collection ä¹‹å‰ï¼Œä½ éœ€è¦è®¾è®¡å‡ºå®ƒçš„ Schemaï¼Œå®šä¹‰å¦‚ä½•ç»„ç»‡ Collection ä¸­çš„æ•°æ®ã€‚ä¸€ä¸ª Collection Schema æœ‰ä¸€ä¸ªä¸»é”®ã€æœ€å¤šå››ä¸ªå‘é‡å­—æ®µå’Œå‡ ä¸ªæ ‡é‡å­—æ®µã€‚ä¸‹å›¾è¯´æ˜äº†å¦‚ä½•å°†æ–‡ç« æ˜ å°„åˆ°æ¨¡å¼å­—æ®µåˆ—è¡¨ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/63719224bca245d48fd4eab300fefd56.jpg)

Milvusæ”¯æŒçš„æ›´å¤šç±»å‹å‚è€ƒï¼šhttps://milvus.io/docs/zh/schema.md

**4. æ•°æ®ä¸€è‡´æ€§**

Milvus æä¾›äº†å››ç§ä¸€è‡´æ€§çº§åˆ«ï¼Œå…è®¸ç”¨æˆ·åœ¨æ•°æ®ä¸€è‡´æ€§å’ŒæŸ¥è¯¢å»¶è¿Ÿä¹‹é—´åšå‡ºå¹³è¡¡é€‰æ‹©ï¼š

- Strongï¼šæœ€å¼ºä¸€è‡´æ€§ï¼Œä¿è¯è¯»å–åˆ°æœ€æ–°æ•°æ®ï¼Œä½†æŸ¥è¯¢å»¶è¿Ÿè¾ƒé«˜ã€‚
- Boundedï¼šæœ‰ç•Œä¸€è‡´æ€§ï¼Œé»˜è®¤çº§åˆ«ï¼Œå…è®¸è½»å¾®å»¶è¿Ÿï¼Œæ»¡è¶³å¤§å¤šæ•°åœºæ™¯ä½¿ç”¨ã€‚
- Session:ä¼šè¯ä¸€è‡´æ€§ï¼Œä¿è¯åœ¨åŒä¸€å®¢æˆ·ç«¯ä¼šè¯ä¸­è¯»å–åˆ°è‡ªå·±å†™å…¥çš„æ•°æ®ï¼Œè·¨ä¼šè¯æ•°æ®å¯èƒ½ä¸ä¸€è‡´ã€‚
- Eventuallyï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œç›¸åº”æŸ¥è¯¢æœ€å¿«ï¼Œæ•°æ®ä¸€è‡´æ€§æœ€å¼±ï¼Œé€‚ç”¨äºå®æ—¶ç›‘æ§ã€æ—¥å¿—å±•ç¤ºç­‰ã€‚

å…³äºä»¥ä¸Šä¸€è‡´æ€§çš„åŸç†å‚è€ƒï¼šhttps://milvus.io/docs/zh/tune_consistency.md#Set-Consistency-Level-upon-Creating-Collectionã€‚

### **8.1.3. Milvus Cliæ“ä½œ**

Milvusä¸­æä¾›äº†Milvus Cliå‘½ä»¤è¡Œæ–¹å¼å¯¹Milvusè¿›è¡Œæ“ä½œï¼ŒMilvus Cli åŸºäºPythonï¼Œè¦æ±‚python3.8.5ä»¥ä¸Šï¼Œå¯ä»¥ä½¿ç”¨â€œpip install milvus-cliâ€è¿›è¡Œå®‰è£…ï¼Œå¦‚ä¸‹æ˜¯åœ¨windowsä¸­åŸºäºancondaï¼ˆé»˜è®¤å·²ç»å®‰è£…ï¼‰å®‰è£…python3.9ç¯å¢ƒå¹¶åœ¨è¯¥ç¯å¢ƒä¸­å®‰è£… milvus-cliï¼Œæ‰“å¼€cmdåæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```
# åˆ›å»ºä¸€ä¸ªåä¸ºpython_milvusçš„ç¯å¢ƒï¼ŒæŒ‡å®šPythonç‰ˆæœ¬æ˜¯3.9
conda create --name python_milvus python=3.9.23

# å®‰è£…å¥½åï¼Œä½¿ç”¨activateæ¿€æ´»è¯¥ç¯å¢ƒ
activate python_milvus

# å®‰è£…milvus-cli
pip install milvus-cli

# å®‰è£… readlineï¼ˆåœ¨windowä¸­ä½¿ç”¨ milvus_cliæ—¶éœ€è¦æ”¹æ¨¡å—ï¼‰
pip install pyreadline3

#å¦‚æœä¸è¡Œä½¿ç”¨è¯¥ç¯å¢ƒï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹åˆ é™¤è¯¥ç¯å¢ƒ
conda remove --name python_milvus --all
```

ä¸‹é¢è¿›å…¥åˆ° milvus-cli ä¸­è¿æ¥Milvuså¹¶è¿›è¡ŒåŸºæœ¬æ“ä½œã€‚

**1. è¿æ¥Milvus**

```
# è¿›å…¥ milvus å®¢æˆ·ç«¯
> milvus_cli

# è¿æ¥milvus_cli ,é»˜è®¤ç”¨æˆ·åå’Œå¯†ç ä¸ºï¼šroot:Milvus
milvus_cli > connect -uri http://node2:19530 -t root:Milvus
Connect Milvus successfully.
Error occurred!
list index out of range
```

è§£é‡Šï¼š-uri:è¿æ¥Milvusçš„uri åç§°ï¼Œé»˜è®¤ä¸º "http://127.0.0.1:19530"ï¼›-t:è¿æ¥Milvusçš„ä»¤ç‰Œï¼ŒæŒ‡å®šç”¨æˆ·åå’Œå¯†ç ;â€œError occurredï¼â€å¯èƒ½æ˜¯ä¸ªbugï¼Œå…ˆå¿½ç•¥ã€‚

**2. æ•°æ®åº“æ“ä½œï¼ˆåˆ›å»ºã€åˆ—å‡ºã€ä½¿ç”¨ã€åˆ é™¤ï¼‰**

```
# åˆ›å»ºæ•°æ®åº“
milvus_cli > create database -db testdb
Create database testdb successfully!

#åˆ—å‡ºæ•°æ®åº“
milvus_cli > list databases
+---------+
| db_name |
+---------+
| default |
| testdb  |
+---------+

#ä½¿ç”¨æ•°æ®åº“
milvus_cli > use database -db testdb
Using database testdb successfully!

#åˆ é™¤æ•°æ®åº“
milvus_cli > delete database -db testdb
Drop database testdb successfully!
```

**3. ç”¨æˆ·æ“ä½œï¼ˆåˆ›å»ºã€åˆ—å‡ºã€åˆ é™¤ï¼‰**

```
# åˆ›å»ºç”¨æˆ·ï¼Œ-u ç”¨æˆ·åï¼›-p å¯†ç 
milvus_cli > create user -u zs -p123456
Create user successfully!
['root', 'zs']

#åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
milvus_cli > list users
['root', 'zs']

#åˆ é™¤ç”¨æˆ·ï¼Œ-u æŒ‡å®šåˆ é™¤çš„ç”¨æˆ·
milvus_cli > delete user -u zs
Warning!
You are trying to delete the user in milvus. This action cannot be undone!

Do you want to continue? [y/N]: y
Delete user zs successfully!
['root']
```

é€šè¿‡Milvus Cli æ“ä½œCollectionç›®å‰å­˜åœ¨é—®é¢˜ï¼Œæˆ‘ä»¬åç»­é€šè¿‡Java SDKæ¥æ¼”ç¤ºCollectionæ“ä½œã€‚

### **8.1.4. Milvus Java API æ“ä½œ**

Java API æ“ä½œMilvus éœ€è¦JDK8ç‰ˆæœ¬ä»¥ä¸Šï¼Œmavenä¸­éœ€è¦å¯¼å…¥å¦‚ä¸‹ä¾èµ–ï¼š

```
<dependency>
  <groupId>io.milvus</groupId>
  <artifactId>milvus-sdk-java</artifactId>
  <version>2.6.0</version>
</dependency>
```

è¿™é‡Œä»¥Javaæ“ä½œMilvusä¸­çš„Collectionä¸ºä¾‹ä»‹ç»Milvus Java APIä½¿ç”¨ã€‚å®Œæ•´çš„ Javaæ“ä½œä»£ç å¦‚ä¸‹ï¼š

```
package org.example;

import com.google.gson.Gson;
import com.google.gson.JsonObject;
import io.milvus.param.collection.FlushParam;
import io.milvus.v2.client.ConnectConfig;
import io.milvus.v2.client.MilvusClientV2;
import io.milvus.v2.common.DataType;
import io.milvus.v2.common.IndexParam;
import io.milvus.v2.service.collection.request.*;
import io.milvus.v2.service.collection.response.DescribeCollectionResp;
import io.milvus.v2.service.utility.request.FlushReq;
import io.milvus.v2.service.vector.request.DeleteReq;
import io.milvus.v2.service.vector.request.GetReq;
import io.milvus.v2.service.vector.request.InsertReq;
import io.milvus.v2.service.vector.request.SearchReq;
import io.milvus.v2.service.vector.response.DeleteResp;
import io.milvus.v2.service.vector.response.GetResp;
import io.milvus.v2.service.vector.response.InsertResp;
import io.milvus.v2.service.vector.response.SearchResp;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

public class TestMilvusCollection {

    static String CLUSTER_ENDPOINT = "http://node2:19530";
    static String TOKEN = "root:Milvus";

    public static void main(String[] args) {
        //1. è¿æ¥åˆ° Milvus
        ConnectConfig connectConfig = ConnectConfig.builder()
                .uri(CLUSTER_ENDPOINT)
                .token(TOKEN)
                .build();

        MilvusClientV2 client = new MilvusClientV2(connectConfig);


        String collectionName = "testCollection";

        //1. åˆ›å»ºä¸€ä¸ªé›†åˆ
        createCollection(client, collectionName);

        //2. åˆ—å‡ºé›†åˆ
        List<String> collectionNames = client.listCollections().getCollectionNames();
        System.out.println("Collections: " + collectionNames);

        //3.æ’å…¥æ•°æ®
        insertDataToCollection(client, collectionName);

        //4.æŸ¥è¯¢æ•°æ®
        GetResp getResp = client.get(GetReq.builder()
                .collectionName(collectionName)// æŸ¥è¯¢é›†åˆåç§°
                .ids(List.of(0, 1, 2)) // æŸ¥è¯¢ id ä¸º 0 å’Œ 1 çš„æ•°æ®
                .outputFields(List.of("id", "color")) // æŸ¥è¯¢ id å’Œ color å­—æ®µ
                .build());
        getResp.getResults.forEach(result->{
               System.out.println("æŸ¥è¯¢ç»“æœï¼š"+result);
        });


        //4.æ ¹æ®ä¸»é”®åˆ é™¤æ•°æ®
        DeleteResp delete = client.delete(DeleteReq.builder()
                .collectionName(collectionName)// åˆ é™¤é›†åˆåç§°
                .ids(List.of(0, 1)) // åˆ é™¤ id ä¸º 0 å’Œ 1 çš„æ•°æ®
                .build()
        );
        System.out.println("åˆ é™¤æ•°æ®åé¦ˆï¼š"+delete);

        //5.åˆ é™¤é›†åˆ
//        client.dropCollection(DropCollectionReq.builder()
//               .collectionName(collectionName)
//               .build());
//        System.out.println("åˆ é™¤é›†åˆï¼š"+collectionName);

    }


    private static void insertDataToCollection(MilvusClientV2 client, String collectionName) {

        //3.1 å‡†å¤‡ json æ•°æ®
        Gson gson = new Gson();
        List<JsonObject> data = Arrays.asList(
                gson.fromJson("{\"id\": 0, \"vector\": [0.3580376395471989, -0.6023495712049978, 0.18414012509913835, -0.26286205330961354, 0.9029438446296592], \"color\": \"pink_8683\"}", JsonObject.class),
                gson.fromJson("{\"id\": 1, \"vector\": [0.19886812562848388, 0.06023560599112088, 0.6976963061752597, 0.2614474506242501, 0.838729485096104], \"color\": \"red_7025\"}", JsonObject.class),
                gson.fromJson("{\"id\": 2, \"vector\": [0.43742130801983836, -0.5597502546264526, 0.6457887650909682, 0.7894058910881185, 0.20785793220625592], \"color\": \"orange_6781\"}", JsonObject.class),
                gson.fromJson("{\"id\": 3, \"vector\": [0.3172005263489739, 0.9719044792798428, -0.36981146090600725, -0.4860894583077995, 0.95791889146345], \"color\": \"pink_9298\"}", JsonObject.class),
                gson.fromJson("{\"id\": 4, \"vector\": [0.4452349528804562, -0.8757026943054742, 0.8220779437047674, 0.46406290649483184, 0.30337481143159106], \"color\": \"red_4794\"}", JsonObject.class),
                gson.fromJson("{\"id\": 5, \"vector\": [0.985825131989184, -0.8144651566660419, 0.6299267002202009, 0.1206906911183383, -0.1446277761879955], \"color\": \"yellow_4222\"}", JsonObject.class),
                gson.fromJson("{\"id\": 6, \"vector\": [0.8371977790571115, -0.015764369584852833, -0.31062937026679327, -0.562666951622192, -0.8984947637863987], \"color\": \"red_9392\"}", JsonObject.class),
                gson.fromJson("{\"id\": 7, \"vector\": [-0.33445148015177995, -0.2567135004164067, 0.8987539745369246, 0.9402995886420709, 0.5378064918413052], \"color\": \"grey_8510\"}", JsonObject.class),
                gson.fromJson("{\"id\": 8, \"vector\": [0.39524717779832685, 0.4000257286739164, -0.5890507376891594, -0.8650502298996872, -0.6140360785406336], \"color\": \"white_9381\"}", JsonObject.class),
                gson.fromJson("{\"id\": 9, \"vector\": [0.5718280481994695, 0.24070317428066512, -0.3737913482606834, -0.06726932177492717, -0.6980531615588608], \"color\": \"purple_4976\"}", JsonObject.class)
        );

        //3.2 æ’å…¥æ•°æ®
        InsertResp insertResp = client.insert(InsertReq.builder()
                .collectionName(collectionName)
                .data(data)
                .build());


        //3.3 åˆ·æ–°æ•°æ® ï¼Œå¦åˆ™æŸ¥è¯¢ä¸åˆ°æ•°æ®
        FlushReq flushReq = FlushReq.builder()
               .collectionNames(Arrays.asList(collectionName))
               .build();

        client.flush(flushReq);

        System.out.println("æ’å…¥æ•°æ®åé¦ˆï¼š"+insertResp);
    }

    public static void createCollection(MilvusClientV2 client, String collectionName) {
        //1.1 å…ˆåˆ›å»ºé›†åˆ schema
        CreateCollectionReq.CollectionSchema schema = MilvusClientV2.CreateSchema()
                .addField(AddFieldReq.builder()
                        .fieldName("id")
                        .dataType(DataType.Int64)
                        .isPrimaryKey(true)
                        .autoID(false)
                        .build())
                .addField(AddFieldReq.builder()
                        .fieldName("vector")
                        .dataType(DataType.FloatVector)
                        .dimension(5)
                        .build())
                .addField(AddFieldReq.builder()
                        .fieldName("color")
                        .dataType(DataType.VarChar)
                        .maxLength(512)
                        .build());


        //1.2 å¦‚æœè¦åˆ›å»ºç´¢å¼•ï¼Œå¿…é¡»ä¸º vector åˆ—åˆ›å»ºç´¢å¼•ï¼Œå¦åˆ™æ— æ³•åˆ›å»ºè¡¨
        // å»ºè®®å¯¹vectoråˆ—åˆ›å»ºç´¢å¼•ï¼Œæ–¹ä¾¿é«˜æ•ˆå‘é‡æœç´¢
        List<IndexParam> indexParams = new ArrayList<>();

        IndexParam vector = IndexParam.builder()
                .fieldName("vector")
                .indexType(IndexParam.IndexType.IVF_FLAT) // å‘é‡ç´¢å¼•ç±»å‹
                .metricType(IndexParam.MetricType.COSINE) // ä½™å¼¦ç›¸ä¼¼åº¦
                .build();

        indexParams.add(vector);

        //1.3 åˆ›å»ºé›†åˆ
        if (client.hasCollection(HasCollectionReq.builder().collectionName(collectionName).build())) {
            System.out.println("Collection already exists: " + collectionName);
            return;
        }

        client.createCollection(CreateCollectionReq.builder()
               .collectionName(collectionName) // é›†åˆåç§°
               .collectionSchema(schema) // é›†åˆ schema
               .indexParams(indexParams) // ç´¢å¼•å‚æ•°
               .build());

        System.out.println("Collection created: " + collectionName);

    }
}
```

ä»¥ä¸Šä»£ç æ³¨æ„å¦‚ä¸‹å‡ ç‚¹ï¼š

- åˆ›å»ºCollectionæ—¶éœ€è¦æŒ‡å®šSchemaï¼Œå¦‚æœè¡¨ä¸­æœ‰vectorå­—æ®µå¿…é¡»è®¾ç½®ç´¢å¼•ï¼ŒåŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚
- å‘Collectionä¸­æ’å…¥æ•°æ®åï¼Œéœ€è¦æ‰§è¡Œflushï¼Œå¦åˆ™æŸ¥è¯¢ä¸åˆ°æ•°æ®ã€‚
- åœ¨ä»£ç è¿è¡Œè¿‡ç¨‹ä¸­å¯ä»¥ç»“åˆAttuå·¥å…·æŸ¥çœ‹Milvusä¸­çš„CollectionåŠå…¶å†…å®¹ã€‚

## 8.2. **Spring AI RAGä»‹ç»**

Springâ€¯AI æä¾›äº†å¯¹å¸¸è§ RAG æµç¨‹çš„å¼€ç®±æ”¯æŒï¼Œé€šè¿‡ Advisor API å®ç°ï¼Œå‘é‡æ•°æ®åº“å­˜å‚¨ç€AIæ¨¡å‹æ‰€ä¸çŸ¥é“çš„æ•°æ®ï¼Œå½“ç”¨æˆ·æé—®æ—¶ï¼ŒAdvisorä¼šå‘å‘é‡æ•°æ®åº“æŸ¥è¯¢ä¸ç”¨æˆ·é—®é¢˜ç›¸å…³çš„æ–‡æ¡£ï¼Œå°†æ£€ç´¢ç»“æœé™„åŠ åˆ°ç”¨æˆ·æ–‡æœ¬ä¸­ï¼Œç„¶åé€šè¿‡AIå¤§æ¨¡å‹æ¨ç†ç”Ÿæˆæœ€ç»ˆå›ç­”ã€‚

åœ¨RAGæµç¨‹ä¸­ï¼Œæœ‰ä¸¤ç§Advisorï¼šQuestionAnswerAdvisorå’ŒRetrievalAugmentationAdvisorã€‚

- **QuestionAnswerAdvisor**

å½“ç”¨æˆ·æå‡ºé—®é¢˜æ—¶ï¼ŒQuestionAnswerAdvisor ä¼šå¸®åŠ©ç³»ç»Ÿä»å·²æœ‰çš„çŸ¥è¯†åº“æˆ–æ•°æ®åº“ä¸­æ£€ç´¢ç­”æ¡ˆï¼Œå¹¶å°†å…¶è¿”å›ç»™ç”¨æˆ·ï¼Œå…¶æ ¸å¿ƒç›®çš„æ˜¯å°†ç”¨æˆ·çš„é—®é¢˜ä¸çŸ¥è¯†åº“ä¸­çš„ç­”æ¡ˆè¿›è¡ŒåŒ¹é…ï¼Œæä¾›ç­”æ¡ˆã€‚QuestionAnswerAdvisor ä¾§é‡é—®ç­”å¤„ç†ï¼Œé€šè¿‡ç†è§£å’Œåˆ†æç”¨æˆ·çš„é—®é¢˜ï¼Œæ‰¾åˆ°æœ€åˆé€‚çš„ç­”æ¡ˆ

- **RetrievalAugmentationAdvisor**

å½“éœ€è¦ä»å¤§å‹æ•°æ®åº“æˆ–çŸ¥è¯†åº“ä¸­æ£€ç´¢ä¿¡æ¯æ—¶ï¼ŒRetrievalAugmentationAdvisor ä¼šåœ¨æ£€ç´¢è¯·æ±‚å‰åæ’å…¥å¢å¼ºé€»è¾‘ã€‚ä¾‹å¦‚ï¼Œåœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­ï¼ŒRetrievalAugmentationAdvisor å¯ä»¥è‡ªåŠ¨åŠ å…¥é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·çš„å†å²æŸ¥è¯¢ã€åå¥½ã€é¢†åŸŸçŸ¥è¯†ç­‰ï¼‰ï¼Œä»¥æé«˜æ£€ç´¢ç»“æœçš„ç›¸å…³æ€§å’Œå‡†ç¡®æ€§ã€‚RetrievalAugmentationAdvisor ä¾§é‡ ä¿¡æ¯æ£€ç´¢ï¼Œé€šè¿‡å¢å¼ºæ£€ç´¢æ¡ä»¶å’Œä¸Šä¸‹æ–‡ä¿¡æ¯æ¥ä¼˜åŒ–æŸ¥è¯¢è¿‡ç¨‹ã€‚

*å¤‡æ³¨ï¼šAdvisorï¼ˆé¡¾é—®ï¼‰æ˜¯ Spring AI ä¸­ç”¨äºå¢å¼ºæ–¹æ³•æ‰§è¡Œé€»è¾‘çš„ç»„ä»¶ï¼Œç±»ä¼¼äºä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œé€šè¿‡ Advisorï¼Œå¯ä»¥åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ’å…¥è‡ªå®šä¹‰é€»è¾‘ï¼Œä»è€Œæå‡ä»£ç çš„å¯æ‰©å±•æ€§ä¸çµæ´»æ€§ï¼Œå¸¸ç”¨äºä»»åŠ¡å¢å¼ºã€æ•°æ®é¢„å¤„ç†ç­‰åœºæ™¯ã€‚*

ä½¿ç”¨ä»¥ä¸Šä¸¤ç§Advisoræ—¶éœ€è¦åœ¨é¡¹ç›®maven pom.xmlå¯¼å…¥å¦‚ä¸‹ä¾èµ–ï¼š

```
<!-- QuestionAnswerAdvisor ä¾èµ–åŒ…-->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-advisors-vector-store</artifactId>
</dependency>

<!--  RetrievalAugmentationAdvisor  ä¾èµ–åŒ…-->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-rag</artifactId>
</dependency>
```

ä¸‹é¢é€šè¿‡SpringBootç¨‹åºæ¼”ç¤ºä¸¤ç§Advisorçš„ä½¿ç”¨æ–¹å¼ï¼Œè¯¥æ¡ˆä¾‹ä¸­æˆ‘ä»¬å°†å›ºå®šçš„æ–‡æ¡£ç‰‡æ®µå­˜å…¥åˆ°Milvuså‘é‡åº“ï¼Œç„¶åé€šè¿‡chatClient è¾“å…¥é—®é¢˜ï¼Œåˆ†åˆ«ä½¿ç”¨ä¸¤ç§Advisorè¿›è¡Œæ£€ç´¢å‘é‡åº“è¿›è¡Œå›ç­”ã€‚

**1) åˆ›å»ºSpringBooté¡¹ç›®**

SpringBooté¡¹ç›®å‘½åä¸ºSpringAIRAGWithAdvisorï¼Œè®¾ç½®ä½¿ç”¨çš„JDKä¸º17ç‰ˆæœ¬ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/5c4a866ae6e34526a3548493bee1fccf.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/2edd8178d4d14a9996b256d061c3a477.jpg)

**2) åœ¨é¡¹ç›®ä¸­åŠ å…¥å¦‚ä¸‹Mavenä¾èµ–**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.3</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>SpringAIRAGWithAdvisor</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>SpringAIRAGWithAdvisor</name>
    <description>SpringAIRAGWithAdvisor</description>


    <properties>
        <java.version>17</java.version>
    </properties>

    <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0-SNAPSHOT</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- Deepseek AI ä¾èµ– -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-deepseek</artifactId>
        </dependency>

        <!-- æ™ºæ™®AI ä¾èµ– -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-zhipuai</artifactId>
        </dependency>

        <!-- QuestionAnswerAdvisor ä¾èµ–åŒ…-->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-advisors-vector-store</artifactId>
        </dependency>

        <!--  RetrievalAugmentationAdviso  ä¾èµ–åŒ…-->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-rag</artifactId>
        </dependency>

        <!--  Milvus VectorStore ä¾èµ–åŒ…-->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-vector-store-milvus</artifactId>
        </dependency>

    </dependencies>

    <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
        <repository>
            <name>Central Portal Snapshots</name>
            <id>central-portal-snapshots</id>
            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

æ³¨æ„ï¼š

- åœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-model-zhipuaiâ€ä¾èµ–åŒ…ç”¨äºæ–‡æ¡£ç‰‡æ®µè½¬æ¢æˆå‘é‡å­˜å…¥å‘é‡åº“ï¼›
- åœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-model-deepseekâ€ä¾èµ–åŒ…ç”¨äºchatClientèŠå¤©ã€‚
- åœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-advisors-vector-storeâ€å’Œâ€œspring-ai-ragâ€ä¾èµ–åŒ…ï¼Œä¸¤ä¸ªä¾èµ–åŒ…åˆ†åˆ«ä¸ºQuestionAnswerAdvisorå’ŒRetrievalAugmentationAdvisorä¾èµ–ã€‚
- åœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-vector-store-milvusâ€ä¾èµ–åŒ…ï¼Œè¯¥ä¾èµ–ä¸ºMilvus VectorStore ä¾èµ–åŒ…ã€‚

**3) é…ç½®resources/application.properties**

```
spring.application.name=SpringAIRAGWithAdvisor

server.port=8080

## ä½¿ç”¨ æ™ºæ™®AI Embedding æ¨¡å‹ï¼Œéœ€è¦åœ¨pom.xmlä¸­å¼•å…¥å¯¹åº”ä¾èµ–
spring.ai.zhipuai.api-key=d...4
spring.ai.zhipuai.base-url=https://open.bigmodel.cn/api/paas
spring.ai.zhipuai.embedding.options.model=embedding-2

## é…ç½® Chat Model:Deepseekçš„åŸºç¡€URLã€å¯†é’¥å’Œä½¿ç”¨æ¨¡å‹
spring.ai.deepseek.base-url=https://api.deepseek.com
spring.ai.deepseek.api-key=sk-8...1
spring.ai.deepseek.chat.options.model=deepseek-chat

## Milvus é…ç½®
spring.ai.vectorstore.milvus.client.host=node2
spring.ai.vectorstore.milvus.client.port=19530
# é»˜è®¤ç”¨æˆ·åå’Œå¯†ç ä¸º root å’Œ Milvus
spring.ai.vectorstore.milvus.client.token=root:Milvus
# è¦ä½¿ç”¨çš„ Milvus æ•°æ®åº“çš„åç§°
spring.ai.vectorstore.milvus.database-name=default
# ç”¨äºå­˜å‚¨ vector çš„ Milvus é›†åˆåç§°
spring.ai.vectorstore.milvus.collection-name=vector_store
#æ˜¯å¦è‡ªåŠ¨åˆå§‹åŒ– schemaï¼Œå¦‚ï¼švector_storeå¦‚æœæ²¡æœ‰ä¼šè‡ªåŠ¨åˆ›å»º
spring.ai.vectorstore.milvus.initialize-schema=true
# Milvus é›†åˆä¸­è¦å­˜å‚¨çš„ vector çš„ç»´åº¦ï¼Œé»˜è®¤ä¸º1536ï¼Œè¦ä¸æ‰€ä½¿ç”¨çš„ embedding æ¨¡å‹çš„ç»´åº¦åŒ¹é…ï¼ˆå¦‚ï¼šDeepSeekã€ZhiPuAI æˆ–å…¶ä»–ï¼Œéƒ½æ˜¯1024ç»´ï¼‰
spring.ai.vectorstore.milvus.embedding-dimension=1024
```

**4) æ„å»ºä¸¤ä¸ªRag Advisorå’ŒChat Client**

åœ¨é¡¹ç›®ä¸­åˆ›å»ºconfig/AIConfig.java ï¼Œè¯¥ç±»æ ‡è®°ä¸ºConfigurationç±»ã€‚ç±»ä¸­æ³¨å…¥QuestionAnswerAdvisorã€RetrievalAugmentationAdvisorä»¥åŠChatClientï¼Œå¹¶ä¸”æ¯æ¬¡è¿è¡ŒSpringBooté¡¹ç›®æ—¶å‘Milvusä¸­æ’å…¥æŒ‡å®šæ–‡æ¡£å‘é‡æ•°æ®ï¼ˆå¦‚æœå·²å­˜åœ¨åˆ™ä¸é‡å¤æ’å…¥ï¼‰ã€‚

```
package com.example.springairagwithadvisor.config;

import io.milvus.client.MilvusServiceClient;
import io.milvus.grpc.GetCollectionStatisticsResponse;
import io.milvus.param.R;
import io.milvus.param.collection.FlushParam;
import io.milvus.param.collection.GetCollectionStatisticsParam;
import io.milvus.response.GetCollStatResponseWrapper;
import jakarta.annotation.PostConstruct;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.client.advisor.vectorstore.QuestionAnswerAdvisor;
import org.springframework.ai.deepseek.DeepSeekChatModel;
import org.springframework.ai.document.Document;
import org.springframework.ai.rag.advisor.RetrievalAugmentationAdvisor;
import org.springframework.ai.rag.generation.augmentation.ContextualQueryAugmenter;
import org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;
import org.springframework.ai.vectorstore.SearchRequest;
import org.springframework.ai.vectorstore.VectorStore;
import org.springframework.ai.vectorstore.milvus.MilvusVectorStore;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

@Configuration
public class AIConfig {

    // æ³¨å…¥ MilvusVectorStore å®ä¾‹
    @Autowired
    private MilvusVectorStore vectorStore;

    // ä»é…ç½®æ–‡ä»¶ä¸­è¯»å– Milvus é›†åˆåç§°
    @Value("${spring.ai.vectorstore.milvus.collection-name}")
    private String collectionName;


    //é…ç½® QuestionAnswerAdvisorï¼Œç”¨äºé—®ç­”ä»»åŠ¡
    @Bean
    public QuestionAnswerAdvisor questionAnswerAdvisor() {
        return QuestionAnswerAdvisor.builder(vectorStore)
                // é…ç½®å‘é‡æœç´¢çš„å‚æ•°ï¼Œè¿™é‡Œè®¾ç½®äº†ç›¸ä¼¼åº¦é˜ˆå€¼ä¸º 0.5ï¼Œè¿”å›å‰ 6 ä¸ªç»“æœ
                .searchRequest(SearchRequest.builder().similarityThreshold(0.5d).topK(6).build())
                .build();
    }


    //é…ç½® RetrievalAugmentationAdvisorï¼Œç”¨äºå¢å¼ºæ£€ç´¢ä»»åŠ¡
    @Bean
    public RetrievalAugmentationAdvisor retrievalAugmentationAdvisor() {

        //VectorStoreDocumentRetriever è´Ÿè´£åœ¨å‘é‡æ•°æ®åº“ä¸­æ ¹æ®æŸ¥è¯¢è·å–æœ€ç›¸å…³çš„æ–‡æ¡£
        //æ”¯æŒæ ¹æ®ç›¸ä¼¼åº¦é˜ˆå€¼ã€top-Kï¼ˆè¿”å›å‰Kä¸ªæœ€ç›¸å…³æ–‡æ¡£ï¼‰å’Œè¿‡æ»¤è¡¨è¾¾å¼ç­‰æ–¹å¼è¿›è¡Œç²¾ç¡®æ£€ç´¢
        VectorStoreDocumentRetriever retriever = VectorStoreDocumentRetriever.builder()
                .vectorStore(vectorStore) // è®¾ç½®å‘é‡å­˜å‚¨å¯¹è±¡
                .similarityThreshold(0.5)//è®¾ç½®ç›¸ä¼¼åº¦é˜ˆå€¼
                .topK(6)//è®¾ç½®è¿”å›å‰Kä¸ªæœ€ç›¸å…³æ–‡æ¡£
                .build();

        //ContextualQueryAugmenter ç”¨äºå¢å¼ºæŸ¥è¯¢ï¼Œæ ¹æ®ä¸Šä¸‹æ–‡ä¿¡æ¯ç”Ÿæˆæ›´å…·ä½“çš„æŸ¥è¯¢
        //æ”¯æŒåŸºäºä¸Šä¸‹æ–‡çš„æŸ¥è¯¢å¢å¼ºï¼Œä¾‹å¦‚æ ¹æ®ç”¨æˆ·è¾“å…¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ç”Ÿæˆæ›´å…·ä½“çš„æŸ¥è¯¢ï¼Œæé«˜æ£€ç´¢çš„å‡†ç¡®æ€§å’Œæ•ˆç‡
        ContextualQueryAugmenter cqa = ContextualQueryAugmenter.builder()
                .allowEmptyContext(true)//å…è®¸ç©ºä¸Šä¸‹æ–‡
                .build();

        //è¿”å› RetrievalAugmentationAdvisor å¯¹è±¡ï¼Œç”¨äºå¢å¼ºæ£€ç´¢ä»»åŠ¡
        return RetrievalAugmentationAdvisor.builder()
                .documentRetriever(retriever) // è®¾ç½®æ–‡æ¡£æ£€ç´¢å™¨
                .queryAugmenter(cqa) // è®¾ç½®æŸ¥è¯¢å¢å¼ºå™¨
                .build();
    }


    //é…ç½® ChatClientï¼Œåˆå§‹åŒ–èŠå¤©å®¢æˆ·ç«¯
    @Bean
    public ChatClient chatClient(DeepSeekChatModel chatModel) {
        return ChatClient.builder(chatModel)
                .defaultSystem("ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹ï¼Œå›ç­”ç”¨æˆ·é—®é¢˜æ˜¯ä¸è¦æåŠå›å¤æ˜¯ä»ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸­è·å–çš„ï¼Œ" +
                        "ä¸è¦å›ç­”ä½ ä¸çŸ¥é“çš„é—®é¢˜ï¼Œå¦‚æœä½ ä¸çŸ¥é“ç­”æ¡ˆï¼Œå°±å›ç­”ï¼šæŠ±æ­‰ï¼Œæˆ‘ä¸æ¸…æ¥šè¿™ä¸ªé—®é¢˜ã€‚")
                .build();
    }


    /**
     * @PostConstruct æ³¨è§£çš„æ–¹æ³•ä¼šåœ¨ Spring å®¹å™¨å®Œæˆä¾èµ–æ³¨å…¥åè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡ï¼Œå¸¸ç”¨äºæ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ã€‚
     */
    @PostConstruct
    public void initVectorData() {
        System.out.println("åˆå§‹åŒ–å‘é‡æ•°æ®ï¼Œå†™å…¥åˆ° Milvus æ•°æ®åº“ä¸­...");

        // è·å– Milvus å®¢æˆ·ç«¯å®ä¾‹
        MilvusServiceClient client = (MilvusServiceClient)vectorStore.getNativeClient().get();

        // è·å–é›†åˆç»Ÿè®¡ä¿¡æ¯ï¼ŒæŸ¥è¯¢é›†åˆçš„è®°å½•æ•°é‡
        R<GetCollectionStatisticsResponse> resp = client.getCollectionStatistics(GetCollectionStatisticsParam.newBuilder()
                .withCollectionName(collectionName)
                .build());

        // è·å–å®ä½“æ•°é‡ï¼Œå³æ•°æ®è¡Œæ•°
        long rowCount = new GetCollStatResponseWrapper(resp.getData()).getRowCount();

        System.out.println("Milvus vector_store ä¸­æ•°æ®æ•°é‡ï¼š" + rowCount);

        //å¦‚æœé›†åˆæ²¡æœ‰æ•°æ®å°±å†™å…¥
        if(rowCount==0){
            System.out.println("Milvus vector_store ä¸­æ²¡æœ‰æ•°æ®ï¼Œå†™å…¥...");
            List<Document> docs = List.of(
                    new Document("Spring AI æ˜¯ä¸€ä¸ªå¼€æº AI é›†æˆé¡¹ç›®"),
                    new Document("Milvus æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½å‘é‡æ•°æ®åº“"),
                    new Document("DeepSeek æ˜¯ä¸€ä¸ªå¼€æºå¤§è¯­è¨€æ¨¡å‹")
            );

            //vectorStore.add(docs) è°ƒç”¨æ—¶ï¼ŒSpring AI çš„ MilvusVectorStore ä¼šä½¿ç”¨æ³¨å…¥çš„ EmbeddingModel å°†æ¯ä¸ª Document ä¸­çš„æ–‡æœ¬å†…å®¹è½¬æ¢æˆå‘é‡å¹¶å†™å…¥
            vectorStore.add(docs);

            // è·å– Milvus å®¢æˆ·ç«¯å¹¶æ‰‹åŠ¨è°ƒç”¨ flushï¼Œåˆ·æ–°ç´¢å¼•ï¼Œç¡®ä¿æ•°æ®è¢«æŒä¹…åŒ–åˆ° Milvus æ•°æ®åº“ä¸­
            System.out.println("Milvus vector_store åˆ·æ–°ç´¢å¼•...");
            client.flush(FlushParam.newBuilder()
                    .withCollectionNames(List.of(collectionName)) // è®¾ç½®åˆ·æ–°æ“ä½œçš„é›†åˆåç§°
                    .build());
        }

    }
}
```

**5) åˆ›å»ºRagController.java**

```
package com.example.springairagwithadvisor.controller;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.client.advisor.vectorstore.QuestionAnswerAdvisor;
import org.springframework.ai.rag.advisor.RetrievalAugmentationAdvisor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@RestController
@RequestMapping("/ai")
public class RagController {

    @Autowired
    private ChatClient chatClient;
    @Autowired
    private QuestionAnswerAdvisor qaAdvisor;
    @Autowired
    private RetrievalAugmentationAdvisor ragAdvisor;


    @GetMapping("/chat1")
    public String ask1(@RequestParam String message) {
        return chatClient.prompt()
                .user(message)
                //è®¾ç½®ä½¿ç”¨ QuestionAnswerAdvisor
                .advisors(List.of(qaAdvisor))
                .call()
                .content();
    }

    @GetMapping("/chat2")
    public String ask2(@RequestParam String message) {
        return chatClient.prompt()
                .user(message)
                //è®¾ç½®ä½¿ç”¨ RetrievalAugmentationAdvisor
                .advisors(List.of(ragAdvisor))
                .call()
                .content();
    }
}
```

**6) å¯åŠ¨Milvus**

åœ¨linux node2 èŠ‚ç‚¹å¯åŠ¨Milvusï¼š

```
#è¿›å…¥ milvusç›®å½•
cd /software/milvus

#å¯åŠ¨ Milvus
docker compose up -d
```

**7) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨SpringAiRAGWithAdvisoré¡¹ç›®ï¼Œè¿è¡Œä¸»åº”ç”¨ç±»SpringAiragWithAdvisorApplication.javaï¼Œå¯åŠ¨è¯¥é¡¹ç›®ã€‚

åœ¨æµè§ˆå™¨ä¸­è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œæµ‹è¯•ï¼š

```
# http://localhost:8080/ai/chat1?message=Milvusæ˜¯ä»€ä¹ˆï¼Ÿ
Milvusæ˜¯ä¸€æ¬¾é«˜æ€§èƒ½å‘é‡æ•°æ®åº“ã€‚

# http://localhost:8080/ai/chat1?message=ä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ
æŠ±æ­‰ï¼Œæˆ‘ä¸æ¸…æ¥šè¿™ä¸ªé—®é¢˜ã€‚

#http://localhost:8080/ai/chat2?message=Spring AIæ˜¯ä»€ä¹ˆï¼Ÿ
Spring AI æ˜¯ä¸€ä¸ªå¼€æº AI é›†æˆé¡¹ç›®ã€‚

#http://localhost:8080/ai/chat2?message=ä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ
æŠ±æ­‰ï¼Œæˆ‘ä¸æ¸…æ¥šè¿™ä¸ªé—®é¢˜ã€‚
```

## 8.3. **å¯¼æ¸¸è€ƒè¯•RAGæ¡ˆä¾‹**

ä¸‹é¢é€šè¿‡å¯¼æ¸¸è€ƒè¯•RAGæ¡ˆä¾‹æ¥æ¼”ç¤ºSpring AI ä¸­RAG ä»é›¶åˆ°ä¸€ç»¼åˆå¼€å‘ï¼Œè¿™ä¸ªæ¡ˆä¾‹ä¸­æ¶‰åŠå¦‚ä¸‹å†…å®¹ï¼š

1. ä»æœ¬åœ°docæ–‡ä»¶æ„å»ºçŸ¥è¯†åº“ï¼Œå°†å†…å®¹å­˜å…¥Milvusä¸­ã€‚
2. ä½¿ç”¨QuestionAnswerAdvisorå’ŒRetrievalAugmentationAdvisor å®ç°RAGã€‚

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤å®ç°è¯¥æ¡ˆä¾‹ï¼š

**1) åˆ›å»ºSpringBooté¡¹ç›®**

SpringBooté¡¹ç›®å‘½åä¸ºSpringAIRAGDemoï¼Œè®¾ç½®ä½¿ç”¨çš„JDKä¸º17ç‰ˆæœ¬ã€‚

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/e0fbffb6a8c84ce2a9526ae1270a2af5.jpg)

![img](https://:0/) ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/20/1751796495022/02960aa1d27949658c259b722ffc8be0.jpg)

**2) åœ¨é¡¹ç›®ä¸­åŠ å…¥å¦‚ä¸‹Mavenä¾èµ–**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
   <modelVersion>4.0.0</modelVersion>
   <parent>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-parent</artifactId>
      <version>3.5.3</version>
      <relativePath/> <!-- lookup parent from repository -->
   </parent>
   <groupId>com.example</groupId>
   <artifactId>SpringAIRAGDemo</artifactId>
   <version>0.0.1-SNAPSHOT</version>
   <name>SpringAIRAGDemo</name>
   <description>SpringAIRAGDemo</description>


   <properties>
      <java.version>17</java.version>
   </properties>

   <!-- å¯¼å…¥ Spring AI BOMï¼Œç”¨äºç»Ÿä¸€ç®¡ç† Spring AI ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
    å¼•ç”¨æ¯ä¸ª Spring AI æ¨¡å—æ—¶ä¸ç”¨å†å†™ <version>ï¼Œåªè¦ä¾èµ–ä»€ä¹ˆæ¨¡å— Mavens è‡ªåŠ¨ä½¿ç”¨ BOM æ¨èçš„ç‰ˆæœ¬ -->
   <dependencyManagement>
      <dependencies>
         <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-bom</artifactId>
            <version>1.0.0-SNAPSHOT</version>
            <type>pom</type>
            <scope>import</scope>
         </dependency>
      </dependencies>
   </dependencyManagement>

   <dependencies>
      <dependency>
         <groupId>org.springframework.boot</groupId>
         <artifactId>spring-boot-starter-web</artifactId>
      </dependency>

      <!-- Deepseek AI ä¾èµ– -->
      <dependency>
         <groupId>org.springframework.ai</groupId>
         <artifactId>spring-ai-starter-model-deepseek</artifactId>
      </dependency>

      <!-- æ™ºæ™®AI ä¾èµ– -->
      <dependency>
         <groupId>org.springframework.ai</groupId>
         <artifactId>spring-ai-starter-model-zhipuai</artifactId>
      </dependency>

      <!-- QuestionAnswerAdvisor ä¾èµ–åŒ…-->
      <dependency>
         <groupId>org.springframework.ai</groupId>
         <artifactId>spring-ai-advisors-vector-store</artifactId>
      </dependency>

      <!--  RetrievalAugmentationAdvisor  ä¾èµ–åŒ…-->
      <dependency>
         <groupId>org.springframework.ai</groupId>
         <artifactId>spring-ai-rag</artifactId>
      </dependency>

      <!--  Milvus VectorStore ä¾èµ–åŒ…-->
      <dependency>
         <groupId>org.springframework.ai</groupId>
         <artifactId>spring-ai-starter-vector-store-milvus</artifactId>
      </dependency>

      <!-- Tika DocumentReader ä¾èµ–åŒ…-->
      <dependency>
         <groupId>org.springframework.ai</groupId>
         <artifactId>spring-ai-tika-document-reader</artifactId>
      </dependency>


   </dependencies>

   <!-- å£°æ˜ä»“åº“ï¼Œ ç”¨äºè·å– Spring AI ä»¥åŠç›¸å…³é¢„å‘å¸ƒç‰ˆæœ¬-->
   <repositories>
      <repository>
         <id>spring-snapshots</id>
         <name>Spring Snapshots</name>
         <url>https://repo.spring.io/snapshot</url>
         <releases>
            <enabled>false</enabled>
         </releases>
      </repository>
      <repository>
         <name>Central Portal Snapshots</name>
         <id>central-portal-snapshots</id>
         <url>https://central.sonatype.com/repository/maven-snapshots/</url>
         <releases>
            <enabled>false</enabled>
         </releases>
         <snapshots>
            <enabled>true</enabled>
         </snapshots>
      </repository>
   </repositories>

</project>
```

æ³¨æ„ï¼š

- åœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-model-zhipuaiâ€ä¾èµ–åŒ…ç”¨äºæ–‡æ¡£ç‰‡æ®µè½¬æ¢æˆå‘é‡å­˜å…¥å‘é‡åº“ï¼›
- åœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-model-deepseekâ€ä¾èµ–åŒ…ç”¨äºchatClientèŠå¤©ã€‚
- åœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-advisors-vector-storeâ€å’Œâ€œspring-ai-ragâ€ä¾èµ–åŒ…ï¼Œä¸¤ä¸ªä¾èµ–åŒ…åˆ†åˆ«ä¸ºQuestionAnswerAdvisorå’ŒRetrievalAugmentationAdvisorä¾èµ–ã€‚
- åœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-starter-vector-store-milvusâ€ä¾èµ–åŒ…ï¼Œè¯¥ä¾èµ–ä¸ºMilvus VectorStore ä¾èµ–åŒ…ã€‚
- åœ¨è¯¥pom.xmlä¸­å¼•å…¥äº†â€œspring-ai-tika-document-readerâ€ä¾èµ–åŒ…ï¼Œè¯¥ä¾èµ–ç”¨äºåˆ‡åˆ†DOC æ–‡æ¡£ã€‚

**3) é…ç½®resources/application.properties**

```
spring.application.name=SpringAIRAGDemo
server.port=8080

## ä½¿ç”¨ æ™ºæ™®AI Embedding æ¨¡å‹ï¼Œéœ€è¦åœ¨pom.xmlä¸­å¼•å…¥å¯¹åº”ä¾èµ–
spring.ai.zhipuai.api-key=d...4
spring.ai.zhipuai.base-url=https://open.bigmodel.cn/api/paas
spring.ai.zhipuai.embedding.options.model=embedding-2

## é…ç½® Chat Model:Deepseekçš„åŸºç¡€URLã€å¯†é’¥å’Œä½¿ç”¨æ¨¡å‹
spring.ai.deepseek.base-url=https://api.deepseek.com
spring.ai.deepseek.api-key=sk-8...1
spring.ai.deepseek.chat.options.model=deepseek-chat

## Milvus é…ç½®
spring.ai.vectorstore.milvus.client.host=node2
spring.ai.vectorstore.milvus.client.port=19530
# é»˜è®¤ç”¨æˆ·åå’Œå¯†ç ä¸º root å’Œ Milvus
spring.ai.vectorstore.milvus.client.token=root:Milvus
# è¦ä½¿ç”¨çš„ Milvus æ•°æ®åº“çš„åç§°
spring.ai.vectorstore.milvus.database-name=default
# ç”¨äºå­˜å‚¨ vector çš„ Milvus é›†åˆåç§°
spring.ai.vectorstore.milvus.collection-name=guide_qa_store
#æ˜¯å¦è‡ªåŠ¨åˆå§‹åŒ– schemaï¼Œå¦‚ï¼švector_storeå¦‚æœæ²¡æœ‰ä¼šè‡ªåŠ¨åˆ›å»º
spring.ai.vectorstore.milvus.initialize-schema=true
# Milvus é›†åˆä¸­è¦å­˜å‚¨çš„ vector çš„ç»´åº¦ï¼Œé»˜è®¤ä¸º1536ï¼Œè¦ä¸æ‰€ä½¿ç”¨çš„ embedding æ¨¡å‹çš„ç»´åº¦åŒ¹é…ï¼ˆå¦‚ï¼šDeepSeekã€ZhiPuAI æˆ–å…¶ä»–ï¼Œéƒ½æ˜¯1024ç»´ï¼‰
spring.ai.vectorstore.milvus.embedding-dimension=1024
```

**4) å‡†å¤‡çŸ¥è¯†åº“æ–‡æ¡£**

å°†â€œå¯¼æ¸¸é¢è¯•é—®ç­”.docâ€æ–‡æ¡£æ”¾åˆ°é¡¹ç›®resourcesèµ„æºç›®å½•ä¸‹ã€‚

**5) æ„å»ºä¸¤ä¸ªRag Advisorå’ŒChat Client**

åœ¨é¡¹ç›®ä¸­åˆ›å»ºconfig/AIConfig.java ï¼Œè¯¥ç±»æ ‡è®°ä¸ºConfigurationç±»ã€‚ç±»ä¸­æ³¨å…¥QuestionAnswerAdvisorã€RetrievalAugmentationAdvisorä»¥åŠChatClientï¼Œå¹¶ä¸”æ¯æ¬¡è¿è¡ŒSpringBooté¡¹ç›®æ—¶è¯»å–é¡¹ç›®resourcesèµ„æºç›®å½•ä¸‹çš„â€œå¯¼æ¸¸é¢è¯•é—®ç­”.docâ€å†…å®¹ï¼Œåˆ‡åˆ†æ–‡æ¡£å†…å®¹ï¼Œå¹¶å‘Milvusä¸­æ’å…¥åˆ†ç‰‡æ–‡æ¡£å‘é‡æ•°æ®ï¼ˆå¦‚æœå·²å­˜åœ¨åˆ™ä¸é‡å¤æ’å…¥ï¼‰ã€‚

```
package com.example.springairagdemo.config;

import io.milvus.client.MilvusServiceClient;
import io.milvus.grpc.GetCollectionStatisticsResponse;
import io.milvus.param.R;
import io.milvus.param.collection.FlushParam;
import io.milvus.param.collection.GetCollectionStatisticsParam;
import io.milvus.response.GetCollStatResponseWrapper;
import jakarta.annotation.PostConstruct;
import org.apache.tika.Tika;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.client.advisor.vectorstore.QuestionAnswerAdvisor;
import org.springframework.ai.deepseek.DeepSeekChatModel;
import org.springframework.ai.document.Document;
import org.springframework.ai.rag.advisor.RetrievalAugmentationAdvisor;
import org.springframework.ai.rag.generation.augmentation.ContextualQueryAugmenter;
import org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;
import org.springframework.ai.reader.tika.TikaDocumentReader;
import org.springframework.ai.transformer.splitter.TokenTextSplitter;
import org.springframework.ai.vectorstore.SearchRequest;
import org.springframework.ai.vectorstore.milvus.MilvusVectorStore;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.ClassPathResource;

import java.util.ArrayList;
import java.util.List;

@Configuration
public class AIConfig {

    // æ³¨å…¥ MilvusVectorStore å®ä¾‹
    @Autowired
    private MilvusVectorStore vectorStore;

    // ä»é…ç½®æ–‡ä»¶ä¸­è¯»å– Milvus é›†åˆåç§°
    @Value("${spring.ai.vectorstore.milvus.collection-name}")
    private String collectionName;

    //é…ç½® QuestionAnswerAdvisorï¼Œç”¨äºé—®ç­”ä»»åŠ¡
    @Bean
    public QuestionAnswerAdvisor questionAnswerAdvisor() {
        return QuestionAnswerAdvisor.builder(vectorStore)
                // é…ç½®å‘é‡æœç´¢çš„å‚æ•°ï¼Œè¿™é‡Œè®¾ç½®äº†ç›¸ä¼¼åº¦é˜ˆå€¼ä¸º 0.5ï¼Œè¿”å›å‰ 6 ä¸ªç»“æœ
                .searchRequest(SearchRequest.builder().similarityThreshold(0.1d).topK(6).build())
                .build();
    }


    //é…ç½® RetrievalAugmentationAdvisorï¼Œç”¨äºå¢å¼ºæ£€ç´¢ä»»åŠ¡
    @Bean
    public RetrievalAugmentationAdvisor retrievalAugmentationAdvisor() {

        //VectorStoreDocumentRetriever è´Ÿè´£åœ¨å‘é‡æ•°æ®åº“ä¸­æ ¹æ®æŸ¥è¯¢è·å–æœ€ç›¸å…³çš„æ–‡æ¡£
        //æ”¯æŒæ ¹æ®ç›¸ä¼¼åº¦é˜ˆå€¼ã€top-Kï¼ˆè¿”å›å‰Kä¸ªæœ€ç›¸å…³æ–‡æ¡£ï¼‰å’Œè¿‡æ»¤è¡¨è¾¾å¼ç­‰æ–¹å¼è¿›è¡Œç²¾ç¡®æ£€ç´¢
        VectorStoreDocumentRetriever retriever = VectorStoreDocumentRetriever.builder()
                .vectorStore(vectorStore) // è®¾ç½®å‘é‡å­˜å‚¨å¯¹è±¡
                .similarityThreshold(0.1)//è®¾ç½®ç›¸ä¼¼åº¦é˜ˆå€¼
                .topK(6)//è®¾ç½®è¿”å›å‰Kä¸ªæœ€ç›¸å…³æ–‡æ¡£
                .build();

        //ContextualQueryAugmenter ç”¨äºå¢å¼ºæŸ¥è¯¢ï¼Œæ ¹æ®ä¸Šä¸‹æ–‡ä¿¡æ¯ç”Ÿæˆæ›´å…·ä½“çš„æŸ¥è¯¢
        //æ”¯æŒåŸºäºä¸Šä¸‹æ–‡çš„æŸ¥è¯¢å¢å¼ºï¼Œä¾‹å¦‚æ ¹æ®ç”¨æˆ·è¾“å…¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ç”Ÿæˆæ›´å…·ä½“çš„æŸ¥è¯¢ï¼Œæé«˜æ£€ç´¢çš„å‡†ç¡®æ€§å’Œæ•ˆç‡
        ContextualQueryAugmenter cqa = ContextualQueryAugmenter.builder()
                .allowEmptyContext(true)//å…è®¸ç©ºä¸Šä¸‹æ–‡
                .build();

        //è¿”å› RetrievalAugmentationAdvisor å¯¹è±¡ï¼Œç”¨äºå¢å¼ºæ£€ç´¢ä»»åŠ¡
        return RetrievalAugmentationAdvisor.builder()
                .documentRetriever(retriever) // è®¾ç½®æ–‡æ¡£æ£€ç´¢å™¨
                .queryAugmenter(cqa) // è®¾ç½®æŸ¥è¯¢å¢å¼ºå™¨
                .build();
    }


    //é…ç½® ChatClientï¼Œåˆå§‹åŒ–èŠå¤©å®¢æˆ·ç«¯
    @Bean
    public ChatClient chatClient(DeepSeekChatModel chatModel,QuestionAnswerAdvisor qaAdvisor) {
        return ChatClient.builder(chatModel)
                .defaultSystem("ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹ï¼Œå›ç­”ç”¨æˆ·é—®é¢˜æ˜¯ä¸è¦æåŠå›å¤æ˜¯ä»ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸­è·å–çš„ï¼Œ" +
                        "ä¸è¦å›ç­”ä½ ä¸çŸ¥é“çš„é—®é¢˜ï¼Œå¦‚æœä½ ä¸çŸ¥é“ç­”æ¡ˆï¼Œå°±å›ç­”ï¼šæŠ±æ­‰ï¼Œæˆ‘ä¸æ¸…æ¥šè¿™ä¸ªé—®é¢˜ã€‚")
                .build();
    }


    /**
     * @PostConstruct æ³¨è§£çš„æ–¹æ³•ä¼šåœ¨ Spring å®¹å™¨å®Œæˆä¾èµ–æ³¨å…¥åè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡ï¼Œå¸¸ç”¨äºæ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ã€‚
     */
    @PostConstruct
    public void initVectorData() {
        System.out.println("åˆå§‹åŒ–å‘é‡æ•°æ®ï¼Œå†™å…¥åˆ° Milvus æ•°æ®åº“ä¸­...");

        // è·å– Milvus å®¢æˆ·ç«¯å®ä¾‹
        MilvusServiceClient client = (MilvusServiceClient)vectorStore.getNativeClient().get();

        // è·å–é›†åˆç»Ÿè®¡ä¿¡æ¯ï¼ŒæŸ¥è¯¢é›†åˆçš„è®°å½•æ•°é‡
        R<GetCollectionStatisticsResponse> resp = client.getCollectionStatistics(GetCollectionStatisticsParam.newBuilder()
                .withCollectionName(collectionName)
                .build());

        // è·å–å®ä½“æ•°é‡ï¼Œå³æ•°æ®è¡Œæ•°
        long rowCount = new GetCollStatResponseWrapper(resp.getData()).getRowCount();

        System.out.println("Milvus vector_store ä¸­æ•°æ®æ•°é‡ï¼š" + rowCount);

        //å¦‚æœé›†åˆæ²¡æœ‰æ•°æ®å°±å†™å…¥
        if(rowCount==0){
            System.out.println("Milvus vector_store ä¸­æ²¡æœ‰æ•°æ®ï¼Œå¼€å§‹å†™å…¥...");
            loadAndStoreDocumentData();
        }

        // è·å– Milvus å®¢æˆ·ç«¯å¹¶æ‰‹åŠ¨è°ƒç”¨ flushï¼Œåˆ·æ–°ç´¢å¼•ï¼Œç¡®ä¿æ•°æ®è¢«æŒä¹…åŒ–åˆ° Milvus æ•°æ®åº“ä¸­
        System.out.println("Milvus vector_store åˆ·æ–°ç´¢å¼•...");
        client.flush(FlushParam.newBuilder()
                .withCollectionNames(List.of(collectionName)) // è®¾ç½®åˆ·æ–°æ“ä½œçš„é›†åˆåç§°
                .build());


    }


    /**
     * è¯»å– Word æ–‡ä»¶å†…å®¹å¹¶å­˜å…¥ Milvus å‘é‡æ•°æ®åº“
     */
    private void loadAndStoreDocumentData() {
        List<Document> documents = new ArrayList<>();

        try {
            // ä» resources ç›®å½•åŠ è½½æ–‡æ¡£
            var resource = new ClassPathResource("å¯¼æ¸¸é¢è¯•é—®ç­”.doc");
            Tika tika = new Tika();
            String text = tika.parseToString(resource.getFile());

            // ä½¿ç”¨ TokenTextSplitter æ‹†åˆ†æ–‡æœ¬
            TokenTextSplitter splitter = TokenTextSplitter.builder()
                    .withChunkSize(800)           // æ¯æ®µæœ€å¤š 800 ä¸ª token
                    .withMinChunkSizeChars(400)   // æ¯æ®µæœ€å°å­—ç¬¦æ•° 400
                    .withKeepSeparator(true)      // ä¿ç•™åˆ†éš”ç¬¦
                    .build();


            // æ‹†åˆ†æ–‡æœ¬
            List<Document> rawDocs = List.of(new Document(text));
            List<Document> chunks = splitter.apply(rawDocs);

            // éå†æ¯ä¸ª chunkï¼Œç”Ÿæˆ embedding å¹¶å­˜å‚¨
            for (Document chunk : chunks) {
                String chunkText = chunk.getText().strip();
                //chunk:chunk: Document{id='10d79633-7d1c-4736-9423-3877d05f6cd6', text='å†…å®¹ã€‚ã€‚ã€‚', media='null', metadata={}, score=null}
                System.out.println("chunk: " + chunk);
                System.out.println("chunkText: " + chunkText);
                if (!chunkText.isBlank()) {
                    // å°†æ–‡æ¡£å†…å®¹å­˜å…¥ Milvus å‘é‡æ•°æ®åº“
                    documents.add(chunk);
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }

        // å°†æ–‡æ¡£å†…å®¹å­˜å…¥ Milvus å‘é‡æ•°æ®åº“ï¼Œè‡ªåŠ¨å†™å…¥å‘é‡æ•°æ®è¡¨ guide_qa_vectors ä¸­
        vectorStore.add(documents);
    }
}
```

**6) åˆ›å»ºRagController.java**

```
package com.example.springairagdemo.controller;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.client.advisor.vectorstore.QuestionAnswerAdvisor;
import org.springframework.ai.rag.advisor.RetrievalAugmentationAdvisor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@RestController
@RequestMapping("/ai")
public class RagController {

    @Autowired
    private ChatClient chatClient;
    @Autowired
    private QuestionAnswerAdvisor qaAdvisor;
    @Autowired
    private RetrievalAugmentationAdvisor ragAdvisor;

    @GetMapping("/chat1")
    public String ask1(@RequestParam String message) {
        return chatClient.prompt()
                .user(message)
                //è®¾ç½®ä½¿ç”¨ QuestionAnswerAdvisor
                .advisors(List.of(qaAdvisor))
                .call()
                .content();
    }

    @GetMapping("/chat2")
    public String ask2(@RequestParam String message) {
        return chatClient.prompt()
                .user(message)
                //è®¾ç½®ä½¿ç”¨ RetrievalAugmentationAdvisor
                .advisors(List.of(ragAdvisor))
                .call()
                .content();
    }

}
```

**7) å¯åŠ¨Milvus**

åœ¨linux node2 èŠ‚ç‚¹å¯åŠ¨Milvusï¼š

```
#è¿›å…¥ milvusç›®å½•
cd /software/milvus

#å¯åŠ¨ Milvus
docker compose up -d
```

**8) å¯åŠ¨é¡¹ç›®å¹¶æµ‹è¯•**

å¯åŠ¨SpringAIRAGDemoé¡¹ç›®ï¼Œè¿è¡Œä¸»åº”ç”¨ç±»SpringAiragDemoApplication.javaï¼Œå¯åŠ¨è¯¥é¡¹ç›®ã€‚

åœ¨æµè§ˆå™¨ä¸­è¾“å…¥å¦‚ä¸‹å†…å®¹è¿›è¡Œæµ‹è¯•ï¼š

```
# http://localhost:8080/ai/chat1?message=ä½•ä¸ºä¸¹å´–æ–­å¢™
ä¸¹å´–æ–­å¢™æ˜¯ä¸€æ¡è‡ªç‡•å±±è¿åŠ¨ä»¥æ¥å¤šæ¬¡æ´»åŠ¨çš„æ–­å±‚å¸¦ï¼Œæ€»æ–­è·600ç±³ä»¥ä¸Šã€‚å®ƒæ˜¯ç”±ç´«çº¢è‰²çŸ³è‹±ç ‚å²©æ„æˆçš„æ–­å±‚é¢ï¼Œé•¿250ç±³ï¼Œé«˜150ç±³ã€‚è¯¥æ–­å¢™ä¸‹çš„ä¸€ç³»åˆ—æ–­é˜¶å®Œæ•´åœ°ä½“ç°äº†é€ å±±è¿åŠ¨çš„è¿‡ç¨‹ï¼Œå±•ç¤ºäº†åœ°è´¨è¿åŠ¨çš„ä¼Ÿå¤§åŠ›é‡ã€‚

# http://localhost:8080/ai/chat1?message=Spring AIæ˜¯ä»€ä¹ˆï¼Ÿ
æŠ±æ­‰ï¼Œæˆ‘ä¸æ¸…æ¥šè¿™ä¸ªé—®é¢˜ã€‚

#  http://localhost:8080/ai/chat2?message=ä½•ä¸ºä¸¹å´–æ–­å¢™
ä¸¹å´–æ–­å¢™æ˜¯ä¸€æ¡è‡ªç‡•å±±è¿åŠ¨ä»¥æ¥å¤šæ¬¡æ´»åŠ¨çš„æ–­å±‚å¸¦ï¼Œæ€»æ–­è·600ç±³ä»¥ä¸Šã€‚ä¸¹å´–æ–­å¢™æ˜¯è¯¥æ–­å±‚æœ€æ–°ä¸€æ¬¡æ´»åŠ¨å½¢æˆçš„æ–­å±‚é¢ï¼Œç”±ç´«çº¢è‰²çŸ³è‹±ç ‚å²©æ„æˆï¼Œé•¿250ç±³ï¼Œé«˜150ç±³ã€‚æ–­å¢™ä¸‹çš„ä¸€ç³»åˆ—æ–­é˜¶ï¼Œå®Œæ•´åœ°ä½“ç°äº†é€ å±±è¿åŠ¨çš„è¿‡ç¨‹ï¼Œåˆå±•ç¤ºäº†é€ å±±è¿åŠ¨çš„ä¼Ÿå¤§ã€‚

#http://localhost:8080/ai/chat2?message=ä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ
æŠ±æ­‰ï¼Œæˆ‘ä¸æ¸…æ¥šè¿™ä¸ªé—®é¢˜ã€‚
```